<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="~{layout :: html(title='首頁', content=~{::content})}">

<body>
    <div th:fragment="content">
        <link rel="stylesheet" th:href="@{/css/home-premium.css}">

        <!-- 輪播圖資料 (隱藏，供 Alpine 讀取) -->
        <template th:each="slide : ${carouselSlides}">
            <div class="carousel-slide-data" th:data-image="${slide.imageUrl}" th:data-link="${slide.linkUrl}"></div>
        </template>

        <!-- 跑馬燈 -->
        <div class="winner-reel-container" th:if="${!#lists.isEmpty(latestWinners)}" x-data="winnerReel">
            <div class="winner-reel">
                <div th:each="win : ${latestWinners}" class="winner-item">
                    🎊 恭喜玩家 <span class="winner-name" th:text="${win.username}">j***n</span>
                    抽中 <span class="winner-prize" th:text="${win.prizeName}">實體抱枕</span>
                    <span th:if="${win.prizeRank != null}" th:text="'(' + ${win.prizeRank} + '賞)'"
                        class="winner-rank"></span>
                </div>
            </div>
        </div>

        <div class="container">
            <!-- 用戶儀表板 -->
            <div th:if="${currentMember != null}" class="personal-dashboard" x-data="homeDashboard"
                x-init="balance = /*[[${currentMember.platformWalletBalance}]]*/ 0">
                <div class="user-welcome">
                    歡迎回來，<span
                        th:text="${currentMember.nickname != null ? currentMember.nickname : currentMember.username}">玩家</span>！
                    <span th:if="${currentMember.level != null}" class="user-level-badge"
                        th:text="${currentMember.level.name}">VIP1</span>
                </div>
                <div class="user-assets">
                    <div class="asset-item">
                        <span class="asset-label">錢包餘額</span>
                        <span class="asset-value gold">$<span x-text="balance"
                                th:text="${currentMember.platformWalletBalance}">0</span></span>
                    </div>
                    <div class="asset-item">
                        <span class="asset-label">累積積分</span>
                        <span class="asset-value points" th:text="${currentMember.points}">0</span>
                    </div>
                    <div class="asset-item">
                        <span class="asset-label">成長值</span>
                        <span class="asset-value growth" th:text="${currentMember.growthValue}">0</span>
                    </div>
                    <div class="asset-item">
                        <span class="asset-label">幸運值</span>
                        <span class="asset-value lucky" th:text="${currentMember.luckyValue}">0</span>
                    </div>
                </div>
                <div class="user-actions">
                    <a th:href="@{/transactions}" class="btn-deposit">儲值點數</a>
                </div>

                <!-- 簽到與任務 -->
                <div class="loyalty-container">
                    <div class="sign-in-section" th:if="${signInInfo != null}">
                        <div class="loyalty-label">連續簽到：<span th:text="${signInInfo.consecutiveDays}">1</span> 天</div>
                        <div class="streak-grid">
                            <div th:each="i : ${#numbers.sequence(1, 7)}"
                                th:class="'streak-box ' + (${signInInfo.consecutiveDays >= i} ? 'active' : '')">
                                <div class="day-num" th:text="${i}">1</div>
                                <div class="bonus-tag" th:text="${i == 7 ? '+50' : '+10'}"></div>
                            </div>
                        </div>
                    </div>

                    <div class="mission-section" th:if="${!#lists.isEmpty(dailyMissions)}">
                        <div class="loyalty-label">今日任務</div>
                        <div class="mission-list">
                            <div th:each="mission : ${dailyMissions}" class="mission-card">
                                <div class="mission-header">
                                    <span class="m-name"
                                        th:text="${mission.type == T(com.toy.store.model.MemberMission.MissionType).DAILY_LOGIN ? '每日登入' : (mission.type == T(com.toy.store.model.MemberMission.MissionType).SPEND_AMOUNT ? '累計消費' : '累計抽獎')}">任務</span>
                                    <span class="m-reward"
                                        th:text="'+' + ${mission.rewardBonusPoints} + ' 點'">+10</span>
                                </div>
                                <div class="m-progress-bg">
                                    <div class="m-progress-fill"
                                        th:style="'width: ' + (${mission.currentValue * 100.0 / mission.targetValue > 100 ? 100 : mission.currentValue * 100.0 / mission.targetValue}) + '%'">
                                    </div>
                                </div>
                                <div class="m-footer">
                                    <span th:text="${mission.currentValue} + ' / ' + ${mission.targetValue}">0/1</span>
                                    <span th:if="${mission.completed}" class="done-tag">已完成</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Hero (無輪播圖時) -->
        <header class="hero" th:if="${#lists.isEmpty(carouselSlides)}">
            <div>
                <h1>釋放你的 <span class="hero-accent">童心靈魂 <i class="fa-solid fa-ghost"></i></span></h1>
                <p>探索稀有收藏品、限定公仔與神秘扭蛋。</p>
                <div class="hero-actions">
                    <a th:if="${@systemSettingService.isShoppingEnabled()}" th:href="@{/products}"
                        class="btn btn-primary">立即選購</a>
                    <a th:href="@{/gacha}" class="btn btn-outline">試試手氣</a>
                </div>
            </div>
        </header>

        <!-- 輪播圖 -->
        <div class="carousel-container" th:if="${!#lists.isEmpty(carouselSlides)}" x-data="homeCarousel">
            <template x-for="(slide, i) in slides" :key="i">
                <div class="carousel-slide" :class="{ 'active': currentSlide === i }"
                    :style="'background-image: url(' + slide.imageUrl + ')'">
                    <a x-show="slide.linkUrl" :href="slide.linkUrl" class="carousel-link"></a>
                </div>
            </template>
            <button class="carousel-nav carousel-nav--prev" @click="prev()">❮</button>
            <button class="carousel-nav carousel-nav--next" @click="next()">❯</button>
            <div class="carousel-indicators">
                <template x-for="(slide, i) in slides" :key="'ind-' + i">
                    <button class="carousel-indicator" :class="{ 'active': currentSlide === i }"
                        @click="goTo(i)"></button>
                </template>
            </div>
        </div>

        <div class="container">
            <!-- IP Game Feed -->
            <div class="section-block" x-data="gameFeed">
                <h2 class="section-title">
                    <i class="fa-solid fa-star" style="color: var(--accent-color); margin-right: 10px;"></i>
                    熱門商品
                </h2>

                <div class="game-feed-grid">
                    <template x-for="item in items" :key="item.type + '-' + item.id">
                        <a :href="getLink(item)" class="feed-card">
                            <div class="feed-card__image-wrapper">
                                <img :src="item.imageUrl || '/images/placeholder.jpg'" class="feed-card__image"
                                    loading="lazy">
                                <!-- Stock Overlay for Ichiban -->
                                <div class="feed-stock-badge" x-show="item.type === 'ICHIBAN' && item.totalStock > 0">
                                    <span x-text="item.remainingStock + '/' + item.totalStock"></span>
                                </div>
                            </div>

                            <div class="feed-card__content">
                                <div class="feed-card__header">
                                    <span class="feed-tag" :class="getBadgeClass(item.type)"
                                        x-text="item.typeDisplay"></span>
                                    <h3 class="feed-card__title" x-text="item.name"></h3>
                                </div>

                                <div class="feed-card__footer">
                                    <div class="feed-card__price">
                                        <span class="currency">$</span>
                                        <span class="amount" x-text="item.price"></span>
                                    </div>
                                    <span class="feed-action-icon">➔</span>
                                </div>
                            </div>
                        </a>
                    </template>
                </div>

                <!-- Sentinel & Loading State -->
                <div id="feed-sentinel" class="feed-loader">
                    <div x-show="loading" class="spinner"></div>
                    <p x-show="!hasMore && items.length > 0" class="no-more-text">沒有更多商品了</p>
                </div>
            </div>
        </div>

        <!-- Alpine 元件 -->
        <script th:src="@{/js/alpine/home-component.js}"></script>
        <script th:src="@{/js/alpine/home-feed.js}"></script>
        <link rel="stylesheet" th:href="@{/css/home-feed.css}">


    </div>
</body>

</html>