<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:fragment="html(title, content)">

<head>
    <meta charset="UTF-8">
    <title th:text="${title} + ' - ToySoul'">ç©å…·éˆé­‚ Toy Store</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>

<body>
    <nav class="navbar">
        <div class="container nav-content">
            <a th:href="@{/}" class="nav-logo">TOY<span class="logo-accent">SOUL</span></a>
            <div class="hamburger" onclick="toggleMenu()">
                <span></span>
                <span></span>
                <span></span>
            </div>
            <ul class="nav-menu" id="navMenu">
                <li><a th:href="@{/}" class="nav-link">é¦–é </a></li>
                <li><a th:href="@{/products}" class="nav-link">å•†å“åˆ—è¡¨</a></li>
                <li><a th:href="@{/mystery-box}" class="nav-link">ç›²ç›’æŠ½ç</a></li>

                <li th:if="${currentUser != null}"
                    style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                    <span th:if="${currentUser != null}" style="color: var(--accent-color); font-weight: bold;">
                        $<span th:text="${currentUser.platformWalletBalance}">1000</span>
                    </span>
                    <a th:href="@{/cart}" class="nav-link">è³¼ç‰©è»Š</a>
                    <a th:href="@{/orders}" class="nav-link">è¨‚å–®</a>
                    <a th:href="@{/profile}" class="nav-link"
                        th:text="${currentUser.nickname != null ? currentUser.nickname : currentUser.username}">User</a>
                    <form th:action="@{/logout}" method="post" style="display:inline;">
                        <button type="submit" class="nav-link"
                            style="background:none; border:none; padding:0; cursor: pointer; font-size: 0.95rem;">ç™»å‡º</button>
                    </form>
                </li>

                <li th:if="${currentUser == null}">
                    <a th:href="@{/login}" class="nav-link btn-outline btn-sm">ç™»å…¥</a>
                    <a th:href="@{/register}" class="btn btn-primary btn-sm" style="margin-left: 10px;">è¨»å†Š</a>
                </li>
            </ul>
        </div>
    </nav>

    <div th:replace="${content}"></div>

    <!-- Floating Cart Button -->
    <div id="floatingCartBtn" th:if="${currentUser != null}" onclick="toggleCart()"
        style="position: fixed; bottom: 30px; right: 30px; background: var(--accent-color); color: #000; width: 60px; height: 60px; border-radius: 50%; display: flex; justify-content: center; align-items: center; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.3); z-index: 1000;">
        <span style="font-size: 24px;">ğŸ›’</span>
        <span id="cartBadge" class="badge"
            style="position: absolute; top: -5px; right: -5px; background: red; color: white; border-radius: 50%; padding: 4px 8px; font-size: 0.8rem; display: none;">0</span>
    </div>

    <!-- Floating Cart Panel -->
    <div id="floatingCartPanel" th:if="${currentUser != null}"
        style="position: fixed; top: 0; right: -350px; width: 350px; height: 100%; background: #fff; box-shadow: -2px 0 10px rgba(0,0,0,0.1); z-index: 1001; transition: right 0.3s ease; display: flex; flex-direction: column;">
        <div
            style="padding: 15px; background: var(--primary-color); color: #fff; display: flex; justify-content: space-between; align-items: center;">
            <h3 style="margin: 0; font-size: 1.2rem;">è³¼ç‰©è»Š</h3>
            <span onclick="toggleCart()" style="cursor: pointer; font-size: 1.5rem;">&times;</span>
        </div>
        <div id="cartContent" style="flex-grow: 1; overflow-y: auto;">
            <!-- Cart items will be loaded here -->
            <div class="text-center" style="padding: 20px;">è¼‰å…¥ä¸­...</div>
        </div>
        <div style="padding: 15px; border-top: 1px solid #eee;">
            <button onclick="toggleCart()" class="btn btn-outline" style="width: 100%;">é—œé–‰è³¼ç‰©è»Š</button>
        </div>
    </div>

    <footer class="text-center section" style="background: var(--bg-secondary); margin-top: 50px;">
        <p>&copy; 2024 Toy Soul. ç‰ˆæ¬Šæ‰€æœ‰. | <a th:href="@{/refunds}"
                style="color: var(--text-secondary); text-decoration: underline;">é€€æ›è²¨èªªæ˜</a></p>
    </footer>

    <!-- Back to Top Button -->
    <button id="backToTopBtn" onclick="scrollToTop()" title="Go to top"
        style="display: none; position: fixed; bottom: 100px; right: 30px; z-index: 99; border: none; outline: none; background-color: var(--primary-color); color: white; cursor: pointer; padding: 15px; border-radius: 50%; font-size: 18px; box-shadow: 0 2px 5px rgba(0,0,0,0.3);">
        â–²
    </button>

    <script>
        function toggleMenu() {
            const menu = document.getElementById('navMenu');
            menu.classList.toggle('active');
        }

        function toggleCart() {
            const panel = document.getElementById('floatingCartPanel');
            if (panel.style.right === '0px') {
                panel.style.right = '-350px';
            } else {
                panel.style.right = '0px';
                loadCartItems();
            }
        }

        function loadCartItems() {
            fetch('/cart/api/items')
                .then(response => {
                    if (response.redirected && response.url.includes('login')) {
                        window.location.href = '/login';
                        return null;
                    }
                    if (!response.ok) {
                        if (response.status === 401 || response.status === 403) {
                            window.location.href = '/login';
                            return null;
                        }
                    }
                    return response.text();
                })
                .then(html => {
                    if (html) {
                        // If the response is the login page (full HTML), redirect to login
                        if (html.includes('<!DOCTYPE html>') || html.includes('<html')) {
                            window.location.href = '/login';
                        } else {
                            document.getElementById('cartContent').innerHTML = html;
                        }
                    }
                })
                .catch(error => console.error('Error loading cart:', error));
        }

        function addToCartAjax(event, form) {
            event.preventDefault();
            const formData = new FormData(form);

            fetch('/cart/api/add', {
                method: 'POST',
                body: formData
            })
                .then(response => {
                    if (response.status === 401) {
                        window.location.href = '/login';
                        return;
                    }
                    return response.json();
                })
                .then(data => {
                    if (data && data.success) {
                        // Open cart and reload items
                        const panel = document.getElementById('floatingCartPanel');
                        panel.style.right = '0px';
                        loadCartItems();

                        // Update Badge
                        const badge = document.getElementById('cartBadge');
                        if (data.totalItems > 0) {
                            badge.innerText = data.totalItems;
                            badge.style.display = 'block';
                        } else {
                            badge.style.display = 'none';
                        }
                    } else {
                        alert('åŠ å…¥å¤±æ•—: ' + (data ? data.message : 'Unknown error'));
                    }
                })
                .catch(error => console.error('Error:', error));
        }

        function removeFromCartAjax(event, form) {
            event.preventDefault();
            const formData = new FormData(form);

            fetch('/cart/api/remove', {
                method: 'POST',
                body: formData
            })
                .then(response => {
                    if (response.status === 401) {
                        window.location.href = '/login';
                        return;
                    }
                    return response.json();
                })
                .then(data => {
                    if (data && data.success) {
                        loadCartItems();
                        // Update Badge
                        const badge = document.getElementById('cartBadge');
                        if (data.totalItems > 0) {
                            badge.innerText = data.totalItems;
                            badge.style.display = 'block';
                        } else {
                            badge.style.display = 'none';
                        }
                    } else {
                        alert('ç§»é™¤å¤±æ•—: ' + (data ? data.message : 'Unknown error'));
                    }
                })
                .catch(error => console.error('Error:', error));
        }

        // Back to Top Button Logic
        window.onscroll = function () { scrollFunction() };

        function scrollFunction() {
            const btn = document.getElementById("backToTopBtn");
            if (document.body.scrollTop > 300 || document.documentElement.scrollTop > 300) {
                btn.style.display = "block";
            } else {
                btn.style.display = "none";
            }
        }

        function scrollToTop() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
    </script>
</body>

</html>