<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:fragment="html(title, content)">

<head>
    <meta charset="UTF-8">
    <title th:text="${title} + ' - ToySoul'">ç©å…·éˆé­‚ Toy Store</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>

<body>
    <nav class="navbar">
        <div class="container nav-content">
            <a th:href="@{/}" class="nav-logo">TOY<span class="logo-accent">SOUL</span></a>
            <div class="hamburger" onclick="toggleMenu()">
                <span></span>
                <span></span>
                <span></span>
            </div>
            <ul class="nav-menu" id="navMenu">
                <li><a th:href="@{/}" class="nav-link">ğŸ  é¦–é </a></li>
                <li th:if="${@systemSettingService.isShoppingEnabled()}"><a th:href="@{/products}"
                        class="nav-link">å•†å“åˆ—è¡¨</a></li>
                <!-- æŠ½çç³»çµ± - ç›´æ¥é¡¯ç¤ºå„å…¥å£ -->
                <li th:if="${@systemSettingService.isIchibanEnabled()}">
                    <a th:href="@{/ichiban}" class="nav-link">ğŸ¯ ä¸€ç•ªè³</a>
                </li>
                <li th:if="${@systemSettingService.isRouletteEnabled()}">
                    <a th:href="@{/roulette}" class="nav-link">ğŸ¡ è½‰ç›¤</a>
                </li>
                <li th:if="${@systemSettingService.isBingoEnabled()}">
                    <a th:href="@{/bingo}" class="nav-link">ğŸ² ä¹å®®æ ¼</a>
                </li>
                <li th:if="${@systemSettingService.isRedeemEnabled()}">
                    <a th:href="@{/redeem-shop}" class="nav-link">ğŸ’ å…Œæ›</a>
                </li>
                <li th:if="${@systemSettingService.isMysteryBoxEnabled()}">
                    <a th:href="@{/mystery-box}" class="nav-link">ğŸ ç›²ç›’</a>
                </li>

                <li th:if="${currentUser != null}"
                    style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                    <!-- ç­‰ç´šå¾½ç«  -->
                    <span th:if="${currentUser.level != null}"
                        style="background: linear-gradient(145deg, #667eea, #764ba2); color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.75rem; font-weight: bold;"
                        th:text="${currentUser.level.name}">VIP</span>
                    <!-- é¤˜é¡ -->
                    <span style="color: var(--accent-color); font-weight: bold;">
                        ğŸ’° $<span th:text="${currentUser.platformWalletBalance}">1000</span>
                    </span>
                    <a th:href="@{/transactions}" class="nav-link">ğŸ’³ äº¤æ˜“</a>
                    <a th:href="@{/gacha-history}" class="nav-link">ğŸ“œ ç´€éŒ„</a>
                    <a th:if="${@systemSettingService.isShoppingEnabled()}" th:href="@{/cart}" class="nav-link">ğŸ›’
                        è³¼ç‰©è»Š</a>
                    <a th:if="${@systemSettingService.isShoppingEnabled()}" th:href="@{/orders}" class="nav-link">ğŸ“¦
                        è¨‚å–®</a>
                    <a th:href="@{/profile}" class="nav-link">ğŸ‘¤
                        <span
                            th:text="${currentUser.nickname != null ? currentUser.nickname : currentUser.username}">User</span></a>
                    <form th:action="@{/logout}" method="post" style="display:inline;">
                        <button type="submit" class="nav-link"
                            style="background:none; border:none; padding:0; cursor: pointer; font-size: 0.95rem;">ç™»å‡º</button>
                    </form>
                </li>

                <li th:if="${currentUser == null}">
                    <a th:href="@{/login}" class="nav-link btn-outline btn-sm">ç™»å…¥</a>
                    <a th:href="@{/register}" class="btn btn-primary btn-sm" style="margin-left: 10px;">è¨»å†Š</a>
                </li>
            </ul>
        </div>
    </nav>

    <div th:replace="${content}"></div>

    <!-- æŠ½çè·‘é¦¬ç‡ˆ -->
    <div id="gachaMarquee"
        style="position: fixed; bottom: 0; left: 0; right: 0; background: linear-gradient(90deg, rgba(102,126,234,0.95), rgba(118,75,162,0.95)); color: white; padding: 8px 0; z-index: 999; overflow: hidden;">
        <div id="marqueeContent"
            style="display: flex; gap: 60px; animation: scroll 30s linear infinite; white-space: nowrap;">
            <span>ğŸ° è¼‰å…¥ä¸­çè³‡è¨Š...</span>
        </div>
    </div>
    <style>
        @keyframes scroll {
            0% {
                transform: translateX(100vw);
            }

            100% {
                transform: translateX(-100%);
            }
        }

        #gachaMarquee .win-item {
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        #gachaMarquee .win-rare {
            color: #FFD700;
            font-weight: bold;
        }
    </style>

    <!-- Floating Cart Button -->
    <div id="floatingCartBtn" th:if="${currentUser != null && @systemSettingService.isShoppingEnabled()}"
        onclick="toggleCart()"
        style="position: fixed; bottom: 30px; right: 30px; background: var(--accent-color); color: #000; width: 60px; height: 60px; border-radius: 50%; display: flex; justify-content: center; align-items: center; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.3); z-index: 1000;">
        <span style="font-size: 24px;">ğŸ›’</span>
        <span id="cartBadge" class="badge"
            style="position: absolute; top: -5px; right: -5px; background: red; color: white; border-radius: 50%; padding: 4px 8px; font-size: 0.8rem; display: none;">0</span>
    </div>

    <!-- Floating Cart Panel -->
    <div id="floatingCartPanel" th:if="${currentUser != null && @systemSettingService.isShoppingEnabled()}"
        style="position: fixed; top: 0; right: -350px; width: 350px; height: 100%; background: #fff; box-shadow: -2px 0 10px rgba(0,0,0,0.1); z-index: 1001; transition: right 0.3s ease; display: flex; flex-direction: column;">
        <div
            style="padding: 15px; background: var(--primary-color); color: #fff; display: flex; justify-content: space-between; align-items: center;">
            <h3 style="margin: 0; font-size: 1.2rem;">è³¼ç‰©è»Š</h3>
            <span onclick="toggleCart()" style="cursor: pointer; font-size: 1.5rem;">&times;</span>
        </div>
        <div id="cartContent" style="flex-grow: 1; overflow-y: auto;">
            <!-- Cart items will be loaded here -->
            <div class="text-center" style="padding: 20px;">è¼‰å…¥ä¸­...</div>
        </div>
        <div style="padding: 15px; border-top: 1px solid #eee;">
            <button onclick="toggleCart()" class="btn btn-outline" style="width: 100%;">é—œé–‰è³¼ç‰©è»Š</button>
        </div>
    </div>

    <footer class="text-center section" style="background: var(--bg-secondary); margin-top: 50px;">
        <p>&copy; 2024 Toy Soul. ç‰ˆæ¬Šæ‰€æœ‰. | <a th:href="@{/refunds}"
                style="color: var(--text-secondary); text-decoration: underline;">é€€æ›è²¨èªªæ˜</a></p>
    </footer>

    <!-- Back to Top Button -->
    <button id="backToTopBtn" onclick="scrollToTop()" title="Go to top"
        style="display: none; position: fixed; bottom: 100px; right: 30px; z-index: 99; border: none; outline: none; background-color: var(--accent-color); color: #000; cursor: pointer; width: 50px; height: 50px; border-radius: 50%; box-shadow: 0 4px 10px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; padding: 0;">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M18 15l-6-6-6 6" />
        </svg>
    </button>

    <script>
        function toggleMenu() {
            const menu = document.getElementById('navMenu');
            menu.classList.toggle('active');
        }

        function toggleCart() {
            const panel = document.getElementById('floatingCartPanel');
            if (panel.style.right === '0px') {
                panel.style.right = '-350px';
            } else {
                panel.style.right = '0px';
                loadCartItems();
            }
        }

        function loadCartItems() {
            fetch('/cart/api/items')
                .then(response => {
                    if (response.redirected && response.url.includes('login')) {
                        window.location.href = '/login';
                        return null;
                    }
                    if (!response.ok) {
                        if (response.status === 401 || response.status === 403) {
                            window.location.href = '/login';
                            return null;
                        }
                    }
                    return response.text();
                })
                .then(html => {
                    if (html) {
                        // If the response is the login page (full HTML), redirect to login
                        if (html.includes('<!DOCTYPE html>') || html.includes('<html')) {
                            window.location.href = '/login';
                        } else {
                            document.getElementById('cartContent').innerHTML = html;
                        }
                    }
                })
                .catch(error => console.error('Error loading cart:', error));
        }

        function addToCartAjax(event, form) {
            event.preventDefault();
            const formData = new FormData(form);

            fetch('/cart/api/add', {
                method: 'POST',
                body: formData
            })
                .then(response => {
                    if (response.status === 401) {
                        window.location.href = '/login';
                        return;
                    }
                    return response.json();
                })
                .then(data => {
                    if (data && data.success) {
                        // Open cart and reload items
                        const panel = document.getElementById('floatingCartPanel');
                        panel.style.right = '0px';
                        loadCartItems();

                        // Update Badge
                        const badge = document.getElementById('cartBadge');
                        if (data.totalItems > 0) {
                            badge.innerText = data.totalItems;
                            badge.style.display = 'block';
                        } else {
                            badge.style.display = 'none';
                        }
                    } else {
                        alert('åŠ å…¥å¤±æ•—: ' + (data ? data.message : 'Unknown error'));
                    }
                })
                .catch(error => console.error('Error:', error));
        }

        function removeFromCartAjax(event, form) {
            event.preventDefault();
            const formData = new FormData(form);

            fetch('/cart/api/remove', {
                method: 'POST',
                body: formData
            })
                .then(response => {
                    if (response.status === 401) {
                        window.location.href = '/login';
                        return;
                    }
                    return response.json();
                })
                .then(data => {
                    if (data && data.success) {
                        loadCartItems();
                        // Update Badge
                        const badge = document.getElementById('cartBadge');
                        if (data.totalItems > 0) {
                            badge.innerText = data.totalItems;
                            badge.style.display = 'block';
                        } else {
                            badge.style.display = 'none';
                        }
                    } else {
                        alert('ç§»é™¤å¤±æ•—: ' + (data ? data.message : 'Unknown error'));
                    }
                })
                .catch(error => console.error('Error:', error));
        }

        // Back to Top Button Logic
        window.onscroll = function () { scrollFunction() };

        function scrollFunction() {
            const btn = document.getElementById("backToTopBtn");
            if (document.body.scrollTop > 300 || document.documentElement.scrollTop > 300) {
                btn.style.display = "flex";
            } else {
                btn.style.display = "none";
            }
        }

        function scrollToTop() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // è¼‰å…¥æŠ½çè·‘é¦¬ç‡ˆ
        function loadMarquee() {
            fetch('/api/gacha/recent?limit=10')
                .then(res => res.json())
                .then(data => {
                    if (data.success && data.data.length > 0) {
                        const container = document.getElementById('marqueeContent');
                        container.innerHTML = data.data.map(r => {
                            const icon = r.gachaType === 'ICHIBAN' ? 'ğŸ¯' :
                                r.gachaType === 'ROULETTE' ? 'ğŸ¡' :
                                    r.gachaType === 'BINGO' ? 'ğŸ²' : 'ğŸ';
                            const cls = r.isRare ? 'win-item win-rare' : 'win-item';
                            return `<span class="${cls}">${icon} ${r.player} ç²å¾— ${r.prizeName}${r.prizeRank ? ' [' + r.prizeRank + 'è³]' : ''}</span>`;
                        }).join('');
                    }
                })
                .catch(err => console.log('Marquee load failed'));
        }

        // é é¢è¼‰å…¥æ™‚åŸ·è¡Œ
        document.addEventListener('DOMContentLoaded', function () {
            loadMarquee();
            setInterval(loadMarquee, 30000); // æ¯ 30 ç§’æ›´æ–°
        });
    </script>
</body>

</html>