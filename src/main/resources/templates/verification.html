<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="~{layout :: html(title='æŠ½çé©—è­‰ä¸­å¿ƒ', content=~{::content})}">

<body>
    <div th:fragment="content">
        <div class="container section">
            <h2 class="section-title">ğŸ” æŠ½çé©—è­‰ä¸­å¿ƒ</h2>
            <p class="text-center" style="color: var(--text-secondary); margin-bottom: 30px;">
                é€é SHA256 å“ˆå¸ŒæŠ€è¡“ï¼Œç¢ºä¿æ¯ä¸€æ¬¡æŠ½ççµæœçš„å…¬æ­£é€æ˜
            </p>

            <!-- èªªæ˜å€å¡Š -->
            <div class="info-block"
                style="background: linear-gradient(145deg, #667eea, #764ba2); color: white; border-radius: 20px; padding: 30px; margin-bottom: 40px;">
                <h3 style="margin-bottom: 15px;">ğŸ” å¦‚ä½•é©—è­‰æŠ½ççµæœï¼Ÿ</h3>
                <ol style="line-height: 2;">
                    <li>æ¯å ´éŠæˆ²é–‹å§‹æ™‚ï¼Œç³»çµ±ç”Ÿæˆå”¯ä¸€çš„éš¨æ©Ÿç¨®å­ (Random Seed)</li>
                    <li>æ¯æ¬¡æŠ½ççµæœéƒ½æœƒéˆå¼è¨˜éŒ„ä¸¦è¨ˆç®—æ–°çš„ SHA256 å“ˆå¸Œå€¼</li>
                    <li>éŠæˆ²å®Œå”®å¾Œï¼Œæ‚¨å¯ä»¥æŸ¥çœ‹å®Œæ•´çš„ä¸­çç´€éŒ„èˆ‡æœ€çµ‚å“ˆå¸Œå€¼</li>
                    <li>ä½¿ç”¨ä¸‹æ–¹å·¥å…·è‡ªè¡Œè¨ˆç®—é©—è­‰ï¼Œç¢ºä¿çµæœæœªè¢«ç¯¡æ”¹</li>
                </ol>
            </div>

            <!-- æœ€è¿‘å®Œå”®éŠæˆ² -->
            <div class="verification-section">
                <h3 style="margin-bottom: 20px;">ğŸ“‹ æœ€è¿‘å®Œå”®éŠæˆ²</h3>
                <div id="completedList" class="completed-games">
                    <div class="loading-state">è¼‰å…¥ä¸­...</div>
                </div>
            </div>

            <!-- é©—è­‰å·¥å…· -->
            <div class="verification-section" style="margin-top: 40px;">
                <h3 style="margin-bottom: 20px;">ğŸ§® SHA256 é©—è­‰å·¥å…·</h3>
                <div class="verify-tool"
                    style="background: white; border-radius: 20px; padding: 30px; box-shadow: 0 5px 20px rgba(0,0,0,0.1);">
                    <div class="form-group">
                        <label>è¼¸å…¥å­—ç¬¦ä¸²</label>
                        <textarea id="verifyInput" rows="3" placeholder="è¼¸å…¥æ‚¨æƒ³é©—è­‰çš„å­—ç¬¦ä¸²..."
                            style="width: 100%; padding: 15px; border: 2px solid #eee; border-radius: 10px; resize: vertical;"></textarea>
                    </div>
                    <button class="btn-gacha" onclick="computeHash()" style="margin-top: 15px;">è¨ˆç®— SHA256</button>

                    <div id="hashResult"
                        style="display: none; margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 10px;">
                        <label style="color: #666; font-size: 0.9rem;">SHA256 çµæœ</label>
                        <div id="hashOutput"
                            style="font-family: monospace; word-break: break-all; color: #667eea; font-weight: bold; margin-top: 5px;">
                        </div>
                    </div>
                </div>
            </div>

            <!-- è©³æƒ… Modal -->
            <div id="detailModal" class="verification-modal" style="display: none;">
                <div class="modal-backdrop" onclick="closeDetailModal()"></div>
                <div class="modal-content">
                    <button class="modal-close" onclick="closeDetailModal()">&times;</button>
                    <h3 id="modalTitle">éŠæˆ²è©³æƒ…</h3>
                    <div id="modalBody"></div>
                </div>
            </div>
        </div>

        <script>
            document.addEventListener('DOMContentLoaded', loadCompletedGames);

            function loadCompletedGames() {
                fetch('/api/verification/completed')
                    .then(r => r.json())
                    .then(response => {
                        const container = document.getElementById('completedList');
                        if (!response.success || response.data.length === 0) {
                            container.innerHTML = '<div class="empty-state">å°šç„¡å®Œå”®éŠæˆ²è¨˜éŒ„</div>';
                            return;
                        }

                        container.innerHTML = response.data.map(game => `
                            <div class="game-item" onclick="showDetail('${game.gameType}', ${game.id})">
                                <div class="game-info">
                                    <span class="game-type">${getGameTypeIcon(game.gameType)} ${game.gameType}</span>
                                    <span class="game-name">${game.gameName}</span>
                                    <span class="game-time">${formatTime(game.completedAt)}</span>
                                </div>
                                <div class="game-hash" title="${game.hashValue}">
                                    <span>SHA256:</span>
                                    <code>${game.hashValue.substring(0, 16)}...${game.hashValue.substring(48)}</code>
                                </div>
                            </div>
                        `).join('');
                    });
            }

            function getGameTypeIcon(type) {
                const icons = {
                    'ICHIBAN': 'ğŸ¯',
                    'ROULETTE': 'ğŸ¡',
                    'BINGO': 'ğŸ”¢',
                    'GACHA': 'ğŸ°',
                    'BLINDBOX': 'ğŸ“¦'
                };
                return icons[type] || 'ğŸ®';
            }

            function formatTime(dateStr) {
                if (!dateStr) return '-';
                return new Date(dateStr).toLocaleString('zh-TW');
            }

            function showDetail(gameType, verificationId) {
                fetch(`/api/verification/${gameType}/${verificationId}`)
                    .then(r => r.json())
                    .then(response => {
                        if (!response.success) {
                            alert(response.message);
                            return;
                        }

                        const data = response.data;
                        document.getElementById('modalTitle').textContent = data.gameName;
                        document.getElementById('modalBody').innerHTML = `
                            <div class="detail-section">
                                <label>éŠæˆ²é¡å‹</label>
                                <p>${getGameTypeIcon(data.gameType)} ${data.gameType}</p>
                            </div>
                            <div class="detail-section">
                                <label>éš¨æ©Ÿç¨®å­ (Random Seed)</label>
                                <code class="hash-code">${data.randomSeed}</code>
                            </div>
                            <div class="detail-section">
                                <label>æœ€çµ‚å“ˆå¸Œå€¼ (SHA256)</label>
                                <code class="hash-code">${data.hashValue}</code>
                            </div>
                            <div class="detail-section">
                                <label>å®Œå”®æ™‚é–“</label>
                                <p>${formatTime(data.completedAt)}</p>
                            </div>
                            ${data.resultJson ? `
                                <div class="detail-section">
                                    <label>ä¸­çè¨˜éŒ„</label>
                                    <div class="result-preview">${formatResults(data.resultJson)}</div>
                                </div>
                            ` : ''}
                        `;
                        document.getElementById('detailModal').style.display = 'flex';
                    });
            }

            function formatResults(json) {
                try {
                    const results = JSON.parse(json);
                    if (Array.isArray(results) && results.length > 0) {
                        return results.slice(0, 5).map(r =>
                            `<div class="result-row">${r.memberName || 'æœƒå“¡'} â†’ ${r.prizeName || 'çå“'}</div>`
                        ).join('') + (results.length > 5 ? `<div class="result-more">...é‚„æœ‰ ${results.length - 5} ç­†</div>` : '');
                    }
                    return '<em>ç„¡è©³ç´°è¨˜éŒ„</em>';
                } catch (e) {
                    return '<em>æ ¼å¼è§£æéŒ¯èª¤</em>';
                }
            }

            function closeDetailModal() {
                document.getElementById('detailModal').style.display = 'none';
            }

            function computeHash() {
                const input = document.getElementById('verifyInput').value;
                if (!input.trim()) {
                    alert('è«‹è¼¸å…¥å­—ç¬¦ä¸²');
                    return;
                }

                fetch('/api/verification/compute-hash', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ input: input })
                })
                    .then(r => r.json())
                    .then(response => {
                        if (response.success) {
                            document.getElementById('hashResult').style.display = 'block';
                            document.getElementById('hashOutput').textContent = response.data.sha256;
                        }
                    });
            }
        </script>

        <style>
            .completed-games {
                display: flex;
                flex-direction: column;
                gap: 15px;
            }

            .game-item {
                background: white;
                border-radius: 15px;
                padding: 20px;
                box-shadow: 0 3px 15px rgba(0, 0, 0, 0.08);
                cursor: pointer;
                transition: all 0.3s;
            }

            .game-item:hover {
                transform: translateX(5px);
                box-shadow: 0 5px 20px rgba(102, 126, 234, 0.2);
            }

            .game-info {
                display: flex;
                align-items: center;
                gap: 15px;
                margin-bottom: 10px;
            }

            .game-type {
                background: rgba(102, 126, 234, 0.1);
                color: #667eea;
                padding: 5px 12px;
                border-radius: 20px;
                font-size: 0.85rem;
                font-weight: bold;
            }

            .game-name {
                font-weight: bold;
                flex: 1;
            }

            .game-time {
                color: #999;
                font-size: 0.85rem;
            }

            .game-hash {
                display: flex;
                align-items: center;
                gap: 10px;
                color: #666;
                font-size: 0.9rem;
            }

            .game-hash code {
                background: #f8f9fa;
                padding: 5px 10px;
                border-radius: 5px;
                font-family: monospace;
            }

            .verification-modal {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                z-index: 10001;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .modal-backdrop {
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.8);
            }

            .modal-content {
                position: relative;
                background: white;
                border-radius: 20px;
                max-width: 600px;
                width: 95%;
                max-height: 80vh;
                overflow-y: auto;
                padding: 30px;
            }

            .modal-close {
                position: absolute;
                top: 15px;
                right: 20px;
                background: none;
                border: none;
                font-size: 2rem;
                color: #aaa;
                cursor: pointer;
            }

            .detail-section {
                margin-bottom: 20px;
            }

            .detail-section label {
                display: block;
                color: #999;
                font-size: 0.85rem;
                margin-bottom: 5px;
            }

            .hash-code {
                display: block;
                background: #f8f9fa;
                padding: 12px;
                border-radius: 8px;
                font-family: monospace;
                word-break: break-all;
                color: #667eea;
            }

            .result-row {
                padding: 8px 0;
                border-bottom: 1px solid #eee;
            }

            .result-more {
                color: #999;
                padding: 8px 0;
            }

            .empty-state,
            .loading-state {
                text-align: center;
                padding: 40px;
                color: #999;
            }
        </style>
    </div>
</body>

</html>