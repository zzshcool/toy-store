<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="~{layout :: html(title='æ‰­è›‹æ©Ÿ', content=~{::content})}">

<body>
    <div th:fragment="content">
        <!-- é é¢å°ˆå±¬æ¨£å¼ -->
        <link rel="stylesheet" th:href="@{/css/gacha-page.css}">
        <link rel="stylesheet" th:href="@{/css/home-feed.css}">

        <!-- Alpine.js ä¸»å®¹å™¨ -->
        <div class="gacha-page" x-data="gachaComponent">

            <!-- ä¸»é¡Œé¸æ“‡å€ -->
            <div class="container section gacha-theme-section" x-show="!selectedTheme">
                <h2 class="section-title">ğŸ° ç¥ç§˜æ‰­è›‹æ©Ÿ</h2>
                <p class="section-subtitle">è½‰å‹•æ‰­è›‹ï¼Œç²å¾—é©šå–œå¥½ç¦®ï¼</p>

                <!-- è¼‰å…¥ä¸­ -->
                <div x-show="themes.length === 0" class="gacha-loading">
                    <div class="gacha-loading__spinner"></div>
                    <p>è¼‰å…¥ä¸­...</p>
                </div>

                <!-- ä¸»é¡Œç¶²æ ¼ - å¡ç‰‡å¼ Feed -->
                <div class="game-feed-grid" x-show="themes.length > 0">
                    <template x-for="theme in themes" :key="theme.id">
                        <div class="feed-card" @click="selectTheme(theme)">
                            <div class="feed-card__image-wrapper">
                                <img :src="theme.imageUrl || '/images/placeholder.jpg'" class="feed-card__image"
                                    loading="lazy">
                            </div>

                            <div class="feed-card__content">
                                <div class="feed-card__header">
                                    <span class="feed-tag badge-gacha">è½‰è›‹</span>
                                    <h3 class="feed-card__title" x-text="theme.name"></h3>
                                </div>

                                <div class="feed-card__footer">
                                    <div class="feed-card__price">
                                        <span class="currency">$</span>
                                        <span class="amount" x-text="theme.price"></span>
                                    </div>
                                    <span class="feed-action-icon">â”</span>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>

            <!-- æ‰­è›‹æ©Ÿæ“ä½œå€ -->
            <div class="gacha-machine-section" x-show="selectedTheme" x-cloak>
                <div class="container">
                    <h3 class="gacha-machine-section__title" x-text="selectedTheme?.name || 'ä¸»é¡Œåç¨±'"></h3>

                    <!-- ç°¡åŒ–æ‰­è›‹æ©Ÿ -->
                    <div class="gacha-machine">
                        <!-- çƒè‰™ -->
                        <div class="gacha-machine__dome">
                            <div class="gacha-ball gacha-ball--red"></div>
                            <div class="gacha-ball gacha-ball--blue"></div>
                            <div class="gacha-ball gacha-ball--yellow"></div>
                            <div class="gacha-ball gacha-ball--purple"></div>
                            <div class="gacha-ball gacha-ball--red"></div>
                            <div class="gacha-ball gacha-ball--green"></div>
                            <div class="gacha-ball gacha-ball--yellow"></div>
                            <div class="gacha-ball gacha-ball--blue"></div>
                            <div class="gacha-ball gacha-ball--purple"></div>
                            <div class="gacha-ball gacha-ball--green"></div>
                        </div>

                        <!-- æ§åˆ¶å€ -->
                        <div class="gacha-machine__control">
                            <div class="gacha-handle-wrapper">
                                <div id="gachaHandle" class="gacha-handle"></div>
                            </div>
                            <p class="gacha-handle-label">è½‰å‹•æ‰‹æŠŠé–‹å§‹</p>
                            <div class="gacha-machine__exit"></div>
                        </div>

                        <!-- è† å›Š (å‹•ç•«ç”¨) -->
                        <div id="capsuleContainer" class="gacha-capsule-container" style="display: none;">
                            <div class="gacha-capsule">
                                <div class="gacha-capsule__top">
                                    <div class="gacha-capsule__shine"></div>
                                </div>
                                <div class="gacha-capsule__bottom"></div>
                            </div>
                        </div>
                    </div>

                    <!-- æ“ä½œæŒ‰éˆ• -->
                    <div class="gacha-actions">
                        <button class="gacha-btn-draw" @click="openConfirmModal()" :disabled="isSpinning">
                            <span x-show="!isSpinning">ğŸ² æŠ•å¹£è½‰è›‹ï¼</span>
                            <span x-show="isSpinning">è½‰å‹•ä¸­...</span>
                        </button>
                        <button class="gacha-btn-trial" @click="spin(true)" :disabled="isSpinning">ğŸ§ª å…è²»è©¦æŠ½</button>
                        <p class="gacha-price-display">æ¶ˆè²» $<span x-text="displayPrice">100</span></p>
                        <button class="gacha-btn-back" @click="clearSelection()">â† è¿”å›é¸æ“‡</button>
                    </div>
                </div>
            </div>

            <!-- ç¢ºèªæ‰£æ¬¾å½ˆçª— -->
            <div class="gacha-confirm-modal" x-show="showConfirmModal" x-cloak @click.self="closeConfirmModal()">
                <div class="gacha-confirm-card">
                    <div class="gacha-confirm-card__icon">ğŸ°</div>
                    <h3 class="gacha-confirm-card__title">ç¢ºèªæŠ•å¹£</h3>
                    <p class="gacha-confirm-card__desc">å³å°‡æ‰£é™¤é¤˜é¡é€²è¡ŒæŠ½ç</p>
                    <div class="gacha-confirm-card__price-box">
                        <p class="gacha-confirm-card__price">$<span x-text="displayPrice">0</span></p>
                    </div>
                    <div class="gacha-confirm-card__actions">
                        <button class="gacha-confirm-card__btn gacha-confirm-card__btn--cancel"
                            @click="closeConfirmModal()">å–æ¶ˆ</button>
                        <button class="gacha-confirm-card__btn gacha-confirm-card__btn--trial"
                            @click="spin(true)">å…è²»è©¦æŠ½</button>
                        <button class="gacha-confirm-card__btn gacha-confirm-card__btn--confirm" @click="spin(false)"
                            x-show="$store.user.isLoggedIn">ç¢ºèªæŠ•å¹£</button>
                    </div>
                </div>
            </div>

            <!-- çµæœå½ˆçª— -->
            <div class="gacha-result-modal" x-show="showResultModal" x-cloak @click.self="closeResultModal()">
                <div class="gacha-result-card">
                    <span class="gacha-result-card__trial-badge" x-show="isTrial">è©¦æŠ½é«”é©—</span>
                    <h2 class="gacha-result-card__title">ğŸ‰ æ­å–œç²å¾—ï¼</h2>
                    <p class="gacha-result-card__prize-name" x-text="result?.prize?.name || 'ç¥ç§˜çå“'"></p>
                    <p class="gacha-result-card__meta gacha-result-card__meta--weight">
                        ç¨€æœ‰åº¦ï¼š<span x-text="result?.prize?.weight || '-'"></span>
                    </p>
                    <p class="gacha-result-card__meta gacha-result-card__meta--value">
                        åƒ¹å€¼ï¼š$<span x-text="result?.prize?.value || '-'"></span>
                    </p>
                    <p class="gacha-result-card__action-hint" x-show="isTrial && !$store.user.isLoggedIn">
                        å–œæ­¡é€™å€‹çå“å—ï¼Ÿç™»å…¥å¾Œå³å¯æ­£å¼æŠ½å–ï¼
                    </p>
                    <button class="gacha-result-card__btn" @click="closeResultModal()">å¤ªæ£’äº†ï¼å†æŠ½ä¸€æ¬¡</button>
                </div>
            </div>
        </div>

        <!-- Alpine.js å…ƒä»¶ -->
        <script th:src="@{/js/alpine/gacha-component.js}"></script>

        <style>
            /* è¼‰å…¥ç‹€æ…‹ */
            .gacha-loading {
                text-align: center;
                padding: 60px 20px;
            }

            .gacha-loading__spinner {
                width: 40px;
                height: 40px;
                border: 3px solid var(--bg-secondary);
                border-top-color: var(--accent-color);
                border-radius: 50%;
                animation: spin 0.8s linear infinite;
                margin: 0 auto 1rem;
            }

            @keyframes spin {
                to {
                    transform: rotate(360deg);
                }
            }

            /* éš±è—æœªåˆå§‹åŒ–çš„ Alpine å…ƒç´  */
            [x-cloak] {
                display: none !important;
            }
        </style>
    </div>
</body>

</html>