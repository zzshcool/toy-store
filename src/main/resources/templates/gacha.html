<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="~{layout :: html(title='æ‰­è›‹æ©Ÿ', content=~{::content})}">

<body>
    <div th:fragment="content">
        <link rel="stylesheet" th:href="@{/css/gacha-animations.css}">
        <script th:src="@{/js/game-utils.js}"></script>

        <div class="container section">
            <h2 class="section-title">ğŸ° ç¥ç§˜æ‰­è›‹æ©Ÿ</h2>
            <p class="text-center" style="color: var(--text-secondary); margin-bottom: 30px;">
                è½‰å‹•æ‰­è›‹ï¼Œç²å¾—é©šå–œå¥½ç¦®ï¼
            </p>

            <!-- æ‰­è›‹ä¸»é¡Œé¸æ“‡ -->
            <div class="grid" style="margin-bottom: 40px;">
                <div th:each="theme : ${themes}" class="card text-center" style="cursor: pointer; transition: all 0.3s;"
                    onclick="selectTheme(this)" th:data-id="${theme.id}" th:data-price="${theme.price}"
                    th:data-name="${theme.name}">
                    <div class="img-placeholder"
                        style="background: linear-gradient(145deg, #ff6b6b, #ee5a5a); margin-bottom: 15px;">
                        <span style="font-size: 3rem;">ğŸ</span>
                    </div>
                    <div style="display: flex; justify-content: center; gap: 5px; margin-bottom: 8px;">
                        <span th:if="${theme.ipName != ''}" th:text="${theme.ipName}"
                            style="background: var(--gacha-gold); color: #333; padding: 2px 8px; border-radius: 10px; font-size: 0.75rem; font-weight: bold;">
                        </span>
                    </div>
                    <h3 th:text="${theme.name}">ä¸»é¡Œåç¨±</h3>
                    <p th:text="${theme.description}"
                        style="color: var(--text-secondary); font-size: 0.9rem; margin: 10px 0;"></p>
                    <p style="font-size: 1.3rem; font-weight: bold; color: var(--accent-color);">
                        $<span th:text="${theme.price}">100</span> / æŠ½
                    </p>
                </div>
            </div>
        </div>

        <!-- æ‰­è›‹æ“ä½œå€ -->
        <div id="gachaSection"
            style="display: none; padding: 60px 0; background: linear-gradient(180deg, #1a1a2e, #16213e); text-align: center;">
            <h3 id="selectedThemeName" style="color: white; margin-bottom: 30px;">ä¸»é¡Œåç¨±</h3>

            <!-- å°ˆæ¥­æ“¬çœŸæ‰­è›‹æ©Ÿ -->
            <div class="gacha-machine-wrap">
                <!-- é€æ˜çƒè‰™ -->
                <div class="gacha-head">
                    <div class="gacha-dome"></div>
                    <div class="gacha-balls-pool">
                        <!-- è£é£¾ç”¨å°çƒ -->
                        <div class="ball-mini" style="--bg: #ff6b6b"></div>
                        <div class="ball-mini" style="--bg: #4ecdc4"></div>
                        <div class="ball-mini" style="--bg: #ffd93d"></div>
                        <div class="ball-mini" style="--bg: #6c5ce7"></div>
                        <div class="ball-mini" style="--bg: #ff6b6b"></div>
                        <div class="ball-mini" style="--bg: #4ecdc4"></div>
                        <div class="ball-mini" style="--bg: #ffd93d"></div>
                        <div class="ball-mini" style="--bg: #6c5ce7"></div>
                        <div class="ball-mini" style="--bg: #ff6b6b"></div>
                        <div class="ball-mini" style="--bg: #4ecdc4"></div>
                    </div>
                </div>

                <!-- æ§åˆ¶å€èˆ‡æ‰‹æŠŠ -->
                <div class="gacha-control">
                    <div class="gacha-handle-outer" onclick="startDraw()">
                        <div id="gachaHandle" class="gacha-handle"></div>
                    </div>
                    <p style="color: white; font-weight: bold; margin-top: 10px; font-size: 0.9rem;">è½‰å‹•æ‰‹æŠŠé–‹å§‹</p>

                    <div class="gacha-exit">
                        <div id="capsuleExit" style="position: relative; top: -40px; display: none;">
                            <div class="gacha-capsule" id="capsule">
                                <div class="top">
                                    <div class="shine"></div>
                                </div>
                                <div class="bottom"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ä¸‹æ–¹æŒ‰éˆ• (è¼”åŠ©) -->
            <div style="display: flex; flex-direction: column; align-items: center; gap: 10px; margin-top: 30px;">
                <button id="drawBtn" class="btn-gacha" onclick="startDraw()" style="width: 220px; font-size: 1.3rem;">
                    ğŸ² æŠ•å¹£è½‰è›‹ï¼
                </button>
                <button id="trialBtn" class="btn btn-outline" onclick="startTrial()"
                    style="width: 150px; color: #fff; border-color: rgba(255,255,255,0.3); font-size: 0.9rem;">
                    ğŸ§ª å…è²»è©¦æŠ½
                </button>
                <p id="drawPrice" style="color: #aaa; margin-top: 5px;">æ¶ˆè²» $<span>100</span></p>
                <button class="btn btn-outline" onclick="closeGacha()"
                    style="color: white; border-color: white; margin-top: 10px;">
                    â† è¿”å›é¸æ“‡
                </button>
            </div>
        </div>

        <!-- çµæœå½ˆçª— -->
        <div id="resultModal" class="prize-reveal-overlay" style="display: none;">
            <div class="prize-card" style="max-width: 400px;">
                <div id="trialBadge"
                    style="display: none; background: #666; color: white; padding: 2px 10px; border-radius: 10px; font-size: 0.8rem; margin-bottom: 10px;">
                    è©¦æŠ½é«”é©—</div>
                <h2 style="margin-bottom: 20px;">ğŸ‰ æ­å–œç²å¾—ï¼</h2>
                <div id="resultContent">
                    <h3 id="prizeNameResult"
                        style="color: var(--accent-color); font-size: 1.5rem; margin-bottom: 10px;">çå“åç¨±</h3>
                    <p id="prizeWeightResult" style="color: #666;">ç¨€æœ‰åº¦ï¼š<span>10</span></p>
                    <p id="prizeValueResult" style="color: #666;">åƒ¹å€¼ï¼š<span>$100</span></p>
                </div>
                <div id="trialAction" style="display: none; margin-top: 15px; font-size: 0.9rem; color: #666;">
                    å–œæ­¡é€™å€‹çå“å—ï¼Ÿç™»å…¥å¾Œå³å¯æ­£å¼æŠ½å–ï¼
                </div>
                <button class="btn-gacha" onclick="closeResultModal()" style="margin-top: 20px;">å¤ªæ£’äº†ï¼å†æŠ½ä¸€æ¬¡</button>
            </div>
        </div>

        <!-- éŒ¯èª¤æç¤º -->
        <div th:if="${error}" class="container" style="margin-top: 20px;">
            <div class="alert alert-error text-center" th:text="${error}">éŒ¯èª¤</div>
        </div>

        <!-- ç¢ºèªæ‰£æ¬¾æ¨¡æ…‹æ¡† -->
        <div id="confirmModal" class="prize-reveal-overlay" style="display: none;">
            <div class="prize-card" style="max-width: 400px;">
                <div style="font-size: 2rem; margin-bottom: 15px;">ğŸ°</div>
                <h3 style="margin: 0 0 15px 0;">ç¢ºèªæŠ•å¹£</h3>
                <p style="margin-bottom: 10px;">å³å°‡æ‰£é™¤é¤˜é¡é€²è¡ŒæŠ“æŠ½</p>
                <div style="background: rgba(102,126,234,0.1); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <p style="margin: 0; font-size: 1.5rem; color: var(--accent-color); font-weight: bold;">
                        $<span id="confirmPrice">0</span>
                    </p>
                </div>
                <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                    <button class="btn btn-outline" onclick="cancelConfirm()">å–æ¶ˆ</button>
                    <button class="btn btn-outline" onclick="confirmDraw(true)"
                        style="border-color: #667eea; color: #667eea;">å…è²»è©¦æŠ½é«”é©—</button>
                    <button class="btn-gacha" onclick="confirmDraw(false)">ç¢ºèªæŠ•å¹£</button>
                </div>
            </div>
        </div>

        <script th:inline="javascript">
            let selectedTheme = null;

            function selectTheme(card) {
                selectedTheme = {
                    id: card.dataset.id,
                    price: card.dataset.price,
                    name: card.dataset.name
                };

                document.getElementById('selectedThemeName').textContent = selectedTheme.name;
                document.getElementById('drawPrice').querySelector('span').textContent = selectedTheme.price;
                document.querySelector('.container.section').style.display = 'none';
                document.getElementById('gachaSection').style.display = 'block';
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }

            function closeGacha() {
                document.querySelector('.container.section').style.display = 'block';
                document.getElementById('gachaSection').style.display = 'none';
                selectedTheme = null;
            }

            function startDraw() {
                if (!selectedTheme) {
                    alert('è«‹å…ˆé¸æ“‡ä¸»é¡Œ');
                    return;
                }

                // ç„¡è«–æ˜¯å¦ç™»å…¥ï¼Œéƒ½é¡¯ç¤ºç¢ºèªæ¡†
                document.getElementById('confirmPrice').textContent = selectedTheme.price;
                document.getElementById('confirmModal').style.display = 'flex';
            }

            function startTrial() {
                if (!selectedTheme) {
                    alert('è«‹å…ˆé¸æ“‡ä¸»é¡Œ');
                    return;
                }
                confirmDraw(true);
            }

            function cancelConfirm() {
                document.getElementById('confirmModal').style.display = 'none';
            }

            function confirmDraw(isTrial = false) {
                document.getElementById('confirmModal').style.display = 'none';
                GameUtils.showMask();

                const btn = document.getElementById('drawBtn');
                const trialBtn = document.getElementById('trialBtn');
                const handle = document.getElementById('gachaHandle');
                const capsuleExit = document.getElementById('capsuleExit');
                const capsule = document.getElementById('capsule');
                const balls = document.querySelectorAll('.ball-mini');

                if (btn) btn.disabled = true;
                if (trialBtn) trialBtn.disabled = true;

                // 1. GSAP ç¸½é«” TimeLine
                const masterTl = gsap.timeline();

                // 2. è½‰å‹•æ‰‹æŠŠå‹•ç•«
                masterTl.to(handle, {
                    rotation: 360,
                    duration: 0.8,
                    ease: "back.inOut(1.7)",
                    onStart: () => playHandleSound()
                });

                // 3. çƒè‰™æŠ–å‹•å‹•ç•«
                masterTl.to(balls, {
                    x: "random(-10, 10)",
                    y: "random(-10, 10)",
                    rotation: "random(-45, 45)",
                    duration: 0.1,
                    repeat: 6,
                    yoyo: true,
                    ease: "none"
                }, 0.2);

                // 4. ç™¼é€å›å¾Œå° API è«‹æ±‚
                const params = new URLSearchParams();
                params.append('themeId', selectedTheme.id);
                if (isTrial) {
                    params.append('isTrial', 'true');
                }

                // 5. ç­‰å¾…æ‰‹æŠŠè½‰å®Œå¾Œæ‰è½
                masterTl.add(() => {
                    fetch('/gacha/draw', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: params.toString()
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (!data.success) {
                                alert(data.message || 'æŠ½çå¤±æ•—');
                                GameUtils.hideMask();
                                location.reload();
                                return;
                            }

                            // 6. æ‰è½å‹•ç•«
                            capsuleExit.style.display = 'block';

                            gsap.fromTo(capsule,
                                { y: -400, rotation: 0, scale: 0.5, opacity: 0 },
                                {
                                    y: 0,
                                    rotation: 720,
                                    scale: 1,
                                    opacity: 1,
                                    duration: 1.2,
                                    ease: "bounce.out",
                                    onComplete: () => {
                                        setTimeout(() => {
                                            GameUtils.playWinSound();
                                            GameUtils.spawnConfetti();
                                            showAjaxResult(data.wonItem.name, data.wonItem.weight, data.wonItem.estimatedValue, isTrial);

                                            // é‡ç½®
                                            if (btn) btn.disabled = false;
                                            if (trialBtn) trialBtn.disabled = false;
                                            capsuleExit.style.display = 'none';
                                        }, 500);
                                    }
                                }
                            );
                        })
                        .catch(err => {
                            console.error('Error:', err);
                            alert('ç¶²è·¯ç•°å¸¸æˆ–ç³»çµ±éŒ¯èª¤ï¼Œè«‹é‡è©¦');
                            GameUtils.hideMask();
                        });
                }, 0.8);
            }

            function playHandleSound() {
                try {
                    const ctx = new (window.AudioContext || window.webkitAudioContext)();
                    const osc = ctx.createOscillator();
                    const g = ctx.createGain();
                    osc.connect(g); g.connect(ctx.destination);
                    osc.type = 'square';
                    osc.frequency.setValueAtTime(150, ctx.currentTime);
                    osc.frequency.exponentialRampToValueAtTime(40, ctx.currentTime + 0.2);
                    g.gain.setValueAtTime(0.1, ctx.currentTime);
                    g.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.2);
                    osc.start(); osc.stop(ctx.currentTime + 0.2);
                } catch (e) { }
            }


            function showAjaxResult(name, weight, value, isTrial) {
                const isLoggedIn = /*[[${currentUser != null}]]*/ false;
                document.getElementById('prizeNameResult').textContent = name;
                document.getElementById('prizeWeightResult').querySelector('span').textContent = weight;
                document.getElementById('prizeValueResult').querySelector('span').textContent = value;
                document.getElementById('trialBadge').style.display = isTrial ? 'inline-block' : 'none';

                const trialAction = document.getElementById('trialAction');
                if (isTrial) {
                    trialAction.style.display = 'block';
                    trialAction.innerHTML = isLoggedIn ?
                        'âœ¨ è©¦æŠ½å®Œæˆï¼éš¨æ™‚å¯ä»¥æ­£å¼æŠ•å¹£æŠ½å–çœŸå“ã€‚' :
                        'å–œæ­¡é€™å€‹çå“å—ï¼Ÿç™»å…¥å¾Œå³å¯æ­£å¼æŠ½å–ï¼';
                } else {
                    trialAction.style.display = 'none';
                }

                const resultBtn = document.querySelector('#resultModal .btn-gacha');
                if (isTrial) {
                    resultBtn.innerHTML = isLoggedIn ? 'âœ¨ è¿”å›é¸è³¼' : 'å¤ªæ£’äº†ï¼å†æŠ½ä¸€æ¬¡';
                    resultBtn.onclick = closeResultModal;
                } else {
                    resultBtn.innerHTML = 'ğŸ“¦ æŸ¥çœ‹æˆ‘çš„çå“ç´€éŒ„';
                    resultBtn.onclick = () => GameUtils.redirectToHistory();
                }

                document.getElementById('resultModal').style.display = 'flex';
            }

            function closeResultModal() {
                document.getElementById('resultModal').style.display = 'none';
                GameUtils.hideMask();
                // å¦‚æœæ˜¯æ­£å¼æŠ½çï¼Œé—œé–‰å¾Œè·³è½‰è‡³ç´€éŒ„é é¢
                const isTrial = document.getElementById('trialBadge').style.display !== 'none';
                if (!isTrial) {
                    GameUtils.redirectToHistory();
                } else {
                    location.reload();
                }
            }

            // åˆå§‹æ•¸æ“šæª¢æŸ¥
            document.addEventListener('DOMContentLoaded', function () {
                const urlParams = new URLSearchParams(window.location.search);
                if (urlParams.has('error')) {
                    console.log('Error found in URL');
                }
            });
        </script>
    </div>
</body>

</html>