<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="~{layout :: html(title='ä¸€ç•ªè³', content=~{::content})}">

<body>
    <div th:fragment="content">
        <link rel="stylesheet" th:href="@{/css/gacha-animations.css}">

        <div class="container section">
            <h2 class="section-title">ğŸ¯ ä¸€ç•ªè³</h2>
            <p class="text-center" style="color: var(--text-secondary); margin-bottom: 30px;">
                é¸æ“‡ä½ çš„å¹¸é‹è™Ÿç¢¼ï¼Œæ­æ›‰éš±è—çå“ï¼å¯ä¸€æ¬¡é¸æ“‡å¤šå€‹æ ¼å­ï¼
            </p>

            <!-- ç®±é«”åˆ—è¡¨ -->
            <div id="boxList" class="grid" style="margin-bottom: 40px;">
                <div class="text-center" style="grid-column: 1/-1; padding: 40px;">
                    <div class="loading-spinner"></div>
                    <p>è¼‰å…¥ä¸­...</p>
                </div>
            </div>

            <!-- é¸è™Ÿå€åŸŸï¼ˆé¸æ“‡ç®±é«”å¾Œé¡¯ç¤ºï¼‰ -->
            <div id="slotSection" style="display: none;">
                <div
                    style="background: linear-gradient(145deg, #1a1a2e, #16213e); border-radius: 20px; padding: 30px; margin-bottom: 30px;">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px; margin-bottom: 20px;">
                        <div>
                            <h3 id="selectedBoxName" style="color: white; margin: 0;">ç®±é«”åç¨±</h3>
                            <p id="selectedBoxDesc" style="color: #aaa; margin: 5px 0 0 0;">æè¿°</p>
                        </div>
                        <div style="text-align: right;">
                            <span style="color: var(--gacha-gold); font-size: 1.5rem; font-weight: bold;">
                                $<span id="pricePerDraw">0</span> / æŠ½
                            </span>
                        </div>
                    </div>

                    <!-- æ ¼å­ç¶²æ ¼ -->
                    <div class="ichiban-grid" id="slotGrid">
                        <!-- æ ¼å­å°‡ç”± JS å‹•æ…‹ç”Ÿæˆ -->
                    </div>

                    <!-- è³¼ç‰©è»Šæµ®å‹•æ¬„ -->
                    <div id="cartBar"
                        style="display: none; position: sticky; bottom: 0; background: linear-gradient(to right, #667eea, #764ba2); 
                         border-radius: 15px; padding: 15px 25px; margin-top: 20px; display: none; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 15px;">
                        <div style="color: white;">
                            <span>å·²é¸æ“‡ <strong id="selectedCount" style="font-size: 1.3rem;">0</strong> æ ¼</span>
                            <span style="margin-left: 20px;">ç¸½åƒ¹ï¼š<strong id="totalPrice"
                                    style="color: #ffd700; font-size: 1.3rem;">$0</strong></span>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-outline" onclick="clearSelection()"
                                style="color: white; border-color: white;">æ¸…é™¤é¸æ“‡</button>
                            <button class="btn-gacha" onclick="confirmPurchase()"
                                style="background: #ffd700; color: #333;">ç¢ºèªè³¼è²·</button>
                        </div>
                    </div>

                    <div style="text-align: center; margin-top: 20px;">
                        <button class="btn btn-outline" onclick="backToBoxList()"
                            style="color: white; border-color: white;">
                            â† è¿”å›åˆ—è¡¨
                        </button>
                    </div>
                </div>

                <!-- çå“åˆ—è¡¨ -->
                <div style="background: white; border-radius: 20px; padding: 30px;">
                    <h4 style="margin-bottom: 20px;">ğŸ çå“ä¸€è¦½</h4>
                    <div id="prizeList" class="grid"
                        style="grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));">
                        <!-- çå“å°‡ç”± JS å‹•æ…‹ç”Ÿæˆ -->
                    </div>
                </div>
            </div>
        </div>

        <!-- è³¼è²·ç¢ºèªå½ˆçª— -->
        <div id="purchaseModal"
            style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 9999; align-items: center; justify-content: center;">
            <div style="background: white; border-radius: 20px; padding: 40px; max-width: 450px; text-align: center;">
                <h3>ç¢ºèªè³¼è²·</h3>
                <div style="margin: 20px 0;">
                    <p>æ‚¨é¸æ“‡äº† <strong id="confirmCount" style="color: var(--gacha-gold); font-size: 1.5rem;">0</strong>
                        å€‹æ ¼å­</p>
                    <p id="confirmSlots" style="color: #666; font-size: 0.9rem; word-break: break-all;"></p>
                </div>
                <p style="font-size: 1.5rem; color: #e74c3c; font-weight: bold;">
                    ç¸½åƒ¹ï¼š$<span id="confirmTotal">0</span>
                </p>
                <p style="color: #666; margin-top: 10px;">è³¼è²·å¾Œå°‡ç«‹å³æ‰£æ¬¾ä¸¦æ­æ›‰æ‰€æœ‰çå“</p>
                <div style="margin-top: 30px; display: flex; gap: 15px; justify-content: center;">
                    <button class="btn btn-outline" onclick="closePurchaseModal()">å–æ¶ˆ</button>
                    <button class="btn-gacha" onclick="executePurchase()" id="purchaseBtn">ç¢ºèªè³¼è²·</button>
                </div>
            </div>
        </div>

        <!-- é–‹ççµæœå½ˆçª— -->
        <div id="resultModal"
            style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 9999; overflow-y: auto;">
            <div
                style="min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 40px 20px;">
                <div
                    style="background: white; border-radius: 20px; padding: 40px; max-width: 600px; width: 100%; text-align: center;">
                    <h2 style="margin-bottom: 30px;">ğŸ‰ æ­å–œç²å¾—ï¼</h2>
                    <div id="prizeResults"
                        style="display: flex; flex-wrap: wrap; gap: 20px; justify-content: center; margin-bottom: 30px;">
                        <!-- çå“çµæœå°‡ç”± JS å‹•æ…‹ç”Ÿæˆ -->
                    </div>
                    <div style="border-top: 1px solid #eee; padding-top: 20px; margin-top: 20px;">
                        <p>å…±ç²å¾— <strong id="totalShardsResult" style="color: #6c5ce7;">0</strong> ç¢ç‰‡</p>
                        <p style="color: #666; font-size: 0.9rem;">æ¶ˆè²»é‡‘é¡ï¼š$<span id="totalCostResult">0</span></p>
                    </div>
                    <button class="btn-gacha" onclick="closeResultModal()" style="margin-top: 20px;">å¤ªæ£’äº†ï¼</button>
                </div>
            </div>
        </div>

        <script>
            let currentBoxId = null;
            let selectedSlots = [];
            let pricePerDraw = 0;

            // é é¢è¼‰å…¥æ™‚å–å¾—ç®±é«”åˆ—è¡¨
            document.addEventListener('DOMContentLoaded', function () {
                loadBoxList();
            });

            // è¼‰å…¥ç®±é«”åˆ—è¡¨
            function loadBoxList() {
                fetch('/api/ichiban')
                    .then(res => res.json())
                    .then(response => {
                        if (response.success && response.data.length > 0) {
                            renderBoxList(response.data);
                        } else {
                            document.getElementById('boxList').innerHTML = `
                                <div class="text-center" style="grid-column: 1/-1; padding: 40px;">
                                    <p>ç›®å‰æ²’æœ‰é€²è¡Œä¸­çš„ä¸€ç•ªè³</p>
                                </div>
                            `;
                        }
                    })
                    .catch(err => {
                        console.error('Error loading boxes:', err);
                        document.getElementById('boxList').innerHTML = `
                            <div class="text-center" style="grid-column: 1/-1; padding: 40px;">
                                <p style="color: var(--error-color);">è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢</p>
                            </div>
                        `;
                    });
            }

            // æ¸²æŸ“ç®±é«”åˆ—è¡¨
            function renderBoxList(boxes) {
                const html = boxes.map(box => `
                    <div class="card" style="cursor: pointer;" onclick="selectBox(${box.id}, ${box.pricePerDraw})">
                        <div class="img-placeholder" style="background: linear-gradient(145deg, #667eea, #764ba2);">
                            <span style="color: white; font-size: 3rem;">ğŸ</span>
                        </div>
                        <div style="padding: 20px;">
                            <span style="background: var(--gacha-gold); color: #333; padding: 3px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: bold;">
                                ${box.ipName}
                            </span>
                            <h3 style="margin: 10px 0;">${box.name}</h3>
                            <p style="color: var(--text-secondary); font-size: 0.9rem;">${box.description || ''}</p>
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 15px;">
                                <span style="color: var(--accent-color); font-weight: bold; font-size: 1.2rem;">$${box.pricePerDraw}</span>
                                <span style="color: #666; font-size: 0.9rem;">${box.totalSlots} æ ¼</span>
                            </div>
                        </div>
                    </div>
                `).join('');
                document.getElementById('boxList').innerHTML = html;
            }

            // é¸æ“‡ç®±é«”
            function selectBox(boxId, price) {
                currentBoxId = boxId;
                pricePerDraw = price;
                selectedSlots = [];
                updateCartBar();
                document.getElementById('boxList').style.display = 'none';
                document.getElementById('slotSection').style.display = 'block';
                loadBoxDetails(boxId);
            }

            // è¿”å›ç®±é«”åˆ—è¡¨
            function backToBoxList() {
                currentBoxId = null;
                selectedSlots = [];
                updateCartBar();
                document.getElementById('boxList').style.display = 'grid';
                document.getElementById('slotSection').style.display = 'none';
            }

            // è¼‰å…¥ç®±é«”è©³æƒ…èˆ‡æ ¼å­ç‹€æ…‹
            function loadBoxDetails(boxId) {
                Promise.all([
                    fetch(`/api/ichiban/${boxId}`).then(r => r.json()),
                    fetch(`/api/ichiban/${boxId}/slots`).then(r => r.json())
                ]).then(([boxRes, slotsRes]) => {
                    if (boxRes.success) {
                        const box = boxRes.data;
                        document.getElementById('selectedBoxName').textContent = box.name;
                        document.getElementById('selectedBoxDesc').textContent = box.description || '';
                        document.getElementById('pricePerDraw').textContent = box.pricePerDraw;
                        pricePerDraw = parseFloat(box.pricePerDraw);
                    }
                    if (slotsRes.success) {
                        renderSlots(slotsRes.data);
                    }
                }).catch(err => console.error('Error:', err));
            }

            // æ¸²æŸ“æ ¼å­ï¼ˆæ”¯æ´å¤šé¸ï¼‰
            function renderSlots(slots) {
                const html = slots.map(slot => {
                    const isSelected = selectedSlots.includes(slot.slotNumber);
                    let statusClass = slot.status.toLowerCase();
                    let statusText = '';
                    let clickable = false;

                    if (slot.status === 'REVEALED') {
                        statusText = 'å·²é–‹';
                    } else if (slot.status === 'LOCKED' && !slot.isLockExpired) {
                        statusText = 'é–å®šä¸­';
                    } else {
                        statusText = isSelected ? 'å·²é¸' : 'å¯é¸';
                        clickable = true;
                        if (isSelected) statusClass = 'selected';
                        else statusClass = 'available';
                    }

                    return `
                        <div class="ichiban-slot ${statusClass}" 
                             ${clickable ? `onclick="toggleSlot(${slot.slotNumber})"` : ''}
                             style="${isSelected ? 'border: 3px solid #ffd700; box-shadow: 0 0 15px rgba(255,215,0,0.5);' : ''}">
                            <span class="slot-number">${slot.formattedNumber}</span>
                            <span class="slot-status">${statusText}</span>
                        </div>
                    `;
                }).join('');
                document.getElementById('slotGrid').innerHTML = html;
            }

            // åˆ‡æ›æ ¼å­é¸æ“‡ç‹€æ…‹
            function toggleSlot(slotNumber) {
                const index = selectedSlots.indexOf(slotNumber);
                if (index > -1) {
                    selectedSlots.splice(index, 1);
                } else {
                    if (selectedSlots.length >= 10) {
                        alert('å–®æ¬¡æœ€å¤šé¸æ“‡ 10 æ ¼');
                        return;
                    }
                    selectedSlots.push(slotNumber);
                }
                updateCartBar();
                // é‡æ–°æ¸²æŸ“æ ¼å­ä»¥æ›´æ–°é¸ä¸­ç‹€æ…‹
                fetch(`/api/ichiban/${currentBoxId}/slots`)
                    .then(r => r.json())
                    .then(response => {
                        if (response.success) renderSlots(response.data);
                    });
            }

            // æ›´æ–°è³¼ç‰©è»Šåˆ—
            function updateCartBar() {
                const cartBar = document.getElementById('cartBar');
                const count = selectedSlots.length;
                const total = count * pricePerDraw;

                document.getElementById('selectedCount').textContent = count;
                document.getElementById('totalPrice').textContent = '$' + total;

                cartBar.style.display = count > 0 ? 'flex' : 'none';
            }

            // æ¸…é™¤é¸æ“‡
            function clearSelection() {
                selectedSlots = [];
                updateCartBar();
                fetch(`/api/ichiban/${currentBoxId}/slots`)
                    .then(r => r.json())
                    .then(response => {
                        if (response.success) renderSlots(response.data);
                    });
            }

            // ç¢ºèªè³¼è²·
            function confirmPurchase() {
                if (selectedSlots.length === 0) {
                    alert('è«‹è‡³å°‘é¸æ“‡ä¸€å€‹æ ¼å­');
                    return;
                }

                const count = selectedSlots.length;
                const total = count * pricePerDraw;
                const sortedSlots = [...selectedSlots].sort((a, b) => a - b);

                document.getElementById('confirmCount').textContent = count;
                document.getElementById('confirmSlots').textContent = 'æ ¼å­ç·¨è™Ÿï¼š' + sortedSlots.map(n => String(n).padStart(2, '0')).join(', ');
                document.getElementById('confirmTotal').textContent = total;
                document.getElementById('purchaseModal').style.display = 'flex';
            }

            // é—œé–‰è³¼è²·ç¢ºèªå½ˆçª—
            function closePurchaseModal() {
                document.getElementById('purchaseModal').style.display = 'none';
            }

            // åŸ·è¡Œè³¼è²·
            function executePurchase() {
                const btn = document.getElementById('purchaseBtn');
                btn.disabled = true;
                btn.textContent = 'è™•ç†ä¸­...';

                fetch(`/api/ichiban/${currentBoxId}/purchase`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ slotNumbers: selectedSlots })
                })
                    .then(res => res.json())
                    .then(response => {
                        closePurchaseModal();
                        btn.disabled = false;
                        btn.textContent = 'ç¢ºèªè³¼è²·';

                        if (response.success) {
                            showResultModal(response.data);
                            selectedSlots = [];
                            updateCartBar();
                            loadBoxDetails(currentBoxId);
                        } else {
                            alert(response.message || 'è³¼è²·å¤±æ•—');
                        }
                    })
                    .catch(err => {
                        console.error('Error:', err);
                        alert('è³¼è²·å¤±æ•—ï¼Œè«‹é‡è©¦');
                        closePurchaseModal();
                        btn.disabled = false;
                        btn.textContent = 'ç¢ºèªè³¼è²·';
                    });
            }

            // é¡¯ç¤ºé–‹ççµæœ
            function showResultModal(data) {
                const prizes = data.prizes || [];
                const html = prizes.map(item => {
                    const prize = item.prize;
                    return `
                        <div style="background: linear-gradient(145deg, #f8f9fa, #e9ecef); border-radius: 15px; padding: 20px; width: 150px;">
                            <div style="font-size: 1.2rem; font-weight: bold; color: #333; margin-bottom: 10px;">
                                #${String(item.slotNumber).padStart(2, '0')}
                            </div>
                            ${prize ? `
                                <div style="background: var(--gacha-gold); color: #333; padding: 3px 8px; border-radius: 10px; font-size: 0.8rem; display: inline-block; margin-bottom: 8px;">
                                    ${prize.rankDisplay}
                                </div>
                                <div style="font-weight: bold; color: #333;">${prize.name}</div>
                            ` : '<div style="color: #999;">æœªçŸ¥çå“</div>'}
                            <div style="color: #6c5ce7; font-size: 0.9rem; margin-top: 5px;">+${item.shards} ç¢ç‰‡</div>
                        </div>
                    `;
                }).join('');

                document.getElementById('prizeResults').innerHTML = html;
                document.getElementById('totalShardsResult').textContent = data.totalShards;
                document.getElementById('totalCostResult').textContent = data.totalCost;
                document.getElementById('resultModal').style.display = 'block';
            }

            // é—œé–‰çµæœå½ˆçª—
            function closeResultModal() {
                document.getElementById('resultModal').style.display = 'none';
            }

            // æ¯ 5 ç§’è‡ªå‹•åˆ·æ–°æ ¼å­ç‹€æ…‹ï¼ˆä¿æŒé¸ä¸­ç‹€æ…‹ï¼‰
            setInterval(() => {
                if (currentBoxId) {
                    fetch(`/api/ichiban/${currentBoxId}/slots`)
                        .then(r => r.json())
                        .then(response => {
                            if (response.success) {
                                renderSlots(response.data);
                            }
                        });
                }
            }, 5000);
        </script>
    </div>
</body>

</html>