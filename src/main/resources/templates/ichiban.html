<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="~{layout :: html(title='ä¸€ç•ªè³', content=~{::content})}">

<body>
    <div th:fragment="content">
        <link rel="stylesheet" th:href="@{/css/gacha-animations.css}">
        <script th:src="@{/js/game-utils.js}"></script>

        <div class="container section">
            <h2 class="section-title">ğŸ¯ ä¸€ç•ªè³</h2>
            <p class="text-center" style="color: var(--text-secondary); margin-bottom: 30px;">
                é¸æ“‡ä½ çš„å¹¸é‹è™Ÿç¢¼ï¼Œæ­æ›‰éš±è—çå“ï¼å¯ä¸€æ¬¡é¸æ“‡å¤šå€‹æ ¼å­ï¼
            </p>

            <!-- ç®±é«”åˆ—è¡¨ -->
            <div id="boxList" class="grid" style="margin-bottom: 40px;">
                <div class="text-center" style="grid-column: 1/-1; padding: 40px;">
                    <div class="loading-spinner"></div>
                    <p>è¼‰å…¥ä¸­...</p>
                </div>
            </div>

            <!-- é¸è™Ÿå€åŸŸï¼ˆé¸æ“‡ç®±é«”å¾Œé¡¯ç¤ºï¼‰ -->
            <div id="slotSection" style="display: none;">
                <!-- è©¦æŠ½æç¤ºæ©«å¹… -->
                <div id="trialModeBanner"
                    style="display: none; background: #6c5ce7; color: white; padding: 10px; text-align: center; border-radius: 10px; margin-bottom: 20px; font-weight: bold; animation: pulse 2s infinite;">
                    âœ¨ ç›®å‰ç‚ºè©¦æŠ½æ¨¡å¼ï¼Œçµæœä¸åˆ—å…¥ç´€éŒ„ã€‚ç«‹å³ç™»å…¥åƒèˆ‡æ­£å¼æŠ½çï¼
                </div>

                <div
                    style="background: linear-gradient(145deg, #1a1a2e, #16213e); border-radius: 20px; padding: 30px; margin-bottom: 30px;">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px; margin-bottom: 20px;">
                        <div>
                            <h3 id="selectedBoxName" style="color: white; margin: 0;">ç®±é«”åç¨±</h3>
                            <p id="selectedBoxDesc" style="color: #aaa; margin: 5px 0 0 0;">æè¿°</p>
                        </div>
                        <div style="text-align: right;">
                            <span style="color: var(--gacha-gold); font-size: 1.5rem; font-weight: bold;">
                                $<span id="pricePerDraw">0</span> / æŠ½
                            </span>
                        </div>
                    </div>

                    <!-- æ ¼å­ç¶²æ ¼ -->
                    <div class="ichiban-grid" id="slotGrid">
                        <!-- æ ¼å­å°‡ç”± JS å‹•æ…‹ç”Ÿæˆ -->
                    </div>

                    <!-- è³¼ç‰©è»Šæµ®å‹•æ¬„ -->
                    <div id="cartBar"
                        style="display: none; position: sticky; bottom: 0; background: linear-gradient(to right, #667eea, #764ba2); 
                         border-radius: 15px; padding: 15px 25px; margin-top: 20px; display: none; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 15px;">
                        <div style="color: white;">
                            <span>å·²é¸æ“‡ <strong id="selectedCount" style="font-size: 1.3rem;">0</strong> æ ¼</span>
                            <span style="margin-left: 20px;">ç¸½åƒ¹ï¼š<strong id="totalPrice"
                                    style="color: #ffd700; font-size: 1.3rem;">$0</strong></span>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-outline" onclick="clearSelection()"
                                style="color: white; border-color: white;">æ¸…é™¤é¸æ“‡</button>
                            <button id="purchaseBtnTrigger" class="btn-gacha" onclick="confirmPurchase()"
                                style="background: #ffd700; color: #333;">ç¢ºèªè³¼è²·</button>
                        </div>
                    </div>

                    <div style="text-align: center; margin-top: 20px;">
                        <button class="btn btn-outline" onclick="backToBoxList()"
                            style="color: white; border-color: white;">
                            â† è¿”å›åˆ—è¡¨
                        </button>
                    </div>
                </div>

                <!-- çå“åˆ—è¡¨ -->
                <div style="background: white; border-radius: 20px; padding: 30px;">
                    <h4 style="margin-bottom: 20px;">ğŸ çå“ä¸€è¦½</h4>
                    <div id="prizeList" class="grid"
                        style="grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));">
                        <!-- çå“å°‡ç”± JS å‹•æ…‹ç”Ÿæˆ -->
                    </div>
                </div>
            </div>
        </div>

        <!-- è³¼è²·ç¢ºèªå½ˆçª— -->
        <div id="purchaseModal"
            style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 10000; align-items: center; justify-content: center;">
            <div
                style="background: white; border-radius: 20px; padding: 30px; max-width: 400px; width: 100%; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.2);">
                <h3 style="margin-bottom: 20px;">ç¢ºèªè³¼è²·</h3>
                <div
                    style="margin-bottom: 25px; text-align: left; background: #f8f9fa; padding: 15px; border-radius: 10px;">
                    <p>å·²é¸æ“‡ï¼š<strong id="confirmSlotsCount" style="color: #6c5ce7;">0</strong> æ ¼</p>
                    <p>å–®åƒ¹ï¼š$<span id="confirmPricePerDraw">0</span></p>
                    <p style="border-top: 1px solid #ddd; padding-top: 10px; margin-top: 10px; font-size: 1.2rem;">
                        ç¸½è¨ˆï¼š<strong id="confirmTotalCost" style="color: var(--gacha-red);">$0</strong>
                    </p>
                </div>
                <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                    <button class="btn btn-outline" onclick="closePurchaseModal()">å–æ¶ˆ</button>
                    <button class="btn btn-outline" onclick="simulateTrialPurchase()"
                        style="border-color: #6c5ce7; color: #6c5ce7;">å…è²»è©¦æŠ½é«”é©—</button>
                    <button id="purchaseBtn" class="btn-gacha" onclick="executePurchase()"
                        style="flex: 1; min-width: 150px;">ç¢ºèªæ­£å¼è³¼è²·</button>
                </div>
            </div>
        </div>

        <!-- é–‹ççµæœå½ˆçª— -->
        <div id="resultModal"
            style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 10001; overflow-y: auto;">
            <div
                style="min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 40px 20px;">
                <div
                    style="background: white; border-radius: 20px; padding: 40px; max-width: 600px; width: 100%; text-align: center;">
                    <h2 style="margin-bottom: 30px;">ğŸ‰ æ­å–œç²å¾—ï¼</h2>
                    <div id="prizeResults"
                        style="display: flex; flex-wrap: wrap; gap: 20px; justify-content: center; margin-bottom: 30px;">
                        <!-- çå“çµæœå°‡ç”± JS å‹•æ…‹ç”Ÿæˆ -->
                    </div>
                    <div style="border-top: 1px solid #eee; padding-top: 20px; margin-top: 20px;">
                        <p>å…±ç²å¾— <strong id="totalShardsResult" style="color: #6c5ce7;">0</strong> ç¢ç‰‡</p>
                        <p style="color: #666; font-size: 0.9rem;">æ¶ˆè²»é‡‘é¡ï¼š$<span id="totalCostResult">0</span></p>
                    </div>
                    <button class="btn-gacha" onclick="closeResultModal()" style="margin-top: 20px;">å¤ªæ£’äº†ï¼</button>
                </div>
            </div>
        </div>

        <script th:inline="javascript">
            let currentBoxId = null;
            let selectedSlots = [];
            let pricePerDraw = 0;

            // é é¢è¼‰å…¥æ™‚å–å¾—ç®±é«”åˆ—è¡¨
            document.addEventListener('DOMContentLoaded', function () {
                loadBoxList();
            });

            // è¼‰å…¥ç®±é«”åˆ—è¡¨
            function loadBoxList() {
                fetch('/api/ichiban')
                    .then(res => res.json())
                    .then(response => {
                        if (response.success && response.data.length > 0) {
                            renderBoxList(response.data);
                        } else {
                            document.getElementById('boxList').innerHTML = `
                                <div class="text-center" style="grid-column: 1/-1; padding: 40px;">
                                    <p>ç›®å‰æ²’æœ‰é€²è¡Œä¸­çš„ä¸€ç•ªè³</p>
                                </div>
                            `;
                        }
                    })
                    .catch(err => {
                        console.error('Error loading boxes:', err);
                        document.getElementById('boxList').innerHTML = `
                            <div class="text-center" style="grid-column: 1/-1; padding: 40px;">
                                <p style="color: var(--error-color);">è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢</p>
                            </div>
                        `;
                    });
            }

            // æ¸²æŸ“ç®±é«”åˆ—è¡¨
            function renderBoxList(boxes) {
                const isLoggedIn = /*[[${currentUser != null}]]*/ false;
                const html = boxes.map(box => `
                    <div class="card" style="cursor: pointer;" onclick="selectBox(${box.id}, ${box.pricePerDraw})">
                        <div class="img-placeholder" style="background: linear-gradient(145deg, #667eea, #764ba2);">
                            <span style="color: white; font-size: 3rem;">ğŸ</span>
                        </div>
                        <div style="padding: 20px;">
                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                <span style="background: var(--gacha-gold); color: #333; padding: 3px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: bold;">
                                    ${box.ipName}
                                </span>
                                ${!isLoggedIn ? '<span style="color: #6c5ce7; font-size: 0.75rem; font-weight: bold;">âœ¨ è©¦æŠ½æ¨¡å¼</span>' : ''}
                            </div>
                            <h3 style="margin: 10px 0;">${box.name}</h3>
                            <p style="color: var(--text-secondary); font-size: 0.9rem;">${box.description || ''}</p>
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 15px;">
                                <span style="color: var(--accent-color); font-weight: bold; font-size: 1.2rem;">$${box.pricePerDraw}</span>
                                <span style="color: #666; font-size: 0.9rem;">å‰©é¤˜ ${box.remainingSlots} / ${box.totalSlots}</span>
                            </div>
                        </div>
                    </div>
                `).join('');
                document.getElementById('boxList').innerHTML = html;
            }

            function promptLogin() {
                alert('è«‹å…ˆç™»å…¥æœƒå“¡ä»¥é€²è¡ŒæŠ½çï¼');
                window.location.href = '/login';
            }

            // é¸æ“‡ç®±é«”
            function selectBox(boxId, price) {
                currentBoxId = boxId;
                pricePerDraw = price;
                selectedSlots = [];
                updateCartBar();

                const isLoggedIn = /*[[${currentUser != null}]]*/ false;
                // åªæœ‰æœªç™»å…¥æ™‚é¡¯ç¤ºè©¦æŠ½æ¨¡å¼æç¤º
                if (!isLoggedIn) {
                    document.getElementById('trialModeBanner').style.display = 'block';
                    document.getElementById('trialModeBanner').innerHTML = 'âœ¨ ç›®å‰ç‚ºè©¦æŠ½æ¨¡å¼ï¼Œçµæœä¸åˆ—å…¥ç´€éŒ„ã€‚ç«‹å³ç™»å…¥è´å–çœŸå“ï¼';
                } else {
                    document.getElementById('trialModeBanner').style.display = 'none';
                }

                document.getElementById('boxList').style.display = 'none';
                document.getElementById('slotSection').style.display = 'block';
                loadBoxDetails(boxId);
            }

            // è¿”å›ç®±é«”åˆ—è¡¨
            function backToBoxList() {
                currentBoxId = null;
                selectedSlots = [];
                updateCartBar();
                document.getElementById('boxList').style.display = 'grid';
                document.getElementById('slotSection').style.display = 'none';
            }

            // è¼‰å…¥ç®±é«”è©³æƒ…èˆ‡æ ¼å­ç‹€æ…‹
            function loadBoxDetails(boxId) {
                Promise.all([
                    fetch(`/api/ichiban/${boxId}`).then(r => r.json()),
                    fetch(`/api/ichiban/${boxId}/slots`).then(r => r.json())
                ]).then(([boxRes, slotsRes]) => {
                    if (boxRes.success) {
                        const box = boxRes.data;
                        currentBoxData = box; // æš«å­˜ä»¥ä¾¿è©¦æŠ½ä½¿ç”¨
                        document.getElementById('selectedBoxName').textContent = box.name;
                        document.getElementById('selectedBoxDesc').textContent = box.description || '';
                        document.getElementById('pricePerDraw').textContent = box.pricePerDraw;
                        pricePerDraw = parseFloat(box.pricePerDraw);

                        // æ¸²æŸ“çå“ä¸€è¦½
                        if (box.prizes) {
                            const prizeHtml = box.prizes.map(p => {
                                const isSoldOut = p.remainingQuantity === 0;
                                return `
                                    <div class="prize-item ${isSoldOut ? 'sold-out' : ''}" style="text-align: center; border: 1px solid #eee; padding: 10px; border-radius: 10px; position: relative; opacity: ${isSoldOut ? '0.5' : '1'}">
                                        <div style="font-size: 1.5rem; background: #eee; border-radius: 5px; margin-bottom: 5px;">ğŸ</div>
                                        <div style="font-weight: bold; font-size: 0.9rem;">${p.rankDisplay}è³</div>
                                        <div style="font-size: 0.8rem; color: #666; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${p.name}</div>
                                        <div style="font-size: 0.75rem; color: #999; margin-top: 5px;">
                                            ${isSoldOut ? '<span style="color: #e74c3c;">å·²æŠ½å®Œ</span>' : `å‰©é¤˜ ${p.remainingQuantity} / ${p.totalQuantity}`}
                                        </div>
                                    </div>
                                `;
                            }).join('');
                            document.getElementById('prizeList').innerHTML = prizeHtml;
                        }
                    }
                    if (slotsRes.success) {
                        renderSlots(slotsRes.data);
                    }
                }).catch(err => console.error('Error:', err));
            }

            // æ¸²æŸ“æ ¼å­ï¼ˆæ”¯æ´å¤šé¸ï¼‰
            function renderSlots(slots) {
                const html = slots.map(slot => {
                    const isSelected = selectedSlots.includes(slot.slotNumber);
                    let statusClass = slot.status.toLowerCase();
                    let statusText = '';
                    let clickable = false;

                    if (slot.status === 'REVEALED') {
                        statusText = 'å·²é–‹';
                    } else if (slot.status === 'LOCKED' && !slot.isLockExpired) {
                        statusText = 'é–å®šä¸­';
                    } else {
                        statusText = isSelected ? 'å·²é¸' : 'å¯é¸';
                        clickable = true;
                        if (isSelected) statusClass = 'selected';
                        else statusClass = 'available';
                    }

                    return `
                        <div class="ichiban-slot ${statusClass}" 
                             ${clickable ? `onclick="toggleSlot(${slot.slotNumber})"` : ''}
                             style="${isSelected ? 'border: 3px solid #ffd700; box-shadow: 0 0 15px rgba(255,215,0,0.5);' : ''}">
                            <span class="slot-number">${slot.formattedNumber}</span>
                            <span class="slot-status">${statusText}</span>
                        </div>
                    `;
                }).join('');
                document.getElementById('slotGrid').innerHTML = html;
            }

            // åˆ‡æ›æ ¼å­é¸æ“‡ç‹€æ…‹
            function toggleSlot(slotNumber) {
                const index = selectedSlots.indexOf(slotNumber);
                if (index > -1) {
                    selectedSlots.splice(index, 1);
                } else {
                    if (selectedSlots.length >= 10) {
                        alert('å–®æ¬¡æœ€å¤šé¸æ“‡ 10 æ ¼');
                        return;
                    }
                    selectedSlots.push(slotNumber);
                }
                updateCartBar();
                // é‡æ–°æ¸²æŸ“æ ¼å­ä»¥æ›´æ–°é¸ä¸­ç‹€æ…‹
                fetch(`/api/ichiban/${currentBoxId}/slots`)
                    .then(r => r.json())
                    .then(response => {
                        if (response.success) renderSlots(response.data);
                    });
            }

            // æ›´æ–°è³¼ç‰©è»Šåˆ—
            function updateCartBar() {
                const cartBar = document.getElementById('cartBar');
                const purchaseBtn = document.getElementById('purchaseBtnTrigger');
                const isLoggedIn = /*[[${currentUser != null}]]*/ false;
                const count = selectedSlots.length;
                const total = count * pricePerDraw;

                document.getElementById('selectedCount').textContent = count;
                document.getElementById('totalPrice').textContent = '$' + total;

                purchaseBtn.textContent = 'ç¢ºèªè³¼è²· / è©¦æŠ½';
                purchaseBtn.style.background = '#ffd700';
                purchaseBtn.style.color = '#333';

                cartBar.style.display = count > 0 ? 'flex' : 'none';
            }

            // æ¸…é™¤é¸æ“‡
            function clearSelection() {
                selectedSlots = [];
                updateCartBar();
                fetch(`/api/ichiban/${currentBoxId}/slots`)
                    .then(r => r.json())
                    .then(response => {
                        if (response.success) renderSlots(response.data);
                    });
            }

            // ç¢ºèªè³¼è²·
            function confirmPurchase() {
                if (selectedSlots.length === 0) {
                    alert('è«‹è‡³å°‘é¸æ“‡ä¸€å€‹æ ¼å­');
                    return;
                }

                const isLoggedIn = /*[[${currentUser != null}]]*/ false;
                const count = selectedSlots.length;
                const total = count * pricePerDraw;
                const sortedSlots = [...selectedSlots].sort((a, b) => a - b);

                document.getElementById('confirmSlotsCount').textContent = count;
                document.getElementById('confirmPricePerDraw').textContent = pricePerDraw;
                document.getElementById('confirmTotalCost').textContent = '$' + total;

                const modalTitle = document.querySelector('#purchaseModal h3');
                const purchaseBtn = document.getElementById('purchaseBtn');

                // å§‹çµ‚é¡¯ç¤ºå…©å€‹é¸é … (é™¤éæœ‰ç‰¹æ®Šéœ€æ±‚)
                // é€™è£¡æˆ‘å€‘ä¿®æ”¹ Modal HTML ä¾†åŒ…å«å…©å€‹æŒ‰éˆ•
                document.getElementById('purchaseModal').style.display = 'flex';
                document.body.style.overflow = 'hidden';
                if (window.showMask) window.showMask();
            }

            // é—œé–‰è³¼è²·ç¢ºèªå½ˆçª—
            function closePurchaseModal() {
                document.getElementById('purchaseModal').style.display = 'none';
                document.body.style.overflow = 'auto';
                if (window.hideMask) window.hideMask();
            }

            // æ¨¡æ“¬è©¦æŠ½é‚è¼¯ï¼ˆä½¿ç”¨çœŸæ­£çš„è©¦æŠ½ APIï¼‰
            function simulateTrialPurchase() {
                closePurchaseModal();
                if (window.showMask) window.showMask();

                // èª¿ç”¨è©¦æŠ½ API
                fetch(`/api/ichiban/${currentBoxId}/trial`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ count: selectedSlots.length })
                })
                    .then(res => res.json())
                    .then(response => {
                        if (response.success) {
                            const data = response.data;
                            // è½‰æ›æ ¼å¼ä»¥é…åˆç¾æœ‰é¡¯ç¤ºé‚è¼¯
                            const prizes = data.results.map(r => ({
                                slotNumber: r.slotNumber,
                                prize: r.prize,
                                shards: r.shards
                            }));

                            const simulatedData = {
                                prizes: prizes,
                                totalShards: prizes.reduce((sum, p) => sum + p.shards, 0),
                                totalCost: selectedSlots.length * pricePerDraw,
                                isTrial: true
                            };

                            showResultModal(simulatedData);
                            selectedSlots = [];
                            updateCartBar();
                        } else {
                            alert(response.message || 'è©¦æŠ½å¤±æ•—');
                            if (window.hideMask) window.hideMask();
                        }
                    })
                    .catch(err => {
                        console.error('Trial error:', err);
                        alert('è©¦æŠ½å¤±æ•—ï¼Œè«‹é‡è©¦');
                        if (window.hideMask) window.hideMask();
                    });
            }

            // åŸ·è¡Œè³¼è²· (å«è©¦æŠ½æ¨¡æ“¬)
            function executePurchase() {
                const isLoggedIn = /*[[${currentUser != null}]]*/ false;

                if (!isLoggedIn) {
                    simulateTrialPurchase();
                    return;
                }

                const btn = document.getElementById('purchaseBtn');
                btn.disabled = true;
                btn.textContent = 'è™•ç†ä¸­...';

                fetch(`/api/ichiban/${currentBoxId}/purchase`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ slotNumbers: selectedSlots })
                })
                    .then(res => res.json())
                    .then(response => {
                        closePurchaseModal();
                        btn.disabled = false;
                        btn.textContent = 'ç¢ºèªè³¼è²·';

                        if (response.success) {
                            showResultModal(response.data);
                            selectedSlots = [];
                            updateCartBar();
                            loadBoxDetails(currentBoxId);
                        } else {
                            alert(response.message || 'è³¼è²·å¤±æ•—');
                            if (window.hideMask) window.hideMask();
                        }
                    })
                    .catch(err => {
                        console.error('Error:', err);
                        alert('è³¼è²·å¤±æ•—ï¼Œè«‹é‡è©¦');
                        closePurchaseModal();
                        btn.disabled = false;
                        btn.textContent = 'ç¢ºèªè³¼è²·';
                        if (window.hideMask) window.hideMask();
                    });
            }

            // é¡¯ç¤ºé–‹ççµæœï¼ˆå¸¶åˆ®é–‹å‹•ç•«ï¼‰
            function showResultModal(data) {
                const prizes = data.prizes || [];
                if (prizes.length === 0) return;

                // ä½¿ç”¨ GSAP æ­æ›‰å‹•ç•«
                showAdvancedReveal(prizes, data);
            }

            function showAdvancedReveal(prizes, data) {
                if (prizes.length === 0) return;

                let currentIndex = 0;

                function revealNext() {
                    if (currentIndex >= prizes.length) {
                        showFinalSummary(data);
                        return;
                    }

                    const item = prizes[currentIndex];
                    const prize = item.prize || {};
                    const rankDisplay = prize.rankDisplay || '?è³';
                    const prizeName = prize.name || 'ç¥ç§˜çå“';

                    // å»ºç«‹æ’•ç¥¨å®¹å™¨
                    const overlay = document.createElement('div');
                    overlay.className = 'ichiban-ticket-overlay';
                    overlay.innerHTML = `
                        <div class="ticket-wrapper">
                            <div class="ticket-content">
                                <h1 class="ticket-rank-text">${rankDisplay}</h1>
                                <p class="ticket-prize-name">${prizeName}</p>
                                <div style="color: #6c5ce7; font-weight: bold; margin-top: 20px;">+${item.shards} ç¢ç‰‡</div>
                            </div>
                            <div class="ticket-part ticket-top">
                                <span>#${String(item.slotNumber).padStart(2, '0')}</span>
                            </div>
                            <div class="ticket-part ticket-bottom">
                                <span>OPEN</span>
                                <div class="ticket-peek-corner"></div>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(overlay);

                    const top = overlay.querySelector('.ticket-top');
                    const bottom = overlay.querySelector('.ticket-bottom');
                    const content = overlay.querySelector('.ticket-content');

                    // 1. å’ªç‰Œå‹•ç•« (Peek) - åƒ…é‡å° A è³æˆ–å¤§ç
                    const tl = gsap.timeline();

                    if (prize.rank === 'A' || rankDisplay.includes('A')) {
                        tl.to(bottom, { rotationX: -15, duration: 0.5, ease: "power2.out" })
                            .to(bottom, { rotationX: 0, duration: 0.3, ease: "bounce.out", delay: 0.5 });
                    }

                    // 2. æ’•ç¥¨å‹•ç•« (Tear) - é»æ“Šå¾Œè§¸ç™¼
                    overlay.onclick = () => {
                        overlay.onclick = null; // é˜²æ­¢é‡è¤‡é»æ“Š

                        const tearTl = gsap.timeline({
                            onComplete: () => {
                                setTimeout(() => {
                                    gsap.to(overlay, {
                                        opacity: 0, duration: 0.5, onComplete: () => {
                                            overlay.remove();
                                            currentIndex++;
                                            revealNext();
                                        }
                                    });
                                }, 1500);
                            }
                        });

                        if (window.GameUtils && GameUtils.playRevealSound) {
                            GameUtils.playRevealSound();
                        }

                        tearTl.to(top, {
                            y: -200,
                            rotation: -15,
                            opacity: 0,
                            duration: 0.8,
                            ease: "power2.in"
                        }, 0);

                        tearTl.to(bottom, {
                            y: 200,
                            rotation: 15,
                            opacity: 0,
                            duration: 0.8,
                            ease: "power2.in"
                        }, 0);

                        tearTl.from(content, {
                            scale: 0.5,
                            opacity: 0,
                            duration: 0.6,
                            ease: "back.out(1.7)"
                        }, 0.2);

                        // ç…™ç«ç‰¹æ•ˆ
                        if (prize.rank === 'A' || rankDisplay.includes('A')) {
                            if (window.GameUtils && GameUtils.spawnConfetti) {
                                setTimeout(() => GameUtils.spawnConfetti(), 300);
                            }
                        }
                    };
                }

                revealNext();
            }


            // å–®å¼µåˆ®åˆ®å¡æ­æ›‰å‹•ç•«
            function showScratchReveal(item, data) {
                const prize = item.prize || {};
                const rankDisplay = prize.rankDisplay || '?è³';
                const prizeName = prize.name || 'ç¥ç§˜çå“';

                // å»ºç«‹åˆ®é–‹å®¹å™¨
                const container = document.createElement('div');
                container.className = 'scratch-reveal-container';
                container.innerHTML = `
                    <div class="scratch-card">
                        <div class="scratch-card-back">
                            <div class="scratch-card-prize">ğŸ</div>
                            <div style="font-size: 1.5rem;">#${String(item.slotNumber).padStart(2, '0')}</div>
                        </div>
                        <div class="scratch-card-front">
                            <div style="font-size: 1rem; opacity: 0.8;">é»æ“Šåˆ®é–‹</div>
                            <div style="font-size: 4rem; margin: 15px 0;">âœ¨</div>
                            <div style="font-size: 0.9rem;">æ­æ›‰ä½ çš„çå“ï¼</div>
                        </div>
                    </div>
                `;
                document.body.appendChild(container);

                // é»æ“Šåˆ®é–‹
                const front = container.querySelector('.scratch-card-front');
                const back = container.querySelector('.scratch-card-back');

                container.onclick = function () {
                    front.classList.add('revealing');

                    // æ›´æ–°èƒŒé¢å…§å®¹
                    setTimeout(() => {
                        back.innerHTML = `
                            <div class="scratch-card-rank">${rankDisplay}</div>
                            <div class="scratch-card-prize">ğŸ†</div>
                            <div class="scratch-card-name">${prizeName}</div>
                            <div style="margin-top: 15px; color: #ffd93d;">+${item.shards} ç¢ç‰‡</div>
                        `;

                        // è§¸ç™¼ç²’å­çˆ†ç™¼
                        GameUtils.spawnConfetti();

                        // 3ç§’å¾Œé—œé–‰ä¸¦é¡¯ç¤ºç¸½çµ
                        setTimeout(() => {
                            container.remove();
                            showFinalSummary(data);
                        }, 2500);
                    }, 800);
                };
            }

            // å¤šå¼µçå“ä¾åºæ­æ›‰
            function showSequentialReveal(prizes, data) {
                let currentIndex = 0;

                function revealNext() {
                    if (currentIndex >= prizes.length) {
                        showFinalSummary(data);
                        return;
                    }

                    const item = prizes[currentIndex];
                    const prize = item.prize || {};

                    // å¿«é€Ÿé–ƒç¾å¡ç‰‡
                    const flash = document.createElement('div');
                    flash.className = 'scratch-reveal-container';
                    flash.innerHTML = `
                        <div style="text-align: center; color: white;">
                            <div style="font-size: 1.5rem; margin-bottom: 10px;">#${String(item.slotNumber).padStart(2, '0')}</div>
                            <div style="font-size: 3rem; margin-bottom: 15px;">ğŸ</div>
                            <div style="font-size: 2rem; color: var(--gacha-gold); font-weight: bold;">${prize.rankDisplay || '?è³'}</div>
                            <div style="font-size: 1.2rem; margin-top: 10px;">${prize.name || 'ç¥ç§˜çå“'}</div>
                            <div style="color: #a29bfe; margin-top: 5px;">+${item.shards} ç¢ç‰‡</div>
                        </div>
                    `;
                    document.body.appendChild(flash);

                    // æ’­æ”¾å¿«é€ŸéŸ³æ•ˆ
                    GameUtils.playRevealSound();

                    setTimeout(() => {
                        flash.remove();
                        currentIndex++;
                        revealNext();
                    }, 800);
                }

                revealNext();
            }

            // é¡¯ç¤ºæœ€çµ‚ç¸½çµ (å¢åŠ è©¦æŠ½å°å¼•)
            function showFinalSummary(data) {
                const prizes = data.prizes || [];
                const isTrial = data.totalCost > 0 && !data.id; // ç°¡å–®åˆ¤æ–·æ˜¯å¦ç‚ºè©¦æŠ½

                let resultHtml = `
                    <div id="trialWatermark" style="${isTrial ? 'display: block;' : 'display: none;'} background: #6c5ce7; color: white; padding: 5px; border-radius: 5px; margin-bottom: 15px; font-size: 0.9rem;">
                        âš¡ é€™æ˜¯è©¦æŠ½æ¨¡å¼ï¼Œå¿«ç™»å…¥è´å–çœŸå“å§ï¼
                    </div>
                `;

                resultHtml += prizes.map(item => {
                    const prize = item.prize;
                    return `
                        <div style="background: linear-gradient(145deg, #f8f9fa, #e9ecef); border-radius: 15px; padding: 20px; width: 150px; position: relative; overflow: hidden;">
                            <div style="font-size: 1.2rem; font-weight: bold; color: #333; margin-bottom: 10px;">
                                #${String(item.slotNumber).padStart(2, '0')}
                            </div>
                            ${prize ? `
                                <div style="background: var(--gacha-gold); color: #333; padding: 3px 8px; border-radius: 10px; font-size: 0.8rem; display: inline-block; margin-bottom: 8px;">
                                    ${prize.rankDisplay}è³
                                </div>
                                <div style="font-weight: bold; color: #333; height: 40px; overflow: hidden;">${prize.name}</div>
                            ` : '<div style="color: #999;">æœªçŸ¥çå“</div>'}
                            <div style="color: #6c5ce7; font-size: 0.9rem; margin-top: 5px;">+${item.shards} ç¢ç‰‡</div>
                        </div>
                    `;
                }).join('');

                document.getElementById('prizeResults').innerHTML = resultHtml;
                document.getElementById('totalShardsResult').textContent = data.totalShards;
                document.getElementById('totalCostResult').textContent = data.totalCost;

                const summaryBtn = document.querySelector('#resultModal .btn-gacha');
                const isLoggedIn = /*[[${currentUser != null}]]*/ false;

                if (isTrial) {
                    summaryBtn.innerHTML = isLoggedIn ? 'âœ¨ è¿”å›é¸è³¼' : 'ç¢ºå®š';
                    summaryBtn.onclick = closeResult;
                } else {
                    summaryBtn.innerHTML = 'ğŸ“¦ æŸ¥çœ‹æˆ‘çš„çå“ç´€éŒ„';
                    summaryBtn.onclick = () => GameUtils.redirectToHistory();
                }

                document.getElementById('resultModal').style.display = 'flex';
                document.getElementById('resultModal').dataset.isTrial = isTrial;

                if (!isTrial) {
                    spawnConfetti();
                }
            }

            function closeResult() {
                const isTrial = document.getElementById('resultModal').dataset.isTrial === 'true';
                document.getElementById('resultModal').style.display = 'none';
                if (window.hideMask) window.hideMask();

                if (!isTrial) {
                    GameUtils.redirectToHistory();
                } else {
                    location.reload();
                }
            }

            function closePurchaseModal() {
                document.getElementById('purchaseModal').style.display = 'none';
                document.body.style.overflow = 'auto';
                if (window.hideMask) window.hideMask();
            }

            function confirmPurchase() {
                if (selectedSlots.length === 0) {
                    alert('è«‹å…ˆé¸æ“‡è¦è³¼è²·çš„æ ¼å­');
                    return;
                }

                document.getElementById('confirmSlotsCount').textContent = selectedSlots.length;
                document.getElementById('confirmPricePerDraw').textContent = pricePerDraw;
                document.getElementById('confirmTotalCost').textContent = '$' + (selectedSlots.length * pricePerDraw);

                document.getElementById('purchaseModal').style.display = 'flex';
                document.body.style.overflow = 'hidden';
                if (window.showMask) window.showMask();
            }

            // é—œé–‰çµæœå½ˆçª—
            function closeResultModal() {
                document.getElementById('resultModal').style.display = 'none';
                document.body.style.overflow = 'auto';
                if (window.hideMask) window.hideMask();
            }

            // æ¯ 10 ç§’è‡ªå‹•åˆ·æ–°æ ¼å­ç‹€æ…‹ï¼ˆä¿æŒé¸ä¸­ç‹€æ…‹ï¼‰
            setInterval(() => {
                if (currentBoxId) {
                    fetch(`/api/ichiban/${currentBoxId}/slots`)
                        .then(r => r.json())
                        .then(response => {
                            if (response.success) {
                                renderSlots(response.data);
                            }
                        });
                }
            }, 10000);
        </script>
    </div>
    <style>
        .not-logged-in {
            filter: grayscale(0.7);
            opacity: 0.8;
            position: relative;
        }

        .not-logged-in::after {
            content: 'ğŸ”’ ç™»å…¥å¾Œå¯æŠ½ç';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.85rem;
            white-space: nowrap;
            z-index: 10;
        }

        .sold-out {
            background-color: #f8f9fa;
        }
    </style>
</body>

</html>