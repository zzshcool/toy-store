<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<body>
    <!-- Coupons Management Fragment -->
    <div th:fragment="content" id="coupons" class="tab-content" style="display:none;">
        <h3>優惠券管理</h3>
        <div class="card" style="padding: 20px; margin-bottom: 20px;">
            <h4>新增優惠券</h4>
            <form th:action="@{/admin/coupons/create}" method="post">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <input type="text" name="name" placeholder="名稱" class="form-control" required />
                    <input type="text" name="code" placeholder="代碼 (選填)" class="form-control" />
                    <select name="type" class="form-control" required>
                        <option value="DISCOUNT_PERCENT">商品折扣 (折數)</option>
                        <option value="DISCOUNT_AMOUNT">商品購物金 (金額)</option>
                        <option value="MYSTERY_BOX_FREE">抽獎次數 (次)</option>
                    </select>
                    <input type="number" step="0.01" name="value" placeholder="數值 (如 0.9 或 100)" class="form-control"
                        required />
                    <input type="datetime-local" name="validFrom" class="form-control" required title="生效日" />
                    <input type="datetime-local" name="validUntil" class="form-control" required title="到期日" />
                    <input type="text" name="description" placeholder="描述" class="form-control"
                        style="grid-column: span 2;" />
                </div>
                <button type="submit" class="btn btn-primary" style="margin-top: 10px;">建立優惠券</button>
            </form>
        </div>

        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>名稱</th>
                    <th>類型</th>
                    <th>數值</th>
                    <th>有效期</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody>
                <tr th:each="coupon : ${coupons}">
                    <td th:text="${coupon.id}"></td>
                    <td th:text="${coupon.name}"></td>
                    <td th:text="${coupon.type}"></td>
                    <td th:text="${coupon.value}"></td>
                    <td>
                        <span th:text="${#temporals.format(coupon.validFrom, 'yyyy-MM-dd HH:mm')}"></span> ~
                        <span th:text="${#temporals.format(coupon.validUntil, 'yyyy-MM-dd HH:mm')}"></span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-info"
                            th:onclick="openDistributeModal([[${coupon.id}]], '[[${coupon.name}]]')">派發</button>
                    </td>
                </tr>
            </tbody>
        </table>

        <!-- Distribute Modal -->
        <div id="distributeCouponModal" class="modal"
            style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5);">
            <div class="card" style="margin: 10% auto; width: 40%; padding: 20px;">
                <h4 id="distributeTitle">派發優惠券</h4>

                <div style="margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px;">
                    <h5>按等級派發</h5>
                    <form th:action="@{/admin/coupons/distribute/level}" method="post" style="display:flex; gap:10px;">
                        <input type="hidden" id="distCouponIdLevel" name="couponId">
                        <select name="levelId" class="form-control" required>
                            <option value="">選擇等級</option>
                            <option th:each="lvl : ${memberLevels}" th:value="${lvl.id}" th:text="${lvl.name}">
                            </option>
                        </select>
                        <button type="submit" class="btn btn-primary">派發</button>
                    </form>
                </div>

                <div style="margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px;">
                    <h5>📌 按會員標籤派發</h5>
                    <div style="display:flex; gap:10px;">
                        <select id="distTagId" class="form-control" required>
                            <option value="">選擇標籤</option>
                            <!-- 從 API 動態載入 -->
                        </select>
                        <button type="button" class="btn btn-success" onclick="distributeByTag()">批量派發</button>
                    </div>
                    <p id="distTagResult" style="margin-top: 10px; color: #27ae60;"></p>
                </div>

                <div>
                    <h5>按會員ID派發</h5>
                    <form th:action="@{/admin/coupons/distribute/member}" method="post" style="display:flex; gap:10px;">
                        <input type="hidden" id="distCouponIdMember" name="couponId">
                        <input type="number" name="memberId" placeholder="會員ID" class="form-control" required>
                        <button type="submit" class="btn btn-primary">派發</button>
                    </form>
                </div>

                <div style="margin-top: 20px; text-align: right;">
                    <button type="button" class="btn btn-secondary"
                        onclick="document.getElementById('distributeCouponModal').style.display='none'">關閉</button>
                </div>
            </div>
        </div>
    </div>
</body>

</html>