<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="~{admin_layout :: html(title='ÁÆ°ÁêÜÂæåÂè∞', content=~{::content})}">

<body>
    <div th:fragment="content">
        <!-- ÈåØË™§Ë®äÊÅØ -->
        <div th:if="${errorMessage}" class="alert alert-danger"
            style="color: red; padding: 10px; border: 1px solid red; margin-bottom: 10px;">
            <b th:text="${errorMessage}">Error</b>
        </div>

        <!-- History Modal -->
        <div id="historyModal" class="modal"
            style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5);">
            <div class="modal-content"
                style="background: white; margin: 10% auto; padding: 30px; border-radius: 10px; max-width: 600px; position: relative;">
                <span onclick="document.getElementById('historyModal').style.display='none'"
                    style="position: absolute; top: 10px; right: 15px; cursor: pointer; font-size: 24px;">&times;</span>
                <h3 style="margin-bottom: 20px;">üìã ÊúÉÂì°Ë©≥Á¥∞Ë≥áË®ä</h3>
                <div id="historyModalContent">
                    <!-- Content will be loaded dynamically -->
                </div>
            </div>
        </div>

        <!-- Member Management -->
        <div id="members" class="tab-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3 style="margin: 0;">ÊúÉÂì°ÂàóË°®</h3>
                <button class="btn btn-success" onclick="exportMembersCSV()">üì• ÂåØÂá∫ CSV</button>
            </div>
            <table id="members-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>‰ΩøÁî®ËÄÖÂêçÁ®±</th>
                        <th>È§òÈ°ç</th>
                        <th>Á≠âÁ¥ö</th>
                        <th>ÊúÄÂæåÁôªÂÖ•</th>
                        <th>Ë®ªÂÜäÊó•Êúü</th>
                        <th>ÁãÄÊÖã</th>
                        <th>Êìç‰Ωú</th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="member : ${membersPage.content}">
                        <td th:text="${member.id}">1</td>
                        <td th:text="${member.username}">User</td>
                        <td th:text="${member.platformWalletBalance}">1000</td>
                        <td th:text="${member.level != null ? member.level.name : 'Âπ≥Ê∞ë'}">Level</td>
                        <td
                            th:text="${member.lastLoginTime != null ? #temporals.format(member.lastLoginTime, 'yyyy-MM-dd HH:mm') : 'Êú™ÁôªÂÖ•'}">
                            2023-01-01</td>
                        <td
                            th:text="${member.createdAt != null ? #temporals.format(member.createdAt, 'yyyy-MM-dd HH:mm') : '-'}">
                            2023-01-01</td>
                        <td>
                            <span th:class="${member.enabled ? 'badge badge-success' : 'badge badge-danger'}"
                                th:text="${member.enabled ? 'Ê≠£Â∏∏' : 'Â∑≤Â∞ÅÈéñ'}">Ê≠£Â∏∏</span>
                        </td>
                        <td style="display: flex; gap: 5px;">
                            <form th:action="@{/admin/members/{id}/toggle-status(id=${member.id})}" method="post"
                                style="margin:0;">
                                <button type="submit" class="btn btn-sm"
                                    th:classappend="${member.enabled ? 'btn-danger' : 'btn-success'}"
                                    th:text="${member.enabled ? 'Â∞ÅÈéñ' : 'ÂïüÁî®'}">Â∞ÅÈéñ</button>
                            </form>
                            <button class="btn btn-sm btn-info"
                                th:onclick="'showHistory(' + ${member.id} + ')'">Ê≠∑Âè≤Á¥ÄÈåÑ</button>
                            <button class="btn btn-sm btn-primary"
                                th:onclick="editMember([[${member.id}]], '[[${member.email}]]', '[[${member.nickname}]]', [[${member.enabled}]], [[${member.level != null ? member.level.id : ''}]])">Á∑®ËºØ</button>
                        </td>
                    </tr>
                </tbody>
            </table>

            <!-- ÊúÉÂì°ÂàÜÈ†ÅÊéßÂà∂ -->
            <div th:if="${membersPage != null}"
                style="display: flex; justify-content: space-between; align-items: center; margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                <span>ÂÖ± <strong th:text="${membersPage.totalElements}">0</strong> Á≠ÜÔºåÁ¨¨ <strong
                        th:text="${membersPage.number + 1}">1</strong>/<strong
                        th:text="${membersPage.totalPages}">1</strong> È†Å</span>
                <div style="display: flex; gap: 5px;">
                    <a th:if="${membersPage.hasPrevious()}"
                        th:href="@{/admin(memberPage=${membersPage.number - 1}, memberSize=${membersPage.size})}"
                        class="btn btn-sm btn-outline">¬´ ‰∏ä‰∏ÄÈ†Å</a>
                    <a th:if="${membersPage.hasNext()}"
                        th:href="@{/admin(memberPage=${membersPage.number + 1}, memberSize=${membersPage.size})}"
                        class="btn btn-sm btn-outline">‰∏ã‰∏ÄÈ†Å ¬ª</a>
                </div>
            </div>
        </div>

        <!-- Product Management -->
        <div id="products" class="tab-content" style="display:none;">
            <h3>ÂïÜÂìÅÁÆ°ÁêÜ</h3>
            <div class="card" style="padding: 20px; margin-bottom: 20px;">
                <h4>Êñ∞Â¢ûÂïÜÂìÅ</h4>
                <form th:action="@{/admin/products}" method="post" th:object="${newProduct}">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <input type="text" name="name" placeholder="ÂêçÁ®±" class="form-control" required />
                        <input type="number" step="0.01" name="price" placeholder="ÂÉπÊ†º" class="form-control" required />
                        <input type="number" name="stock" placeholder="Â∫´Â≠ò" class="form-control" required />
                        <select id="prodCategory" name="category" class="form-control"
                            onchange="loadSubCats(this.value)" required>
                            <option value="">ÈÅ∏ÊìáÂ§ßÂàÜÈ°û</option>
                            <option th:each="cat : ${categories}" th:value="${cat.id}" th:text="${cat.name}"></option>
                        </select>
                        <select id="prodSubCategory" name="subCategory" class="form-control" required>
                            <option value="">ÈÅ∏ÊìáÂ≠êÂàÜÈ°û</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary" style="margin-top: 10px;">Êñ∞Â¢û</button>
                </form>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>ÂêçÁ®±</th>
                        <th>ÂàÜÈ°û</th>
                        <th>Â≠êÂàÜÈ°û</th>
                        <th>ÂÉπÊ†º</th>
                        <th>Â∫´Â≠ò</th>
                        <th>Êìç‰Ωú</th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="product : ${products}">
                        <td th:text="${product.id}">1</td>
                        <td th:text="${product.name}">Toy</td>
                        <td th:text="${product.category != null ? product.category : '-'}">Cat</td>
                        <td th:text="${product.subCategory != null ? product.subCategory : '-'}">Sub</td>
                        <td th:text="${product.price}">100</td>
                        <td th:text="${product.stock}">10</td>
                        <td style="display: flex; gap: 5px;">
                            <button class="btn btn-sm btn-info" title="Á∑®ËºØ">Á∑®ËºØ</button>
                            <form th:action="@{/admin/products/delete/{id}(id=${product.id})}" method="post"
                                style="display:inline;" onsubmit="return confirm('Á¢∫ÂÆöÂà™Èô§Ôºü');">
                                <button type="submit" class="btn btn-sm btn-danger" title="Âà™Èô§">Âà™Èô§</button>
                            </form>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Member Level Management -->
        <div id="levels" class="tab-content" style="display:none;">
            <h3>ÊúÉÂì°Á≠âÁ¥öÁÆ°ÁêÜ</h3>
            <div class="card" style="padding: 20px; margin-bottom: 20px;">
                <h4>Êñ∞Â¢ûÁ≠âÁ¥ö</h4>
                <form th:action="@{/admin/member-levels}" method="post">
                    <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px;">
                        <input type="text" name="name" placeholder="Á≠âÁ¥öÂêçÁ®±" class="form-control" required />
                        <input type="number" name="sortOrder" placeholder="ÊéíÂ∫è (1=ÊúÄ‰Ωé)" class="form-control" required />
                        <input type="number" step="0.01" name="threshold" placeholder="Á¥ØÁ©çÂÑ≤ÂÄºÈñÄÊ™ª" class="form-control"
                            required />
                        <input type="text" name="monthlyReward" placeholder="ÊØèÊúàÁçéÂãµ" class="form-control" />
                        <button type="submit" class="btn btn-primary">Êñ∞Â¢û</button>
                    </div>
                </form>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>ÊéíÂ∫è</th>
                        <th>ÂêçÁ®±</th>
                        <th>ÈñÄÊ™ª</th>
                        <th>ÊØèÊúàÁçéÂãµ</th>
                        <th>ÁãÄÊÖã</th>
                        <th>Êìç‰Ωú</th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="lvl : ${memberLevels}">
                        <td th:text="${lvl.sortOrder}">1</td>
                        <td th:text="${lvl.name}">Common</td>
                        <td th:text="${lvl.threshold}">0</td>
                        <td th:text="${lvl.monthlyReward}">-</td>
                        <td th:text="${lvl.enabled ? 'ÂïüÁî®' : 'ÂÅúÁî®'}">Active</td>
                        <td>
                            <button class="btn btn-sm btn-info"
                                th:onclick="editLevel([[${lvl.id}]], '[[${lvl.name}]]', [[${lvl.sortOrder}]], [[${lvl.threshold}]], '[[${lvl.monthlyReward}]]', [[${lvl.enabled}]])">‚úèÔ∏è</button>
                            <form th:action="@{/admin/member-levels/delete/{id}(id=${lvl.id})}" method="post"
                                style="display:inline;" onsubmit="return confirm('Á¢∫ÂÆöÂà™Èô§Á≠âÁ¥öÔºü');">
                                <button type="submit" style="background:none;border:none;cursor:pointer;"
                                    title="Âà™Èô§">üóëÔ∏è</button>
                            </form>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Category Management -->
        <div id="categories" class="tab-content" style="display:none;">
            <h3>ÂàÜÈ°ûÁÆ°ÁêÜ</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div class="card">
                    <h4>ÂàÜÈ°ûÂàóË°®</h4>
                    <ul style="list-style-type: none; padding-left: 0;">
                        <li th:each="cat : ${categories}"
                            style="margin-bottom: 10px; border: 1px solid #ddd; padding: 10px; border-radius: 5px;">
                            <div
                                style="display: flex; justify-content: space-between; align-items: center; background: #f0f0f0; padding: 5px;">
                                <strong th:text="${cat.name}">Category</strong>
                                <div>
                                    <button class="btn btn-sm btn-info"
                                        th:onclick="editCategory([[${cat.id}]], '[[${cat.name}]]')">‚úèÔ∏è</button>
                                    <form th:action="@{/admin/categories/delete/{id}(id=${cat.id})}" method="post"
                                        style="display:inline;" onsubmit="return confirm('Âà™Èô§‰∏ªÂàÜÈ°ûÂ∞áÈÄ£ÂêåÂ≠êÂàÜÈ°û‰∏ÄËµ∑Âà™Èô§ÔºåÁ¢∫ÂÆöÔºü');">
                                        <button type="submit" style="background:none;border:none;cursor:pointer;"
                                            title="Âà™Èô§">üóëÔ∏è</button>
                                    </form>
                                </div>
                            </div>
                            <ul style="margin-top: 5px; padding-left: 20px;">
                                <li th:each="sub : ${cat.subCategories}"
                                    style="display: flex; justify-content: space-between; border-bottom: 1px solid #eee;">
                                    <span th:text="${sub.name}">Sub</span>
                                    <div>
                                        <button class="btn btn-sm" style="font-size:0.8em;"
                                            th:onclick="editSubCategory([[${sub.id}]], '[[${sub.name}]]')">‚úèÔ∏è</button>
                                        <form th:action="@{/admin/subcategories/delete/{id}(id=${sub.id})}"
                                            method="post" style="display:inline;"
                                            onsubmit="return confirm('Á¢∫ÂÆöÂà™Èô§Â≠êÂàÜÈ°ûÔºü');">
                                            <button type="submit"
                                                style="font-size:0.8em;background:none;border:none;cursor:pointer;"
                                                title="Âà™Èô§">üóëÔ∏è</button>
                                        </form>
                                    </div>
                                </li>
                            </ul>
                        </li>
                    </ul>
                </div>
                <div class="card">
                    <h4>Êñ∞Â¢ûÂàÜÈ°û</h4>
                    <form th:action="@{/admin/categories}" method="post" style="margin-bottom: 20px;">
                        <div style="display: flex; gap: 5px;">
                            <input type="text" name="name" placeholder="Â§ßÂàÜÈ°ûÂêçÁ®±" class="form-control" required>
                            <button type="submit" class="btn btn-primary">Êñ∞Â¢ûÂ§ßÂàÜÈ°û</button>
                        </div>
                    </form>

                    <h4>Êñ∞Â¢ûÂ≠êÂàÜÈ°û</h4>
                    <form th:action="@{/admin/subcategories}" method="post">
                        <div style="display: flex; gap: 5px;">
                            <select name="categoryId" class="form-control" required>
                                <option value="">ÈÅ∏ÊìáÊâÄÂ±¨Â§ßÂàÜÈ°û</option>
                                <option th:each="cat : ${categories}" th:value="${cat.id}" th:text="${cat.name}">
                                </option>
                            </select>
                            <input type="text" name="name" placeholder="Â≠êÂàÜÈ°ûÂêçÁ®±" class="form-control" required>
                            <button type="submit" class="btn btn-primary">Êñ∞Â¢û</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Category Edit Modal -->
            <div id="editCategoryModal" class="modal"
                style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5);">
                <div class="card" style="margin: 15% auto; width: 30%; padding: 20px;">
                    <h4>Á∑®ËºØÂàÜÈ°û</h4>
                    <form th:action="@{/admin/categories/update}" method="post">
                        <input type="hidden" id="editCatId" name="id">
                        <input type="text" id="editCatName" name="name" class="form-control" required>
                        <div style="margin-top: 10px; display: flex; justify-content: flex-end; gap: 10px;">
                            <button type="button" class="btn btn-secondary"
                                onclick="document.getElementById('editCategoryModal').style.display='none'">ÂèñÊ∂à</button>
                            <button type="submit" class="btn btn-primary">ÂÑ≤Â≠ò</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- SubCategory Edit Modal -->
            <div id="editSubCategoryModal" class="modal"
                style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5);">
                <div class="card" style="margin: 15% auto; width: 30%; padding: 20px;">
                    <h4>Á∑®ËºØÂ≠êÂàÜÈ°û</h4>
                    <form th:action="@{/admin/subcategories/update}" method="post">
                        <input type="hidden" id="editSubCatId" name="id">
                        <input type="text" id="editSubCatName" name="name" class="form-control" required>
                        <div style="margin-top: 10px; display: flex; justify-content: flex-end; gap: 10px;">
                            <button type="button" class="btn btn-secondary"
                                onclick="document.getElementById('editSubCategoryModal').style.display='none'">ÂèñÊ∂à</button>
                            <button type="submit" class="btn btn-primary">ÂÑ≤Â≠ò</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Mystery Box Management -->
        <div id="mystery" class="tab-content" style="display:none;">
            <h3>Êâ≠ËõãÁÆ°ÁêÜ</h3>
            <div class="card" style="padding: 20px; margin-bottom: 20px;">
                <h4>Êñ∞Â¢û‰∏ªÈ°å</h4>
                <!-- Theme Form -->
                <form th:action="@{/admin/gacha/themes}" method="post">
                    <div style="display: flex; gap: 10px;">
                        <input type="text" name="name" placeholder="‰∏ªÈ°åÂêçÁ®±" class="form-control" required />
                        <input type="number" step="0.01" name="price" placeholder="ÂÉπÊ†º" class="form-control" required />
                        <button type="submit" class="btn btn-primary">Êñ∞Â¢û‰∏ªÈ°å</button>
                    </div>
                </form>
            </div>

            <div th:each="theme : ${gachaThemes}" class="card" style="margin-bottom: 20px;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h4 th:text="${theme.name} + ' ($' + ${theme.price} + ')'">Gundam ($100)</h4>
                    <button class="btn btn-sm btn-info"
                        th:onclick="editTheme([[${theme.id}]], '[[${theme.name}]]', [[${theme.price}]])">Á∑®ËºØ‰∏ªÈ°å</button>

                    <form th:action="@{/admin/gacha/themes/delete/{id}(id=${theme.id})}" method="post"
                        style="display:inline;" onsubmit="return confirm('Âà™Èô§‰∏ªÈ°åÂ∞áÈÄ£ÂêåÁçéÂìÅ‰∏ÄËµ∑Âà™Èô§ÔºåÁ¢∫ÂÆöÔºü');">
                        <button type="submit" class="btn btn-sm btn-danger">Âà™Èô§‰∏ªÈ°å</button>
                    </form>
                </div>

                <!-- Add Item to Theme -->
                <form th:action="@{/admin/gacha/items}" method="post"
                    style="margin-bottom: 10px; background: #f9f9f9; padding: 10px;">
                    <input type="hidden" name="themeId" th:value="${theme.id}">
                    <div style="display: flex; gap: 5px;">
                        <input type="text" name="name" placeholder="ÁçéÂìÅÂêçÁ®±" class="form-control" required>
                        <input type="number" name="estimatedValue" placeholder="ÂÉπÂÄº" class="form-control" required>
                        <input type="number" name="weight" placeholder="Ê¨äÈáç(%)" class="form-control" required>
                        <button type="submit" class="btn btn-sm btn-secondary">Êñ∞Â¢ûÁçéÂìÅ</button>
                    </div>
                </form>

                <table>
                    <thead>
                        <tr>
                            <th>ÁçéÂìÅÂêçÁ®±</th>
                            <th>ÂÉπÂÄº</th>
                            <th>Ê¨äÈáç</th>
                            <th>Êìç‰Ωú</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="item : ${theme.items}">
                            <td th:text="${item.name}">Item</td>
                            <td th:text="${item.estimatedValue}">50</td>
                            <td th:text="${item.weight}">20</td>
                            <td>
                                <button class="btn btn-sm btn-info"
                                    th:onclick="editBoxItem([[${item.id}]], '[[${item.name}]]', [[${item.estimatedValue}]], [[${item.weight}]])">‚úèÔ∏è</button>
                                <form th:action="@{/admin/gacha/items/delete/{id}(id=${item.id})}" method="post"
                                    style="display:inline;" onsubmit="return confirm('Á¢∫ÂÆöÂà™Èô§ÁçéÂìÅÔºü');">
                                    <button type="submit" style="background:none;border:none;cursor:pointer;"
                                        title="Âà™Èô§">üóëÔ∏è</button>
                                </form>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Edit Theme Modal -->
            <div id="editThemeModal" class="modal"
                style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5);">
                <div class="card" style="margin: 15% auto; width: 30%; padding: 20px;">
                    <h4>Á∑®ËºØ‰∏ªÈ°å</h4>
                    <form th:action="@{/admin/gacha/themes/update}" method="post">
                        <input type="hidden" id="editThemeId" name="id">
                        <input type="text" id="editThemeName" name="name" class="form-control" placeholder="ÂêçÁ®±"
                            required>
                        <input type="number" step="0.01" id="editThemePrice" name="price" class="form-control"
                            placeholder="ÂÉπÊ†º" required>
                        <div style="margin-top: 10px; display: flex; justify-content: flex-end; gap: 10px;">
                            <button type="button" class="btn btn-secondary"
                                onclick="document.getElementById('editThemeModal').style.display='none'">ÂèñÊ∂à</button>
                            <button type="submit" class="btn btn-primary">ÂÑ≤Â≠ò</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Edit Box Item Modal -->
            <div id="editBoxItemModal" class="modal"
                style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5);">
                <div class="card" style="margin: 15% auto; width: 30%; padding: 20px;">
                    <h4>Á∑®ËºØÁçéÂìÅ</h4>
                    <form th:action="@{/admin/gacha/items/update}" method="post">
                        <input type="hidden" id="editBoxItemId" name="id">
                        <input type="text" id="editBoxItemName" name="name" class="form-control" placeholder="ÂêçÁ®±"
                            required>
                        <input type="number" id="editBoxItemValue" name="estimatedValue" class="form-control"
                            placeholder="ÂÉπÂÄº" required>
                        <input type="number" id="editBoxItemWeight" name="weight" class="form-control" placeholder="Ê¨äÈáç"
                            required>
                        <div style="margin-top: 10px; display: flex; justify-content: flex-end; gap: 10px;">
                            <button type="button" class="btn btn-secondary"
                                onclick="document.getElementById('editBoxItemModal').style.display='none'">ÂèñÊ∂à</button>
                            <button type="submit" class="btn btn-primary">ÂÑ≤Â≠ò</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Transaction Management -->
        <div id="transactions" class="tab-content" style="display:none;">
            <h3>‰∫§ÊòìÁ¥ÄÈåÑ</h3>
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>ÊúÉÂì°</th>
                        <th>È°ûÂûã</th>
                        <th>ÈáëÈ°ç</th>
                        <th>ÊèèËø∞</th>
                        <th>ÊôÇÈñì</th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="tx : ${transactionsPage.content}">
                        <td th:text="${tx.id}">1</td>
                        <td th:text="${tx.member != null ? tx.member.username : 'Unknown'}">User</td>
                        <td th:text="${tx.type}">PURCHASE</td>
                        <td th:text="${tx.amount}" th:style="${tx.amount > 0 ? 'color:green' : 'color:red'}">100</td>
                        <td th:text="${tx.description}">Desc</td>
                        <td th:text="${#temporals.format(tx.timestamp, 'yyyy-MM-dd HH:mm')}">Time</td>
                    </tr>
                </tbody>
            </table>

            <!-- ‰∫§ÊòìÂàÜÈ†ÅÊéßÂà∂ -->
            <div th:if="${transactionsPage != null}"
                style="display: flex; justify-content: space-between; align-items: center; margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                <span>ÂÖ± <strong th:text="${transactionsPage.totalElements}">0</strong> Á≠ÜÔºåÁ¨¨ <strong
                        th:text="${transactionsPage.number + 1}">1</strong>/<strong
                        th:text="${transactionsPage.totalPages}">1</strong> È†Å</span>
                <div style="display: flex; gap: 5px;">
                    <a th:if="${transactionsPage.hasPrevious()}"
                        th:href="@{/admin(txPage=${transactionsPage.number - 1}, txSize=${transactionsPage.size})}"
                        class="btn btn-sm btn-outline">¬´ ‰∏ä‰∏ÄÈ†Å</a>
                    <a th:if="${transactionsPage.hasNext()}"
                        th:href="@{/admin(txPage=${transactionsPage.number + 1}, txSize=${transactionsPage.size})}"
                        class="btn btn-sm btn-outline">‰∏ã‰∏ÄÈ†Å ¬ª</a>
                </div>
            </div>
        </div>

        <!-- Activity Management -->
        <div id="activities" class="tab-content" style="display:none;">
            <h3>Ê¥ªÂãïÁÆ°ÁêÜ</h3>
            <div class="card" style="padding: 20px; margin-bottom: 20px;">
                <h4>Êñ∞Â¢ûÊ¥ªÂãï</h4>
                <form th:action="@{/admin/activities}" method="post" th:object="${newActivity}">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <input type="text" name="title" placeholder="Ê®ôÈ°å" class="form-control" required />
                        <input type="text" name="type" placeholder="È°ûÂûã (‰æãÂ¶Ç: SALE)" class="form-control" required />
                        <input type="datetime-local" name="startDate" class="form-control" placeholder="ÈñãÂßãÊôÇÈñì" />
                        <input type="datetime-local" name="expiryDate" class="form-control" placeholder="ÁµêÊùüÊôÇÈñì" />
                        <input type="text" name="imageUrl" placeholder="ÂúñÁâá URL" class="form-control" />
                        <textarea name="description" placeholder="ÂÖßÂÆπ" class="form-control"
                            style="grid-column: span 2"></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary" style="margin-top: 10px;">Êñ∞Â¢û</button>
                </form>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Ê®ôÈ°å</th>
                        <th>È°ûÂûã</th>
                        <th>ÈñãÂßãÊôÇÈñì</th>
                        <th>ÁµêÊùüÊôÇÈñì</th>
                        <th>ÁãÄÊÖã</th>
                        <th>Êìç‰Ωú</th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="act : ${activities}">
                        <td th:text="${act.title}">Title</td>
                        <td th:text="${act.type}">SALE</td>
                        <td
                            th:text="${act.startDate != null ? #temporals.format(act.startDate, 'yyyy-MM-dd HH:mm') : '-'}">
                            Start</td>
                        <td
                            th:text="${act.expiryDate != null ? #temporals.format(act.expiryDate, 'yyyy-MM-dd HH:mm') : '-'}">
                            End</td>
                        <td>
                            <form th:action="@{/admin/activities/toggle/{id}(id=${act.id})}" method="post"
                                style="margin:0;"
                                onsubmit="if(![[${act.active}]]) return true; return confirm('Á¢∫ÂÆöË¶ÅÈóúÈñâÊ¥ªÂãïÂóéÔºü');">
                                <button type="submit" class="btn btn-sm"
                                    th:classappend="${act.active ? 'btn-success' : 'btn-secondary'}"
                                    th:text="${act.active ? 'ÂïüÁî®' : 'ÂÅúÁî®'}">Active</button>
                            </form>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-info"
                                th:onclick="editActivity([[${act.id}]], '[[${act.title}]]', '[[${act.description}]]', '[[${act.type}]]', '[[${act.startDate}]]', '[[${act.expiryDate}]]')">‚úèÔ∏è</button>
                            <form th:action="@{/admin/activities/delete/{id}(id=${act.id})}" method="post"
                                style="display:inline;" onsubmit="return confirm('Á¢∫ÂÆöÂà™Èô§Ôºü');">
                                <button type="submit" style="background:none;border:none;cursor:pointer;"
                                    title="Âà™Èô§">üóëÔ∏è</button>
                            </form>
                        </td>
                    </tr>
                </tbody>
            </table>

            <!-- Edit Activity Modal -->
            <div id="editActivityModal" class="modal"
                style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5);">
                <div class="card" style="margin: 10% auto; width: 50%; padding: 20px;">
                    <h4>Á∑®ËºØÊ¥ªÂãï</h4>
                    <form th:action="@{/admin/activities/update}" method="post">
                        <input type="hidden" id="editActId" name="id">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <input type="text" id="editActTitle" name="title" placeholder="Ê®ôÈ°å" class="form-control"
                                required />
                            <input type="text" id="editActType" name="type" placeholder="È°ûÂûã" class="form-control"
                                required />
                            <input type="datetime-local" id="editActStart" name="startDate" class="form-control"
                                placeholder="ÈñãÂßãÊôÇÈñì" />
                            <input type="datetime-local" id="editActEnd" name="expiryDate" class="form-control"
                                placeholder="ÁµêÊùüÊôÇÈñì" />
                            <textarea id="editActDesc" name="description" placeholder="ÂÖßÂÆπ" class="form-control"
                                style="grid-column: span 2"></textarea>
                        </div>
                        <div style="margin-top: 10px; display: flex; justify-content: flex-end; gap: 10px;">
                            <button type="button" class="btn btn-secondary"
                                onclick="document.getElementById('editActivityModal').style.display='none'">ÂèñÊ∂à</button>
                            <button type="submit" class="btn btn-primary">ÂÑ≤Â≠ò</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Coupon Management -->
        <div id="coupons" class="tab-content" style="display:none;">
            <h3>ÂÑ™ÊÉ†Âà∏ÁÆ°ÁêÜ</h3>
            <div class="card" style="padding: 20px; margin-bottom: 20px;">
                <h4>Êñ∞Â¢ûÂÑ™ÊÉ†Âà∏</h4>
                <form th:action="@{/admin/coupons/create}" method="post">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <input type="text" name="name" placeholder="ÂêçÁ®±" class="form-control" required />
                        <input type="text" name="code" placeholder="‰ª£Á¢º (ÈÅ∏Â°´)" class="form-control" />
                        <select name="type" class="form-control" required>
                            <option value="DISCOUNT_PERCENT">ÂïÜÂìÅÊäòÊâ£ (ÊäòÊï∏)</option>
                            <option value="DISCOUNT_AMOUNT">ÂïÜÂìÅË≥ºÁâ©Èáë (ÈáëÈ°ç)</option>
                            <option value="MYSTERY_BOX_FREE">ÊäΩÁçéÊ¨°Êï∏ (Ê¨°)</option>
                        </select>
                        <input type="number" step="0.01" name="value" placeholder="Êï∏ÂÄº (Â¶Ç 0.9 Êàñ 100)"
                            class="form-control" required />
                        <input type="datetime-local" name="validFrom" class="form-control" required title="ÁîüÊïàÊó•" />
                        <input type="datetime-local" name="validUntil" class="form-control" required title="Âà∞ÊúüÊó•" />
                        <input type="text" name="description" placeholder="ÊèèËø∞" class="form-control"
                            style="grid-column: span 2;" />
                    </div>
                    <button type="submit" class="btn btn-primary" style="margin-top: 10px;">Âª∫Á´ãÂÑ™ÊÉ†Âà∏</button>
                </form>
            </div>

            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>ÂêçÁ®±</th>
                        <th>È°ûÂûã</th>
                        <th>Êï∏ÂÄº</th>
                        <th>ÊúâÊïàÊúü</th>
                        <th>Êìç‰Ωú</th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="coupon : ${coupons}">
                        <td th:text="${coupon.id}"></td>
                        <td th:text="${coupon.name}"></td>
                        <td th:text="${coupon.type}"></td>
                        <td th:text="${coupon.value}"></td>
                        <td>
                            <span th:text="${#temporals.format(coupon.validFrom, 'yyyy-MM-dd HH:mm')}"></span> ~
                            <span th:text="${#temporals.format(coupon.validUntil, 'yyyy-MM-dd HH:mm')}"></span>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-info"
                                th:onclick="openDistributeModal([[${coupon.id}]], '[[${coupon.name}]]')">Ê¥æÁôº</button>
                        </td>
                    </tr>
                </tbody>
            </table>

            <!-- Distribute Modal -->
            <div id="distributeCouponModal" class="modal"
                style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5);">
                <div class="card" style="margin: 10% auto; width: 40%; padding: 20px;">
                    <h4 id="distributeTitle">Ê¥æÁôºÂÑ™ÊÉ†Âà∏</h4>

                    <div style="margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px;">
                        <h5>ÊåâÁ≠âÁ¥öÊ¥æÁôº</h5>
                        <form th:action="@{/admin/coupons/distribute/level}" method="post"
                            style="display:flex; gap:10px;">
                            <input type="hidden" id="distCouponIdLevel" name="couponId">
                            <select name="levelId" class="form-control" required>
                                <option value="">ÈÅ∏ÊìáÁ≠âÁ¥ö</option>
                                <option th:each="lvl : ${memberLevels}" th:value="${lvl.id}" th:text="${lvl.name}">
                                </option>
                            </select>
                            <button type="submit" class="btn btn-primary">Ê¥æÁôº</button>
                        </form>
                    </div>

                    <div style="margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px;">
                        <h5>üìå ÊåâÊúÉÂì°Ê®ôÁ±§Ê¥æÁôº</h5>
                        <div style="display:flex; gap:10px;">
                            <select id="distTagId" class="form-control" required>
                                <option value="">ÈÅ∏ÊìáÊ®ôÁ±§</option>
                                <!-- Âæû API ÂãïÊÖãËºâÂÖ• -->
                            </select>
                            <button type="button" class="btn btn-success" onclick="distributeByTag()">ÊâπÈáèÊ¥æÁôº</button>
                        </div>
                        <p id="distTagResult" style="margin-top: 10px; color: #27ae60;"></p>
                    </div>

                    <div>
                        <h5>ÊåâÊúÉÂì°IDÊ¥æÁôº</h5>
                        <form th:action="@{/admin/coupons/distribute/member}" method="post"
                            style="display:flex; gap:10px;">
                            <input type="hidden" id="distCouponIdMember" name="couponId">
                            <input type="number" name="memberId" placeholder="ÊúÉÂì°ID" class="form-control" required>
                            <button type="submit" class="btn btn-primary">Ê¥æÁôº</button>
                        </form>
                    </div>

                    <div style="margin-top: 20px; text-align: right;">
                        <button type="button" class="btn btn-secondary"
                            onclick="document.getElementById('distributeCouponModal').style.display='none'">ÈóúÈñâ</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- [Â∑≤Êï¥ÂêàÂà∞Êñ∞Áâà platform TabÔºå‰ª•‰∏ãËàäÁâàÂèØÂà™Èô§] -->
        <div id="platform-old" class="tab-content" style="display:none;">
            <h3>Âπ≥Âè∞ÁÆ°ÁêÜ (ËàäÁâà)</h3>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <!-- Carousel Management -->
                <div class="card" style="grid-column: span 2;">
                    <div class="card-header bg-info text-white">‰∏ªÁï´Èù¢Ëº™Êí≠</div>
                    <div class="card-body">
                        <form id="form-carousel-create" th:action="@{/admin/platform/carousel/create}" method="post"
                            class="row g-3">
                            <div class="col-md-5">
                                <input type="text" name="imageUrl" class="form-control" placeholder="ÂúñÁâáÁ∂≤ÂùÄ" required>
                            </div>
                            <div class="col-md-5">
                                <input type="text" name="linkUrl" class="form-control" placeholder="ÈÄ£ÁµêÁ∂≤ÂùÄ (ÈÅ∏Â°´)">
                            </div>
                            <div class="col-md-2">
                                <button type="submit" class="btn btn-primary w-100">Êñ∞Â¢û</button>
                            </div>
                        </form>
                        <table class="table mt-3">
                            <thead>
                                <tr>
                                    <th>ÂúñÁâá</th>
                                    <th>ÈÄ£Áµê</th>
                                    <th>Êìç‰Ωú</th>
                                </tr>
                            </thead>
                            <tbody id="tbody-carousel">
                                <tr th:each="slide : ${carouselSlides}">
                                    <td><img th:src="${slide.imageUrl}" style="height: 50px;"></td>
                                    <td th:text="${slide.linkUrl}"></td>
                                    <td>
                                        <button class="btn btn-sm btn-danger btn-delete-carousel"
                                            th:data-id="${slide.id}">Âà™Èô§</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- New Arrivals Management -->
                <div class="card">
                    <div class="card-header bg-success text-white">Êñ∞ÂìÅÈ†ÖÁõÆ (New Arrivals)</div>
                    <div class="card-body">
                        <form id="form-new-arrival" th:action="@{/admin/platform/featured/add}" method="post"
                            class="row g-3">
                            <input type="hidden" name="type" value="NEW_ARRIVAL">
                            <div class="col-md-8">
                                <select name="productId" class="form-control" required>
                                    <option value="">ÈÅ∏ÊìáÂïÜÂìÅ</option>
                                    <option th:each="prod : ${products}" th:value="${prod.id}" th:text="${prod.name}">
                                    </option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <input type="number" name="sortOrder" class="form-control" placeholder="ÊéíÂ∫è" value="0">
                            </div>
                            <div class="col-md-2">
                                <button type="submit" class="btn btn-primary w-100">Êñ∞Â¢û</button>
                            </div>
                        </form>
                        <table class="table mt-3">
                            <thead>
                                <tr>
                                    <th>ÂïÜÂìÅÂêçÁ®±</th>
                                    <th>ÊéíÂ∫è</th>
                                    <th>Êìç‰Ωú</th>
                                </tr>
                            </thead>
                            <tbody id="tbody-new-arrival">
                                <tr th:each="item : ${newArrivals}">
                                    <td th:text="${item.product.name}"></td>
                                    <td th:text="${item.sortOrder}"></td>
                                    <td>
                                        <button class="btn btn-sm btn-danger btn-delete-featured"
                                            th:data-id="${item.id}">ÁßªÈô§</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Best Sellers Management -->
                <div class="card">
                    <div class="card-header bg-warning text-dark">ÁÜ±Èä∑ÊéíË°åÊ¶ú (Best Sellers)</div>
                    <div class="card-body">
                        <form id="form-best-seller" th:action="@{/admin/platform/featured/add}" method="post"
                            class="row g-3">
                            <input type="hidden" name="type" value="BEST_SELLER">
                            <div class="col-md-8">
                                <select name="productId" class="form-control" required>
                                    <option value="">ÈÅ∏ÊìáÂïÜÂìÅ</option>
                                    <option th:each="prod : ${products}" th:value="${prod.id}" th:text="${prod.name}">
                                    </option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <input type="number" name="sortOrder" class="form-control" placeholder="ÊéíÂ∫è" value="0">
                            </div>
                            <div class="col-md-2">
                                <button type="submit" class="btn btn-primary w-100">Êñ∞Â¢û</button>
                            </div>
                        </form>
                        <table class="table mt-3">
                            <thead>
                                <tr>
                                    <th>ÂïÜÂìÅÂêçÁ®±</th>
                                    <th>ÊéíÂ∫è</th>
                                    <th>Êìç‰Ωú</th>
                                </tr>
                            </thead>
                            <tbody id="tbody-best-seller">
                                <tr th:each="item : ${bestSellers}">
                                    <td th:text="${item.product.name}"></td>
                                    <td th:text="${item.sortOrder}"></td>
                                    <td>
                                        <button class="btn btn-sm btn-danger btn-delete-featured"
                                            th:data-id="${item.id}">ÁßªÈô§</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Push Notifications -->
                <div class="card" style="grid-column: span 2;">
                    <div class="card-header bg-danger text-white">ÂèäÊôÇÊé®ÈÄÅ (Push Notifications)</div>
                    <div class="card-body">
                        <form id="form-notification" th:action="@{/admin/platform/notification/send}" method="post">
                            <div class="mb-3">
                                <label>Ê®ôÈ°å</label>
                                <input type="text" name="title" class="form-control" required>
                            </div>
                            <div class="mb-3">
                                <label>ÂÖßÂÆπ</label>
                                <textarea name="content" class="form-control" rows="3" required></textarea>
                            </div>
                            <button type="submit" class="btn btn-primary">ÁôºÈÄÅÈÄöÁü•</button>
                        </form>

                        <h5 class="mt-4">Ê≠∑Âè≤Á¥ÄÈåÑ</h5>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>ÊôÇÈñì</th>
                                    <th>Ê®ôÈ°å</th>
                                    <th>ÂÖßÂÆπ</th>
                                </tr>
                            </thead>
                            <tbody id="tbody-notification">
                                <tr th:each="notif : ${notifications}">
                                    <td th:text="${#temporals.format(notif.createdAt, 'yyyy-MM-dd HH:mm')}"></td>
                                    <td th:text="${notif.title}"></td>
                                    <td th:text="${notif.content}"></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

            </div>
        </div>

        <!-- Logs -->
        <div id="logs" class="tab-content" style="display:none;">
            <h3>Êìç‰ΩúÊó•Ë™å</h3>

            <!-- ÊêúÂ∞ãÈÅéÊøæÂçÄ -->
            <div class="card" style="padding: 15px; margin-bottom: 20px;">
                <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: end;">
                    <div>
                        <label>Êìç‰ΩúËÄÖ</label>
                        <input type="text" id="log-search-user" placeholder="ÊêúÂ∞ãÊìç‰ΩúËÄÖ" class="form-control"
                            style="width: 150px;">
                    </div>
                    <div>
                        <label>Âãï‰ΩúÈ°ûÂûã</label>
                        <select id="log-filter-action" class="form-control" style="width: 150px;">
                            <option value="">ÂÖ®ÈÉ®</option>
                            <option value="LOGIN">ÁôªÂÖ•</option>
                            <option value="CREATE">Âª∫Á´ã</option>
                            <option value="UPDATE">Êõ¥Êñ∞</option>
                            <option value="DELETE">Âà™Èô§</option>
                        </select>
                    </div>
                    <div>
                        <label>Êó•ÊúüÁØÑÂúç</label>
                        <input type="date" id="log-date-from" class="form-control" style="width: 140px;">
                    </div>
                    <div>
                        <label style="visibility: hidden;">-</label>
                        <input type="date" id="log-date-to" class="form-control" style="width: 140px;">
                    </div>
                    <button class="btn btn-primary" onclick="filterLogs()">ÊêúÂ∞ã</button>
                    <button class="btn btn-outline" onclick="clearLogFilters()">Ê∏ÖÈô§</button>
                </div>
            </div>

            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Êìç‰ΩúËÄÖ</th>
                        <th>Âãï‰Ωú</th>
                        <th>Ë©≥ÊÉÖ</th>
                        <th>Ë´ãÊ±ÇÂèÉÊï∏</th>
                        <th>ÊôÇÈñì</th>
                    </tr>
                </thead>
                <tbody id="logs-table-body">
                    <tr th:each="log : ${logs}">
                        <td th:text="${log.id}">1</td>
                        <td th:text="${log.adminUsername}">User</td>
                        <td th:text="${log.action}">LOGIN</td>
                        <td th:text="${log.details}">Success</td>
                        <td th:text="${log.requestParams}"
                            style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;"
                            title="${log.requestParams}">Params</td>
                        <td
                            th:text="${log.timestamp != null ? #temporals.format(log.timestamp, 'yyyy-MM-dd HH:mm') : ''}">
                            Time</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- [Â∑≤Êï¥ÂêàÂà∞Êñ∞Áâà rbac TabÔºå‰ª•‰∏ãËàäÁâàÂèØÂà™Èô§] -->
        <div id="rbac-old" class="tab-content" style="display:none;">
            <h3>üîê ËßíËâ≤Ê¨äÈôêÁÆ°ÁêÜ (ËàäÁâà)</h3>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <!-- ÁÆ°ÁêÜÂì°Â∏≥Ëôü -->
                <div class="card" style="padding: 20px;">
                    <h4>üë§ ÁÆ°ÁêÜÂì°Â∏≥Ëôü</h4>
                    <div style="background: #f9f9f9; padding: 15px; margin-bottom: 15px; border-radius: 5px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                            <input type="text" id="new-admin-username" placeholder="Â∏≥Ëôü" class="form-control">
                            <input type="password" id="new-admin-password" placeholder="ÂØÜÁ¢º" class="form-control">
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <input type="email" id="new-admin-email" placeholder="Email" class="form-control"
                                style="flex:1;">
                            <select id="new-admin-roles" class="form-control" multiple style="width: 150px;"></select>
                            <button class="btn btn-primary" onclick="createAdmin()">Êñ∞Â¢û</button>
                        </div>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Â∏≥Ëôü</th>
                                <th>Email</th>
                                <th>ËßíËâ≤</th>
                                <th>Êìç‰Ωú</th>
                            </tr>
                        </thead>
                        <tbody id="rbac-admins-table"></tbody>
                    </table>
                </div>

                <!-- ËßíËâ≤ÁÆ°ÁêÜ -->
                <div class="card" style="padding: 20px;">
                    <h4>üé≠ ËßíËâ≤ÁÆ°ÁêÜ</h4>
                    <div style="background: #f9f9f9; padding: 15px; margin-bottom: 15px; border-radius: 5px;">
                        <div style="display: flex; gap: 10px;">
                            <input type="text" id="new-role-name" placeholder="ËßíËâ≤ÂêçÁ®±" class="form-control"
                                style="flex:1;">
                            <select id="new-role-perms" class="form-control" multiple style="width: 200px;"></select>
                            <button class="btn btn-primary" onclick="createRole()">Êñ∞Â¢û</button>
                        </div>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>ÂêçÁ®±</th>
                                <th>Ê¨äÈôê</th>
                                <th>Êìç‰Ωú</th>
                            </tr>
                        </thead>
                        <tbody id="rbac-roles-table"></tbody>
                    </table>
                </div>
            </div>

            <!-- Ê¨äÈôêÁÆ°ÁêÜ -->
            <div class="card" style="padding: 20px; margin-top: 20px;">
                <h4>üîë Ê¨äÈôêË®≠ÂÆö</h4>
                <div style="background: #f9f9f9; padding: 15px; margin-bottom: 15px; border-radius: 5px;">
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="new-perm-code" placeholder="Ê¨äÈôê‰ª£Á¢º (Â¶Ç MANAGE_USERS)" class="form-control"
                            style="width: 200px;">
                        <input type="text" id="new-perm-name" placeholder="Ê¨äÈôêÂêçÁ®± (Â¶Ç ÁÆ°ÁêÜÁî®Êà∂)" class="form-control"
                            style="width: 150px;">
                        <input type="text" id="new-perm-desc" placeholder="Ë™™Êòé" class="form-control" style="flex:1;">
                        <button class="btn btn-primary" onclick="createPermission()">Êñ∞Â¢û</button>
                    </div>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>‰ª£Á¢º</th>
                            <th>ÂêçÁ®±</th>
                            <th>Ë™™Êòé</th>
                            <th>Êìç‰Ωú</th>
                        </tr>
                    </thead>
                    <tbody id="rbac-perms-table"></tbody>
                </table>
            </div>
        </div>

        <!-- ==================== ÊäΩÁçéÁ≥ªÁµ±ÁÆ°ÁêÜ ==================== -->

        <!-- IP ‰∏ªÈ°åÁÆ°ÁêÜ -->
        <div id="gacha-ips" class="tab-content" style="display:none;">
            <h3>üéÆ IP ‰∏ªÈ°åÁÆ°ÁêÜ</h3>
            <div class="card" style="padding: 20px; margin-bottom: 20px;">
                <h4>Êñ∞Â¢û IP ‰∏ªÈ°å</h4>
                <form th:action="@{/admin/gacha/ips/create}" method="post">
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                        <input type="text" name="name" placeholder="IP ÂêçÁ®±" class="form-control" required />
                        <input type="text" name="description" placeholder="ÊèèËø∞" class="form-control" />
                        <input type="text" name="imageUrl" placeholder="ÂúñÁâáÁ∂≤ÂùÄ" class="form-control" />
                    </div>
                    <button type="submit" class="btn btn-primary" style="margin-top: 10px;">Êñ∞Â¢û</button>
                </form>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>ÂêçÁ®±</th>
                        <th>ÊèèËø∞</th>
                        <th>ÁãÄÊÖã</th>
                        <th>Êìç‰Ωú</th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="ip : ${gachaIps}">
                        <td th:text="${ip.id}">1</td>
                        <td th:text="${ip.name}">È¨ºÊªÖ‰πãÂàÉ</td>
                        <td th:text="${ip.description}">ÊèèËø∞</td>
                        <td>
                            <span
                                th:class="${ip.status.name() == 'ACTIVE' ? 'badge badge-success' : 'badge badge-secondary'}"
                                th:text="${ip.status.name() == 'ACTIVE' ? 'ÂïüÁî®' : 'ÂÅúÁî®'}">Active</span>
                        </td>
                        <td>
                            <form th:action="@{/admin/gacha/ips/{id}/toggle(id=${ip.id})}" method="post"
                                style="display:inline;">
                                <button type="submit" class="btn btn-sm btn-info"
                                    th:text="${ip.status.name() == 'ACTIVE' ? 'ÂÅúÁî®' : 'ÂïüÁî®'}">Toggle</button>
                            </form>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- ‰∏ÄÁï™Ë≥ûÁÆ°ÁêÜ -->
        <div id="gacha-ichiban" class="tab-content" style="display:none;">
            <h3>üéØ ‰∏ÄÁï™Ë≥ûÁÆ°ÁêÜ</h3>
            <div class="card" style="padding: 20px; margin-bottom: 20px;">
                <h4>Êñ∞Â¢û‰∏ÄÁï™Ë≥ûÁÆ±È´î</h4>
                <form th:action="@{/admin/gacha/ichiban/create}" method="post">
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 10px;">
                        <select name="ipId" class="form-control" required>
                            <option value="">ÈÅ∏Êìá IP ‰∏ªÈ°å</option>
                            <option th:each="ip : ${gachaIps}" th:if="${ip.status.name() == 'ACTIVE'}"
                                th:value="${ip.id}" th:text="${ip.name}"></option>
                        </select>
                        <input type="text" name="name" placeholder="ÁÆ±È´îÂêçÁ®±" class="form-control" required />
                        <input type="number" step="0.01" name="pricePerDraw" placeholder="ÂñÆÊäΩÂÉπÊ†º" class="form-control"
                            required />
                        <input type="number" name="totalSlots" placeholder="Á∏ΩÊ†ºÊï∏" class="form-control" required />
                    </div>
                    <button type="submit" class="btn btn-primary" style="margin-top: 10px;">Âª∫Á´ãÁÆ±È´î</button>
                </form>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>IP</th>
                        <th>ÂêçÁ®±</th>
                        <th>ÂñÆÂÉπ</th>
                        <th>Ê†ºÊï∏</th>
                        <th>ÁãÄÊÖã</th>
                        <th>Êìç‰Ωú</th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="box : ${ichibanBoxes}">
                        <td th:text="${box.id}">1</td>
                        <td th:text="${box.ip != null ? box.ip.name : '-'}">IP</td>
                        <td th:text="${box.name}">Box</td>
                        <td th:text="'$' + ${box.pricePerDraw}">$680</td>
                        <td th:text="${box.totalSlots}">20</td>
                        <td>
                            <span
                                th:class="${box.status.name() == 'ACTIVE' ? 'badge badge-success' : (box.status.name() == 'SOLD_OUT' ? 'badge badge-danger' : 'badge badge-secondary')}"
                                th:text="${box.status.name()}">Status</span>
                        </td>
                        <td>
                            <a th:href="@{/admin/gacha/ichiban/{id}/prizes(id=${box.id})}"
                                class="btn btn-sm btn-info">ÁçéÂìÅË®≠ÂÆö</a>
                            <form th:if="${box.status.name() == 'DRAFT'}"
                                th:action="@{/admin/gacha/ichiban/{id}/activate(id=${box.id})}" method="post"
                                style="display:inline;">
                                <button type="submit" class="btn btn-sm btn-success">‰∏äÊû∂</button>
                            </form>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- ËΩâÁõ§ÁÆ°ÁêÜ -->
        <div id="gacha-roulette" class="tab-content" style="display:none;">
            <h3>üé° ËΩâÁõ§ÁÆ°ÁêÜ</h3>
            <div class="card" style="padding: 20px; margin-bottom: 20px;">
                <h4>Êñ∞Â¢ûËΩâÁõ§ÈÅäÊà≤</h4>
                <form th:action="@{/admin/gacha/roulette/create}" method="post">
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 10px;">
                        <select name="ipId" class="form-control" required>
                            <option value="">ÈÅ∏Êìá IP ‰∏ªÈ°å</option>
                            <option th:each="ip : ${gachaIps}" th:if="${ip.status.name() == 'ACTIVE'}"
                                th:value="${ip.id}" th:text="${ip.name}"></option>
                        </select>
                        <input type="text" name="name" placeholder="ËΩâÁõ§ÂêçÁ®±" class="form-control" required />
                        <input type="number" step="0.01" name="pricePerSpin" placeholder="ÂñÆËΩâÂÉπÊ†º" class="form-control"
                            required />
                        <input type="number" name="totalSlots" placeholder="ÁçéÊ†ºÊï∏(8-12)" class="form-control" required />
                    </div>
                    <button type="submit" class="btn btn-primary" style="margin-top: 10px;">Âª∫Á´ãËΩâÁõ§</button>
                </form>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>IP</th>
                        <th>ÂêçÁ®±</th>
                        <th>ÂñÆÂÉπ</th>
                        <th>ÁçéÊ†ºÊï∏</th>
                        <th>ÁãÄÊÖã</th>
                        <th>Êìç‰Ωú</th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="game : ${rouletteGames}">
                        <td th:text="${game.id}">1</td>
                        <td th:text="${game.ip != null ? game.ip.name : '-'}">IP</td>
                        <td th:text="${game.name}">Game</td>
                        <td th:text="'$' + ${game.pricePerSpin}">$100</td>
                        <td th:text="${game.totalSlots}">8</td>
                        <td>
                            <span
                                th:class="${game.status.name() == 'ACTIVE' ? 'badge badge-success' : 'badge badge-secondary'}"
                                th:text="${game.status.name()}">Status</span>
                        </td>
                        <td>
                            <a th:href="@{/admin/gacha/roulette/{id}/slots(id=${game.id})}"
                                class="btn btn-sm btn-info">ÁçéÊ†ºË®≠ÂÆö</a>
                            <form th:if="${game.status.name() == 'DRAFT'}"
                                th:action="@{/admin/gacha/roulette/{id}/activate(id=${game.id})}" method="post"
                                style="display:inline;">
                                <button type="submit" class="btn btn-sm btn-success">‰∏äÊû∂</button>
                            </form>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- ‰πùÂÆÆÊ†ºÁÆ°ÁêÜ -->
        <div id="gacha-bingo" class="tab-content" style="display:none;">
            <h3>üé≤ ‰πùÂÆÆÊ†ºÁÆ°ÁêÜ</h3>
            <div class="card" style="padding: 20px; margin-bottom: 20px;">
                <h4>Êñ∞Â¢û‰πùÂÆÆÊ†ºÈÅäÊà≤</h4>
                <form th:action="@{/admin/gacha/bingo/create}" method="post">
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr 1fr; gap: 10px;">
                        <select name="ipId" class="form-control" required>
                            <option value="">ÈÅ∏Êìá IP ‰∏ªÈ°å</option>
                            <option th:each="ip : ${gachaIps}" th:if="${ip.status.name() == 'ACTIVE'}"
                                th:value="${ip.id}" th:text="${ip.name}"></option>
                        </select>
                        <input type="text" name="name" placeholder="ÈÅäÊà≤ÂêçÁ®±" class="form-control" required />
                        <input type="number" step="0.01" name="pricePerDig" placeholder="ÂñÆÊåñÂÉπÊ†º" class="form-control"
                            required />
                        <select name="gridSize" class="form-control" required>
                            <option value="3">3x3</option>
                            <option value="4">4x4</option>
                            <option value="5">5x5</option>
                        </select>
                        <input type="text" name="bingoRewardName" placeholder="ÈÄ£Á∑öÁçéÂãµ" class="form-control" />
                    </div>
                    <button type="submit" class="btn btn-primary" style="margin-top: 10px;">Âª∫Á´ã‰πùÂÆÆÊ†º</button>
                </form>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>IP</th>
                        <th>ÂêçÁ®±</th>
                        <th>ÂñÆÂÉπ</th>
                        <th>Â∞∫ÂØ∏</th>
                        <th>ÁãÄÊÖã</th>
                        <th>Êìç‰Ωú</th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="game : ${bingoGames}">
                        <td th:text="${game.id}">1</td>
                        <td th:text="${game.ip != null ? game.ip.name : '-'}">IP</td>
                        <td th:text="${game.name}">Game</td>
                        <td th:text="'$' + ${game.pricePerDig}">$80</td>
                        <td th:text="${game.gridSize + 'x' + game.gridSize}">3x3</td>
                        <td>
                            <span
                                th:class="${game.status.name() == 'ACTIVE' ? 'badge badge-success' : 'badge badge-secondary'}"
                                th:text="${game.status.name()}">Status</span>
                        </td>
                        <td>
                            <a th:href="@{/admin/gacha/bingo/{id}/cells(id=${game.id})}"
                                class="btn btn-sm btn-info">Ê†ºÂ≠êË®≠ÂÆö</a>
                            <form th:if="${game.status.name() == 'DRAFT'}"
                                th:action="@{/admin/gacha/bingo/{id}/activate(id=${game.id})}" method="post"
                                style="display:inline;">
                                <button type="submit" class="btn btn-sm btn-success">‰∏äÊû∂</button>
                            </form>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Á¢éÁâáÂïÜÂ∫óÁÆ°ÁêÜ -->
        <div id="gacha-redeem" class="tab-content" style="display:none;">
            <h3>üíé Á¢éÁâáÂïÜÂ∫óÁÆ°ÁêÜ</h3>
            <div class="card" style="padding: 20px; margin-bottom: 20px;">
                <h4>Êñ∞Â¢ûÂÖåÊèõÂïÜÂìÅ</h4>
                <form th:action="@{/admin/gacha/redeem/create}" method="post">
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr 1fr; gap: 10px;">
                        <input type="text" name="name" placeholder="ÂïÜÂìÅÂêçÁ®±" class="form-control" required />
                        <input type="number" name="shardCost" placeholder="Á¢éÁâáÂÉπÊ†º" class="form-control" required />
                        <input type="number" step="0.01" name="estimatedValue" placeholder="‰º∞Ë®àÂÉπÂÄº" class="form-control"
                            required />
                        <input type="number" name="stock" placeholder="Â∫´Â≠ò" class="form-control" required />
                        <select name="itemType" class="form-control" required>
                            <option value="S_RANK">SÁ¥öÁçéÂìÅ</option>
                            <option value="HIDDEN">Èö±ËóèÁâà</option>
                            <option value="SPECIAL">ÁâπÂÖ∏</option>
                            <option value="PRIZE">Âë®ÈÇä</option>
                        </select>
                    </div>
                    <div style="margin-top: 10px;">
                        <input type="text" name="imageUrl" placeholder="ÂúñÁâáÁ∂≤ÂùÄ" class="form-control" />
                    </div>
                    <button type="submit" class="btn btn-primary" style="margin-top: 10px;">Êñ∞Â¢ûÂïÜÂìÅ</button>
                </form>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>ÂêçÁ®±</th>
                        <th>È°ûÂûã</th>
                        <th>Á¢éÁâáÂÉπÊ†º</th>
                        <th>Â∫´Â≠ò</th>
                        <th>ÁãÄÊÖã</th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="item : ${redeemItems}">
                        <td th:text="${item.id}">1</td>
                        <td th:text="${item.name}">ÂïÜÂìÅ</td>
                        <td th:text="${item.itemType}">S_RANK</td>
                        <td th:text="${item.shardCost}">1000</td>
                        <td th:text="${item.stock + '/' + item.totalStock}">5/10</td>
                        <td>
                            <span
                                th:class="${item.status.name() == 'ACTIVE' ? 'badge badge-success' : 'badge badge-secondary'}"
                                th:text="${item.status.name()}">Active</span>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Âπ≥Âè∞Ë®≠ÂÆö -->
        <div id="platform" class="tab-content" style="display:none;">
            <h3>Âπ≥Âè∞Ë®≠ÂÆö</h3>

            <!-- Ëº™Êí≠ÂúñÁÆ°ÁêÜ -->
            <div class="card" style="padding: 20px; margin-bottom: 20px;">
                <h4>Ëº™Êí≠ÂúñÁÆ°ÁêÜ</h4>
                <form th:action="@{/admin/carousel/create}" method="post" style="margin-bottom: 15px;">
                    <div style="display: grid; grid-template-columns: 2fr 1fr auto; gap: 10px; align-items: end;">
                        <div>
                            <label>ÂúñÁâáÁ∂≤ÂùÄ</label>
                            <input type="text" name="imageUrl" placeholder="https://..." class="form-control"
                                required />
                        </div>
                        <div>
                            <label>ÈÄ£ÁµêÁ∂≤ÂùÄ</label>
                            <input type="text" name="linkUrl" placeholder="/products Êàñ https://..."
                                class="form-control" />
                        </div>
                        <button type="submit" class="btn btn-primary">Êñ∞Â¢û</button>
                    </div>
                </form>
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>È†êË¶Ω</th>
                            <th>ÈÄ£Áµê</th>
                            <th>ÊéíÂ∫è</th>
                            <th>Êìç‰Ωú</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="slide : ${carouselSlides}">
                            <td th:text="${slide.id}">1</td>
                            <td><img th:src="${slide.imageUrl}" style="height: 50px; border-radius: 4px;" /></td>
                            <td th:text="${slide.linkUrl ?: '-'}">-</td>
                            <td th:text="${slide.sortOrder}">0</td>
                            <td>
                                <form th:action="@{/admin/carousel/{id}/delete(id=${slide.id})}" method="post"
                                    style="display:inline;">
                                    <button type="submit" class="btn btn-sm btn-danger"
                                        onclick="return confirm('Á¢∫ÂÆöÂà™Èô§Ôºü')">Âà™Èô§</button>
                                </form>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Á≤æÈÅ∏ÂïÜÂìÅÁÆ°ÁêÜ -->
            <div class="card" style="padding: 20px; margin-bottom: 20px;">
                <h4>Á≤æÈÅ∏ÂïÜÂìÅÔºàÊñ∞ÂìÅ/ÁÜ±Ë≥£Ôºâ</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <h5>Êñ∞ÂìÅÊé®Ëñ¶</h5>
                        <ul>
                            <li th:each="item : ${newArrivals}" th:text="${item.product.name}">ÂïÜÂìÅÂêç</li>
                        </ul>
                    </div>
                    <div>
                        <h5>ÁÜ±Ë≥£ÊéíË°å</h5>
                        <ul>
                            <li th:each="item : ${bestSellers}" th:text="${item.product.name}">ÂïÜÂìÅÂêç</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Á≥ªÁµ±Ë®≠ÂÆö -->
            <div class="card" style="padding: 20px;">
                <h4>Á≥ªÁµ±Ë®≠ÂÆö</h4>
                <p style="color: #888; font-size: 0.9rem; margin-bottom: 15px;">ÂäüËÉΩÈñãÈóúËàáÈÅäÊà≤ÂèÉÊï∏ÈÖçÁΩÆ</p>
                <table>
                    <thead>
                        <tr>
                            <th>Ë®≠ÂÆöÈ†Ö</th>
                            <th>Ë™™Êòé</th>
                            <th>ÁõÆÂâçÂÄº</th>
                            <th>Êìç‰Ωú</th>
                        </tr>
                    </thead>
                    <tbody id="system-settings-table">
                        <!-- ÂãïÊÖãËºâÂÖ• -->
                    </tbody>
                </table>
                <div style="margin-top: 15px; text-align: right;">
                    <button class="btn btn-primary" onclick="saveAllSettings()">ÂÑ≤Â≠òÊâÄÊúâË®≠ÂÆö</button>
                </div>
            </div>
        </div>

        <!-- Á¶ÆÂåÖÁ¢ºÁÆ°ÁêÜ -->
        <div id="promo-codes" class="tab-content" style="display:none;">
            <h3>Á¶ÆÂåÖÁ¢ºÁÆ°ÁêÜ</h3>

            <!-- Âª∫Á´ãÁ¶ÆÂåÖÁ¢º -->
            <div class="card" style="padding: 20px; margin-bottom: 20px;">
                <h4>Âª∫Á´ãÊñ∞Á¶ÆÂåÖÁ¢º</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                    <input type="text" id="promo-name" placeholder="Á¶ÆÂåÖÂêçÁ®±" class="form-control" />
                    <select id="promo-reward-type" class="form-control">
                        <option value="TOKENS">‰ª£Âπ£</option>
                        <option value="BONUS">Á¥ÖÂà©ÈªûÊï∏</option>
                        <option value="SHARDS">Á¢éÁâá</option>
                    </select>
                    <input type="number" id="promo-reward-value" placeholder="ÁçéÂãµÊï∏Èáè" class="form-control" />
                    <input type="number" id="promo-max-uses" placeholder="ÊúÄÂ§ß‰ΩøÁî®Ê¨°Êï∏" class="form-control" value="100" />
                    <input type="datetime-local" id="promo-valid-until" class="form-control" />
                </div>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="promo-description" placeholder="ÊèèËø∞ÔºàÂèØÈÅ∏Ôºâ" class="form-control"
                        style="flex: 1;" />
                    <button class="btn btn-primary" onclick="createPromoCode()">Âª∫Á´ãÁ¶ÆÂåÖÁ¢º</button>
                </div>
            </div>

            <!-- Á¶ÆÂåÖÁ¢ºÂàóË°® -->
            <div class="card" style="padding: 20px;">
                <h4>Á¶ÆÂåÖÁ¢ºÂàóË°®</h4>
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>‰ª£Á¢º</th>
                            <th>ÂêçÁ®±</th>
                            <th>È°ûÂûã</th>
                            <th>ÁçéÂãµ</th>
                            <th>‰ΩøÁî®/‰∏äÈôê</th>
                            <th>ÁãÄÊÖã</th>
                            <th>Êìç‰Ωú</th>
                        </tr>
                    </thead>
                    <tbody id="promo-codes-table">
                        <!-- ÂãïÊÖãËºâÂÖ• -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- RBAC Ê¨äÈôêÁÆ°ÁêÜ -->
        <div id="rbac" class="tab-content" style="display:none;">
            <h3>ËßíËâ≤Ê¨äÈôêÁÆ°ÁêÜ</h3>

            <!-- ËßíËâ≤ÂàóË°® -->
            <div class="card" style="padding: 20px; margin-bottom: 20px;">
                <h4>ËßíËâ≤ÂàóË°®</h4>
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <input type="text" id="new-role-name" placeholder="Êñ∞ËßíËâ≤ÂêçÁ®±" class="form-control"
                        style="width: 200px;" />
                    <select id="new-role-perms" class="form-control" style="width: 300px;" multiple>
                        <!-- ÂãïÊÖãËºâÂÖ•Ê¨äÈôêÈÅ∏È†Ö -->
                    </select>
                    <button class="btn btn-primary" onclick="createRole()">Êñ∞Â¢ûËßíËâ≤</button>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>ËßíËâ≤ÂêçÁ®±</th>
                            <th>Ê¨äÈôê</th>
                            <th>Êìç‰Ωú</th>
                        </tr>
                    </thead>
                    <tbody id="rbac-roles-table">
                        <!-- ÂãïÊÖãËºâÂÖ• -->
                    </tbody>
                </table>
            </div>

            <!-- Ê¨äÈôêÂàóË°® -->
            <div class="card" style="padding: 20px;">
                <h4>Ê¨äÈôêÂàóË°®</h4>
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <input type="text" id="new-perm-code" placeholder="Ê¨äÈôê‰ª£Á¢º (Â¶Ç MEMBER_VIEW)" class="form-control"
                        style="width: 200px;" />
                    <input type="text" id="new-perm-name" placeholder="Ê¨äÈôêÂêçÁ®±" class="form-control"
                        style="width: 200px;" />
                    <input type="text" id="new-perm-desc" placeholder="ÊèèËø∞ (ÂèØÈÅ∏)" class="form-control"
                        style="width: 200px;" />
                    <button class="btn btn-primary" onclick="createPermission()">Êñ∞Â¢ûÊ¨äÈôê</button>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Ê¨äÈôê‰ª£Á¢º</th>
                            <th>Ê¨äÈôêÂêçÁ®±</th>
                            <th>ÊèèËø∞</th>
                            <th>Êìç‰Ωú</th>
                        </tr>
                    </thead>
                    <tbody id="rbac-perms-table">
                        <!-- ÂãïÊÖãËºâÂÖ• -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ÊúÉÂì°Ê®ôÁ±§ÁÆ°ÁêÜ -->
        <div id="member-tags" class="tab-content" style="display:none;">
            <h3>ÊúÉÂì°Ê®ôÁ±§ÁÆ°ÁêÜ</h3>

            <!-- Âª∫Á´ãÊ®ôÁ±§ -->
            <div class="card" style="padding: 20px; margin-bottom: 20px;">
                <h4>Âª∫Á´ãÊñ∞Ê®ôÁ±§</h4>
                <div style="display: flex; gap: 10px; align-items: end;">
                    <div>
                        <label>Ê®ôÁ±§ÂêçÁ®±</label>
                        <input type="text" id="tag-name" placeholder="Â¶ÇÔºöÊ¥ªË∫çÁî®Êà∂" class="form-control" />
                    </div>
                    <div>
                        <label>È°èËâ≤</label>
                        <input type="color" id="tag-color" value="#667eea" class="form-control"
                            style="width: 60px; height: 38px;" />
                    </div>
                    <div>
                        <label>Ë™™Êòé</label>
                        <input type="text" id="tag-description" placeholder="ÈÅ∏Â°´" class="form-control" />
                    </div>
                    <button class="btn btn-primary" onclick="createMemberTag()">Âª∫Á´ãÊ®ôÁ±§</button>
                </div>
            </div>

            <!-- Ê®ôÁ±§ÂàóË°® -->
            <div class="card" style="padding: 20px;">
                <h4>Ê®ôÁ±§ÂàóË°®</h4>
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Ê®ôÁ±§</th>
                            <th>Ë™™Êòé</th>
                            <th>È°ûÂûã</th>
                            <th>Êìç‰Ωú</th>
                        </tr>
                    </thead>
                    <tbody id="member-tags-table">
                        <!-- ÂãïÊÖãËºâÂÖ• -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Á≥ªÁµ±ÂÖ¨Âëä -->
        <div id="announcements" class="tab-content" style="display:none;">
            <h3>Á≥ªÁµ±ÂÖ¨Âëä</h3>

            <!-- Áæ§ÁôºÂÖ¨Âëä -->
            <div class="card" style="padding: 20px;">
                <h4>ÁôºÈÄÅÂÖ¨Âëä</h4>
                <div style="display: flex; flex-direction: column; gap: 15px;">
                    <div>
                        <label>ÂÖ¨ÂëäÊ®ôÈ°å</label>
                        <input type="text" id="ann-title" placeholder="Â¶ÇÔºöÁ≥ªÁµ±Á∂≠Ë≠∑ÈÄöÁü•" class="form-control" />
                    </div>
                    <div>
                        <label>ÂÖ¨ÂëäÂÖßÂÆπ</label>
                        <textarea id="ann-content" class="form-control" rows="4" placeholder="Ë´ãËº∏ÂÖ•ÂÖ¨ÂëäÂÖßÂÆπ..."></textarea>
                    </div>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <label>ÁôºÈÄÅÂ∞çË±°Ôºö</label>
                        <select id="ann-target" class="form-control" style="width: 200px;">
                            <option value="all">ÊâÄÊúâÊúÉÂì°</option>
                        </select>
                        <span id="ann-target-count" style="color: #888;"></span>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-primary" onclick="sendAnnouncement()">ÁôºÈÄÅÂÖ¨Âëä</button>
                        <button class="btn btn-secondary" onclick="loadAnnouncementTags()">Âà∑Êñ∞Ê®ôÁ±§ÂàóË°®</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ÈÄèÊòéÈ©óË≠âÊü•Ë©¢ -->
        <div id="transparency" class="tab-content" style="display:none;">
            <h3>ÈñãÁçéÈÄèÊòéÈ©óË≠â</h3>

            <div class="card" style="padding: 20px;">
                <h4>Â∑≤ÂÆåÂîÆÈÅäÊà≤È©óË≠âË®òÈåÑ</h4>
                <button class="btn btn-secondary" onclick="loadTransparencyData()"
                    style="margin-bottom: 15px;">Âà∑Êñ∞</button>
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>ÈÅäÊà≤È°ûÂûã</th>
                            <th>ÈÅäÊà≤ ID</th>
                            <th>ÈÅäÊà≤ÂêçÁ®±</th>
                            <th>ÂÆåÊàêÊôÇÈñì</th>
                            <th>Êìç‰Ωú</th>
                        </tr>
                    </thead>
                    <tbody id="transparency-table">
                        <!-- ÂãïÊÖãËºâÂÖ• -->
                    </tbody>
                </table>
            </div>

            <!-- È©óË≠â Modal -->
            <div id="hashVerifyModal" class="modal" style="display: none;">
                <div class="modal-content" style="max-width: 600px;">
                    <span class="modal-close" onclick="closeHashModal()">&times;</span>
                    <h3>ÂìàÂ∏åÈ©óË≠â</h3>
                    <p id="hashDisplayValue"
                        style="word-break: break-all; background: #f5f5f5; padding: 10px; border-radius: 4px;"></p>
                    <div style="margin-top: 15px;">
                        <input type="text" id="hashVerifyInput" placeholder="Ëº∏ÂÖ•ÂìàÂ∏åÂÄºÈÄ≤Ë°åÈ©óË≠â" class="form-control" />
                        <button class="btn btn-primary" onclick="verifyHash()" style="margin-top: 10px;">È©óË≠â</button>
                    </div>
                    <p id="hashVerifyResult" style="margin-top: 15px;"></p>
                </div>
            </div>
        </div>

        <!-- ËßíËâ≤Ê¨äÈôêÁ∑®ËºØ Modal -->
        <div id="rolePermissionModal" class="modal">
            <div class="modal-content" style="max-width: 500px;">
                <span class="modal-close" onclick="closeRoleModal()">&times;</span>
                <div class="modal-header">
                    <h3>Á∑®ËºØËßíËâ≤Ê¨äÈôê: <span id="editingRoleName"></span></h3>
                </div>
                <div id="permissionCheckboxList" style="max-height: 400px; overflow-y: auto;">
                    <!-- ÂãïÊÖãÁîüÊàêÊ¨äÈôêÂãæÈÅ∏Ê°Ü -->
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeRoleModal()">ÂèñÊ∂à</button>
                    <button class="btn btn-primary" onclick="saveRolePermissions()">ÂÑ≤Â≠òÊ¨äÈôê</button>
                </div>
            </div>
        </div>

        <!-- Edit Member Level Modal -->
        <div id="editLevelModal" class="modal"
            style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5);">
            <div class="card" style="margin: 10% auto; width: 40%; padding: 20px;">
                <h4>Á∑®ËºØÁ≠âÁ¥ö</h4>
                <form th:action="@{/admin/member-levels/update}" method="post">
                    <input type="hidden" id="editLvlId" name="id">
                    <div style="display: grid; gap: 10px;">
                        <label>Á≠âÁ¥öÂêçÁ®±</label>
                        <input type="text" id="editLvlName" name="name" class="form-control" required />
                        <label>ÊéíÂ∫è</label>
                        <input type="number" id="editLvlSort" name="sortOrder" class="form-control" required />
                        <label>Á¥ØÁ©çÂÑ≤ÂÄºÈñÄÊ™ª</label>
                        <input type="number" step="0.01" id="editLvlThreshold" name="threshold" class="form-control"
                            required />
                        <label>ÊØèÊúàÁçéÂãµ</label>
                        <input type="text" id="editLvlReward" name="monthlyReward" class="form-control" />
                        <label>ÁãÄÊÖã</label>
                        <select id="editLvlEnabled" name="enabled" class="form-control">
                            <option value="true">ÂïüÁî®</option>
                            <option value="false">ÂÅúÁî®</option>
                        </select>
                    </div>
                    <div style="margin-top: 10px; display: flex; justify-content: flex-end; gap: 10px;">
                        <button type="button" class="btn btn-secondary"
                            onclick="document.getElementById('editLevelModal').style.display='none'">ÂèñÊ∂à</button>
                        <button type="submit" class="btn btn-primary">ÂÑ≤Â≠ò</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Edit Member Modal -->
        <div id="editMemberModal" class="modal"
            style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5);">
            <div class="card" style="margin: 10% auto; width: 40%; padding: 20px;">
                <h4>Á∑®ËºØÊúÉÂì°</h4>
                <form th:action="@{/admin/members/update}" method="post">
                    <input type="hidden" id="editMemberId" name="id">
                    <div style="display: grid; gap: 10px;">
                        <label>Email</label>
                        <input type="text" id="editMemberEmail" name="email" class="form-control" />
                        <label>Êö±Á®±</label>
                        <input type="text" id="editMemberName" name="nickname" class="form-control" />
                        <label>ÁãÄÊÖã</label>
                        <select id="editMemberStatus" name="enabled" class="form-control">
                            <option value="true">ÂïüÁî®</option>
                            <option value="false">ÂÅúÁî®</option>
                        </select>
                        <label>Á≠âÁ¥ö</label>
                        <select id="editMemberLevel" name="level" class="form-control">
                            <option value="">ÈÅ∏ÊìáÁ≠âÁ¥ö</option>
                            <option th:each="lvl : ${memberLevels}" th:value="${lvl.id}" th:text="${lvl.name}"></option>
                        </select>
                    </div>
                    <div style="margin-top: 10px; display: flex; justify-content: flex-end; gap: 10px;">
                        <button type="button" class="btn btn-secondary"
                            onclick="document.getElementById('editMemberModal').style.display='none'">ÂèñÊ∂à</button>
                        <button type="submit" class="btn btn-primary">ÂÑ≤Â≠ò</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Áâ©ÊµÅÁÆ°ÁêÜ Tab -->
        <div id="logistics" class="tab-content" style="display:none;">
            <h3>üì¶ Áâ©ÊµÅÁÆ°ÁêÜ</h3>
            <div class="card" style="padding: 20px; margin-bottom: 20px;">
                <h4>ÊâπÊ¨°ÂåØÂÖ•Áâ©ÊµÅÂñÆËôü</h4>
                <p style="color: #888; margin-bottom: 15px;">CSV Ê†ºÂºè: Âá∫Ë≤®Áî≥Ë´ãID, Áâ©ÊµÅÂñÆËôü, Áâ©ÊµÅÂÖ¨Âè∏(ÂèØÈÅ∏)</p>
                <textarea id="csv-import-content" class="form-control" rows="5"
                    placeholder="1001,9876543210,ÈªëË≤ì&#10;1002,1234567890,Êñ∞Á´π"></textarea>
                <button class="btn btn-primary" style="margin-top: 10px;" onclick="importLogisticsCSV()">ÂåØÂÖ•</button>
                <div id="import-result" style="margin-top: 10px; display: none;"></div>
            </div>
            <h4>ÂæÖËôïÁêÜÁôºË≤®Áî≥Ë´ã</h4>
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>ÊúÉÂì°ID</th>
                        <th>Êî∂‰ª∂‰∫∫</th>
                        <th>ÈõªË©±</th>
                        <th>Âú∞ÂùÄ</th>
                        <th>‰ª∂Êï∏</th>
                        <th>ÁãÄÊÖã</th>
                        <th>Áâ©ÊµÅÂñÆËôü</th>
                    </tr>
                </thead>
                <tbody id="pending-shipments-tbody">
                    <tr th:each="ship : ${pendingShipments}" th:if="${pendingShipments != null}">
                        <td th:text="${ship.id}">1</td>
                        <td th:text="${ship.memberId}">1001</td>
                        <td th:text="${ship.recipientName}">ÁéãÂ∞èÊòé</td>
                        <td th:text="${ship.recipientPhone}">0912345678</td>
                        <td th:text="${ship.recipientAddress}">Âè∞ÂåóÂ∏Ç...</td>
                        <td th:text="${ship.itemCount}">5</td>
                        <td>
                            <span
                                th:class="${ship.status.name() == 'PENDING' ? 'badge badge-warning' : 'badge badge-success'}"
                                th:text="${ship.status.getDisplayName()}">ÂæÖËôïÁêÜ</span>
                        </td>
                        <td th:text="${ship.trackingNumber != null ? ship.trackingNumber : '-'}">-</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- ÈáëÊµÅË®ÇÂñÆÁÆ°ÁêÜ -->
        <div id="payment-orders" class="tab-content" style="display:none;">
            <h3>ÈáëÊµÅË®ÇÂñÆÁÆ°ÁêÜ</h3>

            <!-- Áµ±Ë®àÊëòË¶Å -->
            <div id="payment-summary"
                style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px;">
                <div class="card" style="padding: 15px; text-align: center;">
                    <div style="font-size: 1.5rem; font-weight: bold; color: #667eea;" id="po-total">-</div>
                    <div style="color: #888;">Á∏ΩË®ÇÂñÆÊï∏</div>
                </div>
                <div class="card" style="padding: 15px; text-align: center;">
                    <div style="font-size: 1.5rem; font-weight: bold; color: #f39c12;" id="po-pending">-</div>
                    <div style="color: #888;">ÂæÖËôïÁêÜ</div>
                </div>
                <div class="card" style="padding: 15px; text-align: center;">
                    <div style="font-size: 1.5rem; font-weight: bold; color: #27ae60;" id="po-paid">-</div>
                    <div style="color: #888;">Â∑≤‰ªòÊ¨æ</div>
                </div>
                <div class="card" style="padding: 15px; text-align: center;">
                    <div style="font-size: 1.5rem; font-weight: bold; color: #e74c3c;" id="po-failed">-</div>
                    <div style="color: #888;">Â§±Êïó</div>
                </div>
            </div>

            <!-- Ë®ÇÂñÆÂàóË°® -->
            <div class="card" style="padding: 20px;">
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <button class="btn btn-secondary" onclick="loadPaymentOrders()">Âà∑Êñ∞</button>
                    <select id="po-filter" class="form-control" style="width: 150px;" onchange="filterOrders()">
                        <option value="all">ÂÖ®ÈÉ®ÁãÄÊÖã</option>
                        <option value="PENDING">ÂæÖËôïÁêÜ</option>
                        <option value="PAID">Â∑≤‰ªòÊ¨æ</option>
                        <option value="FAILED">Â§±Êïó</option>
                    </select>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Ë®ÇÂñÆËôü</th>
                            <th>ÊúÉÂì° ID</th>
                            <th>ÈáëÈ°ç</th>
                            <th>‰ªòÊ¨æÊñπÂºè</th>
                            <th>ÁãÄÊÖã</th>
                            <th>Âª∫Á´ãÊôÇÈñì</th>
                        </tr>
                    </thead>
                    <tbody id="payment-orders-table">
                        <!-- ÂãïÊÖãËºâÂÖ• -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ÂÑÄË°®ÊùøÁ∏ΩË¶Ω Tab -->
        <div id="dashboard-overview" class="tab-content" style="display:none;">
            <h3>üìä ÁáüÈÅãÂÑÄË°®Êùø</h3>
            <div id="dashboard-kpi"
                style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px;">
                <div class="card" style="padding: 20px; text-align: center;">
                    <div style="font-size: 2rem; color: #667eea; font-weight: bold;" id="kpi-members">-</div>
                    <div style="color: #888;">Á∏ΩÊúÉÂì°Êï∏</div>
                </div>
                <div class="card" style="padding: 20px; text-align: center;">
                    <div style="font-size: 2rem; color: #27ae60; font-weight: bold;" id="kpi-revenue">-</div>
                    <div style="color: #888;">Êú¨ÊúàÁáüÊî∂</div>
                </div>
                <div class="card" style="padding: 20px; text-align: center;">
                    <div style="font-size: 2rem; color: #e74c3c; font-weight: bold;" id="kpi-draws">-</div>
                    <div style="color: #888;">‰ªäÊó•ÊäΩÁçéÊ¨°Êï∏</div>
                </div>
                <div class="card" style="padding: 20px; text-align: center;">
                    <div style="font-size: 2rem; color: #f39c12; font-weight: bold;" id="kpi-pending">-</div>
                    <div style="color: #888;">ÂæÖÁôºË≤®</div>
                </div>
            </div>
            <div class="card" style="padding: 20px;">
                <h4>üìà ÊúÄÊñ∞‰∫§ÊòìË®òÈåÑ</h4>
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>ÊúÉÂì°</th>
                            <th>È°ûÂûã</th>
                            <th>ÈáëÈ°ç</th>
                            <th>ÊôÇÈñì</th>
                        </tr>
                    </thead>
                    <tbody id="latest-transactions">
                        <tr>
                            <td colspan="5" style="text-align: center; color: #999;">ËºâÂÖ•‰∏≠...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <script>
            // ÂÑÄË°®ÊùøËºâÂÖ•
            async function loadDashboard() {
                try {
                    // KPI
                    const kpiRes = await fetch('/api/admin/dashboard/kpi');
                    const kpiJson = await kpiRes.json();
                    if (kpiJson.code === 200) {
                        document.getElementById('kpi-members').textContent = kpiJson.data.totalMembers;
                        document.getElementById('kpi-revenue').textContent = '$' + (kpiJson.data.monthRevenue || 0);
                        document.getElementById('kpi-draws').textContent = kpiJson.data.todayDraws;
                        document.getElementById('kpi-pending').textContent = kpiJson.data.pendingShipments;
                    }

                    // Latest Transactions
                    const txRes = await fetch('/api/admin/dashboard/transactions/latest');
                    const txJson = await txRes.json();
                    if (txJson.code === 200) {
                        const tbody = document.getElementById('latest-transactions');
                        if (txJson.data.length > 0) {
                            tbody.innerHTML = txJson.data.map(tx => `
                                <tr>
                                    <td>${tx.id}</td>
                                    <td>${tx.member}</td>
                                    <td>${tx.type}</td>
                                    <td>$${tx.amount}</td>
                                    <td>${tx.time}</td>
                                </tr>
                            `).join('');
                        } else {
                            tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #999;">Êö´ÁÑ°‰∫§ÊòìË®òÈåÑ</td></tr>';
                        }
                    }
                } catch (e) {
                    console.error('ËºâÂÖ•ÂÑÄË°®ÊùøÂ§±Êïó', e);
                }
            }

            // Áâ©ÊµÅÂåØÂÖ•
            async function importLogisticsCSV() {
                const content = document.getElementById('csv-import-content').value.trim();
                if (!content) {
                    alert('Ë´ãËº∏ÂÖ• CSV ÂÖßÂÆπ');
                    return;
                }

                try {
                    const res = await fetch('/api/admin/logistics/import-csv', {
                        method: 'POST',
                        headers: { 'Content-Type': 'text/plain' },
                        body: content
                    });
                    const json = await res.json();
                    const resultEl = document.getElementById('import-result');
                    resultEl.style.display = 'block';

                    if (json.code === 200) {
                        resultEl.innerHTML = `<span style="color: #27ae60;">‚úÖ ÂåØÂÖ•ÊàêÂäü: ${json.data.successCount || 0} Á≠Ü</span>`;
                    } else {
                        resultEl.innerHTML = `<span style="color: #e74c3c;">‚ùå ${json.message}</span>`;
                    }
                } catch (e) {
                    console.error('ÂåØÂÖ•Â§±Êïó', e);
                }
            }

            // ÂÑÄË°®Êùø Tab ÈñãÂïüÊôÇËºâÂÖ•Êï∏Êìö
            const origOpenTabDash = window.openTab;
            window.openTab = function (tabName) {
                if (typeof origOpenTabDash === 'function') {
                    origOpenTabDash(tabName);
                }
                if (tabName === 'dashboard-overview') {
                    loadDashboard();
                }
            };
        </script>

        <script>
            function editLevel(id, name, sort, threshold, reward, enabled) {
                document.getElementById('editLvlId').value = id;
                document.getElementById('editLvlName').value = name;
                document.getElementById('editLvlSort').value = sort;
                document.getElementById('editLvlThreshold').value = threshold;
                document.getElementById('editLvlReward').value = reward;
                document.getElementById('editLvlEnabled').value = enabled;
                document.getElementById('editLevelModal').style.display = 'block';
            }

            function openTab(tabName) {
                var i;
                var x = document.getElementsByClassName("tab-content");
                for (i = 0; i < x.length; i++) {
                    x[i].style.display = "none";
                }
                document.getElementById(tabName).style.display = "block";

                // Update URL without reloading
                const url = new URL(window.location);
                url.searchParams.set('tab', tabName);
                window.history.pushState({}, '', url);
            }

            function loadSubCats(catId) {
                if (!catId) return;
                fetch('/admin/api/subcategories/' + catId)
                    .then(response => response.json())
                    .then(data => {
                        let select = document.getElementById('prodSubCategory');
                        select.innerHTML = '<option value="">ÈÅ∏ÊìáÂ≠êÂàÜÈ°û</option>';
                        data.forEach(sub => {
                            let option = document.createElement('option');
                            option.value = sub.name; // Storing Name as Product entity uses string
                            option.text = sub.name;
                            select.appendChild(option);
                        });
                    });
            }

            function editMember(id, email, name, enabled, level) {
                document.getElementById('editMemberId').value = id;
                document.getElementById('editMemberEmail').value = email;
                document.getElementById('editMemberName').value = name;
                document.getElementById('editMemberStatus').value = enabled;
                document.getElementById('editMemberLevel').value = level;
                document.getElementById('editMemberModal').style.display = 'block';
            }

            // Tab ÂàáÊèõÂáΩÊï∏
            function openTab(tabId) {
                // Èö±ËóèÊâÄÊúâ tab-content
                document.querySelectorAll('.tab-content').forEach(el => {
                    el.style.display = 'none';
                });
                // È°ØÁ§∫ÁõÆÊ®ô tab
                const targetTab = document.getElementById(tabId);
                if (targetTab) {
                    targetTab.style.display = 'block';
                }
                // Êõ¥Êñ∞ URL ÂèÉÊï∏
                const url = new URL(window.location);
                url.searchParams.set('tab', tabId);
                window.history.replaceState({}, '', url);
            }

            async function showHistory(memberId) {
                try {
                    const res = await fetch('/api/member/admin/' + memberId + '/history');
                    const json = await res.json();

                    if (json.code !== 200) {
                        alert('ËºâÂÖ•Â§±Êïó: ' + json.message);
                        return;
                    }

                    const data = json.data;
                    const content = `
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div><strong>ÊúÉÂì°ID:</strong> ${data.id}</div>
                            <div><strong>Â∏≥Ëôü:</strong> ${data.username}</div>
                            <div><strong>Êö±Á®±:</strong> ${data.nickname || '-'}</div>
                            <div><strong>Email:</strong> ${data.email}</div>
                            <div><strong>Á≠âÁ¥ö:</strong> ${data.level}</div>
                            <div><strong>Â∏≥Êà∂È§òÈ°ç:</strong> $${data.balance}</div>
                            <div><strong>Á©çÂàÜ:</strong> ${data.points}</div>
                            <div><strong>Á¥ÖÂà©ÈªûÊï∏:</strong> ${data.bonusPoints}</div>
                            <div><strong>ÊàêÈï∑ÂÄº:</strong> ${data.growthValue}</div>
                            <div><strong>Êú¨ÊúàÂÑ≤ÂÄº:</strong> $${data.monthlyRecharge}</div>
                            <div><strong>Ë®ªÂÜäÊôÇÈñì:</strong> ${data.createdAt || '-'}</div>
                            <div><strong>ÊúÄÂæåÁôªÂÖ•:</strong> ${data.lastLoginTime || 'Êú™ÁôªÂÖ•'}</div>
                            <div style="grid-column: span 2;"><strong>ÁãÄÊÖã:</strong> 
                                <span class="${data.enabled ? 'badge badge-success' : 'badge badge-danger'}">
                                    ${data.enabled ? 'Ê≠£Â∏∏' : 'Â∑≤Â∞ÅÈéñ'}
                                </span>
                            </div>
                        </div>
                    `;

                    document.getElementById('historyModalContent').innerHTML = content;
                    document.getElementById('historyModal').style.display = 'block';
                } catch (e) {
                    console.error('ËºâÂÖ•ÊúÉÂì°Ê≠∑Âè≤Â§±Êïó', e);
                    alert('ËºâÂÖ•ÈåØË™§');
                }
            }

            // On Load: Check for 'tab' param
            document.addEventListener('DOMContentLoaded', (event) => {
                const urlParams = new URLSearchParams(window.location.search);
                const tab = urlParams.get('tab');
                if (tab) {
                    openTab(tab);
                }
            });
            function editTheme(id, name, price) {
                document.getElementById('editThemeId').value = id;
                document.getElementById('editThemeName').value = name;
                document.getElementById('editThemePrice').value = price;
                document.getElementById('editThemeModal').style.display = 'block';
            }

            function editActivity(id, title, desc, type, start, end) {
                document.getElementById('editActId').value = id;
                document.getElementById('editActTitle').value = title;
                document.getElementById('editActDesc').value = desc;
                document.getElementById('editActType').value = type;
                document.getElementById('editActStart').value = start ? start : '';
                document.getElementById('editActEnd').value = end ? end : '';
                document.getElementById('editActivityModal').style.display = 'block';
            }

            function editCategory(id, name) {
                document.getElementById('editCatId').value = id;
                document.getElementById('editCatName').value = name;
                document.getElementById('editCategoryModal').style.display = 'block';
            }

            function editSubCategory(id, name) {
                document.getElementById('editSubCatId').value = id;
                document.getElementById('editSubCatName').value = name;
                document.getElementById('editSubCategoryModal').style.display = 'block';
            }

            function editBoxItem(id, name, value, weight) {
                document.getElementById('editBoxItemId').value = id;
                document.getElementById('editBoxItemName').value = name;
                document.getElementById('editBoxItemValue').value = value;
                document.getElementById('editBoxItemWeight').value = weight;
                document.getElementById('editBoxItemModal').style.display = 'block';
            }
            function openDistributeModal(id, name) {
                document.getElementById('distCouponIdLevel').value = id;
                document.getElementById('distCouponIdMember').value = id;
                document.getElementById('distributeTitle').innerText = 'Ê¥æÁôºÂÑ™ÊÉ†Âà∏ - ' + name;
                document.getElementById('distributeCouponModal').style.display = 'block';
            }
            // Platform Management AJAX
            document.addEventListener('DOMContentLoaded', function () {
                function handleForm(formId, tbodyId, rowBuilder) {
                    const form = document.getElementById(formId);
                    if (!form) return;
                    form.addEventListener('submit', async function (e) {
                        e.preventDefault();
                        const formData = new FormData(form);
                        const params = new URLSearchParams();
                        for (const pair of formData.entries()) { params.append(pair[0], pair[1]); }

                        try {
                            const res = await fetch(form.action, { method: 'POST', body: params });
                            const json = await res.json();
                            if (json.success) {
                                alert('Êìç‰ΩúÊàêÂäü');
                                if (tbodyId && rowBuilder) {
                                    const tbody = document.getElementById(tbodyId);
                                    const tr = document.createElement('tr');
                                    tr.innerHTML = rowBuilder(json);
                                    tbody.appendChild(tr);
                                } else {
                                    location.reload();
                                }
                                form.reset();
                            } else {
                                alert('Â§±Êïó: ' + json.message);
                            }
                        } catch (err) {
                            console.error(err);
                            alert('ÁôºÁîüÈåØË™§');
                        }
                    });
                }

                // Carousel
                handleForm('form-carousel-create', 'tbody-carousel', (json) => {
                    const s = json.slide;
                    return `<td><img src="${s.imageUrl}" style="height: 50px;"></td>
                            <td>${s.linkUrl || ''}</td>
                            <td><button class="btn btn-sm btn-danger btn-delete-carousel" data-id="${s.id}">Âà™Èô§</button></td>`;
                });

                // New Arrival
                handleForm('form-new-arrival', 'tbody-new-arrival', (json) => {
                    const i = json.item;
                    return `<td>${json.productName}</td>
                            <td>${i.sortOrder}</td>
                            <td><button class="btn btn-sm btn-danger btn-delete-featured" data-id="${i.id}">ÁßªÈô§</button></td>`;
                });

                // Best Seller
                handleForm('form-best-seller', 'tbody-best-seller', (json) => {
                    const i = json.item;
                    return `<td>${json.productName}</td>
                            <td>${i.sortOrder}</td>
                            <td><button class="btn btn-sm btn-danger btn-delete-featured" data-id="${i.id}">ÁßªÈô§</button></td>`;
                });

                // Notification
                handleForm('form-notification', null, null);

                // Deletes
                document.addEventListener('click', async function (e) {
                    let endpoint = '';
                    let id = '';
                    if (e.target.classList.contains('btn-delete-carousel')) {
                        endpoint = '/admin/platform/carousel/delete/';
                        id = e.target.getAttribute('data-id');
                    } else if (e.target.classList.contains('btn-delete-featured')) {
                        endpoint = '/admin/platform/featured/delete/';
                        id = e.target.getAttribute('data-id');
                    }

                    if (endpoint && id) {
                        e.preventDefault();
                        if (!confirm('Á¢∫ÂÆöÂà™Èô§Ôºü')) return;
                        try {
                            const res = await fetch(endpoint + id, { method: 'POST' });
                            const json = await res.json();
                            if (json.success) {
                                e.target.closest('tr').remove();
                            } else {
                                alert('Âà™Èô§Â§±Êïó: ' + json.message);
                            }
                        } catch (err) {
                            console.error(err);
                            alert('Âà™Èô§ÈåØË™§');
                        }
                    }
                });
            });

            // ==================== RBAC ËßíËâ≤Ê¨äÈôêÁÆ°ÁêÜ ====================
            async function loadRbacData() {
                try {
                    const [adminsRes, rolesRes, permsRes] = await Promise.all([
                        fetch('/api/admin/rbac/admins'),
                        fetch('/api/admin/rbac/roles'),
                        fetch('/api/admin/rbac/permissions')
                    ]);
                    const admins = (await adminsRes.json()).data || [];
                    const roles = (await rolesRes.json()).data || [];
                    const perms = (await permsRes.json()).data || [];

                    // Ê∏≤ÊüìÁÆ°ÁêÜÂì°ÂàóË°®
                    const adminsTable = document.getElementById('rbac-admins-table');
                    if (adminsTable) {
                        adminsTable.innerHTML = admins.map(a => `
                            <tr>
                                <td>${a.id}</td>
                                <td>${a.username}</td>
                                <td>${a.email || '-'}</td>
                                <td>${a.roles.map(r => r.name).join(', ') || '-'}</td>
                                <td>
                                    <button class="btn btn-sm btn-danger" onclick="deleteAdmin(${a.id})">Âà™Èô§</button>
                                </td>
                            </tr>
                        `).join('');
                    }

                    // Ê∏≤ÊüìËßíËâ≤ÂàóË°®
                    const rolesTable = document.getElementById('rbac-roles-table');
                    if (rolesTable) {
                        rolesTable.innerHTML = roles.map(r => `
                            <tr>
                                <td>${r.id}</td>
                                <td>${r.name}</td>
                                <td>${r.permissions.map(p => p.name).join(', ') || '-'}</td>
                                <td>
                                    <button class="btn btn-sm btn-info" onclick="editRole(${r.id}, '${r.name}')">Á∑®ËºØ</button>
                                    <button class="btn btn-sm btn-danger" onclick="deleteRole(${r.id})">Âà™Èô§</button>
                                </td>
                            </tr>
                        `).join('');
                    }

                    // Ê∏≤ÊüìÊ¨äÈôêÂàóË°®
                    const permsTable = document.getElementById('rbac-perms-table');
                    if (permsTable) {
                        permsTable.innerHTML = perms.map(p => `
                            <tr>
                                <td>${p.id}</td>
                                <td>${p.code}</td>
                                <td>${p.name}</td>
                                <td>${p.description || '-'}</td>
                                <td>
                                    <button class="btn btn-sm btn-danger" onclick="deletePermission(${p.id})">Âà™Èô§</button>
                                </td>
                            </tr>
                        `).join('');
                    }

                    // Êõ¥Êñ∞‰∏ãÊãâÈÅ∏ÂñÆ
                    const roleSelect = document.getElementById('new-admin-roles');
                    if (roleSelect) {
                        roleSelect.innerHTML = roles.map(r =>
                            `<option value="${r.id}">${r.name}</option>`
                        ).join('');
                    }

                    const permSelect = document.getElementById('new-role-perms');
                    if (permSelect) {
                        permSelect.innerHTML = perms.map(p =>
                            `<option value="${p.id}">${p.name} (${p.code})</option>`
                        ).join('');
                    }
                } catch (e) {
                    console.error('ËºâÂÖ• RBAC Ë≥áÊñôÂ§±Êïó', e);
                }
            }

            async function createAdmin() {
                const username = document.getElementById('new-admin-username').value;
                const password = document.getElementById('new-admin-password').value;
                const email = document.getElementById('new-admin-email').value;
                const roleSelect = document.getElementById('new-admin-roles');
                const roleIds = Array.from(roleSelect.selectedOptions).map(o => parseInt(o.value));

                const res = await fetch('/api/admin/rbac/admins', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password, email, roleIds })
                });
                const json = await res.json();
                if (json.code === 200) {
                    alert('Âª∫Á´ãÊàêÂäü');
                    loadRbacData();
                } else {
                    alert('Â§±Êïó: ' + json.message);
                }
            }

            async function deleteAdmin(id) {
                if (!confirm('Á¢∫ÂÆöÂà™Èô§Ê≠§ÁÆ°ÁêÜÂì°Ôºü')) return;
                await fetch('/api/admin/rbac/admins/' + id, { method: 'DELETE' });
                loadRbacData();
            }

            async function createRole() {
                const name = document.getElementById('new-role-name').value;
                const permSelect = document.getElementById('new-role-perms');
                const permissionIds = Array.from(permSelect.selectedOptions).map(o => parseInt(o.value));

                const res = await fetch('/api/admin/rbac/roles', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, permissionIds })
                });
                const json = await res.json();
                if (json.code === 200) {
                    alert('Âª∫Á´ãÊàêÂäü');
                    loadRbacData();
                } else {
                    alert('Â§±Êïó: ' + json.message);
                }
            }

            async function deleteRole(id) {
                if (!confirm('Á¢∫ÂÆöÂà™Èô§Ê≠§ËßíËâ≤Ôºü')) return;
                await fetch('/api/admin/rbac/roles/' + id, { method: 'DELETE' });
                loadRbacData();
            }

            // ==================== Ê¨äÈôêÂãæÈÅ∏ Modal ÂäüËÉΩ ====================
            let currentEditingRoleId = null;
            let allPermissions = [];

            async function editRole(roleId, roleName) {
                currentEditingRoleId = roleId;
                document.getElementById('editingRoleName').textContent = roleName;

                try {
                    // ÂèñÂæóÊâÄÊúâÊ¨äÈôê
                    const permsRes = await fetch('/api/admin/rbac/permissions');
                    const permsJson = await permsRes.json();
                    allPermissions = permsJson.data || [];

                    // ÂèñÂæóË©≤ËßíËâ≤Ë≥áË®ä
                    const rolesRes = await fetch('/api/admin/rbac/roles');
                    const rolesJson = await rolesRes.json();
                    const role = (rolesJson.data || []).find(r => r.id === roleId);
                    const rolePermIds = role ? role.permissions.map(p => p.id) : [];

                    // Ê∏≤ÊüìÊ¨äÈôêÂãæÈÅ∏Ê°Ü
                    const container = document.getElementById('permissionCheckboxList');
                    container.innerHTML = allPermissions.map(p => `
                        <label style="display: flex; align-items: center; padding: 8px; border-bottom: 1px solid #eee; cursor: pointer;">
                            <input type="checkbox" value="${p.id}" ${rolePermIds.includes(p.id) ? 'checked' : ''} 
                                   style="margin-right: 10px; width: 18px; height: 18px;" />
                            <span style="flex: 1;">
                                <strong>${p.name}</strong>
                                <small style="color: #888; margin-left: 8px;">${p.code}</small>
                            </span>
                        </label>
                    `).join('');

                    // È°ØÁ§∫ Modal
                    document.getElementById('rolePermissionModal').style.display = 'block';
                } catch (e) {
                    console.error('ËºâÂÖ•Ê¨äÈôêÂ§±Êïó', e);
                    alert('ËºâÂÖ•Ê¨äÈôêÂ§±Êïó');
                }
            }

            function closeRoleModal() {
                document.getElementById('rolePermissionModal').style.display = 'none';
                currentEditingRoleId = null;
            }

            async function saveRolePermissions() {
                if (!currentEditingRoleId) return;

                const checkboxes = document.querySelectorAll('#permissionCheckboxList input[type="checkbox"]:checked');
                const permissionIds = Array.from(checkboxes).map(cb => parseInt(cb.value));

                try {
                    const res = await fetch('/api/admin/rbac/roles/' + currentEditingRoleId, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ permissionIds })
                    });
                    const json = await res.json();
                    if (json.code === 200) {
                        alert('Ê¨äÈôêÊõ¥Êñ∞ÊàêÂäü');
                        closeRoleModal();
                        loadRbacData();
                    } else {
                        alert('Êõ¥Êñ∞Â§±Êïó: ' + json.message);
                    }
                } catch (e) {
                    console.error('ÂÑ≤Â≠òÊ¨äÈôêÂ§±Êïó', e);
                    alert('ÂÑ≤Â≠òÈåØË™§');
                }
            }

            async function createPermission() {
                const code = document.getElementById('new-perm-code').value;
                const name = document.getElementById('new-perm-name').value;
                const description = document.getElementById('new-perm-desc').value;

                const res = await fetch('/api/admin/rbac/permissions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code, name, description })
                });
                const json = await res.json();
                if (json.code === 200) {
                    alert('Âª∫Á´ãÊàêÂäü');
                    loadRbacData();
                } else {
                    alert('Â§±Êïó: ' + json.message);
                }
            }

            async function deletePermission(id) {
                if (!confirm('Á¢∫ÂÆöÂà™Èô§Ê≠§Ê¨äÈôêÔºü')) return;
                await fetch('/api/admin/rbac/permissions/' + id, { method: 'DELETE' });
                loadRbacData();
            }

            // ==================== Á¶ÆÂåÖÁ¢ºÁÆ°ÁêÜ ====================
            async function loadPromoCodes() {
                try {
                    const res = await fetch('/api/admin/promo-codes');
                    const json = await res.json();
                    if (json.success) {
                        const tbody = document.getElementById('promo-codes-table');
                        tbody.innerHTML = json.data.map(c => `
                            <tr>
                                <td>${c.id}</td>
                                <td><code>${c.code}</code></td>
                                <td>${c.name}</td>
                                <td>${c.type === 'GIFT' ? 'Á¶ÆÂåÖ' : 'Êé®Ëñ¶'}</td>
                                <td>${c.rewardValue} ${c.rewardType === 'TOKENS' ? '‰ª£Âπ£' : c.rewardType === 'BONUS' ? 'Á¥ÖÂà©' : 'Á¢éÁâá'}</td>
                                <td>${c.usedCount}/${c.maxUses || '‚àû'}</td>
                                <td>
                                    <span class="badge ${c.enabled ? 'badge-success' : 'badge-secondary'}">${c.enabled ? 'ÂïüÁî®' : 'ÂÅúÁî®'}</span>
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-info" onclick="togglePromoCode(${c.id})">${c.enabled ? 'ÂÅúÁî®' : 'ÂïüÁî®'}</button>
                                    <button class="btn btn-sm btn-danger" onclick="deletePromoCode(${c.id})">Âà™Èô§</button>
                                </td>
                            </tr>
                        `).join('');
                    }
                } catch (e) {
                    console.error('ËºâÂÖ•Á¶ÆÂåÖÁ¢ºÂ§±Êïó', e);
                }
            }

            async function createPromoCode() {
                const name = document.getElementById('promo-name').value;
                const rewardType = document.getElementById('promo-reward-type').value;
                const rewardValue = document.getElementById('promo-reward-value').value;
                const maxUses = document.getElementById('promo-max-uses').value;
                const validUntil = document.getElementById('promo-valid-until').value;
                const description = document.getElementById('promo-description').value;

                if (!name || !rewardValue) {
                    alert('Ë´ãÂ°´ÂØ´Á¶ÆÂåÖÂêçÁ®±ÂíåÁçéÂãµÊï∏Èáè');
                    return;
                }

                try {
                    const res = await fetch('/api/admin/promo-codes', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name, description, rewardType, rewardValue: parseFloat(rewardValue), maxUses: parseInt(maxUses) || 100, validUntil })
                    });
                    const json = await res.json();
                    if (json.success) {
                        alert('Á¶ÆÂåÖÁ¢ºÂª∫Á´ãÊàêÂäü: ' + json.data.code);
                        loadPromoCodes();
                        // Ê∏ÖÁ©∫Ë°®ÂñÆ
                        document.getElementById('promo-name').value = '';
                        document.getElementById('promo-reward-value').value = '';
                        document.getElementById('promo-description').value = '';
                    } else {
                        alert('Âª∫Á´ãÂ§±Êïó: ' + json.message);
                    }
                } catch (e) {
                    console.error('Âª∫Á´ãÁ¶ÆÂåÖÁ¢ºÂ§±Êïó', e);
                }
            }

            async function togglePromoCode(id) {
                await fetch('/api/admin/promo-codes/' + id + '/toggle', { method: 'POST' });
                loadPromoCodes();
            }

            async function deletePromoCode(id) {
                if (!confirm('Á¢∫ÂÆöÂà™Èô§Ê≠§Á¶ÆÂåÖÁ¢ºÔºü')) return;
                await fetch('/api/admin/promo-codes/' + id, { method: 'DELETE' });
                loadPromoCodes();
            }

            // ==================== Á≥ªÁµ±Ë®≠ÂÆöÁÆ°ÁêÜ ====================
            let currentSettings = [];

            async function loadSystemSettings() {
                try {
                    const res = await fetch('/api/admin/settings');
                    const json = await res.json();
                    if (json.success) {
                        currentSettings = json.data;
                        const tbody = document.getElementById('system-settings-table');
                        tbody.innerHTML = json.data.map(s => `
                            <tr>
                                <td><code>${s.key}</code></td>
                                <td>${s.description || '-'}</td>
                                <td>
                                    ${isBooleanSetting(s.key)
                                ? `<select id="setting-${s.key}" class="form-control" style="width: 100px;">
                                            <option value="true" ${s.value === 'true' ? 'selected' : ''}>ÂïüÁî®</option>
                                            <option value="false" ${s.value === 'false' ? 'selected' : ''}>ÂÅúÁî®</option>
                                           </select>`
                                : `<input type="text" id="setting-${s.key}" class="form-control" style="width: 150px;" value="${s.value}" />`
                            }
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-info" onclick="saveSingleSetting('${s.key}')">ÂÑ≤Â≠ò</button>
                                </td>
                            </tr>
                        `).join('');
                    }
                } catch (e) {
                    console.error('ËºâÂÖ•Á≥ªÁµ±Ë®≠ÂÆöÂ§±Êïó', e);
                }
            }

            function isBooleanSetting(key) {
                return key.includes('.enabled') || key === 'captcha.enabled' || key === 'otp.enabled';
            }

            async function saveSingleSetting(key) {
                const input = document.getElementById('setting-' + key);
                if (!input) return;
                const value = input.value;
                try {
                    const res = await fetch('/api/admin/settings/' + encodeURIComponent(key), {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ value })
                    });
                    const json = await res.json();
                    if (json.success) {
                        alert('Ë®≠ÂÆöÂ∑≤ÂÑ≤Â≠ò');
                    } else {
                        alert('ÂÑ≤Â≠òÂ§±Êïó: ' + json.message);
                    }
                } catch (e) {
                    console.error('ÂÑ≤Â≠òË®≠ÂÆöÂ§±Êïó', e);
                }
            }

            async function saveAllSettings() {
                const settings = {};
                currentSettings.forEach(s => {
                    const input = document.getElementById('setting-' + s.key);
                    if (input) {
                        settings[s.key] = input.value;
                    }
                });
                try {
                    const res = await fetch('/api/admin/settings', {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(settings)
                    });
                    const json = await res.json();
                    if (json.success) {
                        alert('ÊâÄÊúâË®≠ÂÆöÂ∑≤ÂÑ≤Â≠ò');
                    } else {
                        alert('ÂÑ≤Â≠òÂ§±Êïó: ' + json.message);
                    }
                } catch (e) {
                    console.error('ÊâπÈáèÂÑ≤Â≠òË®≠ÂÆöÂ§±Êïó', e);
                }
            }

            // ==================== ÊúÉÂì°Ê®ôÁ±§ÁÆ°ÁêÜ ====================
            async function loadMemberTags() {
                try {
                    const res = await fetch('/api/admin/member-tags');
                    const json = await res.json();
                    if (json.success) {
                        const tbody = document.getElementById('member-tags-table');
                        tbody.innerHTML = json.data.map(t => `
                            <tr>
                                <td>${t.id}</td>
                                <td><span style="background: ${t.color}; color: white; padding: 2px 10px; border-radius: 12px;">${t.name}</span></td>
                                <td>${t.description || '-'}</td>
                                <td>${t.type === 'SYSTEM' ? 'Á≥ªÁµ±' : t.type === 'AUTO' ? 'Ëá™Âãï' : 'ÊâãÂãï'}</td>
                                <td>
                                    <button class="btn btn-sm btn-info" onclick="viewTagMembers(${t.id}, '${t.name}')">Êü•ÁúãÊúÉÂì°</button>
                                </td>
                            </tr>
                        `).join('');
                    }
                } catch (e) {
                    console.error('ËºâÂÖ•ÊúÉÂì°Ê®ôÁ±§Â§±Êïó', e);
                }
            }

            async function createMemberTag() {
                const name = document.getElementById('tag-name').value;
                const color = document.getElementById('tag-color').value;
                const description = document.getElementById('tag-description').value;

                if (!name) {
                    alert('Ë´ãÂ°´ÂØ´Ê®ôÁ±§ÂêçÁ®±');
                    return;
                }

                try {
                    const res = await fetch('/api/admin/member-tags', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name, color, description })
                    });
                    const json = await res.json();
                    if (json.success) {
                        alert('Ê®ôÁ±§Âª∫Á´ãÊàêÂäü');
                        loadMemberTags();
                        document.getElementById('tag-name').value = '';
                        document.getElementById('tag-description').value = '';
                    } else {
                        alert('Âª∫Á´ãÂ§±Êïó: ' + json.message);
                    }
                } catch (e) {
                    console.error('Âª∫Á´ãÊ®ôÁ±§Â§±Êïó', e);
                }
            }

            async function viewTagMembers(tagId, tagName) {
                try {
                    const res = await fetch('/api/admin/member-tags/' + tagId + '/members');
                    const json = await res.json();
                    if (json.success) {
                        const count = json.data.length;
                        const sample = json.data.slice(0, 10).join(', ');
                        alert(`Ê®ôÁ±§„Äå${tagName}„ÄçÊúâ ${count} ‰ΩçÊúÉÂì°\n\nÂâç 10 ÂêçÊúÉÂì° ID: ${sample || 'ÁÑ°'}`);
                    }
                } catch (e) {
                    console.error('Êü•Ë©¢Ê®ôÁ±§ÊúÉÂì°Â§±Êïó', e);
                }
            }

            // ==================== Á≥ªÁµ±ÂÖ¨Âëä ====================
            async function loadAnnouncementTags() {
                try {
                    const res = await fetch('/api/admin/member-tags');
                    const json = await res.json();
                    if (json.success) {
                        const select = document.getElementById('ann-target');
                        select.innerHTML = '<option value="all">ÊâÄÊúâÊúÉÂì°</option>' +
                            json.data.map(t => `<option value="tag-${t.id}">Ê®ôÁ±§Ôºö${t.name}</option>`).join('');
                    }
                } catch (e) {
                    console.error('ËºâÂÖ•Ê®ôÁ±§ÂàóË°®Â§±Êïó', e);
                }
            }

            async function sendAnnouncement() {
                const title = document.getElementById('ann-title').value;
                const content = document.getElementById('ann-content').value;
                const target = document.getElementById('ann-target').value;

                if (!title || !content) {
                    alert('Ë´ãÂ°´ÂØ´Ê®ôÈ°åÂíåÂÖßÂÆπ');
                    return;
                }

                if (!confirm('Á¢∫ÂÆöÁôºÈÄÅÂÖ¨ÂëäÔºüÊ≠§Êìç‰ΩúÁÑ°Ê≥ïÊí§Èä∑„ÄÇ')) return;

                try {
                    let url = '/api/admin/announcements/broadcast';
                    if (target.startsWith('tag-')) {
                        const tagId = target.replace('tag-', '');
                        url = '/api/admin/announcements/broadcast-by-tag/' + tagId;
                    }
                    const res = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ title, content })
                    });
                    const json = await res.json();
                    if (json.success) {
                        alert('ÂÖ¨ÂëäÁôºÈÄÅÊàêÂäüÔºÅÂ∑≤ÁôºÈÄÅÁµ¶ ' + json.data.sentCount + ' ‰ΩçÊúÉÂì°');
                        document.getElementById('ann-title').value = '';
                        document.getElementById('ann-content').value = '';
                    } else {
                        alert('ÁôºÈÄÅÂ§±Êïó: ' + json.message);
                    }
                } catch (e) {
                    console.error('ÁôºÈÄÅÂÖ¨ÂëäÂ§±Êïó', e);
                }
            }

            // ==================== ÈÄèÊòéÈ©óË≠âÊü•Ë©¢ ====================
            let currentVerifyId = null;

            async function loadTransparencyData() {
                try {
                    const res = await fetch('/api/admin/transparency/completed');
                    const json = await res.json();
                    if (json.success) {
                        const tbody = document.getElementById('transparency-table');
                        tbody.innerHTML = json.data.map(v => `
                            <tr>
                                <td>${v.id}</td>
                                <td>${v.gameType}</td>
                                <td>${v.gameId}</td>
                                <td>${v.gameName}</td>
                                <td>${v.completedAt || '-'}</td>
                                <td>
                                    <button class="btn btn-sm btn-info" onclick="showHashVerify(${v.id}, '${v.hashValue}')">È©óË≠âÂìàÂ∏å</button>
                                </td>
                            </tr>
                        `).join('') || '<tr><td colspan="6" style="text-align: center;">Êö´ÁÑ°Â∑≤ÂÆåÂîÆÈÅäÊà≤</td></tr>';
                    }
                } catch (e) {
                    console.error('ËºâÂÖ•ÈÄèÊòéÈ©óË≠âË≥áÊñôÂ§±Êïó', e);
                }
            }

            function showHashVerify(id, hashValue) {
                currentVerifyId = id;
                document.getElementById('hashDisplayValue').textContent = hashValue;
                document.getElementById('hashVerifyInput').value = '';
                document.getElementById('hashVerifyResult').textContent = '';
                document.getElementById('hashVerifyModal').style.display = 'block';
            }

            function closeHashModal() {
                document.getElementById('hashVerifyModal').style.display = 'none';
            }

            async function verifyHash() {
                const hash = document.getElementById('hashVerifyInput').value;
                if (!hash) {
                    alert('Ë´ãËº∏ÂÖ•ÂìàÂ∏åÂÄº');
                    return;
                }
                try {
                    const res = await fetch('/api/admin/transparency/verify/' + currentVerifyId, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ hash })
                    });
                    const json = await res.json();
                    if (json.success) {
                        const result = document.getElementById('hashVerifyResult');
                        result.textContent = json.data.message;
                        result.style.color = json.data.valid ? '#4CAF50' : '#f44336';
                    }
                } catch (e) {
                    console.error('È©óË≠âÂ§±Êïó', e);
                }
            }

            // Áï∂ÂàáÊèõÂà∞‰∏çÂêå Tab ÊôÇËºâÂÖ•Ë≥áÊñô
            const origOpenTab = window.openTab;
            window.openTab = function (tabName) {
                origOpenTab(tabName);
                if (tabName === 'rbac') {
                    loadRbacData();
                }
                if (tabName === 'promo-codes') {
                    loadPromoCodes();
                }
                if (tabName === 'platform') {
                    loadSystemSettings();
                }
                if (tabName === 'member-tags') {
                    loadMemberTags();
                }
                if (tabName === 'announcements') {
                    loadAnnouncementTags();
                }
                if (tabName === 'transparency') {
                    loadTransparencyData();
                }
                if (tabName === 'payment-orders') {
                    loadPaymentOrders();
                }
            };

            // ==================== ÈáëÊµÅË®ÇÂñÆÁÆ°ÁêÜ ====================
            async function loadPaymentOrders() {
                try {
                    // ËºâÂÖ•Áµ±Ë®à
                    const summaryRes = await fetch('/api/admin/payments/summary');
                    const summaryJson = await summaryRes.json();
                    if (summaryJson.success) {
                        const d = summaryJson.data;
                        document.getElementById('po-total').textContent = d.totalOrders;
                        document.getElementById('po-pending').textContent = d.pendingOrders;
                        document.getElementById('po-paid').textContent = d.paidOrders;
                        document.getElementById('po-failed').textContent = d.failedOrders;
                    }

                    // ËºâÂÖ•Ë®ÇÂñÆ
                    const ordersRes = await fetch('/api/admin/payments/orders');
                    const ordersJson = await ordersRes.json();
                    if (ordersJson.success) {
                        renderPaymentOrders(ordersJson.data);
                    }
                } catch (e) {
                    console.error('ËºâÂÖ•ÈáëÊµÅË®ÇÂñÆÂ§±Êïó', e);
                }
            }

            function renderPaymentOrders(orders) {
                const tbody = document.getElementById('payment-orders-table');
                tbody.innerHTML = orders.map(o => `
                    <tr>
                        <td>${o.orderNo}</td>
                        <td>${o.memberId}</td>
                        <td>$${o.amount}</td>
                        <td>${o.method || '-'}</td>
                        <td><span class="status-badge status-${o.status.toLowerCase()}">${o.status}</span></td>
                        <td>${o.createdAt ? o.createdAt.substring(0, 16).replace('T', ' ') : '-'}</td>
                    </tr>
                `).join('') || '<tr><td colspan="6" style="text-align: center;">Êö´ÁÑ°Ë®ÇÂñÆ</td></tr>';
            }

            async function filterOrders() {
                const filter = document.getElementById('po-filter').value;
                let url = '/api/admin/payments/orders';
                if (filter !== 'all') {
                    url = '/api/admin/payments/orders/status/' + filter;
                }
                try {
                    const res = await fetch(url);
                    const json = await res.json();
                    if (json.success) {
                        renderPaymentOrders(json.data);
                    }
                } catch (e) {
                    console.error('ÁØ©ÈÅ∏Ë®ÇÂñÆÂ§±Êïó', e);
                }
            }

            // ==================== ÂÑ™ÊÉ†Âà∏ÊâπÈáèÁôºÊîæ ====================
            let currentDistCouponId = null;

            function openDistributeModal(couponId, couponName) {
                currentDistCouponId = couponId;
                document.getElementById('distributeTitle').textContent = 'Ê¥æÁôºÂÑ™ÊÉ†Âà∏Ôºö' + couponName;
                document.getElementById('distCouponIdLevel').value = couponId;
                document.getElementById('distCouponIdMember').value = couponId;
                document.getElementById('distTagResult').textContent = '';
                // ËºâÂÖ•Ê®ôÁ±§ÂàóË°®
                loadTagsForDistribute();
                document.getElementById('distributeCouponModal').style.display = 'block';
            }

            async function loadTagsForDistribute() {
                try {
                    const res = await fetch('/api/admin/member-tags');
                    const json = await res.json();
                    if (json.success) {
                        const select = document.getElementById('distTagId');
                        select.innerHTML = '<option value="">ÈÅ∏ÊìáÊ®ôÁ±§</option>' +
                            json.data.map(t => `<option value="${t.id}">${t.name}</option>`).join('');
                    }
                } catch (e) {
                    console.error('ËºâÂÖ•Ê®ôÁ±§Â§±Êïó', e);
                }
            }

            async function distributeByTag() {
                const tagId = document.getElementById('distTagId').value;
                if (!tagId) {
                    alert('Ë´ãÈÅ∏ÊìáÊ®ôÁ±§');
                    return;
                }
                if (!currentDistCouponId) {
                    alert('Ë´ãÈáçÊñ∞ÈñãÂïüÊ¥æÁôºË¶ñÁ™ó');
                    return;
                }
                try {
                    const res = await fetch('/api/admin/coupons/' + currentDistCouponId + '/distribute-by-tag/' + tagId, {
                        method: 'POST'
                    });
                    const json = await res.json();
                    if (json.success) {
                        document.getElementById('distTagResult').textContent =
                            'ÊàêÂäüÊ¥æÁôºÁµ¶ ' + json.data.successCount + ' / ' + json.data.totalMembers + ' ‰ΩçÊúÉÂì°';
                    } else {
                        document.getElementById('distTagResult').textContent = 'Ê¥æÁôºÂ§±Êïó: ' + json.message;
                        document.getElementById('distTagResult').style.color = '#e74c3c';
                    }
                } catch (e) {
                    console.error('ÊâπÈáèÊ¥æÁôºÂ§±Êïó', e);
                }
            }

            // ==================== Êó•Ë™åÈÅéÊøæ ====================
            let allLogsData = []; // ÂÑ≤Â≠òÂéüÂßãÊó•Ë™åË≥áÊñô

            function filterLogs() {
                const userSearch = document.getElementById('log-search-user').value.toLowerCase();
                const actionFilter = document.getElementById('log-filter-action').value;
                const dateFrom = document.getElementById('log-date-from').value;
                const dateTo = document.getElementById('log-date-to').value;

                const tbody = document.getElementById('logs-table-body');
                const rows = tbody.querySelectorAll('tr');

                rows.forEach(row => {
                    const cells = row.querySelectorAll('td');
                    if (cells.length === 0) return;

                    const username = cells[1]?.textContent?.toLowerCase() || '';
                    const action = cells[2]?.textContent || '';
                    const timestamp = cells[5]?.textContent || '';

                    let show = true;

                    // Áî®Êà∂ÂêçÊêúÂ∞ã
                    if (userSearch && !username.includes(userSearch)) {
                        show = false;
                    }

                    // Âãï‰ΩúÈ°ûÂûãÈÅéÊøæ
                    if (actionFilter && !action.includes(actionFilter)) {
                        show = false;
                    }

                    // Êó•ÊúüÁØÑÂúçÈÅéÊøæ
                    if (dateFrom && timestamp) {
                        const logDate = timestamp.split(' ')[0];
                        if (logDate < dateFrom) show = false;
                    }
                    if (dateTo && timestamp) {
                        const logDate = timestamp.split(' ')[0];
                        if (logDate > dateTo) show = false;
                    }

                    row.style.display = show ? '' : 'none';
                });
            }

            function clearLogFilters() {
                document.getElementById('log-search-user').value = '';
                document.getElementById('log-filter-action').value = '';
                document.getElementById('log-date-from').value = '';
                document.getElementById('log-date-to').value = '';

                const tbody = document.getElementById('logs-table-body');
                const rows = tbody.querySelectorAll('tr');
                rows.forEach(row => row.style.display = '');
            }

            // ==================== ÊúÉÂì°ÂåØÂá∫ ====================
            function exportMembersCSV() {
                const table = document.getElementById('members-table');
                if (!table) {
                    alert('ÁÑ°Ê≥ïÂèñÂæóÊúÉÂì°Ë°®Ê†º');
                    return;
                }

                let csv = [];
                const rows = table.querySelectorAll('tr');

                rows.forEach(row => {
                    const cells = row.querySelectorAll('th, td');
                    const rowData = [];
                    cells.forEach((cell, index) => {
                        // ÊéíÈô§Êìç‰ΩúÊ¨Ñ
                        if (index < cells.length - 1) {
                            let text = cell.textContent.trim().replace(/"/g, '""');
                            rowData.push('"' + text + '"');
                        }
                    });
                    csv.push(rowData.join(','));
                });

                const csvContent = '\uFEFF' + csv.join('\n'); // BOM for Excel
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);

                link.setAttribute('href', url);
                link.setAttribute('download', 'members_' + new Date().toISOString().split('T')[0] + '.csv');
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        </script>
    </div>
</body>

</html>