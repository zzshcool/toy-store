<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="~{admin_layout :: html(title='ç®¡ç†å¾Œå°', content=~{::content})}">

<body>
    <div th:fragment="content">
        <!-- éŒ¯èª¤è¨Šæ¯ -->
        <div th:if="${errorMessage}" class="alert alert-danger"
            style="color: red; padding: 10px; border: 1px solid red; margin-bottom: 10px;">
            <b th:text="${errorMessage}">Error</b>
        </div>

        <!-- History Modal -->
        <div id="historyModal" class="modal"
            style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5);">
            <div class="modal-content"
                style="background: white; margin: 10% auto; padding: 30px; border-radius: 10px; max-width: 600px; position: relative;">
                <span onclick="document.getElementById('historyModal').style.display='none'"
                    style="position: absolute; top: 10px; right: 15px; cursor: pointer; font-size: 24px;">&times;</span>
                <h3 style="margin-bottom: 20px;">ğŸ“‹ æœƒå“¡è©³ç´°è³‡è¨Š</h3>
                <div id="historyModalContent">
                    <!-- Content will be loaded dynamically -->
                </div>
            </div>
        </div>

        <!-- Member Management -->
        <div th:replace="~{admin/members :: content}"></div>

        <!-- Product Management -->
        <div th:replace="~{admin/products :: content}"></div>

        <!-- Member Level Management -->
        <!-- Member Levels -->
        <div th:replace="~{admin/levels :: content}"></div>

        <!-- Category Management -->
        <div th:replace="~{admin/categories :: content}"></div>

        <!-- Mystery Box Management -->
        <div th:replace="~{admin/mystery :: content}"></div>

        <!-- Transaction Management -->
        <div th:replace="~{admin/transactions :: content}"></div>

        <!-- Activity Management -->
        <div th:replace="~{admin/activities :: content}"></div>

        <!-- Coupon Management -->
        <div th:replace="~{admin/coupons :: content}"></div>

        <!-- Logs -->
        <div th:replace="~{admin/logs :: content}"></div>

        <!-- ==================== æŠ½çç³»çµ±ç®¡ç† ==================== -->

        <!-- IP ä¸»é¡Œç®¡ç† -->
        <div id="gacha-ips" class="tab-content" style="display:none;">
            <h3>ğŸ® IP ä¸»é¡Œç®¡ç†</h3>
            <div class="card" style="padding: 20px; margin-bottom: 20px;">
                <h4>æ–°å¢ IP ä¸»é¡Œ</h4>
                <form th:action="@{/admin/gacha/ips/create}" method="post">
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                        <input type="text" name="name" placeholder="IP åç¨±" class="form-control" required />
                        <input type="text" name="description" placeholder="æè¿°" class="form-control" />
                        <input type="text" name="imageUrl" placeholder="åœ–ç‰‡ç¶²å€" class="form-control" />
                    </div>
                    <button type="submit" class="btn btn-primary" style="margin-top: 10px;">æ–°å¢</button>
                </form>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>åç¨±</th>
                        <th>æè¿°</th>
                        <th>ç‹€æ…‹</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="ip : ${gachaIps}">
                        <td th:text="${ip.id}">1</td>
                        <td th:text="${ip.name}">é¬¼æ»…ä¹‹åˆƒ</td>
                        <td th:text="${ip.description}">æè¿°</td>
                        <td>
                            <span
                                th:class="${ip.status.name() == 'ACTIVE' ? 'badge badge-success' : 'badge badge-secondary'}"
                                th:text="${ip.status.name() == 'ACTIVE' ? 'å•Ÿç”¨' : 'åœç”¨'}">Active</span>
                        </td>
                        <td>
                            <form th:action="@{/admin/gacha/ips/{id}/toggle(id=${ip.id})}" method="post"
                                style="display:inline;">
                                <button type="submit" class="btn btn-sm btn-info"
                                    th:text="${ip.status.name() == 'ACTIVE' ? 'åœç”¨' : 'å•Ÿç”¨'}">Toggle</button>
                            </form>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- ä¸€ç•ªè³ç®¡ç† -->
        <div id="gacha-ichiban" class="tab-content" style="display:none;">
            <h3>ğŸ¯ ä¸€ç•ªè³ç®¡ç†</h3>
            <div class="card" style="padding: 20px; margin-bottom: 20px;">
                <h4>æ–°å¢ä¸€ç•ªè³ç®±é«”</h4>
                <form th:action="@{/admin/gacha/ichiban/create}" method="post">
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 10px;">
                        <select name="ipId" class="form-control" required>
                            <option value="">é¸æ“‡ IP ä¸»é¡Œ</option>
                            <option th:each="ip : ${gachaIps}" th:if="${ip.status.name() == 'ACTIVE'}"
                                th:value="${ip.id}" th:text="${ip.name}"></option>
                        </select>
                        <input type="text" name="name" placeholder="ç®±é«”åç¨±" class="form-control" required />
                        <input type="number" step="0.01" name="pricePerDraw" placeholder="å–®æŠ½åƒ¹æ ¼" class="form-control"
                            required />
                        <input type="number" name="totalSlots" placeholder="ç¸½æ ¼æ•¸" class="form-control" required />
                    </div>
                    <button type="submit" class="btn btn-primary" style="margin-top: 10px;">å»ºç«‹ç®±é«”</button>
                </form>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>IP</th>
                        <th>åç¨±</th>
                        <th>å–®åƒ¹</th>
                        <th>æ ¼æ•¸</th>
                        <th>ç‹€æ…‹</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="box : ${ichibanBoxes}">
                        <td th:text="${box.id}">1</td>
                        <td th:text="${box.ip != null ? box.ip.name : '-'}">IP</td>
                        <td th:text="${box.name}">Box</td>
                        <td th:text="'$' + ${box.pricePerDraw}">$680</td>
                        <td th:text="${box.totalSlots}">20</td>
                        <td>
                            <span
                                th:class="${box.status.name() == 'ACTIVE' ? 'badge badge-success' : (box.status.name() == 'SOLD_OUT' ? 'badge badge-danger' : 'badge badge-secondary')}"
                                th:text="${box.status.name()}">Status</span>
                        </td>
                        <td>
                            <a th:href="@{/admin/gacha/ichiban/{id}/prizes(id=${box.id})}"
                                class="btn btn-sm btn-info">çå“è¨­å®š</a>
                            <form th:if="${box.status.name() == 'DRAFT'}"
                                th:action="@{/admin/gacha/ichiban/{id}/activate(id=${box.id})}" method="post"
                                style="display:inline;">
                                <button type="submit" class="btn btn-sm btn-success">ä¸Šæ¶</button>
                            </form>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- è½‰ç›¤ç®¡ç† -->
        <div id="gacha-roulette" class="tab-content" style="display:none;">
            <h3>ğŸ¡ è½‰ç›¤ç®¡ç†</h3>
            <div class="card" style="padding: 20px; margin-bottom: 20px;">
                <h4>æ–°å¢è½‰ç›¤éŠæˆ²</h4>
                <form th:action="@{/admin/gacha/roulette/create}" method="post">
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 10px;">
                        <select name="ipId" class="form-control" required>
                            <option value="">é¸æ“‡ IP ä¸»é¡Œ</option>
                            <option th:each="ip : ${gachaIps}" th:if="${ip.status.name() == 'ACTIVE'}"
                                th:value="${ip.id}" th:text="${ip.name}"></option>
                        </select>
                        <input type="text" name="name" placeholder="è½‰ç›¤åç¨±" class="form-control" required />
                        <input type="number" step="0.01" name="pricePerSpin" placeholder="å–®è½‰åƒ¹æ ¼" class="form-control"
                            required />
                        <input type="number" name="totalSlots" placeholder="çæ ¼æ•¸(8-12)" class="form-control" required />
                    </div>
                    <button type="submit" class="btn btn-primary" style="margin-top: 10px;">å»ºç«‹è½‰ç›¤</button>
                </form>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>IP</th>
                        <th>åç¨±</th>
                        <th>å–®åƒ¹</th>
                        <th>çæ ¼æ•¸</th>
                        <th>ç‹€æ…‹</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="game : ${rouletteGames}">
                        <td th:text="${game.id}">1</td>
                        <td th:text="${game.ip != null ? game.ip.name : '-'}">IP</td>
                        <td th:text="${game.name}">Game</td>
                        <td th:text="'$' + ${game.pricePerSpin}">$100</td>
                        <td th:text="${game.totalSlots}">8</td>
                        <td>
                            <span
                                th:class="${game.status.name() == 'ACTIVE' ? 'badge badge-success' : 'badge badge-secondary'}"
                                th:text="${game.status.name()}">Status</span>
                        </td>
                        <td>
                            <a th:href="@{/admin/gacha/roulette/{id}/slots(id=${game.id})}"
                                class="btn btn-sm btn-info">çæ ¼è¨­å®š</a>
                            <form th:if="${game.status.name() == 'DRAFT'}"
                                th:action="@{/admin/gacha/roulette/{id}/activate(id=${game.id})}" method="post"
                                style="display:inline;">
                                <button type="submit" class="btn btn-sm btn-success">ä¸Šæ¶</button>
                            </form>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- ä¹å®®æ ¼ç®¡ç† -->
        <div id="gacha-bingo" class="tab-content" style="display:none;">
            <h3>ğŸ² ä¹å®®æ ¼ç®¡ç†</h3>
            <div class="card" style="padding: 20px; margin-bottom: 20px;">
                <h4>æ–°å¢ä¹å®®æ ¼éŠæˆ²</h4>
                <form th:action="@{/admin/gacha/bingo/create}" method="post">
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr 1fr; gap: 10px;">
                        <select name="ipId" class="form-control" required>
                            <option value="">é¸æ“‡ IP ä¸»é¡Œ</option>
                            <option th:each="ip : ${gachaIps}" th:if="${ip.status.name() == 'ACTIVE'}"
                                th:value="${ip.id}" th:text="${ip.name}"></option>
                        </select>
                        <input type="text" name="name" placeholder="éŠæˆ²åç¨±" class="form-control" required />
                        <input type="number" step="0.01" name="pricePerDig" placeholder="å–®æŒ–åƒ¹æ ¼" class="form-control"
                            required />
                        <select name="gridSize" class="form-control" required>
                            <option value="3">3x3</option>
                            <option value="4">4x4</option>
                            <option value="5">5x5</option>
                        </select>
                        <input type="text" name="bingoRewardName" placeholder="é€£ç·šçå‹µ" class="form-control" />
                    </div>
                    <button type="submit" class="btn btn-primary" style="margin-top: 10px;">å»ºç«‹ä¹å®®æ ¼</button>
                </form>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>IP</th>
                        <th>åç¨±</th>
                        <th>å–®åƒ¹</th>
                        <th>å°ºå¯¸</th>
                        <th>ç‹€æ…‹</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="game : ${bingoGames}">
                        <td th:text="${game.id}">1</td>
                        <td th:text="${game.ip != null ? game.ip.name : '-'}">IP</td>
                        <td th:text="${game.name}">Game</td>
                        <td th:text="'$' + ${game.pricePerDig}">$80</td>
                        <td th:text="${game.gridSize + 'x' + game.gridSize}">3x3</td>
                        <td>
                            <span
                                th:class="${game.status.name() == 'ACTIVE' ? 'badge badge-success' : 'badge badge-secondary'}"
                                th:text="${game.status.name()}">Status</span>
                        </td>
                        <td>
                            <a th:href="@{/admin/gacha/bingo/{id}/cells(id=${game.id})}"
                                class="btn btn-sm btn-info">æ ¼å­è¨­å®š</a>
                            <form th:if="${game.status.name() == 'DRAFT'}"
                                th:action="@{/admin/gacha/bingo/{id}/activate(id=${game.id})}" method="post"
                                style="display:inline;">
                                <button type="submit" class="btn btn-sm btn-success">ä¸Šæ¶</button>
                            </form>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- ç¢ç‰‡å•†åº—ç®¡ç† -->
        <div id="gacha-redeem" class="tab-content" style="display:none;">
            <h3>ğŸ’ ç¢ç‰‡å•†åº—ç®¡ç†</h3>
            <div class="card" style="padding: 20px; margin-bottom: 20px;">
                <h4>æ–°å¢å…Œæ›å•†å“</h4>
                <form th:action="@{/admin/gacha/redeem/create}" method="post">
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr 1fr; gap: 10px;">
                        <input type="text" name="name" placeholder="å•†å“åç¨±" class="form-control" required />
                        <input type="number" name="shardCost" placeholder="ç¢ç‰‡åƒ¹æ ¼" class="form-control" required />
                        <input type="number" step="0.01" name="estimatedValue" placeholder="ä¼°è¨ˆåƒ¹å€¼" class="form-control"
                            required />
                        <input type="number" name="stock" placeholder="åº«å­˜" class="form-control" required />
                        <select name="itemType" class="form-control" required>
                            <option value="S_RANK">Sç´šçå“</option>
                            <option value="HIDDEN">éš±è—ç‰ˆ</option>
                            <option value="SPECIAL">ç‰¹å…¸</option>
                            <option value="PRIZE">å‘¨é‚Š</option>
                        </select>
                    </div>
                    <div style="margin-top: 10px;">
                        <input type="text" name="imageUrl" placeholder="åœ–ç‰‡ç¶²å€" class="form-control" />
                    </div>
                    <button type="submit" class="btn btn-primary" style="margin-top: 10px;">æ–°å¢å•†å“</button>
                </form>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>åç¨±</th>
                        <th>é¡å‹</th>
                        <th>ç¢ç‰‡åƒ¹æ ¼</th>
                        <th>åº«å­˜</th>
                        <th>ç‹€æ…‹</th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="item : ${redeemItems}">
                        <td th:text="${item.id}">1</td>
                        <td th:text="${item.name}">å•†å“</td>
                        <td th:text="${item.itemType}">S_RANK</td>
                        <td th:text="${item.shardCost}">1000</td>
                        <td th:text="${item.stock + '/' + item.totalStock}">5/10</td>
                        <td>
                            <span
                                th:class="${item.status.name() == 'ACTIVE' ? 'badge badge-success' : 'badge badge-secondary'}"
                                th:text="${item.status.name()}">Active</span>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- å¹³å°è¨­å®š -->
        <div id="platform" class="tab-content" style="display:none;">
            <h3>å¹³å°è¨­å®š</h3>

            <!-- è¼ªæ’­åœ–ç®¡ç† -->
            <div class="card" style="padding: 20px; margin-bottom: 20px;">
                <h4>è¼ªæ’­åœ–ç®¡ç†</h4>
                <form th:action="@{/admin/carousel/create}" method="post" style="margin-bottom: 15px;">
                    <div style="display: grid; grid-template-columns: 2fr 1fr auto; gap: 10px; align-items: end;">
                        <div>
                            <label>åœ–ç‰‡ç¶²å€</label>
                            <input type="text" name="imageUrl" placeholder="https://..." class="form-control"
                                required />
                        </div>
                        <div>
                            <label>é€£çµç¶²å€</label>
                            <input type="text" name="linkUrl" placeholder="/products æˆ– https://..."
                                class="form-control" />
                        </div>
                        <button type="submit" class="btn btn-primary">æ–°å¢</button>
                    </div>
                </form>
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>é è¦½</th>
                            <th>é€£çµ</th>
                            <th>æ’åº</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="slide : ${carouselSlides}">
                            <td th:text="${slide.id}">1</td>
                            <td><img th:src="${slide.imageUrl}" style="height: 50px; border-radius: 4px;" /></td>
                            <td th:text="${slide.linkUrl ?: '-'}">-</td>
                            <td th:text="${slide.sortOrder}">0</td>
                            <td>
                                <form th:action="@{/admin/carousel/{id}/delete(id=${slide.id})}" method="post"
                                    style="display:inline;">
                                    <button type="submit" class="btn btn-sm btn-danger"
                                        onclick="return confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')">åˆªé™¤</button>
                                </form>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- ç²¾é¸å•†å“ç®¡ç† -->
            <div class="card" style="padding: 20px; margin-bottom: 20px;">
                <h4>ç²¾é¸å•†å“ï¼ˆæ–°å“/ç†±è³£ï¼‰</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <h5>æ–°å“æ¨è–¦</h5>
                        <ul>
                            <li th:each="item : ${newArrivals}" th:text="${item.product.name}">å•†å“å</li>
                        </ul>
                    </div>
                    <div>
                        <h5>ç†±è³£æ’è¡Œ</h5>
                        <ul>
                            <li th:each="item : ${bestSellers}" th:text="${item.product.name}">å•†å“å</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- ç³»çµ±è¨­å®š -->
            <div class="card" style="padding: 20px;">
                <h4>ç³»çµ±è¨­å®š</h4>
                <p style="color: #888; font-size: 0.9rem; margin-bottom: 15px;">åŠŸèƒ½é–‹é—œèˆ‡éŠæˆ²åƒæ•¸é…ç½®</p>
                <table>
                    <thead>
                        <tr>
                            <th>è¨­å®šé …</th>
                            <th>èªªæ˜</th>
                            <th>ç›®å‰å€¼</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="system-settings-table">
                        <!-- å‹•æ…‹è¼‰å…¥ -->
                    </tbody>
                </table>
                <div style="margin-top: 15px; text-align: right;">
                    <button class="btn btn-primary" onclick="saveAllSettings()">å„²å­˜æ‰€æœ‰è¨­å®š</button>
                </div>
            </div>
        </div>

        <!-- ç¦®åŒ…ç¢¼ç®¡ç† -->
        <div th:replace="~{admin/promo-codes :: content}"></div>

        <!-- RBAC æ¬Šé™ç®¡ç† -->
        <div id="rbac" class="tab-content" style="display:none;">
            <h3>è§’è‰²æ¬Šé™ç®¡ç†</h3>

            <!-- è§’è‰²åˆ—è¡¨ -->
            <div class="card" style="padding: 20px; margin-bottom: 20px;">
                <h4>è§’è‰²åˆ—è¡¨</h4>
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <input type="text" id="new-role-name" placeholder="æ–°è§’è‰²åç¨±" class="form-control"
                        style="width: 200px;" />
                    <select id="new-role-perms" class="form-control" style="width: 300px;" multiple>
                        <!-- å‹•æ…‹è¼‰å…¥æ¬Šé™é¸é … -->
                    </select>
                    <button class="btn btn-primary" onclick="createRole()">æ–°å¢è§’è‰²</button>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>è§’è‰²åç¨±</th>
                            <th>æ¬Šé™</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="rbac-roles-table">
                        <!-- å‹•æ…‹è¼‰å…¥ -->
                    </tbody>
                </table>
            </div>

            <!-- æ¬Šé™åˆ—è¡¨ -->
            <div class="card" style="padding: 20px;">
                <h4>æ¬Šé™åˆ—è¡¨</h4>
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <input type="text" id="new-perm-code" placeholder="æ¬Šé™ä»£ç¢¼ (å¦‚ MEMBER_VIEW)" class="form-control"
                        style="width: 200px;" />
                    <input type="text" id="new-perm-name" placeholder="æ¬Šé™åç¨±" class="form-control"
                        style="width: 200px;" />
                    <input type="text" id="new-perm-desc" placeholder="æè¿° (å¯é¸)" class="form-control"
                        style="width: 200px;" />
                    <button class="btn btn-primary" onclick="createPermission()">æ–°å¢æ¬Šé™</button>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>æ¬Šé™ä»£ç¢¼</th>
                            <th>æ¬Šé™åç¨±</th>
                            <th>æè¿°</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="rbac-perms-table">
                        <!-- å‹•æ…‹è¼‰å…¥ -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- æœƒå“¡æ¨™ç±¤ç®¡ç† -->
        <div th:replace="~{admin/member-tags :: content}"></div>

        <!-- ç³»çµ±å…¬å‘Š -->
        <div th:replace="~{admin/announcements :: content}"></div>

        <!-- é€æ˜é©—è­‰æŸ¥è©¢ -->
        <div th:replace="~{admin/transparency :: content}"></div>

        <!-- è§’è‰²æ¬Šé™ç·¨è¼¯ Modal -->
        <div id="rolePermissionModal" class="modal">
            <div class="modal-content" style="max-width: 500px;">
                <span class="modal-close" onclick="closeRoleModal()">&times;</span>
                <div class="modal-header">
                    <h3>ç·¨è¼¯è§’è‰²æ¬Šé™: <span id="editingRoleName"></span></h3>
                </div>
                <div id="permissionCheckboxList" style="max-height: 400px; overflow-y: auto;">
                    <!-- å‹•æ…‹ç”Ÿæˆæ¬Šé™å‹¾é¸æ¡† -->
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeRoleModal()">å–æ¶ˆ</button>
                    <button class="btn btn-primary" onclick="saveRolePermissions()">å„²å­˜æ¬Šé™</button>
                </div>
            </div>
        </div>

        <!-- Edit Member Level Modal -->
        <div id="editLevelModal" class="modal"
            style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5);">
            <div class="card" style="margin: 10% auto; width: 40%; padding: 20px;">
                <h4>ç·¨è¼¯ç­‰ç´š</h4>
                <form th:action="@{/admin/member-levels/update}" method="post">
                    <input type="hidden" id="editLvlId" name="id">
                    <div style="display: grid; gap: 10px;">
                        <label>ç­‰ç´šåç¨±</label>
                        <input type="text" id="editLvlName" name="name" class="form-control" required />
                        <label>æ’åº</label>
                        <input type="number" id="editLvlSort" name="sortOrder" class="form-control" required />
                        <label>ç´¯ç©å„²å€¼é–€æª»</label>
                        <input type="number" step="0.01" id="editLvlThreshold" name="threshold" class="form-control"
                            required />
                        <label>æ¯æœˆçå‹µ</label>
                        <input type="text" id="editLvlReward" name="monthlyReward" class="form-control" />
                        <label>ç‹€æ…‹</label>
                        <select id="editLvlEnabled" name="enabled" class="form-control">
                            <option value="true">å•Ÿç”¨</option>
                            <option value="false">åœç”¨</option>
                        </select>
                    </div>
                    <div style="margin-top: 10px; display: flex; justify-content: flex-end; gap: 10px;">
                        <button type="button" class="btn btn-secondary"
                            onclick="document.getElementById('editLevelModal').style.display='none'">å–æ¶ˆ</button>
                        <button type="submit" class="btn btn-primary">å„²å­˜</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Edit Member Modal -->
        <div id="editMemberModal" class="modal"
            style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5);">
            <div class="card" style="margin: 10% auto; width: 40%; padding: 20px;">
                <h4>ç·¨è¼¯æœƒå“¡</h4>
                <form th:action="@{/admin/members/update}" method="post">
                    <input type="hidden" id="editMemberId" name="id">
                    <div style="display: grid; gap: 10px;">
                        <label>Email</label>
                        <input type="text" id="editMemberEmail" name="email" class="form-control" />
                        <label>æš±ç¨±</label>
                        <input type="text" id="editMemberName" name="nickname" class="form-control" />
                        <label>ç‹€æ…‹</label>
                        <select id="editMemberStatus" name="enabled" class="form-control">
                            <option value="true">å•Ÿç”¨</option>
                            <option value="false">åœç”¨</option>
                        </select>
                        <label>ç­‰ç´š</label>
                        <select id="editMemberLevel" name="level" class="form-control">
                            <option value="">é¸æ“‡ç­‰ç´š</option>
                            <option th:each="lvl : ${memberLevels}" th:value="${lvl.id}" th:text="${lvl.name}"></option>
                        </select>
                    </div>
                    <div style="margin-top: 10px; display: flex; justify-content: flex-end; gap: 10px;">
                        <button type="button" class="btn btn-secondary"
                            onclick="document.getElementById('editMemberModal').style.display='none'">å–æ¶ˆ</button>
                        <button type="submit" class="btn btn-primary">å„²å­˜</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- ç‰©æµç®¡ç† Tab -->
        <div th:replace="~{admin/logistics :: content}"></div>

        <!-- é‡‘æµè¨‚å–®ç®¡ç† -->
        <div th:replace="~{admin/payment-orders :: content}"></div>

        <!-- å„€è¡¨æ¿ç¸½è¦½ Tab -->
        <div id="dashboard-overview" class="tab-content" style="display:none;">
            <h3>ğŸ“Š ç‡Ÿé‹å„€è¡¨æ¿</h3>
            <div id="dashboard-kpi"
                style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px;">
                <div class="card" style="padding: 20px; text-align: center;">
                    <div style="font-size: 2rem; color: #667eea; font-weight: bold;" id="kpi-members">-</div>
                    <div style="color: #888;">ç¸½æœƒå“¡æ•¸</div>
                </div>
                <div class="card" style="padding: 20px; text-align: center;">
                    <div style="font-size: 2rem; color: #27ae60; font-weight: bold;" id="kpi-revenue">-</div>
                    <div style="color: #888;">æœ¬æœˆç‡Ÿæ”¶</div>
                </div>
                <div class="card" style="padding: 20px; text-align: center;">
                    <div style="font-size: 2rem; color: #e74c3c; font-weight: bold;" id="kpi-draws">-</div>
                    <div style="color: #888;">ä»Šæ—¥æŠ½çæ¬¡æ•¸</div>
                </div>
                <div class="card" style="padding: 20px; text-align: center;">
                    <div style="font-size: 2rem; color: #f39c12; font-weight: bold;" id="kpi-pending">-</div>
                    <div style="color: #888;">å¾…ç™¼è²¨</div>
                </div>
            </div>
            <div class="card" style="padding: 20px;">
                <h4>ğŸ“ˆ æœ€æ–°äº¤æ˜“è¨˜éŒ„</h4>
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>æœƒå“¡</th>
                            <th>é¡å‹</th>
                            <th>é‡‘é¡</th>
                            <th>æ™‚é–“</th>
                        </tr>
                    </thead>
                    <tbody id="latest-transactions">
                        <tr>
                            <td colspan="5" style="text-align: center; color: #999;">è¼‰å…¥ä¸­...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <script>
            // å„€è¡¨æ¿è¼‰å…¥
            async function loadDashboard() {
                try {
                    // KPI
                    const kpiRes = await fetch('/api/admin/dashboard/kpi');
                    const kpiJson = await kpiRes.json();
                    if (kpiJson.code === 200) {
                        document.getElementById('kpi-members').textContent = kpiJson.data.totalMembers;
                        document.getElementById('kpi-revenue').textContent = '$' + (kpiJson.data.monthRevenue || 0);
                        document.getElementById('kpi-draws').textContent = kpiJson.data.todayDraws;
                        document.getElementById('kpi-pending').textContent = kpiJson.data.pendingShipments;
                    }

                    // Latest Transactions
                    const txRes = await fetch('/api/admin/dashboard/transactions/latest');
                    const txJson = await txRes.json();
                    if (txJson.code === 200) {
                        const tbody = document.getElementById('latest-transactions');
                        if (txJson.data.length > 0) {
                            tbody.innerHTML = txJson.data.map(tx => `
                                <tr>
                                    <td>${tx.id}</td>
                                    <td>${tx.member}</td>
                                    <td>${tx.type}</td>
                                    <td>$${tx.amount}</td>
                                    <td>${tx.time}</td>
                                </tr>
                            `).join('');
                        } else {
                            tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #999;">æš«ç„¡äº¤æ˜“è¨˜éŒ„</td></tr>';
                        }
                    }
                } catch (e) {
                    console.error('è¼‰å…¥å„€è¡¨æ¿å¤±æ•—', e);
                }
            }

            // ç‰©æµåŒ¯å…¥
            async function importLogisticsCSV() {
                const content = document.getElementById('csv-import-content').value.trim();
                if (!content) {
                    alert('è«‹è¼¸å…¥ CSV å…§å®¹');
                    return;
                }

                try {
                    const res = await fetch('/api/admin/logistics/import-csv', {
                        method: 'POST',
                        headers: { 'Content-Type': 'text/plain' },
                        body: content
                    });
                    const json = await res.json();
                    const resultEl = document.getElementById('import-result');
                    resultEl.style.display = 'block';

                    if (json.code === 200) {
                        resultEl.innerHTML = `<span style="color: #27ae60;">âœ… åŒ¯å…¥æˆåŠŸ: ${json.data.successCount || 0} ç­†</span>`;
                    } else {
                        resultEl.innerHTML = `<span style="color: #e74c3c;">âŒ ${json.message}</span>`;
                    }
                } catch (e) {
                    console.error('åŒ¯å…¥å¤±æ•—', e);
                }
            }

            // å„€è¡¨æ¿ Tab é–‹å•Ÿæ™‚è¼‰å…¥æ•¸æ“š
            const origOpenTabDash = window.openTab;
            window.openTab = function (tabName) {
                if (typeof origOpenTabDash === 'function') {
                    origOpenTabDash(tabName);
                }
                if (tabName === 'dashboard-overview') {
                    loadDashboard();
                }
            };
        </script>

        <script>
            function editLevel(id, name, sort, threshold, reward, enabled) {
                document.getElementById('editLvlId').value = id;
                document.getElementById('editLvlName').value = name;
                document.getElementById('editLvlSort').value = sort;
                document.getElementById('editLvlThreshold').value = threshold;
                document.getElementById('editLvlReward').value = reward;
                document.getElementById('editLvlEnabled').value = enabled;
                document.getElementById('editLevelModal').style.display = 'block';
            }

            function openTab(tabName) {
                var i;
                var x = document.getElementsByClassName("tab-content");
                for (i = 0; i < x.length; i++) {
                    x[i].style.display = "none";
                }
                document.getElementById(tabName).style.display = "block";

                // Update URL without reloading
                const url = new URL(window.location);
                url.searchParams.set('tab', tabName);
                window.history.pushState({}, '', url);
            }

            function loadSubCats(catId) {
                if (!catId) return;
                fetch('/admin/api/subcategories/' + catId)
                    .then(response => response.json())
                    .then(data => {
                        let select = document.getElementById('prodSubCategory');
                        select.innerHTML = '<option value="">é¸æ“‡å­åˆ†é¡</option>';
                        data.forEach(sub => {
                            let option = document.createElement('option');
                            option.value = sub.name; // Storing Name as Product entity uses string
                            option.text = sub.name;
                            select.appendChild(option);
                        });
                    });
            }

            function editMember(id, email, name, enabled, level) {
                document.getElementById('editMemberId').value = id;
                document.getElementById('editMemberEmail').value = email;
                document.getElementById('editMemberName').value = name;
                document.getElementById('editMemberStatus').value = enabled;
                document.getElementById('editMemberLevel').value = level;
                document.getElementById('editMemberModal').style.display = 'block';
            }

            // Tab åˆ‡æ›å‡½æ•¸
            function openTab(tabId) {
                // éš±è—æ‰€æœ‰ tab-content
                document.querySelectorAll('.tab-content').forEach(el => {
                    el.style.display = 'none';
                });
                // é¡¯ç¤ºç›®æ¨™ tab
                const targetTab = document.getElementById(tabId);
                if (targetTab) {
                    targetTab.style.display = 'block';
                }
                // æ›´æ–° URL åƒæ•¸
                const url = new URL(window.location);
                url.searchParams.set('tab', tabId);
                window.history.replaceState({}, '', url);
            }

            async function showHistory(memberId) {
                try {
                    const res = await fetch('/api/member/admin/' + memberId + '/history');
                    const json = await res.json();

                    if (json.code !== 200) {
                        alert('è¼‰å…¥å¤±æ•—: ' + json.message);
                        return;
                    }

                    const data = json.data;
                    const content = `
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div><strong>æœƒå“¡ID:</strong> ${data.id}</div>
                            <div><strong>å¸³è™Ÿ:</strong> ${data.username}</div>
                            <div><strong>æš±ç¨±:</strong> ${data.nickname || '-'}</div>
                            <div><strong>Email:</strong> ${data.email}</div>
                            <div><strong>ç­‰ç´š:</strong> ${data.level}</div>
                            <div><strong>å¸³æˆ¶é¤˜é¡:</strong> $${data.balance}</div>
                            <div><strong>ç©åˆ†:</strong> ${data.points}</div>
                            <div><strong>ç´…åˆ©é»æ•¸:</strong> ${data.bonusPoints}</div>
                            <div><strong>æˆé•·å€¼:</strong> ${data.growthValue}</div>
                            <div><strong>æœ¬æœˆå„²å€¼:</strong> $${data.monthlyRecharge}</div>
                            <div><strong>è¨»å†Šæ™‚é–“:</strong> ${data.createdAt || '-'}</div>
                            <div><strong>æœ€å¾Œç™»å…¥:</strong> ${data.lastLoginTime || 'æœªç™»å…¥'}</div>
                            <div style="grid-column: span 2;"><strong>ç‹€æ…‹:</strong> 
                                <span class="${data.enabled ? 'badge badge-success' : 'badge badge-danger'}">
                                    ${data.enabled ? 'æ­£å¸¸' : 'å·²å°é–'}
                                </span>
                            </div>
                        </div>
                    `;

                    document.getElementById('historyModalContent').innerHTML = content;
                    document.getElementById('historyModal').style.display = 'block';
                } catch (e) {
                    console.error('è¼‰å…¥æœƒå“¡æ­·å²å¤±æ•—', e);
                    alert('è¼‰å…¥éŒ¯èª¤');
                }
            }

            // On Load: Check for 'tab' param
            document.addEventListener('DOMContentLoaded', (event) => {
                const urlParams = new URLSearchParams(window.location.search);
                const tab = urlParams.get('tab');
                if (tab) {
                    openTab(tab);
                }
            });
            function editTheme(id, name, price) {
                document.getElementById('editThemeId').value = id;
                document.getElementById('editThemeName').value = name;
                document.getElementById('editThemePrice').value = price;
                document.getElementById('editThemeModal').style.display = 'block';
            }

            function editActivity(id, title, desc, type, start, end) {
                document.getElementById('editActId').value = id;
                document.getElementById('editActTitle').value = title;
                document.getElementById('editActDesc').value = desc;
                document.getElementById('editActType').value = type;
                document.getElementById('editActStart').value = start ? start : '';
                document.getElementById('editActEnd').value = end ? end : '';
                document.getElementById('editActivityModal').style.display = 'block';
            }

            function editCategory(id, name) {
                document.getElementById('editCatId').value = id;
                document.getElementById('editCatName').value = name;
                document.getElementById('editCategoryModal').style.display = 'block';
            }

            function editSubCategory(id, name) {
                document.getElementById('editSubCatId').value = id;
                document.getElementById('editSubCatName').value = name;
                document.getElementById('editSubCategoryModal').style.display = 'block';
            }

            function editBoxItem(id, name, value, weight) {
                document.getElementById('editBoxItemId').value = id;
                document.getElementById('editBoxItemName').value = name;
                document.getElementById('editBoxItemValue').value = value;
                document.getElementById('editBoxItemWeight').value = weight;
                document.getElementById('editBoxItemModal').style.display = 'block';
            }
            function openDistributeModal(id, name) {
                document.getElementById('distCouponIdLevel').value = id;
                document.getElementById('distCouponIdMember').value = id;
                document.getElementById('distributeTitle').innerText = 'æ´¾ç™¼å„ªæƒ åˆ¸ - ' + name;
                document.getElementById('distributeCouponModal').style.display = 'block';
            }
            // Platform Management AJAX
            document.addEventListener('DOMContentLoaded', function () {
                function handleForm(formId, tbodyId, rowBuilder) {
                    const form = document.getElementById(formId);
                    if (!form) return;
                    form.addEventListener('submit', async function (e) {
                        e.preventDefault();
                        const formData = new FormData(form);
                        const params = new URLSearchParams();
                        for (const pair of formData.entries()) { params.append(pair[0], pair[1]); }

                        try {
                            const res = await fetch(form.action, { method: 'POST', body: params });
                            const json = await res.json();
                            if (json.success) {
                                alert('æ“ä½œæˆåŠŸ');
                                if (tbodyId && rowBuilder) {
                                    const tbody = document.getElementById(tbodyId);
                                    const tr = document.createElement('tr');
                                    tr.innerHTML = rowBuilder(json);
                                    tbody.appendChild(tr);
                                } else {
                                    location.reload();
                                }
                                form.reset();
                            } else {
                                alert('å¤±æ•—: ' + json.message);
                            }
                        } catch (err) {
                            console.error(err);
                            alert('ç™¼ç”ŸéŒ¯èª¤');
                        }
                    });
                }

                // Carousel
                handleForm('form-carousel-create', 'tbody-carousel', (json) => {
                    const s = json.slide;
                    return `<td><img src="${s.imageUrl}" style="height: 50px;"></td>
                            <td>${s.linkUrl || ''}</td>
                            <td><button class="btn btn-sm btn-danger btn-delete-carousel" data-id="${s.id}">åˆªé™¤</button></td>`;
                });

                // New Arrival
                handleForm('form-new-arrival', 'tbody-new-arrival', (json) => {
                    const i = json.item;
                    return `<td>${json.productName}</td>
                            <td>${i.sortOrder}</td>
                            <td><button class="btn btn-sm btn-danger btn-delete-featured" data-id="${i.id}">ç§»é™¤</button></td>`;
                });

                // Best Seller
                handleForm('form-best-seller', 'tbody-best-seller', (json) => {
                    const i = json.item;
                    return `<td>${json.productName}</td>
                            <td>${i.sortOrder}</td>
                            <td><button class="btn btn-sm btn-danger btn-delete-featured" data-id="${i.id}">ç§»é™¤</button></td>`;
                });

                // Notification
                handleForm('form-notification', null, null);

                // Deletes
                document.addEventListener('click', async function (e) {
                    let endpoint = '';
                    let id = '';
                    if (e.target.classList.contains('btn-delete-carousel')) {
                        endpoint = '/admin/platform/carousel/delete/';
                        id = e.target.getAttribute('data-id');
                    } else if (e.target.classList.contains('btn-delete-featured')) {
                        endpoint = '/admin/platform/featured/delete/';
                        id = e.target.getAttribute('data-id');
                    }

                    if (endpoint && id) {
                        e.preventDefault();
                        if (!confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) return;
                        try {
                            const res = await fetch(endpoint + id, { method: 'POST' });
                            const json = await res.json();
                            if (json.success) {
                                e.target.closest('tr').remove();
                            } else {
                                alert('åˆªé™¤å¤±æ•—: ' + json.message);
                            }
                        } catch (err) {
                            console.error(err);
                            alert('åˆªé™¤éŒ¯èª¤');
                        }
                    }
                });
            });

            // ==================== RBAC è§’è‰²æ¬Šé™ç®¡ç† ====================
            async function loadRbacData() {
                try {
                    const [adminsRes, rolesRes, permsRes] = await Promise.all([
                        fetch('/api/admin/rbac/admins'),
                        fetch('/api/admin/rbac/roles'),
                        fetch('/api/admin/rbac/permissions')
                    ]);
                    const admins = (await adminsRes.json()).data || [];
                    const roles = (await rolesRes.json()).data || [];
                    const perms = (await permsRes.json()).data || [];

                    // æ¸²æŸ“ç®¡ç†å“¡åˆ—è¡¨
                    const adminsTable = document.getElementById('rbac-admins-table');
                    if (adminsTable) {
                        adminsTable.innerHTML = admins.map(a => `
                            <tr>
                                <td>${a.id}</td>
                                <td>${a.username}</td>
                                <td>${a.email || '-'}</td>
                                <td>${a.roles.map(r => r.name).join(', ') || '-'}</td>
                                <td>
                                    <button class="btn btn-sm btn-danger" onclick="deleteAdmin(${a.id})">åˆªé™¤</button>
                                </td>
                            </tr>
                        `).join('');
                    }

                    // æ¸²æŸ“è§’è‰²åˆ—è¡¨
                    const rolesTable = document.getElementById('rbac-roles-table');
                    if (rolesTable) {
                        rolesTable.innerHTML = roles.map(r => `
                            <tr>
                                <td>${r.id}</td>
                                <td>${r.name}</td>
                                <td>${r.permissions.map(p => p.name).join(', ') || '-'}</td>
                                <td>
                                    <button class="btn btn-sm btn-info" onclick="editRole(${r.id}, '${r.name}')">ç·¨è¼¯</button>
                                    <button class="btn btn-sm btn-danger" onclick="deleteRole(${r.id})">åˆªé™¤</button>
                                </td>
                            </tr>
                        `).join('');
                    }

                    // æ¸²æŸ“æ¬Šé™åˆ—è¡¨
                    const permsTable = document.getElementById('rbac-perms-table');
                    if (permsTable) {
                        permsTable.innerHTML = perms.map(p => `
                            <tr>
                                <td>${p.id}</td>
                                <td>${p.code}</td>
                                <td>${p.name}</td>
                                <td>${p.description || '-'}</td>
                                <td>
                                    <button class="btn btn-sm btn-danger" onclick="deletePermission(${p.id})">åˆªé™¤</button>
                                </td>
                            </tr>
                        `).join('');
                    }

                    // æ›´æ–°ä¸‹æ‹‰é¸å–®
                    const roleSelect = document.getElementById('new-admin-roles');
                    if (roleSelect) {
                        roleSelect.innerHTML = roles.map(r =>
                            `<option value="${r.id}">${r.name}</option>`
                        ).join('');
                    }

                    const permSelect = document.getElementById('new-role-perms');
                    if (permSelect) {
                        permSelect.innerHTML = perms.map(p =>
                            `<option value="${p.id}">${p.name} (${p.code})</option>`
                        ).join('');
                    }
                } catch (e) {
                    console.error('è¼‰å…¥ RBAC è³‡æ–™å¤±æ•—', e);
                }
            }

            async function createAdmin() {
                const username = document.getElementById('new-admin-username').value;
                const password = document.getElementById('new-admin-password').value;
                const email = document.getElementById('new-admin-email').value;
                const roleSelect = document.getElementById('new-admin-roles');
                const roleIds = Array.from(roleSelect.selectedOptions).map(o => parseInt(o.value));

                const res = await fetch('/api/admin/rbac/admins', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password, email, roleIds })
                });
                const json = await res.json();
                if (json.code === 200) {
                    alert('å»ºç«‹æˆåŠŸ');
                    loadRbacData();
                } else {
                    alert('å¤±æ•—: ' + json.message);
                }
            }

            async function deleteAdmin(id) {
                if (!confirm('ç¢ºå®šåˆªé™¤æ­¤ç®¡ç†å“¡ï¼Ÿ')) return;
                await fetch('/api/admin/rbac/admins/' + id, { method: 'DELETE' });
                loadRbacData();
            }

            async function createRole() {
                const name = document.getElementById('new-role-name').value;
                const permSelect = document.getElementById('new-role-perms');
                const permissionIds = Array.from(permSelect.selectedOptions).map(o => parseInt(o.value));

                const res = await fetch('/api/admin/rbac/roles', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, permissionIds })
                });
                const json = await res.json();
                if (json.code === 200) {
                    alert('å»ºç«‹æˆåŠŸ');
                    loadRbacData();
                } else {
                    alert('å¤±æ•—: ' + json.message);
                }
            }

            async function deleteRole(id) {
                if (!confirm('ç¢ºå®šåˆªé™¤æ­¤è§’è‰²ï¼Ÿ')) return;
                await fetch('/api/admin/rbac/roles/' + id, { method: 'DELETE' });
                loadRbacData();
            }

            // ==================== æ¬Šé™å‹¾é¸ Modal åŠŸèƒ½ ====================
            let currentEditingRoleId = null;
            let allPermissions = [];

            async function editRole(roleId, roleName) {
                currentEditingRoleId = roleId;
                document.getElementById('editingRoleName').textContent = roleName;

                try {
                    // å–å¾—æ‰€æœ‰æ¬Šé™
                    const permsRes = await fetch('/api/admin/rbac/permissions');
                    const permsJson = await permsRes.json();
                    allPermissions = permsJson.data || [];

                    // å–å¾—è©²è§’è‰²è³‡è¨Š
                    const rolesRes = await fetch('/api/admin/rbac/roles');
                    const rolesJson = await rolesRes.json();
                    const role = (rolesJson.data || []).find(r => r.id === roleId);
                    const rolePermIds = role ? role.permissions.map(p => p.id) : [];

                    // æ¸²æŸ“æ¬Šé™å‹¾é¸æ¡†
                    const container = document.getElementById('permissionCheckboxList');
                    container.innerHTML = allPermissions.map(p => `
                        <label style="display: flex; align-items: center; padding: 8px; border-bottom: 1px solid #eee; cursor: pointer;">
                            <input type="checkbox" value="${p.id}" ${rolePermIds.includes(p.id) ? 'checked' : ''} 
                                   style="margin-right: 10px; width: 18px; height: 18px;" />
                            <span style="flex: 1;">
                                <strong>${p.name}</strong>
                                <small style="color: #888; margin-left: 8px;">${p.code}</small>
                            </span>
                        </label>
                    `).join('');

                    // é¡¯ç¤º Modal
                    document.getElementById('rolePermissionModal').style.display = 'block';
                } catch (e) {
                    console.error('è¼‰å…¥æ¬Šé™å¤±æ•—', e);
                    alert('è¼‰å…¥æ¬Šé™å¤±æ•—');
                }
            }

            function closeRoleModal() {
                document.getElementById('rolePermissionModal').style.display = 'none';
                currentEditingRoleId = null;
            }

            async function saveRolePermissions() {
                if (!currentEditingRoleId) return;

                const checkboxes = document.querySelectorAll('#permissionCheckboxList input[type="checkbox"]:checked');
                const permissionIds = Array.from(checkboxes).map(cb => parseInt(cb.value));

                try {
                    const res = await fetch('/api/admin/rbac/roles/' + currentEditingRoleId, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ permissionIds })
                    });
                    const json = await res.json();
                    if (json.code === 200) {
                        alert('æ¬Šé™æ›´æ–°æˆåŠŸ');
                        closeRoleModal();
                        loadRbacData();
                    } else {
                        alert('æ›´æ–°å¤±æ•—: ' + json.message);
                    }
                } catch (e) {
                    console.error('å„²å­˜æ¬Šé™å¤±æ•—', e);
                    alert('å„²å­˜éŒ¯èª¤');
                }
            }

            async function createPermission() {
                const code = document.getElementById('new-perm-code').value;
                const name = document.getElementById('new-perm-name').value;
                const description = document.getElementById('new-perm-desc').value;

                const res = await fetch('/api/admin/rbac/permissions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code, name, description })
                });
                const json = await res.json();
                if (json.code === 200) {
                    alert('å»ºç«‹æˆåŠŸ');
                    loadRbacData();
                } else {
                    alert('å¤±æ•—: ' + json.message);
                }
            }

            async function deletePermission(id) {
                if (!confirm('ç¢ºå®šåˆªé™¤æ­¤æ¬Šé™ï¼Ÿ')) return;
                await fetch('/api/admin/rbac/permissions/' + id, { method: 'DELETE' });
                loadRbacData();
            }

            // ==================== ç¦®åŒ…ç¢¼ç®¡ç† ====================
            async function loadPromoCodes() {
                try {
                    const res = await fetch('/api/admin/promo-codes');
                    const json = await res.json();
                    if (json.success) {
                        const tbody = document.getElementById('promo-codes-table');
                        tbody.innerHTML = json.data.map(c => `
                            <tr>
                                <td>${c.id}</td>
                                <td><code>${c.code}</code></td>
                                <td>${c.name}</td>
                                <td>${c.type === 'GIFT' ? 'ç¦®åŒ…' : 'æ¨è–¦'}</td>
                                <td>${c.rewardValue} ${c.rewardType === 'TOKENS' ? 'ä»£å¹£' : c.rewardType === 'BONUS' ? 'ç´…åˆ©' : 'ç¢ç‰‡'}</td>
                                <td>${c.usedCount}/${c.maxUses || 'âˆ'}</td>
                                <td>
                                    <span class="badge ${c.enabled ? 'badge-success' : 'badge-secondary'}">${c.enabled ? 'å•Ÿç”¨' : 'åœç”¨'}</span>
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-info" onclick="togglePromoCode(${c.id})">${c.enabled ? 'åœç”¨' : 'å•Ÿç”¨'}</button>
                                    <button class="btn btn-sm btn-danger" onclick="deletePromoCode(${c.id})">åˆªé™¤</button>
                                </td>
                            </tr>
                        `).join('');
                    }
                } catch (e) {
                    console.error('è¼‰å…¥ç¦®åŒ…ç¢¼å¤±æ•—', e);
                }
            }

            async function createPromoCode() {
                const name = document.getElementById('promo-name').value;
                const rewardType = document.getElementById('promo-reward-type').value;
                const rewardValue = document.getElementById('promo-reward-value').value;
                const maxUses = document.getElementById('promo-max-uses').value;
                const validUntil = document.getElementById('promo-valid-until').value;
                const description = document.getElementById('promo-description').value;

                if (!name || !rewardValue) {
                    alert('è«‹å¡«å¯«ç¦®åŒ…åç¨±å’Œçå‹µæ•¸é‡');
                    return;
                }

                try {
                    const res = await fetch('/api/admin/promo-codes', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name, description, rewardType, rewardValue: parseFloat(rewardValue), maxUses: parseInt(maxUses) || 100, validUntil })
                    });
                    const json = await res.json();
                    if (json.success) {
                        alert('ç¦®åŒ…ç¢¼å»ºç«‹æˆåŠŸ: ' + json.data.code);
                        loadPromoCodes();
                        // æ¸…ç©ºè¡¨å–®
                        document.getElementById('promo-name').value = '';
                        document.getElementById('promo-reward-value').value = '';
                        document.getElementById('promo-description').value = '';
                    } else {
                        alert('å»ºç«‹å¤±æ•—: ' + json.message);
                    }
                } catch (e) {
                    console.error('å»ºç«‹ç¦®åŒ…ç¢¼å¤±æ•—', e);
                }
            }

            async function togglePromoCode(id) {
                await fetch('/api/admin/promo-codes/' + id + '/toggle', { method: 'POST' });
                loadPromoCodes();
            }

            async function deletePromoCode(id) {
                if (!confirm('ç¢ºå®šåˆªé™¤æ­¤ç¦®åŒ…ç¢¼ï¼Ÿ')) return;
                await fetch('/api/admin/promo-codes/' + id, { method: 'DELETE' });
                loadPromoCodes();
            }

            // ==================== ç³»çµ±è¨­å®šç®¡ç† ====================
            let currentSettings = [];

            async function loadSystemSettings() {
                try {
                    const res = await fetch('/api/admin/settings');
                    const json = await res.json();
                    if (json.success) {
                        currentSettings = json.data;
                        const tbody = document.getElementById('system-settings-table');
                        tbody.innerHTML = json.data.map(s => `
                            <tr>
                                <td><code>${s.key}</code></td>
                                <td>${s.description || '-'}</td>
                                <td>
                                    ${isBooleanSetting(s.key)
                                ? `<select id="setting-${s.key}" class="form-control" style="width: 100px;">
                                            <option value="true" ${s.value === 'true' ? 'selected' : ''}>å•Ÿç”¨</option>
                                            <option value="false" ${s.value === 'false' ? 'selected' : ''}>åœç”¨</option>
                                           </select>`
                                : `<input type="text" id="setting-${s.key}" class="form-control" style="width: 150px;" value="${s.value}" />`
                            }
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-info" onclick="saveSingleSetting('${s.key}')">å„²å­˜</button>
                                </td>
                            </tr>
                        `).join('');
                    }
                } catch (e) {
                    console.error('è¼‰å…¥ç³»çµ±è¨­å®šå¤±æ•—', e);
                }
            }

            function isBooleanSetting(key) {
                return key.includes('.enabled') || key === 'captcha.enabled' || key === 'otp.enabled';
            }

            async function saveSingleSetting(key) {
                const input = document.getElementById('setting-' + key);
                if (!input) return;
                const value = input.value;
                try {
                    const res = await fetch('/api/admin/settings/' + encodeURIComponent(key), {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ value })
                    });
                    const json = await res.json();
                    if (json.success) {
                        alert('è¨­å®šå·²å„²å­˜');
                    } else {
                        alert('å„²å­˜å¤±æ•—: ' + json.message);
                    }
                } catch (e) {
                    console.error('å„²å­˜è¨­å®šå¤±æ•—', e);
                }
            }

            async function saveAllSettings() {
                const settings = {};
                currentSettings.forEach(s => {
                    const input = document.getElementById('setting-' + s.key);
                    if (input) {
                        settings[s.key] = input.value;
                    }
                });
                try {
                    const res = await fetch('/api/admin/settings', {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(settings)
                    });
                    const json = await res.json();
                    if (json.success) {
                        alert('æ‰€æœ‰è¨­å®šå·²å„²å­˜');
                    } else {
                        alert('å„²å­˜å¤±æ•—: ' + json.message);
                    }
                } catch (e) {
                    console.error('æ‰¹é‡å„²å­˜è¨­å®šå¤±æ•—', e);
                }
            }

            // ==================== æœƒå“¡æ¨™ç±¤ç®¡ç† ====================
            async function loadMemberTags() {
                try {
                    const res = await fetch('/api/admin/member-tags');
                    const json = await res.json();
                    if (json.success) {
                        const tbody = document.getElementById('member-tags-table');
                        tbody.innerHTML = json.data.map(t => `
                            <tr>
                                <td>${t.id}</td>
                                <td><span style="background: ${t.color}; color: white; padding: 2px 10px; border-radius: 12px;">${t.name}</span></td>
                                <td>${t.description || '-'}</td>
                                <td>${t.type === 'SYSTEM' ? 'ç³»çµ±' : t.type === 'AUTO' ? 'è‡ªå‹•' : 'æ‰‹å‹•'}</td>
                                <td>
                                    <button class="btn btn-sm btn-info" onclick="viewTagMembers(${t.id}, '${t.name}')">æŸ¥çœ‹æœƒå“¡</button>
                                </td>
                            </tr>
                        `).join('');
                    }
                } catch (e) {
                    console.error('è¼‰å…¥æœƒå“¡æ¨™ç±¤å¤±æ•—', e);
                }
            }

            async function createMemberTag() {
                const name = document.getElementById('tag-name').value;
                const color = document.getElementById('tag-color').value;
                const description = document.getElementById('tag-description').value;

                if (!name) {
                    alert('è«‹å¡«å¯«æ¨™ç±¤åç¨±');
                    return;
                }

                try {
                    const res = await fetch('/api/admin/member-tags', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name, color, description })
                    });
                    const json = await res.json();
                    if (json.success) {
                        alert('æ¨™ç±¤å»ºç«‹æˆåŠŸ');
                        loadMemberTags();
                        document.getElementById('tag-name').value = '';
                        document.getElementById('tag-description').value = '';
                    } else {
                        alert('å»ºç«‹å¤±æ•—: ' + json.message);
                    }
                } catch (e) {
                    console.error('å»ºç«‹æ¨™ç±¤å¤±æ•—', e);
                }
            }

            async function viewTagMembers(tagId, tagName) {
                try {
                    const res = await fetch('/api/admin/member-tags/' + tagId + '/members');
                    const json = await res.json();
                    if (json.success) {
                        const count = json.data.length;
                        const sample = json.data.slice(0, 10).join(', ');
                        alert(`æ¨™ç±¤ã€Œ${tagName}ã€æœ‰ ${count} ä½æœƒå“¡\n\nå‰ 10 åæœƒå“¡ ID: ${sample || 'ç„¡'}`);
                    }
                } catch (e) {
                    console.error('æŸ¥è©¢æ¨™ç±¤æœƒå“¡å¤±æ•—', e);
                }
            }

            // ==================== ç³»çµ±å…¬å‘Š ====================
            async function loadAnnouncementTags() {
                try {
                    const res = await fetch('/api/admin/member-tags');
                    const json = await res.json();
                    if (json.success) {
                        const select = document.getElementById('ann-target');
                        select.innerHTML = '<option value="all">æ‰€æœ‰æœƒå“¡</option>' +
                            json.data.map(t => `<option value="tag-${t.id}">æ¨™ç±¤ï¼š${t.name}</option>`).join('');
                    }
                } catch (e) {
                    console.error('è¼‰å…¥æ¨™ç±¤åˆ—è¡¨å¤±æ•—', e);
                }
            }

            async function sendAnnouncement() {
                const title = document.getElementById('ann-title').value;
                const content = document.getElementById('ann-content').value;
                const target = document.getElementById('ann-target').value;

                if (!title || !content) {
                    alert('è«‹å¡«å¯«æ¨™é¡Œå’Œå…§å®¹');
                    return;
                }

                if (!confirm('ç¢ºå®šç™¼é€å…¬å‘Šï¼Ÿæ­¤æ“ä½œç„¡æ³•æ’¤éŠ·ã€‚')) return;

                try {
                    let url = '/api/admin/announcements/broadcast';
                    if (target.startsWith('tag-')) {
                        const tagId = target.replace('tag-', '');
                        url = '/api/admin/announcements/broadcast-by-tag/' + tagId;
                    }
                    const res = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ title, content })
                    });
                    const json = await res.json();
                    if (json.success) {
                        alert('å…¬å‘Šç™¼é€æˆåŠŸï¼å·²ç™¼é€çµ¦ ' + json.data.sentCount + ' ä½æœƒå“¡');
                        document.getElementById('ann-title').value = '';
                        document.getElementById('ann-content').value = '';
                    } else {
                        alert('ç™¼é€å¤±æ•—: ' + json.message);
                    }
                } catch (e) {
                    console.error('ç™¼é€å…¬å‘Šå¤±æ•—', e);
                }
            }

            // ==================== é€æ˜é©—è­‰æŸ¥è©¢ ====================
            let currentVerifyId = null;

            async function loadTransparencyData() {
                try {
                    const res = await fetch('/api/admin/transparency/completed');
                    const json = await res.json();
                    if (json.success) {
                        const tbody = document.getElementById('transparency-table');
                        tbody.innerHTML = json.data.map(v => `
                            <tr>
                                <td>${v.id}</td>
                                <td>${v.gameType}</td>
                                <td>${v.gameId}</td>
                                <td>${v.gameName}</td>
                                <td>${v.completedAt || '-'}</td>
                                <td>
                                    <button class="btn btn-sm btn-info" onclick="showHashVerify(${v.id}, '${v.hashValue}')">é©—è­‰å“ˆå¸Œ</button>
                                </td>
                            </tr>
                        `).join('') || '<tr><td colspan="6" style="text-align: center;">æš«ç„¡å·²å®Œå”®éŠæˆ²</td></tr>';
                    }
                } catch (e) {
                    console.error('è¼‰å…¥é€æ˜é©—è­‰è³‡æ–™å¤±æ•—', e);
                }
            }

            function showHashVerify(id, hashValue) {
                currentVerifyId = id;
                document.getElementById('hashDisplayValue').textContent = hashValue;
                document.getElementById('hashVerifyInput').value = '';
                document.getElementById('hashVerifyResult').textContent = '';
                document.getElementById('hashVerifyModal').style.display = 'block';
            }

            function closeHashModal() {
                document.getElementById('hashVerifyModal').style.display = 'none';
            }

            async function verifyHash() {
                const hash = document.getElementById('hashVerifyInput').value;
                if (!hash) {
                    alert('è«‹è¼¸å…¥å“ˆå¸Œå€¼');
                    return;
                }
                try {
                    const res = await fetch('/api/admin/transparency/verify/' + currentVerifyId, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ hash })
                    });
                    const json = await res.json();
                    if (json.success) {
                        const result = document.getElementById('hashVerifyResult');
                        result.textContent = json.data.message;
                        result.style.color = json.data.valid ? '#4CAF50' : '#f44336';
                    }
                } catch (e) {
                    console.error('é©—è­‰å¤±æ•—', e);
                }
            }

            // ç•¶åˆ‡æ›åˆ°ä¸åŒ Tab æ™‚è¼‰å…¥è³‡æ–™
            const origOpenTab = window.openTab;
            window.openTab = function (tabName) {
                origOpenTab(tabName);
                if (tabName === 'rbac') {
                    loadRbacData();
                }
                if (tabName === 'promo-codes') {
                    loadPromoCodes();
                }
                if (tabName === 'platform') {
                    loadSystemSettings();
                }
                if (tabName === 'member-tags') {
                    loadMemberTags();
                }
                if (tabName === 'announcements') {
                    loadAnnouncementTags();
                }
                if (tabName === 'transparency') {
                    loadTransparencyData();
                }
                if (tabName === 'payment-orders') {
                    loadPaymentOrders();
                }
            };

            // ==================== é‡‘æµè¨‚å–®ç®¡ç† ====================
            async function loadPaymentOrders() {
                try {
                    // è¼‰å…¥çµ±è¨ˆ
                    const summaryRes = await fetch('/api/admin/payments/summary');
                    const summaryJson = await summaryRes.json();
                    if (summaryJson.success) {
                        const d = summaryJson.data;
                        document.getElementById('po-total').textContent = d.totalOrders;
                        document.getElementById('po-pending').textContent = d.pendingOrders;
                        document.getElementById('po-paid').textContent = d.paidOrders;
                        document.getElementById('po-failed').textContent = d.failedOrders;
                    }

                    // è¼‰å…¥è¨‚å–®
                    const ordersRes = await fetch('/api/admin/payments/orders');
                    const ordersJson = await ordersRes.json();
                    if (ordersJson.success) {
                        renderPaymentOrders(ordersJson.data);
                    }
                } catch (e) {
                    console.error('è¼‰å…¥é‡‘æµè¨‚å–®å¤±æ•—', e);
                }
            }

            function renderPaymentOrders(orders) {
                const tbody = document.getElementById('payment-orders-table');
                tbody.innerHTML = orders.map(o => `
                    <tr>
                        <td>${o.orderNo}</td>
                        <td>${o.memberId}</td>
                        <td>$${o.amount}</td>
                        <td>${o.method || '-'}</td>
                        <td><span class="status-badge status-${o.status.toLowerCase()}">${o.status}</span></td>
                        <td>${o.createdAt ? o.createdAt.substring(0, 16).replace('T', ' ') : '-'}</td>
                    </tr>
                `).join('') || '<tr><td colspan="6" style="text-align: center;">æš«ç„¡è¨‚å–®</td></tr>';
            }

            async function filterOrders() {
                const filter = document.getElementById('po-filter').value;
                let url = '/api/admin/payments/orders';
                if (filter !== 'all') {
                    url = '/api/admin/payments/orders/status/' + filter;
                }
                try {
                    const res = await fetch(url);
                    const json = await res.json();
                    if (json.success) {
                        renderPaymentOrders(json.data);
                    }
                } catch (e) {
                    console.error('ç¯©é¸è¨‚å–®å¤±æ•—', e);
                }
            }

            // ==================== å„ªæƒ åˆ¸æ‰¹é‡ç™¼æ”¾ ====================
            let currentDistCouponId = null;

            function openDistributeModal(couponId, couponName) {
                currentDistCouponId = couponId;
                document.getElementById('distributeTitle').textContent = 'æ´¾ç™¼å„ªæƒ åˆ¸ï¼š' + couponName;
                document.getElementById('distCouponIdLevel').value = couponId;
                document.getElementById('distCouponIdMember').value = couponId;
                document.getElementById('distTagResult').textContent = '';
                // è¼‰å…¥æ¨™ç±¤åˆ—è¡¨
                loadTagsForDistribute();
                document.getElementById('distributeCouponModal').style.display = 'block';
            }

            async function loadTagsForDistribute() {
                try {
                    const res = await fetch('/api/admin/member-tags');
                    const json = await res.json();
                    if (json.success) {
                        const select = document.getElementById('distTagId');
                        select.innerHTML = '<option value="">é¸æ“‡æ¨™ç±¤</option>' +
                            json.data.map(t => `<option value="${t.id}">${t.name}</option>`).join('');
                    }
                } catch (e) {
                    console.error('è¼‰å…¥æ¨™ç±¤å¤±æ•—', e);
                }
            }

            async function distributeByTag() {
                const tagId = document.getElementById('distTagId').value;
                if (!tagId) {
                    alert('è«‹é¸æ“‡æ¨™ç±¤');
                    return;
                }
                if (!currentDistCouponId) {
                    alert('è«‹é‡æ–°é–‹å•Ÿæ´¾ç™¼è¦–çª—');
                    return;
                }
                try {
                    const res = await fetch('/api/admin/coupons/' + currentDistCouponId + '/distribute-by-tag/' + tagId, {
                        method: 'POST'
                    });
                    const json = await res.json();
                    if (json.success) {
                        document.getElementById('distTagResult').textContent =
                            'æˆåŠŸæ´¾ç™¼çµ¦ ' + json.data.successCount + ' / ' + json.data.totalMembers + ' ä½æœƒå“¡';
                    } else {
                        document.getElementById('distTagResult').textContent = 'æ´¾ç™¼å¤±æ•—: ' + json.message;
                        document.getElementById('distTagResult').style.color = '#e74c3c';
                    }
                } catch (e) {
                    console.error('æ‰¹é‡æ´¾ç™¼å¤±æ•—', e);
                }
            }

            // ==================== æ—¥èªŒéæ¿¾ ====================
            let allLogsData = []; // å„²å­˜åŸå§‹æ—¥èªŒè³‡æ–™

            function filterLogs() {
                const userSearch = document.getElementById('log-search-user').value.toLowerCase();
                const actionFilter = document.getElementById('log-filter-action').value;
                const dateFrom = document.getElementById('log-date-from').value;
                const dateTo = document.getElementById('log-date-to').value;

                const tbody = document.getElementById('logs-table-body');
                const rows = tbody.querySelectorAll('tr');

                rows.forEach(row => {
                    const cells = row.querySelectorAll('td');
                    if (cells.length === 0) return;

                    const username = cells[1]?.textContent?.toLowerCase() || '';
                    const action = cells[2]?.textContent || '';
                    const timestamp = cells[5]?.textContent || '';

                    let show = true;

                    // ç”¨æˆ¶åæœå°‹
                    if (userSearch && !username.includes(userSearch)) {
                        show = false;
                    }

                    // å‹•ä½œé¡å‹éæ¿¾
                    if (actionFilter && !action.includes(actionFilter)) {
                        show = false;
                    }

                    // æ—¥æœŸç¯„åœéæ¿¾
                    if (dateFrom && timestamp) {
                        const logDate = timestamp.split(' ')[0];
                        if (logDate < dateFrom) show = false;
                    }
                    if (dateTo && timestamp) {
                        const logDate = timestamp.split(' ')[0];
                        if (logDate > dateTo) show = false;
                    }

                    row.style.display = show ? '' : 'none';
                });
            }

            function clearLogFilters() {
                document.getElementById('log-search-user').value = '';
                document.getElementById('log-filter-action').value = '';
                document.getElementById('log-date-from').value = '';
                document.getElementById('log-date-to').value = '';

                const tbody = document.getElementById('logs-table-body');
                const rows = tbody.querySelectorAll('tr');
                rows.forEach(row => row.style.display = '');
            }

            // ==================== æœƒå“¡åŒ¯å‡º ====================
            function exportMembersCSV() {
                const table = document.getElementById('members-table');
                if (!table) {
                    alert('ç„¡æ³•å–å¾—æœƒå“¡è¡¨æ ¼');
                    return;
                }

                let csv = [];
                const rows = table.querySelectorAll('tr');

                rows.forEach(row => {
                    const cells = row.querySelectorAll('th, td');
                    const rowData = [];
                    cells.forEach((cell, index) => {
                        // æ’é™¤æ“ä½œæ¬„
                        if (index < cells.length - 1) {
                            let text = cell.textContent.trim().replace(/"/g, '""');
                            rowData.push('"' + text + '"');
                        }
                    });
                    csv.push(rowData.join(','));
                });

                const csvContent = '\uFEFF' + csv.join('\n'); // BOM for Excel
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);

                link.setAttribute('href', url);
                link.setAttribute('download', 'members_' + new Date().toISOString().split('T')[0] + '.csv');
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        </script>
    </div>
</body>

</html>