<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="~{layout :: html(title='ç¢ç‰‡å…Œæ›å•†åº—', content=~{::content})}">

<body>
    <div th:fragment="content">
        <link rel="stylesheet" th:href="@{/css/gacha-animations.css}">

        <div class="container section">
            <h2 class="section-title">ğŸ’ ç¢ç‰‡å…Œæ›å•†åº—</h2>

            <!-- ç¢ç‰‡é¤˜é¡ -->
            <div style="text-align: center; margin-bottom: 40px;">
                <div class="shard-balance">
                    <span class="shard-icon">ğŸ’</span>
                    <span id="shardBalance">0</span>
                    <span style="font-size: 1rem; opacity: 0.8;">ç¢ç‰‡</span>
                </div>
                <p style="color: var(--text-secondary); margin-top: 15px;">
                    æŠ½çç²å¾—ç¢ç‰‡ï¼Œç´¯ç©å…Œæ›ç¨€æœ‰çå“ï¼
                </p>
            </div>

            <!-- å•†å“åˆ—è¡¨ -->
            <div id="shopItems" class="grid" style="grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));">
                <div class="text-center" style="grid-column: 1/-1; padding: 40px;">
                    <p>è¼‰å…¥ä¸­...</p>
                </div>
            </div>

            <!-- äº¤æ˜“ç´€éŒ„ -->
            <div style="margin-top: 60px;">
                <h3 style="margin-bottom: 20px;">ğŸ“œ ç¢ç‰‡ç´€éŒ„</h3>
                <div id="transactions"
                    style="background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 5px 20px rgba(0,0,0,0.1);">
                    <table style="width: 100%; margin: 0;">
                        <thead>
                            <tr style="background: var(--bg-secondary);">
                                <th style="padding: 15px; text-align: left;">é¡å‹</th>
                                <th style="padding: 15px; text-align: left;">èªªæ˜</th>
                                <th style="padding: 15px; text-align: right;">æ•¸é‡</th>
                            </tr>
                        </thead>
                        <tbody id="transactionList">
                            <tr>
                                <td colspan="3" style="padding: 20px; text-align: center;">è¼‰å…¥ä¸­...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- å…Œæ›ç¢ºèªå½ˆçª— -->
        <div id="redeemModal"
            style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 9999; display: none; align-items: center; justify-content: center;">
            <div style="background: white; border-radius: 20px; padding: 40px; max-width: 400px; text-align: center;">
                <h3 style="margin-bottom: 20px;">ç¢ºèªå…Œæ›</h3>
                <div id="redeemItemPreview" style="margin-bottom: 20px;">
                    <div
                        style="width: 150px; height: 150px; background: linear-gradient(145deg, #6c5ce7, #a29bfe); border-radius: 15px; margin: 0 auto 15px; display: flex; align-items: center; justify-content: center;">
                        <span style="font-size: 4rem;">ğŸ</span>
                    </div>
                    <h4 id="redeemItemName">å•†å“åç¨±</h4>
                </div>
                <p style="color: #666; margin-bottom: 20px;">
                    éœ€è¦ <span id="redeemCost"
                        style="color: var(--gacha-purple); font-weight: bold; font-size: 1.3rem;">10000</span> ç¢ç‰‡
                </p>
                <p id="redeemError" style="color: var(--error-color); display: none; margin-bottom: 15px;">ç¢ç‰‡ä¸è¶³</p>
                <div style="display: flex; gap: 15px; justify-content: center;">
                    <button class="btn btn-outline" onclick="closeRedeemModal()">å–æ¶ˆ</button>
                    <button id="confirmRedeemBtn" class="btn-gacha" onclick="confirmRedeem()">ç¢ºèªå…Œæ›</button>
                </div>
            </div>
        </div>

        <!-- å…Œæ›æˆåŠŸå½ˆçª— -->
        <div id="successModal" class="prize-reveal-overlay" style="display: none;">
            <div class="prize-card">
                <div style="font-size: 4rem; margin-bottom: 20px;">ğŸ‰</div>
                <h2>å…Œæ›æˆåŠŸï¼</h2>
                <p id="successItemName" style="font-size: 1.3rem; margin: 15px 0;"></p>
                <p id="remainingBalance" style="color: #6c5ce7;">å‰©é¤˜ç¢ç‰‡: 0</p>
                <button class="btn-gacha" onclick="closeSuccessModal()" style="margin-top: 20px;">å¤ªæ£’äº†ï¼</button>
            </div>
        </div>

        <script>
            let currentShardBalance = 0;
            let selectedItemId = null;
            let selectedItemCost = 0;

            document.addEventListener('DOMContentLoaded', function () {
                loadShardBalance();
                loadShopItems();
                loadTransactions();
            });

            function loadShardBalance() {
                fetch('/api/shards/balance')
                    .then(r => r.json())
                    .then(response => {
                        if (response.success) {
                            currentShardBalance = response.data.balance;
                            document.getElementById('shardBalance').textContent = currentShardBalance.toLocaleString();
                        }
                    });
            }

            function loadShopItems() {
                fetch('/api/redeem-shop')
                    .then(r => r.json())
                    .then(response => {
                        if (response.success && response.data.length > 0) {
                            renderShopItems(response.data);
                        } else {
                            document.getElementById('shopItems').innerHTML = `
                                <div class="text-center" style="grid-column: 1/-1; padding: 40px;">
                                    <p>ç›®å‰æ²’æœ‰å¯å…Œæ›çš„å•†å“</p>
                                </div>
                            `;
                        }
                    });
            }

            function renderShopItems(items) {
                const html = items.map(item => {
                    const canAfford = currentShardBalance >= item.shardCost;
                    const soldOut = !item.hasStock;

                    return `
                        <div class="redeem-card ${soldOut ? 'sold-out' : ''}" style="position: relative;">
                            ${item.itemType !== 'PRIZE' ? `
                                <div class="card-badge">${item.itemTypeDisplay}</div>
                            ` : ''}
                            <div style="height: 180px; background: linear-gradient(145deg, ${getItemColor(item.itemType)}); display: flex; align-items: center; justify-content: center;">
                                ${item.imageUrl ? `<img src="${item.imageUrl}" style="max-height: 150px; max-width: 100%;">` : `<span style="font-size: 5rem;">ğŸ</span>`}
                            </div>
                            <div style="padding: 20px;">
                                <h4 style="margin: 0 0 10px 0;">${item.name}</h4>
                                <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 15px; min-height: 40px;">
                                    ${item.description || ''}
                                </p>
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                    <span style="color: var(--gacha-purple); font-weight: bold; font-size: 1.2rem;">
                                        ğŸ’ ${item.shardCost.toLocaleString()}
                                    </span>
                                    <span style="color: #666; font-size: 0.9rem;">
                                        åº«å­˜: ${item.stock}/${item.totalStock}
                                    </span>
                                </div>
                                <div style="background: #eee; border-radius: 10px; height: 8px; overflow: hidden; margin-bottom: 15px;">
                                    <div style="width: ${item.stockPercentage}%; height: 100%; background: linear-gradient(90deg, #27ae60, #2ecc71);"></div>
                                </div>
                                ${soldOut ? `
                                    <button class="btn" style="width: 100%; background: #ccc; cursor: not-allowed;" disabled>å·²å”®ç½„</button>
                                ` : `
                                    <button class="btn-gacha" style="width: 100%; ${!canAfford ? 'opacity: 0.6;' : ''}" 
                                        onclick="openRedeemModal(${item.id}, '${item.name}', ${item.shardCost}, ${canAfford})">
                                        ${canAfford ? 'ç«‹å³å…Œæ›' : 'ç¢ç‰‡ä¸è¶³'}
                                    </button>
                                `}
                            </div>
                        </div>
                    `;
                }).join('');
                document.getElementById('shopItems').innerHTML = html;
            }

            function getItemColor(type) {
                switch (type) {
                    case 'S_RANK': return '#FFD700, #FFA500';
                    case 'HIDDEN': return '#8E44AD, #9B59B6';
                    case 'SPECIAL': return '#E74C3C, #C0392B';
                    default: return '#6c5ce7, #a29bfe';
                }
            }

            function loadTransactions() {
                fetch('/api/shards/transactions')
                    .then(r => r.json())
                    .then(response => {
                        if (response.success && response.data.length > 0) {
                            renderTransactions(response.data);
                        } else {
                            document.getElementById('transactionList').innerHTML = `
                                <tr><td colspan="3" style="padding: 20px; text-align: center; color: #999;">æš«ç„¡äº¤æ˜“ç´€éŒ„</td></tr>
                            `;
                        }
                    });
            }

            function renderTransactions(transactions) {
                const html = transactions.map(tx => {
                    const isPositive = tx.amount > 0;
                    return `
                        <tr>
                            <td style="padding: 12px 15px;">
                                <span style="background: ${isPositive ? '#e8f5e9' : '#fdecea'}; color: ${isPositive ? '#27ae60' : '#e74c3c'}; padding: 3px 10px; border-radius: 20px; font-size: 0.8rem;">
                                    ${tx.typeDisplay}
                                </span>
                            </td>
                            <td style="padding: 12px 15px; color: #666;">${tx.description}</td>
                            <td style="padding: 12px 15px; text-align: right; font-weight: bold; color: ${isPositive ? '#27ae60' : '#e74c3c'};">
                                ${isPositive ? '+' : ''}${tx.amount}
                            </td>
                        </tr>
                    `;
                }).join('');
                document.getElementById('transactionList').innerHTML = html;
            }

            function openRedeemModal(itemId, itemName, cost, canAfford) {
                selectedItemId = itemId;
                selectedItemCost = cost;
                document.getElementById('redeemItemName').textContent = itemName;
                document.getElementById('redeemCost').textContent = cost.toLocaleString();
                document.getElementById('redeemError').style.display = canAfford ? 'none' : 'block';
                document.getElementById('confirmRedeemBtn').disabled = !canAfford;
                document.getElementById('confirmRedeemBtn').style.opacity = canAfford ? '1' : '0.5';
                document.getElementById('redeemModal').style.display = 'flex';
            }

            function closeRedeemModal() {
                document.getElementById('redeemModal').style.display = 'none';
                selectedItemId = null;
            }

            function confirmRedeem() {
                if (!selectedItemId) return;

                fetch(`/api/redeem-shop/${selectedItemId}/redeem`, { method: 'POST' })
                    .then(r => r.json())
                    .then(response => {
                        closeRedeemModal();
                        if (response.success) {
                            document.getElementById('successItemName').textContent = response.data.item.name;
                            document.getElementById('remainingBalance').textContent = `å‰©é¤˜ç¢ç‰‡: ${response.data.remainingBalance.toLocaleString()}`;
                            document.getElementById('successModal').style.display = 'flex';
                            loadShardBalance();
                            loadShopItems();
                            loadTransactions();
                        } else {
                            alert(response.message || 'å…Œæ›å¤±æ•—');
                        }
                    })
                    .catch(err => {
                        console.error('Error:', err);
                        alert('æ“ä½œå¤±æ•—');
                        closeRedeemModal();
                    });
            }

            function closeSuccessModal() {
                document.getElementById('successModal').style.display = 'none';
            }
        </script>
    </div>
</body>

</html>