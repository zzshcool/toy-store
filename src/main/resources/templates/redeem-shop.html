<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="~{layout :: html(title='ç¢ç‰‡å…Œæ›å•†åº—', content=~{::content})}">

<body>
    <div th:fragment="content">
        <!-- é é¢å°ˆå±¬æ¨£å¼ -->
        <link rel="stylesheet" th:href="@{/css/game-listing.css}">
        <link rel="stylesheet" th:href="@{/css/game-modals.css}">

        <!-- Alpine.js ä¸»å®¹å™¨ -->
        <div class="game-page" x-data="redeemComponent">
            <div class="container section">
                <h2 class="section-title">ğŸ’ ç¢ç‰‡å…Œæ›å•†åº—</h2>

                <!-- ç¢ç‰‡é¤˜é¡ -->
                <div class="shard-balance-section">
                    <div class="shard-balance">
                        <span class="shard-icon">ğŸ’</span>
                        <span x-text="formatNumber(shardBalance)">0</span>
                        <span class="shard-unit">ç¢ç‰‡</span>
                    </div>
                    <p class="section-subtitle">æŠ½çç²å¾—ç¢ç‰‡ï¼Œç´¯ç©å…Œæ›ç¨€æœ‰çå“ï¼</p>
                </div>

                <!-- å•†å“åˆ—è¡¨ -->
                <div class="game-grid">
                    <!-- è¼‰å…¥ä¸­ -->
                    <div x-show="items.length === 0" class="game-loading">
                        <div class="game-loading__spinner"></div>
                        <p>è¼‰å…¥ä¸­...</p>
                    </div>

                    <!-- å•†å“å¡ç‰‡ -->
                    <template x-for="item in items" :key="item.id">
                        <div class="redeem-card game-card" :class="{ 'sold-out': !item.hasStock }">
                            <span class="game-card__badge" x-show="item.itemType !== 'PRIZE'"
                                x-text="item.itemTypeDisplay"></span>
                            <div class="game-card__image game-card__placeholder"
                                :class="getGradientClass(item.itemType)">
                                <template x-if="item.imageUrl">
                                    <img :src="item.imageUrl" :alt="item.name">
                                </template>
                                <template x-if="!item.imageUrl">
                                    <span style="font-size: 4rem;">ğŸ</span>
                                </template>
                            </div>
                            <div class="game-card__info">
                                <h4 class="game-card__title" x-text="item.name"></h4>
                                <p class="game-card__desc" x-text="item.description || ''"></p>
                                <div class="game-card__price-block">
                                    <div class="game-card__price-row">
                                        <span class="game-card__price">ğŸ’ <span
                                                x-text="formatNumber(item.shardCost)"></span></span>
                                        <span class="game-card__stock"
                                            :class="{ 'game-card__stock--low': item.stock < 3 }">
                                            åº«å­˜: <span x-text="item.stock"></span>/<span x-text="item.totalStock"></span>
                                        </span>
                                    </div>
                                    <div class="stock-bar"
                                        style="background: #eee; border-radius: 10px; height: 6px; margin-top: 10px; overflow: hidden;">
                                        <div :style="{ width: item.stockPercentage + '%' }"
                                            style="height: 100%; background: linear-gradient(90deg, #27ae60, #2ecc71);">
                                        </div>
                                    </div>
                                </div>
                                <template x-if="!item.hasStock">
                                    <button class="game-modal__btn game-modal__btn--cancel"
                                        style="width: 100%; margin-top: 12px;" disabled>å·²å”®ç½„</button>
                                </template>
                                <template x-if="item.hasStock">
                                    <button class="game-modal__btn game-modal__btn--confirm"
                                        style="width: 100%; margin-top: 12px;"
                                        :style="{ opacity: shardBalance >= item.shardCost ? '1' : '0.6' }"
                                        @click="openRedeemModal(item)">
                                        <span x-text="shardBalance >= item.shardCost ? 'ç«‹å³å…Œæ›' : 'ç¢ç‰‡ä¸è¶³'"></span>
                                    </button>
                                </template>
                            </div>
                        </div>
                    </template>
                </div>

                <!-- äº¤æ˜“ç´€éŒ„ -->
                <div class="transaction-section">
                    <h3 class="transaction-section__title">ğŸ“œ ç¢ç‰‡ç´€éŒ„</h3>
                    <div class="transaction-table-wrapper">
                        <table class="transaction-table">
                            <thead>
                                <tr>
                                    <th>é¡å‹</th>
                                    <th>èªªæ˜</th>
                                    <th class="text-right">æ•¸é‡</th>
                                </tr>
                            </thead>
                            <tbody>
                                <template x-if="transactions.length === 0">
                                    <tr>
                                        <td colspan="3" style="padding: 20px; text-align: center; color: #999;">æš«ç„¡äº¤æ˜“ç´€éŒ„
                                        </td>
                                    </tr>
                                </template>
                                <template x-for="tx in transactions" :key="tx.id">
                                    <tr>
                                        <td style="padding: 12px 15px;">
                                            <span class="tx-badge"
                                                :class="tx.amount > 0 ? 'tx-badge--positive' : 'tx-badge--negative'"
                                                x-text="tx.typeDisplay"></span>
                                        </td>
                                        <td style="padding: 12px 15px; color: #666;" x-text="tx.description"></td>
                                        <td style="padding: 12px 15px; text-align: right; font-weight: bold;"
                                            :style="{ color: tx.amount > 0 ? '#27ae60' : '#e74c3c' }">
                                            <span x-text="(tx.amount > 0 ? '+' : '') + tx.amount"></span>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- å…Œæ›ç¢ºèªå½ˆçª— -->
            <div class="game-modal" x-show="showRedeemModal" x-cloak @click.self="closeRedeemModal()">
                <div class="game-modal__card">
                    <div class="game-modal__icon">ğŸ</div>
                    <h3 class="game-modal__title">ç¢ºèªå…Œæ›</h3>
                    <div class="game-modal__details">
                        <div class="redeem-preview">
                            <div class="redeem-preview__icon">ğŸ</div>
                            <h4 class="redeem-preview__name" x-text="selectedItem?.name || 'å•†å“åç¨±'"></h4>
                        </div>
                    </div>
                    <p class="game-modal__desc">
                        éœ€è¦ <span class="redeem-cost" x-text="formatNumber(selectedItem?.shardCost || 0)"></span> ç¢ç‰‡
                    </p>
                    <p class="game-modal__error" x-show="!canAfford">ç¢ç‰‡ä¸è¶³</p>
                    <div class="game-modal__actions">
                        <button class="game-modal__btn game-modal__btn--cancel" @click="closeRedeemModal()">å–æ¶ˆ</button>
                        <button class="game-modal__btn game-modal__btn--confirm" @click="confirmRedeem()"
                            :disabled="!canAfford || isProcessing" :style="{ opacity: canAfford ? '1' : '0.5' }">
                            <span x-text="isProcessing ? 'è™•ç†ä¸­...' : 'ç¢ºèªå…Œæ›'"></span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- å…Œæ›æˆåŠŸå½ˆçª— -->
            <div class="game-modal game-result-modal" x-show="showSuccessModal" x-cloak
                @click.self="closeSuccessModal()">
                <div class="game-modal__card">
                    <div class="game-modal__icon">ğŸ‰</div>
                    <h2 class="game-result__title">å…Œæ›æˆåŠŸï¼</h2>
                    <p class="game-result__prize-name" x-text="redeemResult?.item?.name || ''"></p>
                    <p class="game-result__shards">
                        å‰©é¤˜ç¢ç‰‡: <span x-text="formatNumber(redeemResult?.remainingBalance || 0)"></span>
                    </p>
                    <button class="game-result__btn" @click="closeSuccessModal()">å¤ªæ£’äº†ï¼</button>
                </div>
            </div>
        </div>

        <!-- Alpine.js å…ƒä»¶ -->
        <script th:src="@{/js/game-utils.js}"></script>
        <script th:src="@{/js/alpine/redeem-component.js}"></script>

        <!-- é é¢å°ˆå±¬æ¨£å¼ -->
        <style>
            .shard-balance-section {
                text-align: center;
                margin-bottom: 40px;
            }

            .shard-balance {
                display: inline-flex;
                align-items: center;
                gap: 10px;
                background: linear-gradient(145deg, #667eea, #764ba2);
                color: #fff;
                padding: 15px 30px;
                border-radius: 50px;
                font-size: 1.5rem;
                font-weight: 700;
                box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
            }

            .shard-icon {
                font-size: 1.8rem;
            }

            .shard-unit {
                font-size: 1rem;
                font-weight: 400;
                opacity: 0.8;
            }

            .transaction-section {
                margin-top: 50px;
            }

            .transaction-section__title {
                margin-bottom: 20px;
            }

            .transaction-table-wrapper {
                overflow-x: auto;
            }

            .transaction-table {
                width: 100%;
                border-collapse: collapse;
                background: #fff;
                border-radius: 10px;
                overflow: hidden;
            }

            .transaction-table th {
                background: #f8f9fa;
                padding: 12px 15px;
                text-align: left;
                font-weight: 600;
            }

            .tx-badge {
                padding: 3px 10px;
                border-radius: 10px;
                font-size: 0.8rem;
            }

            .tx-badge--positive {
                background: #d4edda;
                color: #155724;
            }

            .tx-badge--negative {
                background: #f8d7da;
                color: #721c24;
            }

            .redeem-preview {
                text-align: center;
                margin-bottom: 15px;
            }

            .redeem-preview__icon {
                font-size: 3rem;
                margin-bottom: 10px;
            }

            .redeem-preview__name {
                margin: 0;
                font-size: 1.2rem;
            }

            .redeem-cost {
                color: #6c5ce7;
                font-weight: 700;
                font-size: 1.2rem;
            }

            [x-cloak] {
                display: none !important;
            }
        </style>
    </div>
</body>

</html>