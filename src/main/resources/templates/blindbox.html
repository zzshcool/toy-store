<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="~{layout :: html(title='å‹•æ¼«å‘¨é‚Š', content=~{::content})}">

<body>
    <div th:fragment="content">
        <link rel="stylesheet" th:href="@{/css/gacha-animations.css}">
        <script th:src="@{/js/game-utils.js}"></script>

        <div class="container section">
            <h2 class="section-title">ğŸ² å‹•æ¼«å‘¨é‚Š (ç›²ç›’)</h2>
            <p class="text-center" style="color: var(--text-secondary); margin-bottom: 30px;">
                æŒ‘é¸æ‚¨å¿ƒå„€çš„ç›²ç›’ï¼Œé«”é©—æ‹†ç›’çš„é©šå–œï¼æ”¯æ´å–®æŠ½ã€å…¨åŒ…ã€å¤©é¸æŠ½èˆ‡é“å…·å¡ï¼
            </p>

            <!-- ç›²ç›’åˆ—è¡¨ -->
            <div id="boxList" class="grid" style="margin-bottom: 40px;">
                <div class="text-center" style="grid-column: 1/-1; padding: 40px;">
                    <div class="loading-spinner"></div>
                    <p>è¼‰å…¥ä¸­...</p>
                </div>
            </div>

            <!-- ç›²ç›’è©³æƒ…å€ï¼ˆé¸æ“‡å¾Œé¡¯ç¤ºï¼‰ -->
            <div id="detailSection" style="display: none;">
                <!-- å€’æ•¸è¨ˆæ™‚æç¤º -->
                <div id="countdownBanner"
                    style="display: none; background: linear-gradient(to right, #f12711, #f5af19); color: white; padding: 15px; text-align: center; border-radius: 10px; margin-bottom: 20px; font-weight: bold;">
                    â±ï¸ é–å®šå€’æ•¸: <span id="countdownTimer">180</span> ç§’ - è«‹åœ¨æ™‚é–“å…§æ±ºå®šæ˜¯å¦è³¼è²·
                </div>

                <div
                    style="background: linear-gradient(145deg, #1a1a2e, #16213e); border-radius: 20px; padding: 30px; margin-bottom: 30px;">

                    <!-- ç›²ç›’è³‡è¨Š -->
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px; margin-bottom: 25px;">
                        <div>
                            <h3 id="selectedBoxName" style="color: white; margin: 0;">ç›²ç›’åç¨±</h3>
                            <p id="selectedBoxDesc" style="color: #aaa; margin: 5px 0 0 0;">æè¿°</p>
                        </div>
                        <div style="text-align: right;">
                            <div style="color: var(--gacha-gold); font-size: 1.5rem; font-weight: bold;">
                                å–®æŠ½ $<span id="pricePerBox">0</span>
                            </div>
                            <div style="color: #ff6b6b; font-size: 1.1rem;">
                                å…¨åŒ…å„ªæƒ  $<span id="fullBoxPrice">0</span>
                            </div>
                        </div>
                    </div>

                    <!-- é“å…·å¡å€ -->
                    <div id="propCardBar"
                        style="background: rgba(255,255,255,0.1); border-radius: 10px; padding: 15px; margin-bottom: 20px;">
                        <div style="color: white; font-weight: bold; margin-bottom: 10px;">ğŸƒ é“å…·å¡</div>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button class="btn btn-outline" onclick="useHintCard()"
                                style="color: #ffd700; border-color: #ffd700;">
                                ğŸ’¡ æç¤ºå¡
                            </button>
                            <button class="btn btn-outline" onclick="usePeekCard()"
                                style="color: #00e5ff; border-color: #00e5ff;">
                                ğŸ‘ï¸ é€è¦–å¡
                            </button>
                            <button class="btn btn-outline" onclick="useSwapCard()"
                                style="color: #ff6b6b; border-color: #ff6b6b;">
                                ğŸ”„ æ›ä¸€ç›’
                            </button>
                        </div>
                    </div>

                    <!-- ç›²ç›’ç¶²æ ¼ -->
                    <div id="itemGrid" class="blindbox-grid">
                        <!-- ç›²ç›’æ ¼å­å°‡ç”± JS å‹•æ…‹ç”Ÿæˆ -->
                    </div>

                    <!-- æ“ä½œæŒ‰éˆ•å€ -->
                    <div style="display: flex; gap: 15px; margin-top: 25px; flex-wrap: wrap; justify-content: center;">
                        <button class="btn btn-outline" onclick="backToList()"
                            style="color: white; border-color: white;">
                            â† è¿”å›åˆ—è¡¨
                        </button>
                        <button class="btn-gacha" onclick="randomPurchase()"
                            style="background: linear-gradient(to right, #667eea, #764ba2);">
                            ğŸ² å¤©é¸æŠ½
                        </button>
                        <button class="btn-gacha" onclick="fullPurchase()"
                            style="background: linear-gradient(to right, #f12711, #f5af19);">
                            ğŸ“¦ å…¨åŒ…è³¼è²·
                        </button>
                        <button class="btn-gacha" onclick="trialDraw()" style="background: #6c5ce7;">
                            âœ¨ å…è²»è©¦æŠ½
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- è³¼è²·ç¢ºèªå½ˆçª— -->
        <div id="purchaseModal"
            style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 10000; align-items: center; justify-content: center;">
            <div
                style="background: white; border-radius: 20px; padding: 30px; max-width: 400px; width: 100%; text-align: center;">
                <h3 style="margin-bottom: 20px;">ç¢ºèªè³¼è²·</h3>
                <div
                    style="margin-bottom: 25px; text-align: left; background: #f8f9fa; padding: 15px; border-radius: 10px;">
                    <p>ç›’è™Ÿï¼š#<span id="confirmBoxNumber">0</span></p>
                    <p>åƒ¹æ ¼ï¼š<strong id="confirmPrice" style="color: var(--gacha-red);">$0</strong></p>
                    <p id="countdownInfo" style="color: #666; font-size: 0.9rem;"></p>
                </div>
                <div style="display: flex; gap: 15px; justify-content: center;">
                    <button class="btn btn-outline" onclick="closePurchaseModal()">å–æ¶ˆ</button>
                    <button id="purchaseBtn" class="btn-gacha" onclick="executePurchase()">ç¢ºèªè³¼è²·</button>
                </div>
            </div>
        </div>

        <!-- çµæœå½ˆçª— -->
        <div id="resultModal"
            style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 10001; overflow-y: auto;">
            <div
                style="min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 40px 20px;">
                <div
                    style="background: white; border-radius: 20px; padding: 40px; max-width: 500px; width: 100%; text-align: center;">
                    <h2 id="resultTitle" style="margin-bottom: 20px;">ğŸ‰ æ­å–œç²å¾—ï¼</h2>
                    <div id="resultContent" style="margin-bottom: 30px;">
                        <!-- çµæœå°‡ç”± JS å‹•æ…‹ç”Ÿæˆ -->
                    </div>
                    <button class="btn-gacha" onclick="closeResultModal()">å¤ªæ£’äº†ï¼</button>
                </div>
            </div>
        </div>

        <script th:inline="javascript">
            let currentBoxId = null;
            let selectedItemNumber = null;
            let countdownInterval = null;

            document.addEventListener('DOMContentLoaded', function () {
                loadBoxList();
            });

            function loadBoxList() {
                fetch('/api/blindbox')
                    .then(res => res.json())
                    .then(response => {
                        if (response.success && response.data.length > 0) {
                            renderBoxList(response.data);
                        } else {
                            document.getElementById('boxList').innerHTML = `
                                <div class="text-center" style="grid-column: 1/-1; padding: 40px;">
                                    <p>ç›®å‰æ²’æœ‰é€²è¡Œä¸­çš„ç›²ç›’</p>
                                </div>
                            `;
                        }
                    })
                    .catch(err => {
                        console.error('Error:', err);
                        document.getElementById('boxList').innerHTML = `
                            <div class="text-center" style="grid-column: 1/-1; padding: 40px;">
                                <p style="color: var(--error-color);">è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†</p>
                            </div>
                        `;
                    });
            }

            function renderBoxList(boxes) {
                const html = boxes.map(box => `
                    <div class="card" style="cursor: pointer;" onclick="selectBox(${box.id})">
                        <div class="img-placeholder" style="background: linear-gradient(145deg, #ff6b6b, #feca57);">
                            <span style="color: white; font-size: 3rem;">ğŸ“¦</span>
                        </div>
                        <div style="padding: 20px;">
                            <span style="background: #6c5ce7; color: white; padding: 3px 10px; border-radius: 20px; font-size: 0.8rem;">
                                ${box.ipName}
                            </span>
                            <h3 style="margin: 10px 0;">${box.name}</h3>
                            <p style="color: var(--text-secondary); font-size: 0.9rem;">${box.description || ''}</p>
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 15px;">
                                <span style="color: var(--accent-color); font-weight: bold;">$${box.pricePerBox}</span>
                                <span style="color: #666; font-size: 0.9rem;">å‰©é¤˜ ${box.remainingCount} / ${box.totalBoxes}</span>
                            </div>
                        </div>
                    </div>
                `).join('');
                document.getElementById('boxList').innerHTML = html;
            }

            function selectBox(boxId) {
                currentBoxId = boxId;
                document.getElementById('boxList').style.display = 'none';
                document.getElementById('detailSection').style.display = 'block';
                loadBoxDetails(boxId);
            }

            function backToList() {
                currentBoxId = null;
                selectedItemNumber = null;
                clearCountdown();
                document.getElementById('boxList').style.display = 'grid';
                document.getElementById('detailSection').style.display = 'none';
            }

            function loadBoxDetails(boxId) {
                fetch(`/api/blindbox/${boxId}`)
                    .then(res => res.json())
                    .then(response => {
                        if (response.success) {
                            const box = response.data;
                            document.getElementById('selectedBoxName').textContent = box.name;
                            document.getElementById('selectedBoxDesc').textContent = box.description || '';
                            document.getElementById('pricePerBox').textContent = box.pricePerBox;
                            document.getElementById('fullBoxPrice').textContent = box.fullBoxPrice;
                            renderItems(box.items);
                        }
                    });
            }

            function renderItems(items) {
                const html = items.map(item => {
                    let statusClass = item.status.toLowerCase();
                    let statusText = '';
                    let clickable = false;

                    if (item.status === 'SOLD') {
                        statusText = 'å·²å”®';
                    } else if (item.status === 'LOCKED' && !item.isLockExpired) {
                        statusText = 'é–å®šä¸­';
                    } else {
                        statusText = 'å¯é¸';
                        clickable = true;
                        statusClass = 'available';
                    }

                    return `
                        <div class="blindbox-item ${statusClass}" 
                             ${clickable ? `onclick="selectItem(${item.boxNumber})"` : ''}
                             style="cursor: ${clickable ? 'pointer' : 'not-allowed'};">
                            <div class="box-icon">ğŸ“¦</div>
                            <div class="box-number">#${String(item.boxNumber).padStart(2, '0')}</div>
                            <div class="box-status">${statusText}</div>
                            ${item.status === 'SOLD' && item.prizeName ? `<div class="prize-name">${item.prizeName}</div>` : ''}
                        </div>
                    `;
                }).join('');
                document.getElementById('itemGrid').innerHTML = html;
            }

            function selectItem(boxNumber) {
                selectedItemNumber = boxNumber;

                const isLoggedIn = /*[[${currentUser != null}]]*/ false;

                if (!isLoggedIn) {
                    // æœªç™»å…¥ç›´æ¥è©¦æŠ½
                    trialDraw();
                    return;
                }

                // é–å®šç›’å­
                fetch(`/api/blindbox/${currentBoxId}/items/${boxNumber}/lock`, {
                    method: 'POST'
                })
                    .then(res => res.json())
                    .then(response => {
                        if (response.success) {
                            startCountdown(response.data.remainingSeconds || 180);
                            showPurchaseModal(boxNumber);
                            loadBoxDetails(currentBoxId);
                        } else {
                            alert(response.message);
                        }
                    });
            }

            function startCountdown(seconds) {
                clearCountdown();
                let remaining = seconds;

                document.getElementById('countdownBanner').style.display = 'block';
                document.getElementById('countdownTimer').textContent = remaining;
                document.getElementById('countdownInfo').textContent = `å‰©é¤˜ ${remaining} ç§’`;

                countdownInterval = setInterval(() => {
                    remaining--;
                    document.getElementById('countdownTimer').textContent = remaining;
                    document.getElementById('countdownInfo').textContent = `å‰©é¤˜ ${remaining} ç§’`;

                    if (remaining <= 0) {
                        clearCountdown();
                        closePurchaseModal();
                        alert('é–å®šå·²éæœŸï¼Œè«‹é‡æ–°é¸æ“‡');
                        loadBoxDetails(currentBoxId);
                    }
                }, 1000);
            }

            function clearCountdown() {
                if (countdownInterval) {
                    clearInterval(countdownInterval);
                    countdownInterval = null;
                }
                document.getElementById('countdownBanner').style.display = 'none';
            }

            function showPurchaseModal(boxNumber) {
                document.getElementById('confirmBoxNumber').textContent = boxNumber;
                document.getElementById('confirmPrice').textContent = '$' + document.getElementById('pricePerBox').textContent;
                document.getElementById('purchaseModal').style.display = 'flex';
            }

            function closePurchaseModal() {
                document.getElementById('purchaseModal').style.display = 'none';
            }

            function executePurchase() {
                const btn = document.getElementById('purchaseBtn');
                btn.disabled = true;
                btn.textContent = 'è™•ç†ä¸­...';

                fetch(`/api/blindbox/${currentBoxId}/items/${selectedItemNumber}/purchase`, {
                    method: 'POST'
                })
                    .then(res => res.json())
                    .then(response => {
                        closePurchaseModal();
                        clearCountdown();
                        btn.disabled = false;
                        btn.textContent = 'ç¢ºèªè³¼è²·';

                        if (response.success) {
                            showResult([response.data.item], response.data.shardsEarned);
                            loadBoxDetails(currentBoxId);
                        } else {
                            alert(response.message);
                        }
                    });
            }

            function randomPurchase() {
                const isLoggedIn = /*[[${currentUser != null}]]*/ false;
                if (!isLoggedIn) {
                    trialDraw();
                    return;
                }

                fetch(`/api/blindbox/${currentBoxId}/random-purchase`, { method: 'POST' })
                    .then(res => res.json())
                    .then(response => {
                        if (response.success) {
                            showResult([response.data.item], response.data.shardsEarned);
                            loadBoxDetails(currentBoxId);
                        } else {
                            alert(response.message);
                        }
                    });
            }

            function fullPurchase() {
                const isLoggedIn = /*[[${currentUser != null}]]*/ false;
                if (!isLoggedIn) {
                    alert('è«‹å…ˆç™»å…¥ä»¥ä½¿ç”¨å…¨åŒ…åŠŸèƒ½');
                    return;
                }

                if (!confirm('ç¢ºå®šè¦å…¨åŒ…è³¼è²·å—ï¼Ÿ')) return;

                fetch(`/api/blindbox/${currentBoxId}/full-purchase`, { method: 'POST' })
                    .then(res => res.json())
                    .then(response => {
                        if (response.success) {
                            showResult(response.data.items, response.data.totalShards, true);
                            loadBoxDetails(currentBoxId);
                        } else {
                            alert(response.message);
                        }
                    });
            }

            function trialDraw() {
                fetch(`/api/blindbox/${currentBoxId}/trial`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ count: 1 })
                })
                    .then(res => res.json())
                    .then(response => {
                        if (response.success) {
                            showTrialResult(response.data);
                        } else {
                            alert(response.message);
                        }
                    });
            }

            function showResult(items, shards, isFullBox = false) {
                const title = isFullBox ? 'ğŸ‰ å…¨åŒ…æˆåŠŸï¼' : 'ğŸ æ­å–œç²å¾—ï¼';
                document.getElementById('resultTitle').textContent = title;

                const html = items.map(item => `
                    <div style="background: linear-gradient(145deg, #f8f9fa, #e9ecef); border-radius: 15px; padding: 20px; margin: 10px 0;">
                        <div style="font-size: 2rem; margin-bottom: 10px;">ğŸ</div>
                        <div style="font-weight: bold; color: #333;">${item.prizeName || 'ç¥ç§˜çå“'}</div>
                        ${item.rarityDisplay ? `<div style="color: #6c5ce7; font-size: 0.9rem;">${item.rarityDisplay}</div>` : ''}
                    </div>
                `).join('') + `<p style="color: #6c5ce7; font-weight: bold; margin-top: 15px;">+${shards} ç©åˆ†</p>`;

                document.getElementById('resultContent').innerHTML = html;
                document.getElementById('resultModal').style.display = 'flex';
            }

            function showTrialResult(data) {
                document.getElementById('resultTitle').textContent = 'âœ¨ è©¦æŠ½çµæœ';

                const html = `
                    <div style="background: #6c5ce7; color: white; padding: 10px; border-radius: 10px; margin-bottom: 15px;">
                        é€™æ˜¯è©¦æŠ½æ¨¡å¼ï¼Œçµæœä¸åˆ—å…¥ç´€éŒ„
                    </div>
                ` + data.results.map(item => `
                    <div style="background: linear-gradient(145deg, #f8f9fa, #e9ecef); border-radius: 15px; padding: 20px; margin: 10px 0;">
                        <div style="font-size: 2rem; margin-bottom: 10px;">ğŸ“¦</div>
                        <div style="font-weight: bold; color: #333;">${item.prizeName}</div>
                        <div style="color: #6c5ce7; font-size: 0.9rem;">${item.rarityDisplay}</div>
                    </div>
                `).join('');

                document.getElementById('resultContent').innerHTML = html;
                document.getElementById('resultModal').style.display = 'flex';
            }

            function closeResultModal() {
                document.getElementById('resultModal').style.display = 'none';
            }

            // é“å…·å¡åŠŸèƒ½
            function useHintCard() {
                const isLoggedIn = /*[[${currentUser != null}]]*/ false;
                if (!isLoggedIn) {
                    alert('è«‹å…ˆç™»å…¥ä»¥ä½¿ç”¨é“å…·å¡');
                    return;
                }

                fetch(`/api/blindbox/${currentBoxId}/use-hint`, { method: 'POST' })
                    .then(res => res.json())
                    .then(response => {
                        if (response.success) {
                            alert(response.message);
                            renderItems(response.data);
                        } else {
                            alert(response.message);
                        }
                    });
            }

            function usePeekCard() {
                if (!selectedItemNumber) {
                    alert('è«‹å…ˆé¸æ“‡ä¸€å€‹ç›’å­');
                    return;
                }

                const isLoggedIn = /*[[${currentUser != null}]]*/ false;
                if (!isLoggedIn) {
                    alert('è«‹å…ˆç™»å…¥ä»¥ä½¿ç”¨é“å…·å¡');
                    return;
                }

                fetch(`/api/blindbox/${currentBoxId}/items/${selectedItemNumber}/use-peek`, { method: 'POST' })
                    .then(res => res.json())
                    .then(response => {
                        if (response.success) {
                            const item = response.data;
                            alert(`ğŸ‘ï¸ é€è¦–çµæœï¼š${item.prizeName} (${item.rarityDisplay})`);
                        } else {
                            alert(response.message);
                        }
                    });
            }

            function useSwapCard() {
                if (!selectedItemNumber) {
                    alert('è«‹å…ˆé¸æ“‡ä¸€å€‹ç›’å­');
                    return;
                }

                const isLoggedIn = /*[[${currentUser != null}]]*/ false;
                if (!isLoggedIn) {
                    alert('è«‹å…ˆç™»å…¥ä»¥ä½¿ç”¨é“å…·å¡');
                    return;
                }

                fetch(`/api/blindbox/${currentBoxId}/items/${selectedItemNumber}/use-swap`, { method: 'POST' })
                    .then(res => res.json())
                    .then(response => {
                        if (response.success) {
                            selectedItemNumber = response.data.boxNumber;
                            alert(response.message);
                            loadBoxDetails(currentBoxId);
                            startCountdown(response.data.remainingSeconds || 180);
                        } else {
                            alert(response.message);
                        }
                    });
            }
        </script>

        <style>
            .blindbox-grid {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
                gap: 15px;
            }

            .blindbox-item {
                background: linear-gradient(145deg, #2d3436, #636e72);
                border-radius: 15px;
                padding: 20px;
                text-align: center;
                color: white;
                transition: all 0.3s ease;
            }

            .blindbox-item.available:hover {
                transform: translateY(-5px);
                box-shadow: 0 10px 30px rgba(108, 92, 231, 0.3);
            }

            .blindbox-item.sold {
                opacity: 0.5;
                background: #555;
            }

            .blindbox-item.locked {
                border: 2px solid #ffd700;
                animation: pulse 1s infinite;
            }

            .box-icon {
                font-size: 2rem;
                margin-bottom: 10px;
            }

            .box-number {
                font-weight: bold;
                font-size: 1.1rem;
            }

            .box-status {
                font-size: 0.8rem;
                opacity: 0.8;
                margin-top: 5px;
            }

            .prize-name {
                font-size: 0.75rem;
                margin-top: 8px;
                color: #ffd700;
            }

            @keyframes pulse {

                0%,
                100% {
                    opacity: 1;
                }

                50% {
                    opacity: 0.7;
                }
            }
        </style>
    </div>
</body>

</html>