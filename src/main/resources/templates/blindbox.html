<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="~{layout :: html(title='Áõ≤Áõí', content=~{::content})}">

<body>
    <div th:fragment="content">
        <link rel="stylesheet" th:href="@{/css/game-listing.css}">
        <link rel="stylesheet" th:href="@{/css/game-modals.css}">
        <link rel="stylesheet" th:href="@{/css/home-feed.css}">

        <div class="game-page" x-data="blindboxComponent">
            <div class="container section">
                <h2 class="section-title">üì¶ Áõ≤ÁõíÊ®ÇÂúí</h2>
                <p class="section-subtitle">ÈÅ∏Êìá‰Ω†ÁöÑÂëΩÈÅã‰πãÁõíÔºÅ</p>

                <!-- Áõ≤ÁõíÂàóË°® - Âç°ÁâáÂºè Feed -->
                <div class="game-feed-grid" x-show="!currentBox">
                    <div x-show="boxes.length === 0" class="feed-loader">
                        <div class="spinner"></div>
                    </div>
                    <template x-for="box in boxes" :key="box.id">
                        <div class="feed-card" :class="{ 'sold-out': box.remainingCount === 0 }"
                            @click="selectBox(box)">
                            <div class="feed-card__image-wrapper">
                                <img :src="box.imageUrl || '/images/placeholder.jpg'" class="feed-card__image"
                                    loading="lazy">
                                <!-- Stock Overlay -->
                                <div class="feed-stock-badge">
                                    <span x-text="box.remainingCount + '/' + box.totalBoxes"></span>
                                </div>
                            </div>

                            <div class="feed-card__content">
                                <div class="feed-card__header">
                                    <span class="feed-tag badge-blindbox">ÁõíÁé©</span>
                                    <h3 class="feed-card__title" x-text="box.name"></h3>
                                </div>

                                <div class="feed-card__footer">
                                    <div class="feed-card__price">
                                        <span class="currency">$</span>
                                        <span class="amount" x-text="box.pricePerBox"></span>
                                    </div>
                                    <span class="feed-action-icon">‚ûî</span>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>

                <!-- Áõ≤ÁõíË©≥ÊÉÖ -->
                <div class="blindbox-detail-section" x-show="currentBox" x-cloak>
                    <div class="game-detail-header">
                        <div class="game-detail-header__top">
                            <div>
                                <h3 class="game-detail-header__name" x-text="currentBox?.name"></h3>
                                <p class="game-detail-header__desc" x-text="currentBox?.description || ''"></p>
                            </div>
                            <div>
                                <div class="game-detail-header__price">$<span x-text="pricePerBox"></span> / Áõí</div>
                                <div style="font-size: 0.9rem; color: #aaa;">ÂÖ®ÂåÖ $<span x-text="fullBoxPrice"></span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Êìç‰ΩúÊåâÈàï -->
                    <div class="blindbox-actions">
                        <button class="game-modal__btn game-modal__btn--trial" @click="trialDraw()"
                            :disabled="isProcessing">üß™ Ë©¶ÊäΩ</button>
                        <button class="game-modal__btn game-modal__btn--confirm" @click="randomPurchase()"
                            :disabled="isProcessing">üé≤ Â§©ÈÅ∏ÊäΩ</button>
                    </div>

                    <!-- Ê†ºÂ≠êÈÅ∏Êìá -->
                    <div class="blindbox-grid">
                        <template x-for="item in items" :key="item.boxNumber">
                            <div class="blindbox-item" :class="item.status.toLowerCase()"
                                :style="{ cursor: isItemClickable(item) ? 'pointer' : 'not-allowed' }"
                                @click="selectItem(item)">
                                <div class="box-icon">üì¶</div>
                                <div class="box-number" x-text="'#' + String(item.boxNumber).padStart(2, '0')"></div>
                                <div class="box-status" x-text="getItemStatus(item)"></div>
                                <div class="prize-name" x-show="item.status === 'SOLD' && item.prizeName"
                                    x-text="item.prizeName"></div>
                            </div>
                        </template>
                    </div>

                    <div style="text-align: center; margin-top: 20px;">
                        <button class="game-back-btn" @click="backToList()">‚Üê ËøîÂõûÂàóË°®</button>
                    </div>
                </div>
            </div>

            <!-- Ë≥ºË≤∑Á¢∫Ë™çÂΩàÁ™ó -->
            <div class="game-modal" x-show="showPurchaseModal" x-cloak @click.self="closePurchaseModal()">
                <div class="game-modal__card">
                    <!-- ÂÄíÊï∏Ë®àÊôÇ -->
                    <div class="countdown-circle">
                        <span x-text="remainingSeconds"></span>s
                    </div>
                    <h3 class="game-modal__title">Á¢∫Ë™çË≥ºË≤∑</h3>
                    <p class="game-modal__desc">ÊÇ®ÈÅ∏Êìá‰∫Ü #<span x-text="selectedItem?.boxNumber"></span></p>
                    <div class="game-modal__details">
                        <p>Ê∂àË≤ªÔºö$<span x-text="pricePerBox"></span></p>
                    </div>
                    <div class="game-modal__actions">
                        <button class="game-modal__btn game-modal__btn--cancel"
                            @click="closePurchaseModal()">ÂèñÊ∂à</button>
                        <button class="game-modal__btn game-modal__btn--confirm" @click="confirmPurchase()"
                            :disabled="isProcessing">
                            <span x-text="isProcessing ? 'ËôïÁêÜ‰∏≠...' : 'Á¢∫Ë™çË≥ºË≤∑'"></span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- ÁµêÊûúÂΩàÁ™ó -->
            <div class="game-modal game-result-modal" x-show="showResultModal" x-cloak @click.self="closeResultModal()">
                <div class="game-modal__card">
                    <div class="game-modal__icon">üéÅ</div>
                    <h2 class="game-result__title" x-text="isTrial ? '‚ú® Ë©¶ÊäΩÁµêÊûú' : 'üéâ ÊÅ≠ÂñúÁç≤ÂæóÔºÅ'"></h2>
                    <p class="game-result__trial-badge" x-show="isTrial">Ë©¶ÊäΩÈ´îÈ©ó</p>
                    <template x-if="result?.item">
                        <div>
                            <p class="game-result__prize-name" x-text="result.item.prizeName"></p>
                            <p class="game-result__prize-rarity" x-text="result.item.rarityDisplay"></p>
                        </div>
                    </template>
                    <template x-if="result?.results">
                        <div class="trial-results">
                            <template x-for="r in result.results" :key="r.prizeName">
                                <div class="trial-result-item">
                                    <span x-text="r.prizeName"></span>
                                    <span class="rarity-badge" x-text="r.rarityDisplay"></span>
                                </div>
                            </template>
                        </div>
                    </template>
                    <p class="game-result__shards" x-show="result?.shardsEarned > 0"
                        x-text="'+' + result?.shardsEarned + ' Á©çÂàÜ'"></p>
                    <button class="game-result__btn" @click="closeResultModal()">
                        <span x-text="isTrial ? 'ÂÜçË©¶‰∏ÄÊ¨°' : 'Â§™Ê£í‰∫ÜÔºÅ'"></span>
                    </button>
                </div>
            </div>
        </div>

        <script th:src="@{/js/game-utils.js}"></script>
        <script th:src="@{/js/alpine/blindbox-component.js}"></script>

        <style>
            .blindbox-actions {
                display: flex;
                gap: 15px;
                justify-content: center;
                margin: 20px 0;
            }

            .blindbox-grid {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
                gap: 15px;
                max-width: 600px;
                margin: 0 auto;
            }

            .blindbox-item {
                background: #fff;
                border-radius: 12px;
                padding: 15px;
                text-align: center;
                box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
                transition: all 0.2s;
            }

            .blindbox-item:hover {
                transform: translateY(-3px);
            }

            .blindbox-item.sold {
                opacity: 0.5;
                background: #eee;
            }

            .blindbox-item.locked {
                border: 2px solid #e74c3c;
            }

            .blindbox-item.available {
                border: 2px solid var(--accent-color);
            }

            .box-icon {
                font-size: 2rem;
                margin-bottom: 5px;
            }

            .box-number {
                font-weight: 700;
                color: #333;
            }

            .box-status {
                font-size: 0.8rem;
                color: #666;
                margin-top: 5px;
            }

            .prize-name {
                font-size: 0.75rem;
                color: #999;
                margin-top: 5px;
            }

            .countdown-circle {
                width: 60px;
                height: 60px;
                border-radius: 50%;
                background: linear-gradient(145deg, #667eea, #764ba2);
                color: #fff;
                display: flex;
                align-items: center;
                justify-content: center;
                font-weight: 700;
                font-size: 1.2rem;
                margin: 0 auto 15px;
            }

            .trial-results {
                margin: 15px 0;
            }

            .trial-result-item {
                display: flex;
                justify-content: center;
                gap: 10px;
                padding: 8px;
            }

            .rarity-badge {
                background: #6c5ce7;
                color: #fff;
                padding: 2px 8px;
                border-radius: 10px;
                font-size: 0.75rem;
            }

            [x-cloak] {
                display: none !important;
            }
        </style>
    </div>
</body>

</html>