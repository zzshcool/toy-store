<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="~{layout :: html(title='Âπ∏ÈÅãËΩâÁõ§', content=~{::content})}">

<body>
    <div th:fragment="content">
        <!-- È†ÅÈù¢Â∞àÂ±¨Ê®£Âºè -->
        <link rel="stylesheet" th:href="@{/css/game-listing.css}">
        <link rel="stylesheet" th:href="@{/css/game-modals.css}">
        <link rel="stylesheet" th:href="@{/css/home-feed.css}">

        <!-- Alpine.js ‰∏ªÂÆπÂô® -->
        <div class="game-page" x-data="rouletteComponent">
            <div class="container section">
                <h2 class="section-title">üé° Âπ∏ÈÅãËΩâÁõ§</h2>
                <p class="section-subtitle">ËΩâÂãïÂëΩÈÅã‰πãËº™ÔºåË¥èÂèñË±êÂéöÁçéÂìÅÔºÅ</p>

                <!-- Âπ∏ÈÅãÂÄºÈÄ≤Â∫¶ -->
                <div class="lucky-section" x-show="$store.user.isLoggedIn">
                    <div class="lucky-bar-wrapper">
                        <div class="lucky-bar">
                            <div class="lucky-bar__fill" :class="{ 'guarantee': isGuaranteeReady }"
                                :style="{ width: luckyProgress + '%' }"></div>
                        </div>
                        <span class="lucky-text" x-text="luckyValue + '/' + luckyThreshold"></span>
                    </div>
                    <p class="lucky-hint" :class="{ 'ready': isGuaranteeReady }">
                        <span
                            x-text="isGuaranteeReady ? 'üéâ ‰øùÂ∫ïÂ∑≤Ëß∏ÁôºÔºÅ‰∏ãÊ¨°ÂøÖ‰∏≠Â§ßÁçéÔºÅ' : 'Á¥ØÁ©çÊªø ' + luckyThreshold + ' Âπ∏ÈÅãÂÄºÂøÖ‰∏≠Â§ßÁçéÔºÅ'"></span>
                    </p>
                </div>

                <!-- ÈÅäÊà≤ÂàóË°® - Âç°ÁâáÂºè Feed -->
                <div class="game-feed-grid" x-show="!currentGame">
                    <div x-show="games.length === 0" class="feed-loader">
                        <div class="spinner"></div>
                        <p>ËºâÂÖ•‰∏≠...</p>
                    </div>

                    <template x-for="game in games" :key="game.id">
                        <div class="feed-card" @click="selectGame(game)">
                            <div class="feed-card__image-wrapper">
                                <img :src="game.imageUrl || '/images/placeholder.jpg'" class="feed-card__image"
                                    loading="lazy">
                            </div>

                            <div class="feed-card__content">
                                <div class="feed-card__header">
                                    <span class="feed-tag badge-roulette">ËΩâÁõ§</span>
                                    <h3 class="feed-card__title" x-text="game.name"></h3>
                                </div>

                                <div class="feed-card__footer">
                                    <div class="feed-card__price">
                                        <span class="currency">$</span>
                                        <span class="amount" x-text="game.pricePerSpin"></span>
                                    </div>
                                    <span class="feed-action-icon">‚ûî</span>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>

                <!-- ËΩâÁõ§ÈÅäÊà≤ÂçÄ -->
                <div class="roulette-game-section" x-show="currentGame" x-cloak>
                    <div class="game-detail-header">
                        <div class="game-detail-header__top">
                            <div>
                                <h3 class="game-detail-header__name" x-text="currentGame?.name"></h3>
                                <p class="game-detail-header__desc" x-text="currentGame?.description || ''"></p>
                            </div>
                            <div class="game-detail-header__price">
                                $<span x-text="displayPrice"></span> / Ê¨°
                            </div>
                        </div>
                    </div>

                    <!-- ËΩâÁõ§ÂÆπÂô® -->
                    <div class="roulette-container">
                        <div class="roulette-wheel">
                            <canvas id="wheelCanvas" width="300" height="300"></canvas>
                            <div class="roulette-center" @click="openConfirmModal()">
                                <span x-text="isSpinning ? 'ËΩâÂãï‰∏≠' : 'START'"></span>
                            </div>
                        </div>
                        <div class="roulette-pointer">‚ñº</div>
                    </div>

                    <!-- Êìç‰ΩúÊåâÈàï -->
                    <div class="roulette-actions">
                        <button class="game-modal__btn game-modal__btn--confirm" @click="openConfirmModal()"
                            :disabled="isSpinning">
                            <span x-text="isSpinning ? 'ËΩâÂãï‰∏≠...' : 'üé° ÈñãÂßãËΩâÂãï'"></span>
                        </button>
                        <button class="game-modal__btn game-modal__btn--trial" @click="spin(true)"
                            :disabled="isSpinning">üß™ ÂÖçË≤ªË©¶ÊäΩ</button>
                    </div>

                    <div style="text-align: center; margin-top: 20px;">
                        <button class="game-back-btn" @click="backToList()">‚Üê ËøîÂõûÂàóË°®</button>
                    </div>

                    <!-- ÁçéÂìÅÂàóË°® -->
                    <div class="game-prize-section">
                        <h4 class="game-prize-section__title">üéÅ ÁçéÂìÅ‰∏ÄË¶Ω</h4>
                        <div class="game-prize-grid">
                            <template x-for="slot in wheelSlots" :key="slot.id">
                                <div class="game-prize-item">
                                    <span class="prize-badge" :class="{
                                        'badge-jackpot': slot.slotType === 'JACKPOT',
                                        'badge-rare': slot.slotType === 'RARE'
                                    }" x-text="slot.slotType"></span>
                                    <div class="game-prize-item__name" x-text="slot.prizeName"></div>
                                    <div style="font-size: 0.85rem; color: #666;" x-text="slot.prizeDescription || ''">
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Á¢∫Ë™çÂΩàÁ™ó -->
            <div class="game-modal" x-show="showConfirmModal" x-cloak @click.self="closeConfirmModal()">
                <div class="game-modal__card">
                    <div class="game-modal__icon">üé°</div>
                    <h3 class="game-modal__title">Á¢∫Ë™çËΩâÂãï</h3>
                    <p class="game-modal__desc">Âç≥Â∞áÊâ£Èô§È§òÈ°çÈÄ≤Ë°åËΩâÁõ§</p>
                    <div class="game-modal__details">
                        <p class="game-modal__details-total">Ê∂àË≤ªÔºö$<span x-text="displayPrice"></span></p>
                    </div>
                    <div class="game-modal__actions">
                        <button class="game-modal__btn game-modal__btn--cancel" @click="closeConfirmModal()">ÂèñÊ∂à</button>
                        <button class="game-modal__btn game-modal__btn--trial" @click="spin(true)">ÂÖçË≤ªË©¶ÊäΩ</button>
                        <button class="game-modal__btn game-modal__btn--confirm" @click="spin(false)"
                            x-show="$store.user.isLoggedIn">Á¢∫Ë™çËΩâÂãï</button>
                    </div>
                </div>
            </div>

            <!-- ÁµêÊûúÂΩàÁ™ó -->
            <div class="game-modal game-result-modal" x-show="showResultModal" x-cloak @click.self="closeResultModal()">
                <div class="game-modal__card">
                    <div class="game-modal__icon" x-text="result?.slot?.isJackpot ? 'üèÜ' : 'üéä'"></div>
                    <h2 class="game-result__title">ÊÅ≠ÂñúÁç≤ÂæóÔºÅ</h2>
                    <p class="game-result__prize-name" x-text="result?.slot?.prizeName || 'Á•ûÁßòÁçéÂìÅ'"></p>
                    <p class="game-result__shards" x-show="result?.shardsEarned > 0"
                        x-text="'+' + result?.shardsEarned + ' Á¢éÁâá'"></p>
                    <p class="game-result__trial-badge" x-show="isTrial">Ë©¶ÊäΩÈ´îÈ©ó</p>
                    <div x-show="result?.isGuarantee"
                        style="background: #ffd700; color: #333; padding: 8px 15px; border-radius: 10px; margin: 10px 0;">
                        üéØ ‰øùÂ∫ïËß∏ÁôºÔºÅ
                    </div>
                    <button class="game-result__btn" @click="closeResultModal()">
                        <span x-text="isTrial ? 'ÂÜçË©¶‰∏ÄÊ¨°' : 'üì¶ Êü•ÁúãÁçéÂìÅÁ¥ÄÈåÑ'"></span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Alpine.js ÂÖÉ‰ª∂ -->
        <script th:src="@{/js/game-utils.js}"></script>
        <script th:src="@{/js/alpine/roulette-component.js}"></script>

        <!-- È†ÅÈù¢Â∞àÂ±¨Ê®£Âºè -->
        <style>
            .lucky-section {
                text-align: center;
                margin-bottom: 30px;
            }

            .lucky-bar-wrapper {
                display: flex;
                align-items: center;
                gap: 15px;
                justify-content: center;
            }

            .lucky-bar {
                width: 300px;
                height: 12px;
                background: #eee;
                border-radius: 10px;
                overflow: hidden;
            }

            .lucky-bar__fill {
                height: 100%;
                background: linear-gradient(90deg, #667eea, #764ba2);
                transition: width 0.5s;
            }

            .lucky-bar__fill.guarantee {
                background: linear-gradient(90deg, #ffd700, #ff6b6b);
                animation: pulse 1s infinite;
            }

            .lucky-text {
                font-weight: 700;
                color: #667eea;
            }

            .lucky-hint {
                color: #999;
                font-size: 0.9rem;
                margin-top: 8px;
            }

            .lucky-hint.ready {
                color: #ffd700;
                font-weight: 700;
            }

            .roulette-container {
                position: relative;
                width: 320px;
                margin: 30px auto;
            }

            .roulette-wheel {
                position: relative;
            }

            #wheelCanvas {
                width: 300px;
                height: 300px;
                border-radius: 50%;
                box-shadow: 0 0 30px rgba(0, 0, 0, 0.3);
            }

            .roulette-center {
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                width: 60px;
                height: 60px;
                background: linear-gradient(145deg, #667eea, #764ba2);
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                color: #fff;
                font-weight: 700;
                font-size: 0.8rem;
                cursor: pointer;
                box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            }

            .roulette-pointer {
                position: absolute;
                top: -10px;
                left: 50%;
                transform: translateX(-50%);
                font-size: 2rem;
                color: #e74c3c;
            }

            .roulette-actions {
                display: flex;
                gap: 15px;
                justify-content: center;
                margin-top: 20px;
            }

            .prize-badge {
                padding: 3px 10px;
                border-radius: 10px;
                font-size: 0.75rem;
                font-weight: 700;
            }

            .badge-jackpot {
                background: #ffd700;
                color: #333;
            }

            .badge-rare {
                background: #6c5ce7;
                color: #fff;
            }

            .badge-normal {
                background: #eee;
                color: #666;
            }

            @keyframes pulse {

                0%,
                100% {
                    opacity: 1;
                }

                50% {
                    opacity: 0.7;
                }
            }

            [x-cloak] {
                display: none !important;
            }
        </style>
    </div>
</body>

</html>