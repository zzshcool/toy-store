<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="~{layout :: html(title='å¹¸é‹è½‰ç›¤', content=~{::content})}">

<body>
    <div th:fragment="content">
        <link rel="stylesheet" th:href="@{/css/gacha-animations.css}">
        <script th:src="@{/js/game-utils.js}"></script>

        <div class="container section">
            <h2 class="section-title">ğŸ¡ å¹¸é‹è½‰ç›¤</h2>

            <!-- å¹¸é‹å€¼é¡¯ç¤º -->
            <div style="max-width: 500px; margin: 0 auto 30px auto; text-align: center;">
                <p style="margin-bottom: 10px;">å¹¸é‹å€¼ç´¯ç©</p>
                <div class="lucky-bar-container">
                    <div id="luckyBar" class="lucky-bar" style="width: 0%;">
                        <span id="luckyText">0/---</span>
                    </div>
                </div>
                <p id="luckyHint" style="color: var(--text-secondary); font-size: 0.9rem;">
                    ç´¯ç©æ»¿å¹¸é‹å€¼å¿…ä¸­å¤§çï¼
                </p>
            </div>

            <!-- è½‰ç›¤åˆ—è¡¨ -->
            <div id="gameList" class="grid" style="margin-bottom: 40px;">
                <div class="text-center" style="grid-column: 1/-1; padding: 40px;">
                    <p>è¼‰å…¥ä¸­...</p>
                </div>
            </div>

            <!-- è½‰ç›¤éŠæˆ²å€åŸŸ -->
            <div id="rouletteGame" style="display: none;">
                <!-- è©¦æŠ½æç¤ºæ©«å¹… -->
                <div id="trialModeBanner"
                    style="display: none; background: #667eea; color: white; padding: 10px; text-align: center; border-radius: 10px; margin-bottom: 20px; font-weight: bold; animation: pulse 2s infinite;">
                    âœ¨ ç›®å‰ç‚ºè©¦æŠ½æ¨¡å¼ï¼Œçµæœä¸åˆ—å…¥ç´€éŒ„ã€‚ç«‹å³ç™»å…¥è´å–çœŸå“ï¼
                </div>

                <div style="text-align: center; margin-bottom: 20px;">
                    <h3 id="gameName" style="margin-bottom: 5px;">è½‰ç›¤åç¨±</h3>
                    <p style="color: var(--text-secondary);">
                        <span style="color: var(--gacha-gold); font-weight: bold; font-size: 1.3rem;">
                            $<span id="spinPrice">0</span>
                        </span> / æ¬¡
                    </p>
                </div>

                <div class="roulette-container"
                    style="max-width: 400px; width: 90%; aspect-ratio: 1/1; margin: 30px auto; position: relative;">
                    <div class="roulette-pointer"></div>
                    <canvas id="wheelCanvas" class="roulette-wheel"
                        style="width: 100%; height: 100%; display: block;"></canvas>
                    <div class="roulette-center" onclick="spin()">
                        <span>ğŸ°</span>
                    </div>
                </div>

                <div style="text-align: center; margin-top: 30px;">
                    <button id="spinBtn" class="btn-gacha" onclick="spin()">é–‹å§‹æ—‹è½‰</button>
                    <button class="btn btn-outline" onclick="backToList()" style="margin-left: 15px;">è¿”å›</button>
                </div>

                <!-- çé …æ¸…å–® -->
                <div style="background: white; border-radius: 20px; padding: 30px; margin-top: 40px;">
                    <h4 style="margin-bottom: 20px;">ğŸ è½‰ç›¤çé …ä¸€è¦½</h4>
                    <div id="prizeList" class="grid"
                        style="grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));">
                        <!-- ç”± JS å‹•æ…‹ç”Ÿæˆ -->
                    </div>
                </div>
            </div>
        </div>

        <style>
            .not-logged-in {
                filter: grayscale(0.7);
                opacity: 0.8;
                position: relative;
            }

            .not-logged-in::after {
                content: 'ğŸ”’ ç™»å…¥å¾Œå¯æŠ½ç';
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: rgba(0, 0, 0, 0.7);
                color: white;
                padding: 5px 15px;
                border-radius: 20px;
                z-index: 10;
            }

            .prize-item {
                text-align: center;
                border: 1px solid #eee;
                padding: 15px;
                border-radius: 12px;
            }

            .prize-badge {
                font-size: 0.75rem;
                padding: 2px 8px;
                border-radius: 10px;
                margin-bottom: 8px;
                display: inline-block;
            }

            .badge-jackpot {
                background: #fee2e2;
                color: #ef4444;
            }

            .badge-rare {
                background: #fef3c7;
                color: #d97706;
            }

            .badge-normal {
                background: #f1f5f9;
                color: #64748b;
            }
        </style>

        <!-- çµæœå½ˆçª— -->
        <div id="resultModal" class="prize-reveal-overlay" style="display: none;">
            <div class="prize-card">
                <div id="resultType" style="font-size: 1.5rem; margin-bottom: 10px;">ğŸŠ</div>
                <h2 id="resultPrize" style="margin: 0 0 20px 0;">çå“åç¨±</h2>
                <p id="resultShards" style="color: #6c5ce7; margin-bottom: 5px;"></p>
                <p id="resultGuarantee" style="color: var(--gacha-gold); font-weight: bold; display: none;">ğŸ‰ ä¿åº•è§¸ç™¼ï¼</p>
                <p id="resultFreeSpin" style="color: #27ae60; font-weight: bold; display: none;">ğŸ ç²å¾—å…è²»å†è½‰ä¸€æ¬¡ï¼</p>
                <button class="btn-gacha" onclick="closeResult()" style="margin-top: 20px;">ç¢ºå®š</button>
            </div>
        </div>

        <!-- ç¢ºèªæ‰£æ¬¾æ¨¡æ…‹æ¡† -->
        <div id="confirmModal" class="prize-reveal-overlay" style="display: none;">
            <div class="prize-card" style="max-width: 400px;">
                <div style="font-size: 2rem; margin-bottom: 15px;">ğŸ¡</div>
                <h3 style="margin: 0 0 15px 0;">ç¢ºèªæ—‹è½‰</h3>
                <p style="margin-bottom: 10px;">å³å°‡æ‰£é™¤é¤˜é¡é€²è¡ŒæŠ½ç</p>
                <div style="background: rgba(102,126,234,0.1); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <p style="margin: 0; font-size: 1.5rem; color: var(--accent-color); font-weight: bold;">
                        $<span id="confirmPrice">0</span>
                    </p>
                </div>
                <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                    <button class="btn btn-outline" onclick="cancelConfirm()">å–æ¶ˆ</button>
                    <button class="btn btn-outline" onclick="simulateTrialSpin()"
                        style="border-color: #667eea; color: #667eea;">å…è²»è©¦æŠ½é«”é©—</button>
                    <button id="realSpinBtn" class="btn-gacha" onclick="confirmSpin()">ç¢ºèªæ‰£æ¬¾</button>
                </div>
            </div>
        </div>

        <script th:inline="javascript">
            let currentGameId = null;
            let isSpinning = false;
            let wheelSlots = [];
            let luckyThreshold = 1000; // å¾ API å‹•æ…‹è®€å–

            document.addEventListener('DOMContentLoaded', function () {
                loadSystemSettings();
                loadLuckyValue();
                loadGameList();
            });

            function loadSystemSettings() {
                fetch('/api/system/settings')
                    .then(r => r.json())
                    .then(response => {
                        if (response.success) {
                            luckyThreshold = response.data.luckyThreshold || 1000;
                            document.getElementById('luckyHint').textContent = `ç´¯ç©æ»¿ ${luckyThreshold} å¹¸é‹å€¼å¿…ä¸­å¤§çï¼`;
                        }
                    });
            }

            function loadLuckyValue() {
                fetch('/api/roulette/lucky-value')
                    .then(r => r.json())
                    .then(response => {
                        if (response.success) {
                            updateLuckyBar(response.data.luckyValue, response.data.threshold || luckyThreshold);
                        }
                    });
            }

            function updateLuckyBar(current, threshold) {
                const percentage = Math.min((current / threshold) * 100, 100);
                const bar = document.getElementById('luckyBar');
                bar.style.width = percentage + '%';
                document.getElementById('luckyText').textContent = `${current}/${threshold}`;

                if (current >= threshold) {
                    bar.classList.add('guarantee');
                    document.getElementById('luckyHint').textContent = 'ğŸ‰ ä¿åº•å·²è§¸ç™¼ï¼ä¸‹æ¬¡å¿…ä¸­å¤§çï¼';
                    document.getElementById('luckyHint').style.color = 'var(--gacha-gold)';
                }
            }

            function loadGameList() {
                fetch('/api/roulette')
                    .then(r => r.json())
                    .then(response => {
                        if (response.success && response.data.length > 0) {
                            renderGameList(response.data);
                        } else {
                            document.getElementById('gameList').innerHTML = `
                                <div class="text-center" style="grid-column: 1/-1; padding: 40px;">
                                    <p>ç›®å‰æ²’æœ‰é€²è¡Œä¸­çš„è½‰ç›¤éŠæˆ²</p>
                                </div>
                            `;
                        }
                    });
            }

            function renderGameList(games) {
                const isLoggedIn = /*[[${currentUser != null}]]*/ false;
                const html = games.map(game => `
                    <div class="card" style="cursor: pointer;" onclick="selectGame(${game.id})">
                        <div class="img-placeholder" style="background: linear-gradient(145deg, #FF6B6B, #FFD93D); border-radius: 50%; margin: 20px auto; width: 140px; height: 140px; display: flex; align-items: center; justify-content: center; box-shadow: 0 5px 15px rgba(255,107,107,0.3);">
                            <span style="color: white; font-size: 3.5rem;">ğŸ¡</span>
                        </div>
                        <div style="padding: 15px; text-align: center;">
                            <div style="display: flex; justify-content: center; align-items: center; gap: 8px; margin-bottom: 8px;">
                                <span style="background: var(--gacha-gold); color: #333; padding: 3px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: bold;">
                                    ${game.ipName}
                                </span>
                            </div>
                            <h3 style="margin: 10px 0; font-size: 1.1rem; color: var(--text-primary);">${game.name}</h3>
                            <div style="display: flex; justify-content: center; gap: 5px; margin-bottom: 8px;">
                                <span style="background: rgba(102,126,234,0.1); color: #667eea; padding: 2px 8px; border-radius: 10px; font-size: 0.7rem;">âœ¨ æ”¯æ´è©¦æŠ½</span>
                            </div>
                            <p style="color: var(--accent-color); font-weight: bold; font-size: 1.2rem; margin-bottom: 5px;">$${game.pricePerSpin} / æ¬¡</p>
                            <p style="color: #666; font-size: 0.8rem;">${game.totalSlots} å€‹çæ ¼</p>
                        </div>
                    </div>
                `).join('');
                document.getElementById('gameList').innerHTML = html;
            }

            function promptLogin() {
                alert('è«‹å…ˆç™»å…¥æœƒå“¡ä»¥é€²è¡ŒæŠ½çï¼');
                window.location.href = '/login';
            }

            function selectGame(gameId) {
                currentGameId = gameId;
                document.getElementById('gameList').style.display = 'none';
                document.getElementById('rouletteGame').style.display = 'block';
                loadGameDetails(gameId);
            }

            function backToList() {
                currentGameId = null;
                document.getElementById('gameList').style.display = 'grid';
                document.getElementById('rouletteGame').style.display = 'none';
            }

            function loadGameDetails(gameId) {
                fetch(`/api/roulette/${gameId}`)
                    .then(r => r.json())
                    .then(response => {
                        if (response.success) {
                            const game = response.data;
                            document.getElementById('gameName').textContent = game.name;
                            document.getElementById('spinPrice').textContent = game.pricePerSpin;
                            wheelSlots = game.slots || [];
                            drawWheel(wheelSlots);
                            renderPrizeList(wheelSlots);
                        }
                    });
            }

            function renderPrizeList(slots) {
                const html = slots.map(slot => {
                    let badgeClass = 'badge-normal';
                    if (slot.slotType === 'JACKPOT') badgeClass = 'badge-jackpot';
                    if (slot.slotType === 'RARE') badgeClass = 'badge-rare';

                    return `
                        <div class="prize-item">
                            <div class="prize-badge ${badgeClass}">${slot.slotType}</div>
                            <div style="font-weight: bold; margin-bottom: 5px;">${slot.prizeName}</div>
                            <div style="font-size: 0.85rem; color: #666;">${slot.prizeDescription || ''}</div>
                        </div>
                    `;
                }).join('');
                document.getElementById('prizeList').innerHTML = html;
            }

            function drawWheel(slots) {
                const canvas = document.getElementById('wheelCanvas');
                const ctx = canvas.getContext('2d');

                // æ ¹æ“šå®¹å™¨å¯¦éš›å¤§å°è¨­å®š Canvas è§£æåº¦ (è§£æ±ºæ¨¡ç³Šèˆ‡æ¯”ä¾‹å•é¡Œ)
                const rect = canvas.getBoundingClientRect();
                canvas.width = rect.width * window.devicePixelRatio;
                canvas.height = rect.height * window.devicePixelRatio;

                const centerX = canvas.width / 2;
                const centerY = canvas.height / 2;
                const radius = Math.min(centerX, centerY) - 10;

                ctx.clearRect(0, 0, canvas.width, canvas.height);

                if (slots.length === 0) return;

                const sliceAngle = (2 * Math.PI) / slots.length;
                const colors = ['#FF6B6B', '#4ECDC4', '#FFD93D', '#6C5CE7', '#A8E6CF', '#FF8B94', '#FFEAA7', '#DFE6E9'];

                slots.forEach((slot, index) => {
                    const startAngle = index * sliceAngle - Math.PI / 2;
                    const endAngle = startAngle + sliceAngle;

                    // ç¹ªè£½æ‰‡å½¢
                    ctx.beginPath();
                    ctx.moveTo(centerX, centerY);
                    ctx.arc(centerX, centerY, radius, startAngle, endAngle);
                    ctx.closePath();
                    ctx.fillStyle = slot.color || colors[index % colors.length];
                    ctx.fill();
                    ctx.strokeStyle = 'white';
                    ctx.lineWidth = 2;
                    ctx.stroke();

                    // ç¹ªè£½æ–‡å­—
                    ctx.save();
                    ctx.translate(centerX, centerY);
                    ctx.rotate(startAngle + sliceAngle / 2);
                    ctx.textAlign = 'right';
                    ctx.fillStyle = 'white';
                    ctx.font = 'bold 12px sans-serif';
                    ctx.fillText(slot.prizeName.substring(0, 6), radius - 15, 5);
                    ctx.restore();
                });
            }

            let currentSpinPrice = 0;

            function spin() {
                if (isSpinning || !currentGameId) return;
                const isLoggedIn = /*[[${currentUser != null}]]*/ false;

                // é¡¯ç¤ºç¢ºèªæ¨¡æ…‹æ¡†
                currentSpinPrice = document.getElementById('spinPrice').textContent;
                document.getElementById('confirmPrice').textContent = currentSpinPrice;

                const modalTitle = document.querySelector('#confirmModal h3');
                modalTitle.textContent = 'ç¢ºèªæ—‹è½‰ / è©¦æŠ½';

                document.getElementById('confirmModal').style.display = 'flex';
            }

            function cancelConfirm() {
                document.getElementById('confirmModal').style.display = 'none';
            }

            function confirmSpin() {
                const isLoggedIn = /*[[${currentUser != null}]]*/ false;
                if (!isLoggedIn) {
                    simulateTrialSpin();
                    return;
                }

                document.getElementById('confirmModal').style.display = 'none';
                GameUtils.showMask(); // Call showMask at the start
                isSpinning = true;
                document.getElementById('spinBtn').disabled = true;

                fetch(`/api/roulette/${currentGameId}/spin`, { method: 'POST' })
                    .then(r => r.json())
                    .then(response => {
                        if (response.success) {
                            const result = response.data;
                            const slotIndex = wheelSlots.findIndex(s => s.id === result.slot.id);
                            animateWheel(slotIndex, () => {
                                showResult(result, response.message);
                                loadLuckyValue();
                                // åˆ·æ–°é¤˜é¡
                                if (window.refreshBalance) window.refreshBalance();
                                GameUtils.hideMask(); // Call hideMask after result is shown
                            });
                        } else {
                            alert(response.message || 'æ—‹è½‰å¤±æ•—');
                            isSpinning = false;
                            document.getElementById('spinBtn').disabled = false;
                            GameUtils.hideMask(); // Call hideMask on error
                        }
                    })
                    .catch(err => {
                        console.error('Error:', err);
                        alert('æ“ä½œå¤±æ•—');
                        isSpinning = false;
                        document.getElementById('spinBtn').disabled = false;
                        GameUtils.hideMask(); // Call hideMask on error
                    });
            }

            function simulateTrialSpin() {
                document.getElementById('confirmModal').style.display = 'none';
                GameUtils.showMask();
                isSpinning = true;
                document.getElementById('spinBtn').disabled = true;

                // éš¨æ©Ÿé¸ä¸€å€‹ç´¢å¼•
                const slotIndex = Math.floor(Math.random() * wheelSlots.length);
                const resultSlot = wheelSlots[slotIndex];

                animateWheel(slotIndex, () => {
                    const trialResult = {
                        isTrial: true,
                        slot: resultSlot,
                        shardsEarned: Math.floor(Math.random() * 100),
                        isGuarantee: false,
                        isFreeSpin: false
                    };
                    showResult(trialResult, "è©¦æŠ½æˆåŠŸ");
                    GameUtils.hideMask();
                });
            }

            function animateWheel(targetIndex, callback) {
                const canvas = document.getElementById('wheelCanvas');
                const container = canvas.closest('.roulette-container');
                const totalSlots = wheelSlots.length;
                const sliceAngle = 360 / totalSlots;

                // 1. è¨ˆç®—ç›®æ¨™æ—‹è½‰è§’åº¦ (å¤šè½‰å¹¾åœˆ + åç§»åˆ°ç›®æ¨™æ ¼å­)
                // è®“ç›®æ¨™æ ¼å­æ­£å°æŒ‡é‡ (æŒ‡é‡åœ¨ä¸Šæ–¹ï¼Œå³ -90åº¦æˆ– 270åº¦æ–¹å‘)
                const currentAngle = gsap.getProperty(canvas, "rotation") || 0;
                const extraSpins = 5;
                const targetRotation = currentAngle + (360 * extraSpins) + (360 - (targetIndex * sliceAngle + sliceAngle / 2));

                // 2. GSAP å‹•æ…‹è£œé–“
                const tl = gsap.timeline({
                    onComplete: () => {
                        isSpinning = false;
                        document.getElementById('spinBtn').disabled = false;
                        // ç§»é™¤ 3D å‚¾æ–œèˆ‡ç™¼å…‰
                        gsap.to(container, { rotationX: 0, rotationY: 0, duration: 0.5 });
                        gsap.to(canvas, { boxShadow: "0 0 30px rgba(0,0,0,0.3)", duration: 0.5 });
                        if (callback) callback();
                    }
                });

                // 3D å‚¾æ–œæ•ˆæœ
                tl.to(container, {
                    rotationX: 15,
                    rotationY: 5,
                    duration: 1,
                    ease: "power2.out"
                }, 0);

                // ç™¼å…‰æ•ˆæœ
                tl.to(canvas, {
                    boxShadow: "0 0 60px rgba(108, 92, 231, 0.6)",
                    duration: 1
                }, 0);

                // æ—‹è½‰
                tl.to(canvas, {
                    rotation: targetRotation,
                    duration: 5,
                    ease: "expo.inOut"
                }, 0);
            }

            function showResult(result, message) {
                const isLoggedIn = /*[[${currentUser != null}]]*/ false;
                const isTrial = !!result.isTrial;
                const slot = result.slot;

                document.getElementById('resultType').textContent = slot.isJackpot ? 'ğŸ†' : 'ğŸŠ';
                document.getElementById('resultPrize').textContent = slot.prizeName;
                document.getElementById('resultShards').textContent = result.shardsEarned > 0 ? `+${result.shardsEarned} ç¢ç‰‡` : '';
                document.getElementById('resultGuarantee').style.display = result.isGuarantee ? 'block' : 'none';
                document.getElementById('resultFreeSpin').style.display = result.isFreeSpin ? 'block' : 'none';

                const resultBtn = document.querySelector('#resultModal .btn-gacha');
                if (isTrial) {
                    resultBtn.innerHTML = isLoggedIn ? 'âœ¨ è¿”å›é¸è³¼' : 'ç¢ºå®š';
                    resultBtn.onclick = closeResult;
                } else {
                    resultBtn.innerHTML = 'ğŸ“¦ æŸ¥çœ‹æˆ‘çš„çå“ç´€éŒ„';
                    resultBtn.onclick = () => GameUtils.redirectToHistory();
                }

                document.getElementById('resultModal').style.display = 'flex';
                // å„²å­˜ç•¶å‰æ˜¯å¦ç‚ºæ­£å¼æŠ½çï¼Œä¾›é—œé–‰æ™‚åƒè€ƒ
                document.getElementById('resultModal').dataset.isTrial = isTrial;

                if (!isTrial) {
                    GameUtils.playWinSound();
                    GameUtils.spawnConfetti();
                }
            }

            function closeResult() {
                const isTrial = document.getElementById('resultModal').dataset.isTrial === 'true';
                document.getElementById('resultModal').style.display = 'none';
                GameUtils.hideMask();

                if (!isTrial) {
                    GameUtils.redirectToHistory();
                } else {
                    location.reload();
                }
            }
        </script>
    </div>
</body>

</html>