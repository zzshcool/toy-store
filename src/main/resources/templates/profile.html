<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="~{layout :: html(title='會員中心', content=~{::content})}">

<body>
    <div th:fragment="content">
        <div class="container section">
            <h2 class="section-title">👤 會員中心</h2>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; max-width: 1100px; margin: 0 auto;">

                <!-- 左側：會員資訊卡 -->
                <div class="card" style="padding: 30px;">
                    <div th:if="${success}" class="alert alert-success text-center" th:text="${success}">更新成功</div>

                    <!-- 會員等級徽章 -->
                    <div style="text-align: center; margin-bottom: 25px;">
                        <div th:if="${member.level != null}"
                            style="display: inline-block; padding: 10px 25px; border-radius: 30px; font-weight: bold; font-size: 1.2rem; color: white;"
                            th:styleappend="'background: linear-gradient(145deg, ' + (${member.level.sortOrder >= 4} ? '#FFD700, #FFA500' : (${member.level.sortOrder >= 3} ? '#C0C0C0, #A0A0A0' : (${member.level.sortOrder >= 2} ? '#CD7F32, #B87333' : '#667eea, #764ba2'))) + ');'">
                            <span th:text="${member.level.name}">VIP</span>
                        </div>
                        <div th:if="${member.level == null}"
                            style="display: inline-block; padding: 10px 25px; border-radius: 30px; font-weight: bold; font-size: 1.2rem; background: linear-gradient(145deg, #95a5a6, #7f8c8d); color: white;">
                            一般會員
                        </div>
                    </div>

                    <form th:action="@{/profile/update}" method="post">
                        <div class="form-group">
                            <label>會員帳號</label>
                            <input type="text" class="form-control" th:value="${member.username}" disabled
                                style="background-color: #f8f9fa;">
                        </div>

                        <div class="form-group">
                            <label>帳戶餘額</label>
                            <div style="display: flex; align-items: center; gap: 15px;">
                                <span style="font-size: 1.5rem; color: var(--accent-color); font-weight: bold;"
                                    th:text="'$' + ${#numbers.formatDecimal(member.platformWalletBalance, 1, 2)}">$0.00</span>
                                <a th:href="@{/topup}" class="btn btn-primary btn-sm">儲值</a>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>本月累計儲值</label>
                            <span style="font-size: 1.1rem; color: #666;"
                                th:text="'$' + ${#numbers.formatDecimal(currentSpent, 1, 2)}">$0.00</span>
                        </div>

                        <div class="form-group">
                            <label>真實姓名 <span style="color: red;">*</span></label>
                            <input type="text" name="realName" class="form-control" th:value="${member.realName}"
                                required placeholder="請輸入真實姓名">
                        </div>

                        <div class="form-group">
                            <label>通訊地址</label>
                            <input type="text" name="address" class="form-control" th:value="${member.address}"
                                placeholder="請輸入通訊地址">
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div class="form-group">
                                <label>性別</label>
                                <select name="gender" class="form-control">
                                    <option value="" th:selected="${member.gender == null || member.gender == ''}">尚未設定
                                    </option>
                                    <option value="Male" th:selected="${member.gender == 'Male'}">男性</option>
                                    <option value="Female" th:selected="${member.gender == 'Female'}">女性</option>
                                    <option value="Other" th:selected="${member.gender == 'Other'}">其他</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>生日</label>
                                <input type="date" name="birthday" class="form-control" th:value="${member.birthday}">
                            </div>
                        </div>

                        <div class="form-group">
                            <label>會員暱稱</label>
                            <input type="text" name="nickname" class="form-control" th:value="${member.nickname}"
                                placeholder="請輸入暱稱" required>
                        </div>

                        <div class="form-group">
                            <label>電子郵件</label>
                            <input type="email" name="email" class="form-control" th:value="${member.email}"
                                placeholder="請輸入電子郵件" required>
                        </div>

                        <div class="form-group">
                            <label>電話</label>
                            <input type="tel" name="phone" class="form-control" th:value="${member.phone}">
                        </div>

                        <div class="text-center" style="margin-top: 30px;">
                            <button type="submit" class="btn btn-gacha">儲存修改</button>
                        </div>
                    </form>
                </div>

                <!-- 右側：等級進度與優惠券 -->
                <div style="display: flex; flex-direction: column; gap: 30px;">
                    <!-- 升級進度卡 -->
                    <div class="card" style="padding: 25px;">
                        <h3 style="margin-bottom: 20px;">📈 會員等級進度</h3>

                        <div th:if="${nextLevel != null}">
                            <p style="margin-bottom: 10px;">距離 <strong th:text="${nextLevel.name}"
                                    style="color: var(--accent-color);">下一等級</strong> 還需儲值</p>
                            <p style="font-size: 2rem; color: var(--accent-color); font-weight: bold; margin-bottom: 15px;"
                                th:text="'$' + ${#numbers.formatDecimal(nextLevel.threshold - currentSpent, 1, 2)}">
                                $0.00</p>

                            <div
                                style="background: #eee; border-radius: 10px; height: 15px; overflow: hidden; margin-bottom: 10px;">
                                <div style="transition: width 0.5s;"
                                    th:style="'height: 100%; background: linear-gradient(90deg, #667eea, #764ba2); width: ' + ${nextLevel.threshold.doubleValue() > 0 ? (currentSpent.doubleValue() / nextLevel.threshold.doubleValue() * 100) : 0} + '%'">
                                </div>
                            </div>
                            <div
                                style="display: flex; justify-content: space-between; font-size: 0.85rem; color: #888;">
                                <span th:text="'本月已儲: $' + ${#numbers.formatDecimal(currentSpent, 1, 0)}"></span>
                                <span th:text="'目標: $' + ${#numbers.formatDecimal(nextLevel.threshold, 1, 0)}"></span>
                            </div>
                        </div>

                        <div th:if="${nextLevel == null}" style="text-align: center; padding: 20px;">
                            <span style="font-size: 3rem;">👑</span>
                            <h4 style="margin-top: 15px; color: var(--gacha-gold);">您已達到最高等級！</h4>
                            <p style="color: #666;">感謝您的支持，享受專屬尊榮禮遇。</p>
                        </div>

                        <hr style="margin: 25px 0; border: 0; border-top: 1px solid #eee;">

                        <h4>🏵️ 等級說明</h4>
                        <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 15px;">
                            <div th:each="lvl : ${levels}"
                                th:class="${member.level != null && member.level.id == lvl.id ? 'level-item active' : 'level-item'}"
                                style="padding: 10px 15px; border-radius: 8px; border: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <strong th:text="${lvl.name}">Level</strong>
                                    <span th:if="${lvl.threshold > 0}"
                                        th:text="' (滿 $' + ${#numbers.formatDecimal(lvl.threshold, 1, 0)} + ')'"
                                        style="font-size: 0.85rem; color: #888;"></span>
                                </div>
                                <span th:if="${lvl.monthlyReward != null}" th:text="${lvl.monthlyReward}"
                                    style="font-size: 0.85rem; background: #e8f4fd; color: #2980b9; padding: 2px 8px; border-radius: 4px;">獎勵</span>
                            </div>
                        </div>
                    </div>

                    <!-- 我的優惠券 -->
                    <div class="card" style="padding: 25px;">
                        <h3 style="margin-bottom: 20px;">🎫 我的優惠券</h3>
                        <div th:if="${#lists.isEmpty(coupons)}" style="text-align: center; color: #999; padding: 20px;">
                            目前沒有可用的優惠券
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr; gap: 15px;">
                            <div th:each="mc : ${coupons}"
                                style="border-left: 5px solid var(--accent-color); background: #fdfdfd; padding: 15px; border-radius: 5px; box-shadow: 2px 2px 5px rgba(0,0,0,0.02); display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <strong th:text="${mc.coupon.name}"
                                        style="display: block; margin-bottom: 5px;">Coupon Name</strong>
                                    <small
                                        th:text="'有效期至: ' + ${#temporals.format(mc.coupon.validUntil, 'yyyy-MM-dd HH:mm')}"
                                        style="color: #999;"></small>
                                </div>
                                <div style="text-align: right;">
                                    <span th:if="${mc.isUsed}" class="badge badge-secondary">已使用</span>
                                    <span th:if="${!mc.isUsed}" class="badge badge-success">未使用</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>

    <style>
        .level-current {
            border-color: var(--accent-color) !important;
            background: linear-gradient(to right, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
        }

        @media (max-width: 768px) {
            .container.section>div {
                grid-template-columns: 1fr !important;
            }
        }
    </style>
    </div>
</body>

</html>