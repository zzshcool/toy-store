<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="~{layout :: html(title='æœƒå“¡ä¸­å¿ƒ', content=~{::content})}">

<body>
    <div th:fragment="content">
        <div class="container section">
            <h2 class="section-title">ğŸ‘¤ æœƒå“¡ä¸­å¿ƒ</h2>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; max-width: 1100px; margin: 0 auto;">

                <!-- å·¦å´ï¼šæœƒå“¡è³‡è¨Šå¡ -->
                <div class="card" style="padding: 30px;">
                    <div th:if="${success}" class="alert alert-success text-center" th:text="${success}">æ›´æ–°æˆåŠŸ</div>

                    <!-- æœƒå“¡ç­‰ç´šå¾½ç«  -->
                    <div style="text-align: center; margin-bottom: 25px;">
                        <div th:if="${member.level != null}"
                            style="display: inline-block; padding: 10px 25px; border-radius: 30px; font-weight: bold; font-size: 1.2rem; color: white;"
                            th:styleappend="'background: linear-gradient(145deg, ' + (${member.level.sortOrder >= 4} ? '#FFD700, #FFA500' : (${member.level.sortOrder >= 3} ? '#C0C0C0, #A0A0A0' : (${member.level.sortOrder >= 2} ? '#CD7F32, #B87333' : '#667eea, #764ba2'))) + ');'">
                            <span th:text="${member.level.name}">VIP</span>
                        </div>
                        <div th:if="${member.level == null}"
                            style="display: inline-block; padding: 10px 25px; border-radius: 30px; font-weight: bold; font-size: 1.2rem; background: linear-gradient(145deg, #95a5a6, #7f8c8d); color: white;">
                            ä¸€èˆ¬æœƒå“¡
                        </div>
                    </div>

                    <form th:action="@{/profile/update}" method="post">
                        <div class="form-group">
                            <label>æœƒå“¡å¸³è™Ÿ</label>
                            <input type="text" class="form-control" th:value="${member.username}" disabled
                                style="background-color: #f8f9fa;">
                        </div>

                        <div class="form-group">
                            <label>å¸³æˆ¶é¤˜é¡</label>
                            <div style="display: flex; align-items: center; gap: 15px;">
                                <span style="font-size: 1.5rem; color: var(--accent-color); font-weight: bold;"
                                    th:text="'$' + ${#numbers.formatDecimal(member.platformWalletBalance, 1, 2)}">$0.00</span>
                                <a th:href="@{/topup}" class="btn btn-primary btn-sm">å„²å€¼</a>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>æœ¬æœˆç´¯è¨ˆå„²å€¼</label>
                            <span style="font-size: 1.1rem; color: #666;"
                                th:text="'$' + ${#numbers.formatDecimal(currentSpent, 1, 2)}">$0.00</span>
                        </div>

                        <div class="form-group">
                            <label>çœŸå¯¦å§“å <span style="color: red;">*</span></label>
                            <input type="text" name="realName" class="form-control" th:value="${member.realName}"
                                required placeholder="è«‹è¼¸å…¥çœŸå¯¦å§“å">
                        </div>

                        <div class="form-group">
                            <label>é€šè¨Šåœ°å€</label>
                            <input type="text" name="address" class="form-control" th:value="${member.address}"
                                placeholder="è«‹è¼¸å…¥é€šè¨Šåœ°å€">
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div class="form-group">
                                <label>æ€§åˆ¥</label>
                                <select name="gender" class="form-control">
                                    <option value="" th:selected="${member.gender == null || member.gender == ''}">å°šæœªè¨­å®š
                                    </option>
                                    <option value="Male" th:selected="${member.gender == 'Male'}">ç”·æ€§</option>
                                    <option value="Female" th:selected="${member.gender == 'Female'}">å¥³æ€§</option>
                                    <option value="Other" th:selected="${member.gender == 'Other'}">å…¶ä»–</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>ç”Ÿæ—¥</label>
                                <input type="date" name="birthday" class="form-control" th:value="${member.birthday}">
                            </div>
                        </div>

                        <div class="form-group">
                            <label>æœƒå“¡æš±ç¨±</label>
                            <input type="text" name="nickname" class="form-control" th:value="${member.nickname}"
                                placeholder="è«‹è¼¸å…¥æš±ç¨±" required>
                        </div>

                        <div class="form-group">
                            <label>é›»å­éƒµä»¶</label>
                            <input type="email" name="email" class="form-control" th:value="${member.email}"
                                placeholder="è«‹è¼¸å…¥é›»å­éƒµä»¶" required>
                        </div>

                        <div class="form-group">
                            <label>é›»è©±</label>
                            <input type="tel" name="phone" class="form-control" th:value="${member.phone}">
                        </div>

                        <div class="text-center" style="margin-top: 30px;">
                            <button type="submit" class="btn btn-gacha">å„²å­˜ä¿®æ”¹</button>
                        </div>
                    </form>
                </div>

                <!-- å³å´ï¼šç­‰ç´šé€²åº¦èˆ‡å„ªæƒ åˆ¸ -->
                <div style="display: flex; flex-direction: column; gap: 30px;">
                    <!-- å‡ç´šé€²åº¦å¡ -->
                    <div class="card" style="padding: 25px;">
                        <h3 style="margin-bottom: 20px;">ğŸ“ˆ æœƒå“¡ç­‰ç´šé€²åº¦</h3>

                        <div th:if="${nextLevel != null}">
                            <p style="margin-bottom: 10px;">è·é›¢ <strong th:text="${nextLevel.name}"
                                    style="color: var(--accent-color);">ä¸‹ä¸€ç­‰ç´š</strong> é‚„éœ€å„²å€¼</p>
                            <p style="font-size: 2rem; color: var(--accent-color); font-weight: bold; margin-bottom: 15px;"
                                th:text="'$' + ${#numbers.formatDecimal(nextLevel.threshold - currentSpent, 1, 2)}">
                                $0.00</p>

                            <div id="progressBar"
                                style="background: #eee; border-radius: 10px; height: 15px; overflow: hidden; margin-bottom: 10px; position: relative;">
                                <div id="progressFill" class="progress-animated"
                                    style="height: 100%; background: linear-gradient(90deg, #667eea, #764ba2); width: 0%; transition: width 1.5s ease-out;">
                                </div>
                            </div>
                            <div
                                style="display: flex; justify-content: space-between; font-size: 0.85rem; color: #888;">
                                <span th:text="'æœ¬æœˆå·²å„²: $' + ${#numbers.formatDecimal(currentSpent, 1, 0)}"></span>
                                <span th:text="'ç›®æ¨™: $' + ${#numbers.formatDecimal(nextLevel.threshold, 1, 0)}"></span>
                            </div>
                        </div>

                        <div th:if="${nextLevel == null}" style="text-align: center; padding: 20px;">
                            <span style="font-size: 3rem;">ğŸ‘‘</span>
                            <h4 style="margin-top: 15px; color: var(--gacha-gold);">æ‚¨å·²é”åˆ°æœ€é«˜ç­‰ç´šï¼</h4>
                            <p style="color: #666;">æ„Ÿè¬æ‚¨çš„æ”¯æŒï¼Œäº«å—å°ˆå±¬å°Šæ¦®ç¦®é‡ã€‚</p>
                        </div>

                        <hr style="margin: 25px 0; border: 0; border-top: 1px solid #eee;">

                        <h4>ğŸµï¸ ç­‰ç´šèªªæ˜</h4>
                        <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 15px;">
                            <div th:each="lvl : ${levels}"
                                th:class="${member.level != null && member.level.id == lvl.id ? 'level-item active' : 'level-item'}"
                                style="padding: 10px 15px; border-radius: 8px; border: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <strong th:text="${lvl.name}">Level</strong>
                                    <span th:if="${lvl.threshold > 0}"
                                        th:text="' (æ»¿ $' + ${#numbers.formatDecimal(lvl.threshold, 1, 0)} + ')'"
                                        style="font-size: 0.85rem; color: #888;"></span>
                                </div>
                                <span th:if="${lvl.monthlyReward != null}" th:text="${lvl.monthlyReward}"
                                    style="font-size: 0.85rem; background: #e8f4fd; color: #2980b9; padding: 2px 8px; border-radius: 4px;">çå‹µ</span>
                            </div>
                        </div>
                    </div>

                    <!-- æˆ‘çš„å„ªæƒ åˆ¸ -->
                    <div class="card" style="padding: 25px;">
                        <h3 style="margin-bottom: 20px;">ğŸ« æˆ‘çš„å„ªæƒ åˆ¸</h3>
                        <div th:if="${#lists.isEmpty(coupons)}" style="text-align: center; color: #999; padding: 20px;">
                            ç›®å‰æ²’æœ‰å¯ç”¨çš„å„ªæƒ åˆ¸
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr; gap: 15px;">
                            <div th:each="mc : ${coupons}"
                                style="border-left: 5px solid var(--accent-color); background: #fdfdfd; padding: 15px; border-radius: 5px; box-shadow: 2px 2px 5px rgba(0,0,0,0.02); display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <strong th:text="${mc.coupon.name}"
                                        style="display: block; margin-bottom: 5px;">Coupon Name</strong>
                                    <small
                                        th:text="'æœ‰æ•ˆæœŸè‡³: ' + ${#temporals.format(mc.coupon.validUntil, 'yyyy-MM-dd HH:mm')}"
                                        style="color: #999;"></small>
                                </div>
                                <div style="text-align: right;">
                                    <span th:if="${mc.isUsed}" class="badge badge-secondary">å·²ä½¿ç”¨</span>
                                    <span th:if="${!mc.isUsed}" class="badge badge-success">æœªä½¿ç”¨</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- æ¯æ—¥ç°½åˆ° -->
                    <div class="card" style="padding: 25px;">
                        <h3 style="margin-bottom: 20px;">ğŸ“… æ¯æ—¥ç°½åˆ°</h3>
                        <div id="sign-in-container" style="text-align: center; padding: 20px;">
                            <div id="sign-in-status" style="margin-bottom: 15px;">
                                <span style="font-size: 1.2rem; color: #666;">è¼‰å…¥ä¸­...</span>
                            </div>
                            <button id="btn-sign-in" class="btn btn-primary"
                                style="padding: 15px 40px; font-size: 1.1rem;" disabled>
                                ç°½åˆ°
                            </button>
                            <div id="sign-in-result" style="margin-top: 15px; display: none;"></div>
                        </div>
                        <div style="margin-top: 15px; font-size: 0.85rem; color: #888;">
                            <p>ğŸ“Œ é€£çºŒç°½åˆ°çå‹µï¼š1~6æ—¥æ¯æ—¥ 10 é»ï¼Œç¬¬7æ—¥ 50 é»ï¼</p>
                        </div>
                    </div>

                    <!-- æ¯æ—¥ä»»å‹™ -->
                    <div class="card" style="padding: 25px;">
                        <h3 style="margin-bottom: 20px;">ğŸ¯ æ¯æ—¥ä»»å‹™</h3>
                        <div id="missions-container">
                            <div style="text-align: center; color: #999; padding: 20px;">è¼‰å…¥ä¸­...</div>
                        </div>
                    </div>

                    <!-- æ¨è–¦ç¢¼/å…Œæ›ç¢¼ -->
                    <div class="card" style="padding: 25px;">
                        <h3 style="margin-bottom: 20px;">ğŸ æ¨è–¦èˆ‡å…Œæ›</h3>

                        <!-- æˆ‘çš„æ¨è–¦ç¢¼ -->
                        <div style="margin-bottom: 20px;">
                            <h4 style="font-size: 1rem; margin-bottom: 10px;">æˆ‘çš„æ¨è–¦ç¢¼</h4>
                            <div id="referral-code-container" style="display: flex; gap: 10px; align-items: center;">
                                <input type="text" id="my-referral-code" class="form-control" readonly
                                    style="flex: 1; font-weight: bold; text-align: center;" placeholder="è¼‰å…¥ä¸­...">
                                <button class="btn btn-secondary btn-sm" onclick="copyReferralCode()">è¤‡è£½</button>
                            </div>
                            <small style="color: #888; display: block; margin-top: 5px;">åˆ†äº«çµ¦å¥½å‹ï¼Œé›™æ–¹éƒ½èƒ½ç²å¾— 50 ä»£å¹£çå‹µï¼</small>
                        </div>

                        <hr style="margin: 15px 0; border-color: #eee;">

                        <!-- å…Œæ›ç¦®åŒ…ç¢¼ -->
                        <div>
                            <h4 style="font-size: 1rem; margin-bottom: 10px;">å…Œæ›ç¦®åŒ…ç¢¼</h4>
                            <div style="display: flex; gap: 10px;">
                                <input type="text" id="redeem-code-input" class="form-control" placeholder="è¼¸å…¥å…Œæ›ç¢¼"
                                    style="flex: 1;">
                                <button class="btn btn-primary" onclick="redeemCode()">å…Œæ›</button>
                            </div>
                            <div id="redeem-result" style="margin-top: 10px; display: none;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ç°½åˆ°åŠŸèƒ½
        async function loadSignInStatus() {
            try {
                const res = await fetch('/api/member/sign-in/status');
                const json = await res.json();
                if (json.code === 200) {
                    const data = json.data;
                    const statusEl = document.getElementById('sign-in-status');
                    const btnEl = document.getElementById('btn-sign-in');

                    if (data.signedToday) {
                        statusEl.innerHTML = `<span style="color: #27ae60; font-size: 1.2rem;">âœ… ä»Šæ—¥å·²ç°½åˆ°</span><br>
                            <span style="color: #666;">é€£çºŒç°½åˆ° ${data.consecutiveDays} å¤©</span>`;
                        btnEl.textContent = 'å·²ç°½åˆ°';
                        btnEl.disabled = true;
                        btnEl.classList.remove('btn-primary');
                        btnEl.classList.add('btn-secondary');
                    } else {
                        statusEl.innerHTML = `<span style="color: #e74c3c;">â— ä»Šæ—¥å°šæœªç°½åˆ°</span><br>
                            <span style="color: #666;">ç°½åˆ°å¯ç²å¾— ${data.nextReward} ç´…åˆ©é»æ•¸</span>`;
                        btnEl.textContent = 'ç«‹å³ç°½åˆ°';
                        btnEl.disabled = false;
                    }
                }
            } catch (e) {
                console.error('è¼‰å…¥ç°½åˆ°ç‹€æ…‹å¤±æ•—', e);
            }
        }

        document.getElementById('btn-sign-in').addEventListener('click', async function () {
            const btn = this;
            btn.disabled = true;
            btn.textContent = 'ç°½åˆ°ä¸­...';

            try {
                const res = await fetch('/api/member/sign-in', { method: 'POST' });
                const json = await res.json();
                const resultEl = document.getElementById('sign-in-result');
                resultEl.style.display = 'block';

                if (json.code === 200) {
                    resultEl.innerHTML = `<span style="color: #27ae60;">ğŸ‰ ${json.data.message}</span>`;
                    loadSignInStatus();
                } else {
                    resultEl.innerHTML = `<span style="color: #e74c3c;">âŒ ${json.message}</span>`;
                    btn.disabled = false;
                    btn.textContent = 'ç«‹å³ç°½åˆ°';
                }
            } catch (e) {
                console.error('ç°½åˆ°å¤±æ•—', e);
            }
        });

        // ä»»å‹™åŠŸèƒ½
        async function loadMissions() {
            try {
                const res = await fetch('/api/member/missions');
                const json = await res.json();
                const container = document.getElementById('missions-container');

                if (json.code === 200 && json.data.length > 0) {
                    container.innerHTML = json.data.map(m => `
                        <div style="border: 1px solid #eee; border-radius: 8px; padding: 15px; margin-bottom: 10px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <strong>${m.typeName}</strong>
                                <span class="${m.completed ? 'badge badge-success' : 'badge badge-secondary'}">
                                    ${m.completed ? 'å·²å®Œæˆ' : 'é€²è¡Œä¸­'}
                                </span>
                            </div>
                            <div style="background: #eee; border-radius: 5px; height: 8px; margin-bottom: 5px;">
                                <div style="background: linear-gradient(90deg, #667eea, #764ba2); height: 100%; border-radius: 5px; width: ${m.progress}%;"></div>
                            </div>
                            <div style="display: flex; justify-content: space-between; font-size: 0.85rem; color: #888;">
                                <span>${m.currentValue} / ${m.targetValue}</span>
                                <span>ğŸ ${m.rewardBonusPoints} ç´…åˆ©</span>
                            </div>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = '<div style="text-align: center; color: #999;">æš«ç„¡ä»»å‹™</div>';
                }
            } catch (e) {
                console.error('è¼‰å…¥ä»»å‹™å¤±æ•—', e);
            }
        }

        // æ¨è–¦ç¢¼åŠŸèƒ½
        async function loadReferralCode() {
            try {
                const res = await fetch('/api/promo/my-referral');
                const json = await res.json();
                if (json.code === 200) {
                    document.getElementById('my-referral-code').value = json.data.code;
                }
            } catch (e) {
                console.error('è¼‰å…¥æ¨è–¦ç¢¼å¤±æ•—', e);
            }
        }

        function copyReferralCode() {
            const input = document.getElementById('my-referral-code');
            input.select();
            document.execCommand('copy');
            alert('æ¨è–¦ç¢¼å·²è¤‡è£½ï¼');
        }

        async function redeemCode() {
            const code = document.getElementById('redeem-code-input').value.trim();
            if (!code) {
                alert('è«‹è¼¸å…¥å…Œæ›ç¢¼');
                return;
            }

            try {
                const res = await fetch('/api/promo/redeem', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code })
                });
                const json = await res.json();
                const resultEl = document.getElementById('redeem-result');
                resultEl.style.display = 'block';

                if (json.code === 200) {
                    resultEl.innerHTML = `<span style="color: #27ae60;">ğŸ‰ ${json.data}</span>`;
                    document.getElementById('redeem-code-input').value = '';
                } else {
                    resultEl.innerHTML = `<span style="color: #e74c3c;">âŒ ${json.message}</span>`;
                }
            } catch (e) {
                console.error('å…Œæ›å¤±æ•—', e);
            }
        }

        // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function () {
            loadSignInStatus();
            loadMissions();
            loadReferralCode();
            initProgressAnimation();
        });

        function initProgressAnimation() {
            const progressFill = document.getElementById('progressFill');
            if (progressFill) {
                // å¾ Thymeleaf è¨ˆç®—çš„çœŸå¯¦é€²åº¦
                const targetWidth = /*[[${nextLevel != null && nextLevel.threshold.doubleValue() > 0 ? (currentSpent.doubleValue() / nextLevel.threshold.doubleValue() * 100) : 0}]]*/ 0;
                // å»¶é²å¾Œå•Ÿå‹•å‹•ç•«
                setTimeout(() => {
                    progressFill.style.width = Math.min(targetWidth, 100) + '%';
                }, 300);
            }
        }
    </script>

    <style>
        .level-current {
            border-color: var(--accent-color) !important;
            background: linear-gradient(to right, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
        }

        @media (max-width: 768px) {
            .container.section>div {
                grid-template-columns: 1fr !important;
            }
        }
    </style>
    </div>
</body>

</html>