<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="~{layout :: html(title='ä¹å®®æ ¼æŒ–å¯¶', content=~{::content})}">

<body>
    <div th:fragment="content">
        <link rel="stylesheet" th:href="@{/css/gacha-animations.css}">
        <script th:src="@{/js/game-utils.js}"></script>

        <div class="container section">
            <h2 class="section-title">ğŸ¯ ä¹å®®æ ¼æŒ–å¯¶</h2>
            <p class="text-center" style="color: var(--text-secondary); margin-bottom: 30px;">
                é»æ“Šæ ¼å­æŒ–æ˜çå“ï¼Œé€£æˆä¸€ç·šç²å¾—é¡å¤–çå‹µï¼
            </p>

            <!-- éŠæˆ²åˆ—è¡¨ -->
            <div id="gameList" class="grid" style="margin-bottom: 40px;">
                <div class="text-center" style="grid-column: 1/-1; padding: 40px;">
                    <p>è¼‰å…¥ä¸­...</p>
                </div>
            </div>

            <!-- éŠæˆ²å€åŸŸ -->
            <div id="bingoGame" style="display: none;">
                <!-- è©¦æŒ–æç¤ºæ©«å¹… -->
                <div id="trialModeBanner"
                    style="display: none; background: #6c5ce7; color: white; padding: 10px; text-align: center; border-radius: 10px; margin-bottom: 20px; font-weight: bold; animation: pulse 2s infinite;">
                    âœ¨ ç›®å‰ç‚ºè©¦æŒ–æ¨¡å¼ï¼Œæ‰€æœ‰æ ¼å­ç‚ºéš¨æ©Ÿå…§å®¹ã€‚
                </div>

                <div style="text-align: center; margin-bottom: 20px;">
                    <h3 id="gameName" style="margin-bottom: 5px;">éŠæˆ²åç¨±</h3>
                    <p style="color: var(--text-secondary);">
                        <span style="color: var(--gacha-gold); font-weight: bold; font-size: 1.3rem;">
                            $<span id="digPrice">0</span>
                        </span> / æ ¼
                    </p>
                    <p id="bingoReward" style="color: var(--gacha-purple); font-size: 0.9rem; margin-top: 5px;">
                        é€£ç·šçå‹µï¼š<span id="rewardName">ç‰¹åˆ¥çå“</span>
                    </p>
                    <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px;">
                        <button id="batchModeBtn" class="btn btn-outline" onclick="toggleBatchMode()">
                            ğŸ”˜ åˆ‡æ›æ‰¹æ¬¡æŒ–æ˜æ¨¡å¼
                        </button>
                    </div>
                </div>

                <div id="bingoGrid" class="bingo-grid grid-3">
                    <!-- æ ¼å­ç”± JS å‹•æ…‹ç”Ÿæˆ -->
                </div>

                <div id="batchCart"
                    style="display: none; background: rgba(102,126,234,0.1); border-radius: 15px; padding: 20px; margin-top: 30px; text-align: center;">
                    <p style="margin-bottom: 15px;">å·²é¸æ“‡ <strong id="selectedDigCount"
                            style="color: var(--accent-color); font-size: 1.2rem;">0</strong> å€‹æ ¼å­</p>
                    <div style="display: flex; gap: 10px; justify-content: center;">
                        <button class="btn btn-outline" onclick="clearDigSelection()">æ¸…é™¤é¸æ“‡</button>
                        <button class="btn-gacha" onclick="confirmBatchDig()">é¸å¥½äº†ï¼Œç«‹å³æŒ–æ˜ï¼</button>
                    </div>
                </div>

                <div style="text-align: center; margin-top: 30px;">
                    <button class="btn btn-outline" onclick="backToList()">è¿”å›åˆ—è¡¨</button>
                </div>

                <!-- çé …æ¸…å–® -->
                <div style="background: white; border-radius: 20px; padding: 30px; margin-top: 40px;">
                    <h4 style="margin-bottom: 20px;">ğŸ æ ¼å­çé …ä¸€è¦½ (éš±è—)</h4>
                    <div id="prizeList" class="grid"
                        style="grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));">
                        <!-- ç”± JS å‹•æ…‹ç”Ÿæˆ -->
                    </div>
                </div>
            </div>
        </div>

        <style>
            .not-logged-in {
                filter: grayscale(0.7);
                opacity: 0.8;
                position: relative;
            }

            .not-logged-in::after {
                content: 'ğŸ”’ ç™»å…¥å¾Œå¯æŒ–å¯¶';
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: rgba(0, 0, 0, 0.7);
                color: white;
                padding: 5px 15px;
                border-radius: 20px;
                z-index: 10;
            }

            .prize-item {
                text-align: center;
                border: 1px solid #eee;
                padding: 15px;
                border-radius: 12px;
            }
        </style>

        <!-- æŒ–æ˜çµæœå½ˆçª— -->
        <div id="digModal" class="prize-reveal-overlay" style="display: none;">
            <div class="prize-card">
                <div style="font-size: 4rem; margin-bottom: 20px;">ğŸ</div>
                <h2 id="digPrize" style="margin: 0 0 15px 0;">çå“åç¨±</h2>
                <p id="digShards" style="color: #6c5ce7;"></p>
                <div id="bingoAlert"
                    style="display: none; margin-top: 20px; padding: 15px; background: linear-gradient(145deg, var(--gacha-gold), #f39c12); border-radius: 10px;">
                    <p style="font-size: 1.5rem; margin: 0;">ğŸŠ BINGO!</p>
                    <p id="bingoRewardText" style="margin: 10px 0 0 0;">ç²å¾—é€£ç·šçå‹µï¼</p>
                </div>
                <button class="btn-gacha" onclick="closeDigModal()" style="margin-top: 20px;">ç¢ºå®š</button>
            </div>
        </div>

        <!-- ç¢ºèªæ‰£æ¬¾æ¨¡æ…‹æ¡† -->
        <div id="confirmModal" class="prize-reveal-overlay" style="display: none;">
            <div class="prize-card" style="max-width: 400px;">
                <div style="font-size: 2rem; margin-bottom: 15px;">ğŸ¯</div>
                <h3 style="margin: 0 0 15px 0;">ç¢ºèªæŒ–æ˜</h3>
                <p style="margin-bottom: 10px;">å³å°‡æ‰£é™¤é¤˜é¡é€²è¡ŒæŒ–å¯¶</p>
                <div style="background: rgba(102,126,234,0.1); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <p style="margin: 0; font-size: 1.5rem; color: var(--accent-color); font-weight: bold;">
                        $<span id="confirmPrice">0</span>
                    </p>
                </div>
                <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                    <button class="btn btn-outline" onclick="cancelConfirm()">å–æ¶ˆ</button>
                    <button class="btn btn-outline" onclick="simulateTrialDig()"
                        style="border-color: #667eea; color: #667eea;">å…è²»è©¦æŒ–é«”é©—</button>
                    <button id="realDigBtn" class="btn-gacha" onclick="confirmDig()">ç¢ºèªæ‰£æ¬¾</button>
                </div>
            </div>
        </div>

        <script th:inline="javascript">
            let currentGameId = null;
            let currentGridSize = 3;
            let gameCells = [];
            let selectedPositions = [];
            let isBatchMode = false;

            document.addEventListener('DOMContentLoaded', function () {
                loadGameList();
            });

            function toggleBatchMode() {
                isBatchMode = !isBatchMode;
                const btn = document.getElementById('batchModeBtn');
                btn.innerHTML = isBatchMode ? 'âŒ é—œé–‰æ‰¹æ¬¡æŒ–æ˜' : 'ğŸ”˜ åˆ‡æ›æ‰¹æ¬¡æŒ–æ˜æ¨¡å¼';
                btn.classList.toggle('active', isBatchMode);

                if (!isBatchMode) {
                    clearDigSelection();
                }
                renderBingoGrid();
            }

            function clearDigSelection() {
                selectedPositions = [];
                updateBatchCart();
                renderBingoGrid();
            }

            function updateBatchCart() {
                const cart = document.getElementById('batchCart');
                const count = document.getElementById('selectedDigCount');
                count.textContent = selectedPositions.length;
                cart.style.display = selectedPositions.length > 0 ? 'block' : 'none';
            }

            function loadGameList() {
                fetch('/api/bingo')
                    .then(r => r.json())
                    .then(response => {
                        if (response.success && response.data.length > 0) {
                            renderGameList(response.data);
                        } else {
                            document.getElementById('gameList').innerHTML = `
                                <div class="text-center" style="grid-column: 1/-1; padding: 40px;">
                                    <p>ç›®å‰æ²’æœ‰é€²è¡Œä¸­çš„ä¹å®®æ ¼éŠæˆ²</p>
                                </div>
                            `;
                        }
                    });
            }

            function renderGameList(games) {
                const isLoggedIn = /*[[${currentUser != null}]]*/ false;
                const html = games.map(game => `
                    <div class="card" style="cursor: pointer;" onclick="selectGame(${game.id})">
                        <div style="padding: 30px; background: linear-gradient(145deg, #1a1a2e, #16213e); text-align: center;">
                            <div style="display: inline-grid; grid-template-columns: repeat(3, 30px); gap: 5px;">
                                ${Array(9).fill('<div style="width: 30px; height: 30px; background: #e74c3c; border-radius: 5px;"></div>').join('')}
                            </div>
                        </div>
                        <div style="padding: 20px; text-align: center;">
                            <div style="display: flex; justify-content: center; align-items: center; gap: 8px; margin-bottom: 5px;">
                                <span style="background: var(--gacha-gold); color: #333; padding: 3px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: bold;">
                                    ${game.ipName}
                                </span>
                            </div>
                            <h3 style="margin: 10px 0;">${game.name}</h3>
                            <div style="display: flex; justify-content: center; gap: 5px; margin-bottom: 5px;">
                                <span style="background: rgba(102,126,234,0.1); color: #667eea; padding: 2px 8px; border-radius: 10px; font-size: 0.75rem;">âœ¨ æ”¯æ´è©¦æŒ–</span>
                            </div>
                            <p style="color: var(--accent-color); font-weight: bold; font-size: 1.3rem;">$${game.pricePerDig} / æ ¼</p>
                            <p style="color: #666; font-size: 0.9rem;">${game.gridSize}Ã—${game.gridSize} æ ¼</p>
                        </div>
                    </div>
                `).join('');
                document.getElementById('gameList').innerHTML = html;
            }

            function promptLogin() {
                alert('è«‹å…ˆç™»å…¥æœƒå“¡ä»¥é€²è¡ŒæŒ–å¯¶ï¼');
                window.location.href = '/login';
            }

            function selectGame(gameId) {
                currentGameId = gameId;
                document.getElementById('gameList').style.display = 'none';
                document.getElementById('bingoGame').style.display = 'block';
                loadGameDetails(gameId);
            }

            function backToList() {
                currentGameId = null;
                isBatchMode = false;
                selectedPositions = [];
                document.getElementById('gameList').style.display = 'grid';
                document.getElementById('bingoGame').style.display = 'none';
            }

            function loadGameDetails(gameId) {
                fetch(`/api/bingo/${gameId}`)
                    .then(r => r.json())
                    .then(response => {
                        if (response.success) {
                            const game = response.data;
                            document.getElementById('gameName').textContent = game.name;
                            document.getElementById('digPrice').textContent = game.pricePerDig;
                            document.getElementById('rewardName').textContent = game.bingoRewardName || 'ç‰¹åˆ¥çå“';
                            currentGridSize = game.gridSize;
                            gameCells = game.cells || [];
                            renderBingoGrid();
                            renderPrizeList(game.prizes || []); // ä½¿ç”¨é è¦½çé …
                            updateBatchCart();
                        }
                    });
            }

            function renderPrizeList(prizes) {
                const html = prizes.map(p => `
                    <div class="prize-item">
                        <div style="font-size: 1.5rem; margin-bottom: 5px;">ğŸ</div>
                        <div style="font-weight: bold; margin-bottom: 5px;">${p.name}</div>
                        <div style="font-size: 0.85rem; color: #666;">${p.description || ''}</div>
                    </div>
                `).join('');
                document.getElementById('prizeList').innerHTML = html;
            }

            function renderBingoGrid() {
                const grid = document.getElementById('bingoGrid');
                grid.className = `bingo-grid grid-${currentGridSize}`;

                const html = gameCells.map(cell => {
                    if (cell.isRevealed) {
                        return `
                            <div class="bingo-cell revealed flipped" data-pos="${cell.position}">
                                <div class="bingo-cell-inner">
                                    <div class="bingo-cell-front"></div>
                                    <div class="bingo-cell-back">
                                        <span style="font-size: 0.8rem; color: white; text-align: center; padding: 5px; word-break: break-all; line-height: 1.1;">
                                            ${cell.prizeName || 'ğŸ'}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        `;
                    } else {
                        const isSelected = selectedPositions.includes(cell.position);
                        return `
                            <div class="bingo-cell hidden ${isSelected ? 'selected' : ''}" 
                                 data-pos="${cell.position}" 
                                 onclick="handleCellClick(${cell.position})">
                                <div class="bingo-cell-inner">
                                    <div class="bingo-cell-front">
                                        ${isSelected ? '<span style="position:absolute; top:5px; right:5px;">âœ…</span>' : ''}
                                    </div>
                                    <div class="bingo-cell-back"></div>
                                </div>
                            </div>
                        `;
                    }
                }).join('');

                grid.innerHTML = html;
            }

            function handleCellClick(position) {
                if (isBatchMode) {
                    const idx = selectedPositions.indexOf(position);
                    if (idx > -1) {
                        selectedPositions.splice(idx, 1);
                    } else {
                        selectedPositions.push(position);
                    }
                    updateBatchCart();
                    renderBingoGrid();
                } else {
                    digCell(position);
                }
            }

            let pendingPosition = null;
            let pendingPositions = [];

            function digCell(position) {
                if (!currentGameId) return;
                const isLoggedIn = /*[[${currentUser != null}]]*/ false;

                const cell = document.querySelector(`[data-pos="${position}"]`);
                if (cell.classList.contains('revealed')) return;

                // é¡¯ç¤ºç¢ºèªæ¨¡æ…‹æ¡†
                pendingPosition = position;
                pendingPositions = [position];
                document.getElementById('confirmPrice').textContent = document.getElementById('digPrice').textContent;

                const modalTitle = document.querySelector('#confirmModal h3');
                const realDigBtn = document.getElementById('realDigBtn');
                const trialDigBtn = document.querySelector('#confirmModal .btn-outline[onclick="simulateTrialDig()"]');

                modalTitle.textContent = 'ç¢ºèªæŒ–æ˜ / è©¦æŒ–';

                if (!isLoggedIn) {
                    realDigBtn.style.display = 'none';
                    trialDigBtn.style.display = 'inline-block';
                } else {
                    realDigBtn.style.display = 'inline-block';
                    trialDigBtn.style.display = 'inline-block';
                }

                document.getElementById('confirmModal').style.display = 'flex';
            }

            function confirmBatchDig() {
                if (selectedPositions.length === 0) return;

                const isLoggedIn = /*[[${currentUser != null}]]*/ false;
                pendingPositions = [...selectedPositions];

                const priceValue = parseFloat(document.getElementById('digPrice').textContent);
                document.getElementById('confirmPrice').textContent = (priceValue * pendingPositions.length).toFixed(2);

                const modalTitle = document.querySelector('#confirmModal h3');
                modalTitle.textContent = `ç¢ºèªæŒ–æ˜ ${pendingPositions.length} å€‹æ ¼å­`;

                document.getElementById('confirmModal').style.display = 'flex';
            }

            function cancelConfirm() {
                pendingPosition = null;
                document.getElementById('confirmModal').style.display = 'none';
            }

            function confirmDig() {
                const isLoggedIn = /*[[${currentUser != null}]]*/ false;
                if (!isLoggedIn) {
                    simulateTrialDig();
                    return;
                }

                document.getElementById('confirmModal').style.display = 'none';
                if (pendingPositions.length === 0) return;

                // é¡¯ç¤ºé®ç½©
                GameUtils.showMask();

                // æ’­æ”¾æŒ–æ˜å‹•ç•« (å°æ‰€æœ‰é¸ä¸­çš„æ ¼å­)
                pendingPositions.forEach(pos => {
                    const cell = document.querySelector(`[data-pos="${pos}"]`);
                    if (cell) {
                        const inner = cell.querySelector('.bingo-cell-inner');
                        // 1. GSAP æŠ–å‹•å‹•ç•«
                        gsap.to(inner, {
                            x: "random(-4, 4)",
                            y: "random(-4, 4)",
                            rotation: "random(-2, 2)",
                            duration: 0.1,
                            repeat: 5,
                            yoyo: true,
                            ease: "none",
                            onComplete: () => {
                                // 2. å¢åŠ ç²’å­èˆ‡éŸ³æ•ˆ (ä¿æŒåŸé‚è¼¯)
                                spawnDigParticles(cell);
                            }
                        });
                    }
                });
                playDigSound();

                setTimeout(() => {
                    const apiUrl = pendingPositions.length === 1
                        ? `/api/bingo/${currentGameId}/dig/${pendingPositions[0]}`
                        : `/api/bingo/${currentGameId}/dig-batch`;

                    const fetchOptions = pendingPositions.length === 1
                        ? { method: 'POST' }
                        : {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ positions: pendingPositions })
                        };

                    fetch(apiUrl, fetchOptions)
                        .then(r => r.json())
                        .then(response => {
                            if (response.success) {
                                // 3. ç¿»è½‰å‹•ç•«
                                pendingPositions.forEach(pos => {
                                    const cell = document.querySelector(`[data-pos="${pos}"]`);
                                    if (cell) {
                                        const resCell = response.data.cells ? response.data.cells.find(c => c.position === pos) : response.data.cell;
                                        if (resCell) {
                                            const back = cell.querySelector('.bingo-cell-back');
                                            back.innerHTML = `<span style="font-size: 0.8rem; color: white; text-align: center; padding: 5px; word-break: break-all; line-height: 1.1;">${resCell.prizeName || 'ğŸ'}</span>`;
                                        }
                                        cell.classList.add('flipped');
                                        cell.classList.remove('hidden');
                                    }
                                });

                                setTimeout(() => {
                                    showDigResult(response.data, response.message);
                                    loadGameDetails(currentGameId);
                                    if (window.refreshBalance) window.refreshBalance();
                                    selectedPositions = []; // æ¸…ç©ºé¸æ“‡
                                }, 600);
                            } else {
                                alert(response.message || 'æŒ–æ˜å¤±æ•—');
                                if (GameUtils.hideMask) GameUtils.hideMask();
                            }
                        })
                        .catch(err => {
                            console.error('Error:', err);
                            alert('æ“ä½œå¤±æ•—');
                            if (window.hideMask) window.hideMask();
                        });
                }, 600);
            }

            function simulateTrialDig() {
                document.getElementById('confirmModal').style.display = 'none';
                if (pendingPositions.length === 0) return;
                if (window.showMask) window.showMask();

                pendingPositions.forEach(pos => {
                    const cell = document.querySelector(`[data-pos="${pos}"]`);
                    if (cell) {
                        const inner = cell.querySelector('.bingo-cell-inner');
                        gsap.to(inner, {
                            x: "random(-4, 4)",
                            y: "random(-4, 4)",
                            rotation: "random(-2, 2)",
                            duration: 0.1,
                            repeat: 5,
                            yoyo: true,
                            ease: "none",
                            onComplete: () => {
                                spawnDigParticles(cell);
                            }
                        });
                    }
                });
                playDigSound();

                setTimeout(() => {
                    // æ¨¡æ“¬çµæœ
                    const randomCell = gameCells[Math.floor(Math.random() * gameCells.length)];
                    const trialResult = {
                        isTrial: true,
                        cells: pendingPositions.map(p => ({ prizeName: randomCell.prizeName, position: p })),
                        cell: { prizeName: randomCell.prizeName }, //ç›¸å®¹èˆŠé‚è¼¯
                        totalShards: Math.floor(Math.random() * 30) * pendingPositions.length,
                        shardsEarned: Math.floor(Math.random() * 30),
                        hasBingo: Math.random() > 0.8,
                        bingoRewardName: "ç¥ç§˜å¤§ç"
                    };

                    // ç¿»è½‰å‹•ç•«
                    pendingPositions.forEach(pos => {
                        const cell = document.querySelector(`[data-pos="${pos}"]`);
                        if (cell) {
                            const back = cell.querySelector('.bingo-cell-back');
                            back.innerHTML = `<span style="font-size: 0.8rem; color: white; text-align: center; padding: 5px; word-break: break-all; line-height: 1.1;">${randomCell.prizeName || 'ğŸ'}</span>`;
                            cell.classList.add('flipped');
                            cell.classList.remove('hidden');
                        }
                    });

                    setTimeout(() => {
                        showDigResult(trialResult, "è©¦æŒ–å®Œæˆ");
                        selectedPositions = [];
                    }, 600);
                }, 600);
            }

            function playDigSound() {
                try {
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();

                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);

                    oscillator.type = 'triangle';
                    oscillator.frequency.setValueAtTime(200, audioContext.currentTime);
                    oscillator.frequency.exponentialRampToValueAtTime(80, audioContext.currentTime + 0.2);

                    gainNode.gain.setValueAtTime(0.4, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);

                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.3);
                } catch (e) { }
            }

            function spawnDigParticles(cell) {
                const rect = cell.getBoundingClientRect();
                const centerX = rect.left + rect.width / 2;
                const centerY = rect.top + rect.height / 2;

                const colors = ['#e74c3c', '#f39c12', '#27ae60', '#3498db'];

                for (let i = 0; i < 12; i++) {
                    const particle = document.createElement('div');
                    particle.style.cssText = `
                        position: fixed;
                        left: ${centerX}px;
                        top: ${centerY}px;
                        width: 8px;
                        height: 8px;
                        background: ${colors[Math.floor(Math.random() * colors.length)]};
                        border-radius: 2px;
                        pointer-events: none;
                        z-index: 10000;
                    `;
                    document.body.appendChild(particle);

                    const angle = (i / 12) * Math.PI * 2;
                    const distance = 50 + Math.random() * 50;
                    const tx = Math.cos(angle) * distance;
                    const ty = Math.sin(angle) * distance - 30;

                    particle.animate([
                        { transform: 'translate(0, 0) scale(1)', opacity: 1 },
                        { transform: `translate(${tx}px, ${ty}px) scale(0)`, opacity: 0 }
                    ], {
                        duration: 500,
                        easing: 'ease-out',
                        fill: 'forwards'
                    }).onfinish = () => particle.remove();
                }
            }

            function showDigResult(result, message) {
                const isLoggedIn = /*[[${currentUser != null}]]*/ false;
                const isTrial = !!result.isTrial;

                // æ’­æ”¾æˆåŠŸéŸ³æ•ˆ
                GameUtils.playWinSound();

                const cells = result.cells || [result.cell];
                const prizeNames = cells.map(c => c.prizeName).filter(n => n).join(', ');

                document.getElementById('digPrize').textContent = cells.length > 2
                    ? `ç²å¾— ${cells.length} å€‹çå“`
                    : (prizeNames || 'ç¥ç§˜çå“');

                const shards = result.totalShards !== undefined ? result.totalShards : result.shardsEarned;
                document.getElementById('digShards').textContent = shards > 0 ? `+${shards} ç¢ç‰‡` : '';

                const bingoAlert = document.getElementById('bingoAlert');
                if (result.hasBingo) {
                    bingoAlert.style.display = 'block';
                    document.getElementById('bingoRewardText').textContent = `ç²å¾—é€£ç·šçå‹µï¼š${result.bingoRewardName || 'ç‰¹åˆ¥çå“'}`;
                    highlightBingoLines(result.bingoLines);
                    GameUtils.spawnConfetti();
                } else {
                    bingoAlert.style.display = 'none';
                }

                const resultBtn = document.querySelector('#digModal .btn-gacha');
                if (isTrial) {
                    resultBtn.innerHTML = isLoggedIn ? 'âœ¨ è¿”å›é¸è³¼' : 'ç¢ºå®š';
                    resultBtn.onclick = closeDigModal;
                } else {
                    resultBtn.innerHTML = 'ğŸ“¦ æŸ¥çœ‹æˆ‘çš„çå“ç´€éŒ„';
                    resultBtn.onclick = () => GameUtils.redirectToHistory();
                }

                document.getElementById('digModal').style.display = 'flex';
                document.getElementById('digModal').dataset.isTrial = isTrial;
            }


            function highlightBingoLines(lines) {
                // é«˜äº®é€£ç·šæ ¼å­
                if (!lines || lines.length === 0) return;

                lines.forEach(line => {
                    let positions = [];
                    if (line.type === 'ROW') {
                        for (let i = 0; i < currentGridSize; i++) {
                            positions.push(line.index * currentGridSize + i + 1);
                        }
                    } else if (line.type === 'COL') {
                        for (let i = 0; i < currentGridSize; i++) {
                            positions.push(i * currentGridSize + line.index + 1);
                        }
                    } else if (line.type === 'DIAGONAL') {
                        if (line.index === 0) {
                            for (let i = 0; i < currentGridSize; i++) {
                                positions.push(i * currentGridSize + i + 1);
                            }
                        } else {
                            for (let i = 0; i < currentGridSize; i++) {
                                positions.push(i * currentGridSize + (currentGridSize - 1 - i) + 1);
                            }
                        }
                    }

                    positions.forEach(pos => {
                        const cell = document.querySelector(`[data-pos="${pos}"]`);
                        if (cell) cell.classList.add('bingo-line');
                    });
                });
            }

            function closeDigModal() {
                const isTrial = document.getElementById('digModal').dataset.isTrial === 'true';
                document.getElementById('digModal').style.display = 'none';
                // éš±è—é®ç½©ï¼Œæ¢å¾©æ“ä½œ
                if (window.hideMask) window.hideMask();

                if (!isTrial) {
                    window.location.href = '/profile';
                } else {
                    location.reload();
                }
            }
        </script>
    </div>
</body>

</html>