<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="~{layout :: html(title='‰πùÂÆÆÊ†ºÊåñÂØ∂', content=~{::content})}">

<body>
    <div th:fragment="content">
        <link rel="stylesheet" th:href="@{/css/game-listing.css}">
        <link rel="stylesheet" th:href="@{/css/game-modals.css}">
        <link rel="stylesheet" th:href="@{/css/home-feed.css}">

        <div class="game-page" x-data="bingoComponent">
            <div class="container section">
                <h2 class="section-title">üéØ ‰πùÂÆÆÊ†ºÊåñÂØ∂</h2>
                <p class="section-subtitle">ÊåñÊéòÊñπÊ†ºÔºåÈÄ£Á∑öÁç≤Â§ßÁçéÔºÅ</p>

                <!-- ÈÅäÊà≤ÂàóË°® - Âç°ÁâáÂºè Feed -->
                <div class="game-feed-grid" x-show="!currentGame">
                    <div x-show="games.length === 0" class="feed-loader">
                        <div class="spinner"></div>
                    </div>
                    <template x-for="game in games" :key="game.id">
                        <div class="feed-card" @click="selectGame(game)">
                            <div class="feed-card__image-wrapper">
                                <img :src="game.imageUrl || '/images/placeholder.jpg'" class="feed-card__image"
                                    loading="lazy">
                            </div>

                            <div class="feed-card__content">
                                <div class="feed-card__header">
                                    <span class="feed-tag badge-bingo">‰πùÂÆÆÊ†º</span>
                                    <h3 class="feed-card__title" x-text="game.name"></h3>
                                </div>

                                <div class="feed-card__footer">
                                    <div class="feed-card__price">
                                        <span class="currency">$</span>
                                        <span class="amount" x-text="game.pricePerDig"></span>
                                    </div>
                                    <span class="feed-action-icon">‚ûî</span>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>

                <!-- ÈÅäÊà≤ÂçÄ -->
                <div class="bingo-game-section" x-show="currentGame" x-cloak>
                    <div class="game-detail-header">
                        <div class="game-detail-header__top">
                            <div>
                                <h3 class="game-detail-header__name" x-text="currentGame?.name"></h3>
                                <p class="game-detail-header__desc" x-text="currentGame?.description || ''"></p>
                            </div>
                            <div class="game-detail-header__price">$<span x-text="currentGame?.pricePerDig"></span> / Ê†º
                            </div>
                        </div>
                    </div>

                    <!-- ÊâπÊ¨°Ê®°ÂºèÂàáÊèõ -->
                    <div class="bingo-controls">
                        <button class="bingo-batch-btn" :class="{ 'active': isBatchMode }" @click="toggleBatchMode()">
                            <span x-text="isBatchMode ? '‚ùå ÈóúÈñâÊâπÊ¨°' : 'üîò ÊâπÊ¨°Ê®°Âºè'"></span>
                        </button>
                        <button x-show="isBatchMode && selectedCells.length > 0" @click="confirmBatchDig()"
                            class="bingo-confirm-batch-btn">
                            ÊåñÊéò <span x-text="selectedCells.length"></span> Ê†º ($<span x-text="totalBatchCost"></span>)
                        </button>
                    </div>

                    <!-- ‰πùÂÆÆÊ†º -->
                    <div class="bingo-grid" :class="gridClass">
                        <template x-for="cell in cells" :key="cell.position">
                            <div class="bingo-cell"
                                :class="{ 'revealed': cell.isRevealed, 'selected': isCellSelected(cell) }"
                                :data-pos="cell.position" @click="handleCellClick(cell)">
                                <div class="bingo-cell-inner">
                                    <div class="bingo-cell-front">
                                        <span x-show="isCellSelected(cell)">‚úÖ</span>
                                    </div>
                                    <div class="bingo-cell-back">
                                        <span x-text="cell.prizeName || 'üéÅ'"></span>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>

                    <div style="text-align: center; margin-top: 20px;">
                        <button class="game-back-btn" @click="backToList()">‚Üê ËøîÂõûÂàóË°®</button>
                    </div>

                    <!-- ÁçéÂìÅÂàóË°® -->
                    <div class="game-prize-section">
                        <h4 class="game-prize-section__title">üéÅ ÂèØÊåñÁçéÂìÅ</h4>
                        <div class="game-prize-grid">
                            <template x-for="prize in prizes" :key="prize.id">
                                <div class="game-prize-item">
                                    <div class="game-prize-item__icon">üéÅ</div>
                                    <div class="game-prize-item__name" x-text="prize.name"></div>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Á¢∫Ë™çÂΩàÁ™ó -->
            <div class="game-modal" x-show="showConfirmModal" x-cloak @click.self="closeConfirmModal()">
                <div class="game-modal__card">
                    <div class="game-modal__icon">‚õèÔ∏è</div>
                    <h3 class="game-modal__title">Á¢∫Ë™çÊåñÊéò</h3>
                    <p class="game-modal__desc">ÊåñÊéò <span x-text="pendingPositions.length"></span> ÂÄãÊ†ºÂ≠ê</p>
                    <div class="game-modal__details">
                        <p>Ê∂àË≤ªÔºö$<span x-text="pendingPositions.length * (currentGame?.pricePerDig || 0)"></span></p>
                    </div>
                    <div class="game-modal__actions">
                        <button class="game-modal__btn game-modal__btn--cancel" @click="closeConfirmModal()">ÂèñÊ∂à</button>
                        <button class="game-modal__btn game-modal__btn--trial" @click="dig(true)">üß™ Ë©¶Êåñ</button>
                        <button class="game-modal__btn game-modal__btn--confirm" @click="dig(false)"
                            x-show="$store.user.isLoggedIn">Á¢∫Ë™çÊåñÊéò</button>
                    </div>
                </div>
            </div>

            <!-- ÁµêÊûúÂΩàÁ™ó -->
            <div class="game-modal game-result-modal" x-show="showResultModal" x-cloak @click.self="closeResultModal()">
                <div class="game-modal__card">
                    <div class="game-modal__icon" x-text="result?.hasBingo ? 'üéâ' : 'üéÅ'"></div>
                    <h2 class="game-result__title" x-text="result?.hasBingo ? 'BINGOÔºÅ' : 'ÊåñÊéòÊàêÂäüÔºÅ'"></h2>
                    <template x-if="result?.cells">
                        <div class="dig-results">
                            <template x-for="c in result.cells" :key="c.position">
                                <div class="dig-result-item">
                                    <span class="dig-result-item__pos" x-text="'#' + c.position"></span>
                                    <span x-text="c.prizeName"></span>
                                </div>
                            </template>
                        </div>
                    </template>
                    <p class="game-result__shards" x-show="result?.shardsEarned > 0"
                        x-text="'+' + result?.shardsEarned + ' Á¢éÁâá'"></p>
                    <p class="game-result__trial-badge" x-show="isTrial">Ë©¶ÊåñÈ´îÈ©ó</p>
                    <button class="game-result__btn" @click="closeResultModal()">
                        <span x-text="isTrial ? 'ÂÜçË©¶‰∏ÄÊ¨°' : 'üì¶ Êü•ÁúãÁçéÂìÅÁ¥ÄÈåÑ'"></span>
                    </button>
                </div>
            </div>
        </div>

        <script th:src="@{/js/game-utils.js}"></script>
        <script th:src="@{/js/alpine/bingo-component.js}"></script>

        <style>
            .bingo-preview {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 3px;
                padding: 20px;
            }

            .bingo-preview__cell {
                background: rgba(255, 255, 255, 0.3);
                border-radius: 4px;
                aspect-ratio: 1;
            }

            .bingo-controls {
                display: flex;
                gap: 10px;
                justify-content: center;
                margin-bottom: 20px;
            }

            .bingo-batch-btn,
            .bingo-confirm-batch-btn {
                padding: 10px 20px;
                border-radius: 20px;
                border: none;
                cursor: pointer;
                font-weight: 600;
            }

            .bingo-batch-btn {
                background: #eee;
            }

            .bingo-batch-btn.active {
                background: #6c5ce7;
                color: #fff;
            }

            .bingo-confirm-batch-btn {
                background: var(--accent-color);
                color: #000;
            }

            .bingo-grid {
                display: grid;
                gap: 8px;
                max-width: 400px;
                margin: 0 auto;
            }

            .grid-3 {
                grid-template-columns: repeat(3, 1fr);
            }

            .grid-4 {
                grid-template-columns: repeat(4, 1fr);
            }

            .grid-5 {
                grid-template-columns: repeat(5, 1fr);
            }

            .bingo-cell {
                aspect-ratio: 1;
                perspective: 600px;
                cursor: pointer;
            }

            .bingo-cell-inner {
                width: 100%;
                height: 100%;
                position: relative;
                transform-style: preserve-3d;
                transition: transform 0.6s;
            }

            .bingo-cell.revealed .bingo-cell-inner,
            .bingo-cell.flipped .bingo-cell-inner {
                transform: rotateY(180deg);
            }

            .bingo-cell-front,
            .bingo-cell-back {
                position: absolute;
                width: 100%;
                height: 100%;
                backface-visibility: hidden;
                display: flex;
                align-items: center;
                justify-content: center;
                border-radius: 10px;
                font-weight: 700;
            }

            .bingo-cell-front {
                background: linear-gradient(145deg, #667eea, #764ba2);
                color: #fff;
            }

            .bingo-cell-back {
                background: linear-gradient(145deg, #ffd700, #ff6b6b);
                color: #333;
                transform: rotateY(180deg);
            }

            .bingo-cell.selected .bingo-cell-front {
                border: 3px solid #fff;
            }

            .dig-results {
                margin: 15px 0;
            }

            .dig-result-item {
                display: flex;
                gap: 10px;
                justify-content: center;
                padding: 8px;
            }

            .dig-result-item__pos {
                background: #6c5ce7;
                color: #fff;
                padding: 2px 8px;
                border-radius: 10px;
                font-size: 0.8rem;
            }

            [x-cloak] {
                display: none !important;
            }
        </style>
    </div>
</body>

</html>