<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="~{layout :: html(title='ä¹å®®æ ¼æŒ–å¯¶', content=~{::content})}">

<body>
    <div th:fragment="content">
        <link rel="stylesheet" th:href="@{/css/gacha-animations.css}">

        <div class="container section">
            <h2 class="section-title">ğŸ¯ ä¹å®®æ ¼æŒ–å¯¶</h2>
            <p class="text-center" style="color: var(--text-secondary); margin-bottom: 30px;">
                é»æ“Šæ ¼å­æŒ–æ˜çå“ï¼Œé€£æˆä¸€ç·šç²å¾—é¡å¤–çå‹µï¼
            </p>

            <!-- éŠæˆ²åˆ—è¡¨ -->
            <div id="gameList" class="grid" style="margin-bottom: 40px;">
                <div class="text-center" style="grid-column: 1/-1; padding: 40px;">
                    <p>è¼‰å…¥ä¸­...</p>
                </div>
            </div>

            <!-- éŠæˆ²å€åŸŸ -->
            <div id="bingoGame" style="display: none;">
                <div style="text-align: center; margin-bottom: 20px;">
                    <h3 id="gameName" style="margin-bottom: 5px;">éŠæˆ²åç¨±</h3>
                    <p style="color: var(--text-secondary);">
                        <span style="color: var(--gacha-gold); font-weight: bold; font-size: 1.3rem;">
                            $<span id="digPrice">0</span>
                        </span> / æ ¼
                    </p>
                    <p id="bingoReward" style="color: var(--gacha-purple); font-size: 0.9rem; margin-top: 5px;">
                        é€£ç·šçå‹µï¼š<span id="rewardName">ç‰¹åˆ¥çå“</span>
                    </p>
                </div>

                <div id="bingoGrid" class="bingo-grid grid-3">
                    <!-- æ ¼å­ç”± JS å‹•æ…‹ç”Ÿæˆ -->
                </div>

                <div style="text-align: center; margin-top: 30px;">
                    <button class="btn btn-outline" onclick="backToList()">è¿”å›åˆ—è¡¨</button>
                </div>
            </div>
        </div>

        <!-- æŒ–æ˜çµæœå½ˆçª— -->
        <div id="digModal" class="prize-reveal-overlay" style="display: none;">
            <div class="prize-card">
                <div style="font-size: 4rem; margin-bottom: 20px;">ğŸ</div>
                <h2 id="digPrize" style="margin: 0 0 15px 0;">çå“åç¨±</h2>
                <p id="digShards" style="color: #6c5ce7;"></p>
                <div id="bingoAlert"
                    style="display: none; margin-top: 20px; padding: 15px; background: linear-gradient(145deg, var(--gacha-gold), #f39c12); border-radius: 10px;">
                    <p style="font-size: 1.5rem; margin: 0;">ğŸŠ BINGO!</p>
                    <p id="bingoRewardText" style="margin: 10px 0 0 0;">ç²å¾—é€£ç·šçå‹µï¼</p>
                </div>
                <button class="btn-gacha" onclick="closeDigModal()" style="margin-top: 20px;">ç¢ºå®š</button>
            </div>
        </div>

        <!-- ç¢ºèªæ‰£æ¬¾æ¨¡æ…‹æ¡† -->
        <div id="confirmModal" class="prize-reveal-overlay" style="display: none;">
            <div class="prize-card" style="max-width: 400px;">
                <div style="font-size: 2rem; margin-bottom: 15px;">ğŸ¯</div>
                <h3 style="margin: 0 0 15px 0;">ç¢ºèªæŒ–æ˜</h3>
                <p style="margin-bottom: 10px;">å³å°‡æ‰£é™¤é¤˜é¡é€²è¡ŒæŒ–å¯¶</p>
                <div style="background: rgba(102,126,234,0.1); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <p style="margin: 0; font-size: 1.5rem; color: var(--accent-color); font-weight: bold;">
                        $<span id="confirmPrice">0</span>
                    </p>
                </div>
                <div style="display: flex; gap: 15px; justify-content: center;">
                    <button class="btn btn-outline" onclick="cancelConfirm()">å–æ¶ˆ</button>
                    <button class="btn-gacha" onclick="confirmDig()">ç¢ºèªæ‰£æ¬¾</button>
                </div>
            </div>
        </div>

        <script>
            let currentGameId = null;
            let currentGridSize = 3;
            let gameCells = [];

            document.addEventListener('DOMContentLoaded', function () {
                loadGameList();
            });

            function loadGameList() {
                fetch('/api/bingo')
                    .then(r => r.json())
                    .then(response => {
                        if (response.success && response.data.length > 0) {
                            renderGameList(response.data);
                        } else {
                            document.getElementById('gameList').innerHTML = `
                                <div class="text-center" style="grid-column: 1/-1; padding: 40px;">
                                    <p>ç›®å‰æ²’æœ‰é€²è¡Œä¸­çš„ä¹å®®æ ¼éŠæˆ²</p>
                                </div>
                            `;
                        }
                    });
            }

            function renderGameList(games) {
                const html = games.map(game => `
                    <div class="card" style="cursor: pointer;" onclick="selectGame(${game.id})">
                        <div style="padding: 30px; background: linear-gradient(145deg, #1a1a2e, #16213e); text-align: center;">
                            <div style="display: inline-grid; grid-template-columns: repeat(3, 30px); gap: 5px;">
                                ${Array(9).fill('<div style="width: 30px; height: 30px; background: #e74c3c; border-radius: 5px;"></div>').join('')}
                            </div>
                        </div>
                        <div style="padding: 20px; text-align: center;">
                            <span style="background: var(--gacha-gold); color: #333; padding: 3px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: bold;">
                                ${game.ipName}
                            </span>
                            <h3 style="margin: 10px 0;">${game.name}</h3>
                            <p style="color: var(--accent-color); font-weight: bold; font-size: 1.3rem;">$${game.pricePerDig} / æ ¼</p>
                            <p style="color: #666; font-size: 0.9rem;">${game.gridSize}Ã—${game.gridSize} æ ¼</p>
                        </div>
                    </div>
                `).join('');
                document.getElementById('gameList').innerHTML = html;
            }

            function selectGame(gameId) {
                currentGameId = gameId;
                document.getElementById('gameList').style.display = 'none';
                document.getElementById('bingoGame').style.display = 'block';
                loadGameDetails(gameId);
            }

            function backToList() {
                currentGameId = null;
                document.getElementById('gameList').style.display = 'grid';
                document.getElementById('bingoGame').style.display = 'none';
            }

            function loadGameDetails(gameId) {
                fetch(`/api/bingo/${gameId}`)
                    .then(r => r.json())
                    .then(response => {
                        if (response.success) {
                            const game = response.data;
                            document.getElementById('gameName').textContent = game.name;
                            document.getElementById('digPrice').textContent = game.pricePerDig;
                            document.getElementById('rewardName').textContent = game.bingoRewardName || 'ç‰¹åˆ¥çå“';
                            currentGridSize = game.gridSize;
                            gameCells = game.cells || [];
                            renderBingoGrid();
                        }
                    });
            }

            function renderBingoGrid() {
                const grid = document.getElementById('bingoGrid');
                grid.className = `bingo-grid grid-${currentGridSize}`;

                const html = gameCells.map(cell => {
                    if (cell.isRevealed) {
                        return `
                            <div class="bingo-cell revealed" data-pos="${cell.position}">
                                <span style="font-size: 1rem; color: white; text-align: center; padding: 5px;">
                                    ${cell.prizeName ? cell.prizeName.substring(0, 4) : 'ğŸ'}
                                </span>
                            </div>
                        `;
                    } else {
                        return `
                            <div class="bingo-cell hidden" data-pos="${cell.position}" onclick="digCell(${cell.position})">
                            </div>
                        `;
                    }
                }).join('');

                grid.innerHTML = html;
            }

            let pendingPosition = null;

            function digCell(position) {
                if (!currentGameId) return;

                const cell = document.querySelector(`[data-pos="${position}"]`);
                if (cell.classList.contains('revealed')) return;

                // é¡¯ç¤ºç¢ºèªæ¨¡æ…‹æ¡†
                pendingPosition = position;
                document.getElementById('confirmPrice').textContent = document.getElementById('digPrice').textContent;
                document.getElementById('confirmModal').style.display = 'flex';
            }

            function cancelConfirm() {
                pendingPosition = null;
                document.getElementById('confirmModal').style.display = 'none';
            }

            function confirmDig() {
                document.getElementById('confirmModal').style.display = 'none';
                if (pendingPosition === null) return;

                // æ’­æ”¾æŒ–æ˜å‹•ç•«
                const cell = document.querySelector(`[data-pos="${pendingPosition}"]`);
                if (cell) {
                    cell.classList.add('digging');
                    playDigSound();
                    spawnDigParticles(cell);
                }

                setTimeout(() => {
                    fetch(`/api/bingo/${currentGameId}/dig/${pendingPosition}`, { method: 'POST' })
                        .then(r => r.json())
                        .then(response => {
                            if (response.success) {
                                showDigResult(response.data, response.message);
                                loadGameDetails(currentGameId);
                                if (window.refreshBalance) window.refreshBalance();
                            } else {
                                alert(response.message || 'æŒ–æ˜å¤±æ•—');
                            }
                            pendingPosition = null;
                        })
                        .catch(err => {
                            console.error('Error:', err);
                            alert('æ“ä½œå¤±æ•—');
                            pendingPosition = null;
                        });
                }, 600); // ç­‰å¾…å‹•ç•«å®Œæˆ
            }

            // æ’­æ”¾æŒ–æ˜éŸ³æ•ˆ
            function playDigSound() {
                try {
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();

                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);

                    oscillator.type = 'triangle';
                    oscillator.frequency.setValueAtTime(200, audioContext.currentTime);
                    oscillator.frequency.exponentialRampToValueAtTime(80, audioContext.currentTime + 0.2);

                    gainNode.gain.setValueAtTime(0.4, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);

                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.3);
                } catch (e) { }
            }

            // ç”¢ç”ŸæŒ–æ˜ç²’å­æ•ˆæœ
            function spawnDigParticles(cell) {
                const rect = cell.getBoundingClientRect();
                const centerX = rect.left + rect.width / 2;
                const centerY = rect.top + rect.height / 2;

                const colors = ['#e74c3c', '#f39c12', '#27ae60', '#3498db'];

                for (let i = 0; i < 12; i++) {
                    const particle = document.createElement('div');
                    particle.style.cssText = `
                        position: fixed;
                        left: ${centerX}px;
                        top: ${centerY}px;
                        width: 8px;
                        height: 8px;
                        background: ${colors[Math.floor(Math.random() * colors.length)]};
                        border-radius: 2px;
                        pointer-events: none;
                        z-index: 10000;
                    `;
                    document.body.appendChild(particle);

                    const angle = (i / 12) * Math.PI * 2;
                    const distance = 50 + Math.random() * 50;
                    const tx = Math.cos(angle) * distance;
                    const ty = Math.sin(angle) * distance - 30;

                    particle.animate([
                        { transform: 'translate(0, 0) scale(1)', opacity: 1 },
                        { transform: `translate(${tx}px, ${ty}px) scale(0)`, opacity: 0 }
                    ], {
                        duration: 500,
                        easing: 'ease-out',
                        fill: 'forwards'
                    }).onfinish = () => particle.remove();
                }
            }

            function showDigResult(result, message) {
                // æ’­æ”¾æˆåŠŸéŸ³æ•ˆ
                playSuccessSound();

                document.getElementById('digPrize').textContent = result.cell.prizeName || 'ç¥ç§˜çå“';
                document.getElementById('digShards').textContent = result.shardsEarned > 0 ? `+${result.shardsEarned} ç¢ç‰‡` : '';

                const bingoAlert = document.getElementById('bingoAlert');
                if (result.hasBingo) {
                    bingoAlert.style.display = 'block';
                    document.getElementById('bingoRewardText').textContent = `ç²å¾—é€£ç·šçå‹µï¼š${result.bingoRewardName || 'ç‰¹åˆ¥çå“'}`;
                    highlightBingoLines(result.bingoLines);
                    spawnBingoConfetti();
                } else {
                    bingoAlert.style.display = 'none';
                }

                document.getElementById('digModal').style.display = 'flex';
            }

            // æ’­æ”¾æˆåŠŸéŸ³æ•ˆ
            function playSuccessSound() {
                try {
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();

                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);

                    oscillator.frequency.setValueAtTime(523, audioContext.currentTime);
                    oscillator.frequency.setValueAtTime(659, audioContext.currentTime + 0.1);

                    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);

                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.3);
                } catch (e) { }
            }

            // Bingo å½©è‰²ç¢ç‰‡
            function spawnBingoConfetti() {
                const container = document.createElement('div');
                container.className = 'confetti-container';
                document.body.appendChild(container);

                const colors = ['#ffd93d', '#ff6b6b', '#6c5ce7', '#00cec9'];
                for (let i = 0; i < 40; i++) {
                    const piece = document.createElement('div');
                    piece.className = 'confetti-piece';
                    piece.style.left = Math.random() * 100 + '%';
                    piece.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                    piece.style.animationDelay = Math.random() * 0.5 + 's';
                    container.appendChild(piece);
                }
                setTimeout(() => container.remove(), 4000);
            }

            function highlightBingoLines(lines) {
                // é«˜äº®é€£ç·šæ ¼å­
                if (!lines || lines.length === 0) return;

                lines.forEach(line => {
                    let positions = [];
                    if (line.type === 'ROW') {
                        for (let i = 0; i < currentGridSize; i++) {
                            positions.push(line.index * currentGridSize + i + 1);
                        }
                    } else if (line.type === 'COL') {
                        for (let i = 0; i < currentGridSize; i++) {
                            positions.push(i * currentGridSize + line.index + 1);
                        }
                    } else if (line.type === 'DIAGONAL') {
                        if (line.index === 0) {
                            for (let i = 0; i < currentGridSize; i++) {
                                positions.push(i * currentGridSize + i + 1);
                            }
                        } else {
                            for (let i = 0; i < currentGridSize; i++) {
                                positions.push(i * currentGridSize + (currentGridSize - 1 - i) + 1);
                            }
                        }
                    }

                    positions.forEach(pos => {
                        const cell = document.querySelector(`[data-pos="${pos}"]`);
                        if (cell) cell.classList.add('bingo-line');
                    });
                });
            }

            function closeDigModal() {
                document.getElementById('digModal').style.display = 'none';
            }
        </script>
    </div>
</body>

</html>