<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="~{layout :: html(title='æ‰­è›‹æ©Ÿ', content=~{::content})}">

<body>
    <div th:fragment="content">
        <link rel="stylesheet" th:href="@{/css/gacha-animations.css}">

        <div class="container section">
            <h2 class="section-title">ğŸ° ç¥ç§˜æ‰­è›‹æ©Ÿ</h2>
            <p class="text-center" style="color: var(--text-secondary); margin-bottom: 30px;">
                è½‰å‹•æ‰­è›‹ï¼Œç²å¾—é©šå–œå¥½ç¦®ï¼
            </p>

            <!-- æ‰­è›‹ä¸»é¡Œé¸æ“‡ -->
            <div class="grid" style="margin-bottom: 40px;">
                <div th:each="theme : ${themes}" class="card text-center" style="cursor: pointer; transition: all 0.3s;"
                    onclick="selectTheme(this)" th:data-id="${theme.id}" th:data-price="${theme.price}"
                    th:data-name="${theme.name}">
                    <div class="img-placeholder"
                        style="background: linear-gradient(145deg, #ff6b6b, #ee5a5a); margin-bottom: 15px;">
                        <span style="font-size: 3rem;">ğŸ</span>
                    </div>
                    <h3 th:text="${theme.name}">ä¸»é¡Œåç¨±</h3>
                    <p th:text="${theme.description}"
                        style="color: var(--text-secondary); font-size: 0.9rem; margin: 10px 0;"></p>
                    <p style="font-size: 1.3rem; font-weight: bold; color: var(--accent-color);">
                        $<span th:text="${theme.price}">100</span> / æŠ½
                    </p>
                </div>
            </div>
        </div>

        <!-- æ‰­è›‹æ“ä½œå€ -->
        <div id="gachaSection"
            style="display: none; padding: 60px 0; background: linear-gradient(180deg, #1a1a2e, #16213e); text-align: center;">
            <h3 id="selectedThemeName" style="color: white; margin-bottom: 30px;">ä¸»é¡Œåç¨±</h3>

            <!-- æ‰­è›‹æ©Ÿ -->
            <div class="gacha-machine" style="position: relative; width: 280px; margin: 0 auto;">
                <!-- æ‰­è›‹å‡ºå£ -->
                <div id="capsuleContainer"
                    style="height: 220px; display: flex; align-items: center; justify-content: center;">
                    <div class="gacha-capsule" id="capsule" style="display: none;">
                        <div class="top">
                            <div class="shine"></div>
                        </div>
                        <div class="bottom"></div>
                    </div>
                    <div id="idleMachine"
                        style="width: 150px; height: 150px; background: linear-gradient(145deg, #333, #555); border-radius: 20px; display: flex; align-items: center; justify-content: center;">
                        <span style="font-size: 4rem;">â“</span>
                    </div>
                </div>

                <!-- æŒ‰éˆ• -->
                <button id="drawBtn" class="btn-gacha" onclick="startDraw()"
                    style="width: 200px; margin-top: 30px; font-size: 1.3rem;">
                    ğŸ² æŠ•å¹£è½‰è›‹ï¼
                </button>
                <p id="drawPrice" style="color: #aaa; margin-top: 15px;">æ¶ˆè²» $<span>100</span></p>

                <button class="btn btn-outline" onclick="closeGacha()"
                    style="color: white; border-color: white; margin-top: 20px;">
                    â† è¿”å›é¸æ“‡
                </button>
            </div>
        </div>

        <!-- çµæœå½ˆçª— -->
        <div id="resultModal" class="prize-reveal-overlay" style="display: none;">
            <div class="prize-card" style="max-width: 400px;">
                <h2 style="margin-bottom: 20px;">ğŸ‰ æ­å–œç²å¾—ï¼</h2>
                <div id="resultContent">
                    <h3 id="prizeNameResult"
                        style="color: var(--accent-color); font-size: 1.5rem; margin-bottom: 10px;">çå“åç¨±</h3>
                    <p id="prizeWeightResult" style="color: #666;">ç¨€æœ‰åº¦ï¼š<span>10</span></p>
                    <p id="prizeValueResult" style="color: #666;">åƒ¹å€¼ï¼š<span>$100</span></p>
                </div>
                <button class="btn-gacha" onclick="closeResult()" style="margin-top: 20px;">å¤ªæ£’äº†ï¼å†æŠ½ä¸€æ¬¡</button>
            </div>
        </div>

        <!-- éŒ¯èª¤æç¤º -->
        <div th:if="${error}" class="container" style="margin-top: 20px;">
            <div class="alert alert-error text-center" th:text="${error}">éŒ¯èª¤</div>
        </div>

        <!-- ç¢ºèªæ‰£æ¬¾æ¨¡æ…‹æ¡† -->
        <div id="confirmModal" class="prize-reveal-overlay" style="display: none;">
            <div class="prize-card" style="max-width: 400px;">
                <div style="font-size: 2rem; margin-bottom: 15px;">ğŸ°</div>
                <h3 style="margin: 0 0 15px 0;">ç¢ºèªæŠ•å¹£</h3>
                <p style="margin-bottom: 10px;">å³å°‡æ‰£é™¤é¤˜é¡é€²è¡ŒæŠ“æŠ½</p>
                <div style="background: rgba(102,126,234,0.1); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <p style="margin: 0; font-size: 1.5rem; color: var(--accent-color); font-weight: bold;">
                        $<span id="confirmPrice">0</span>
                    </p>
                </div>
                <div style="display: flex; gap: 15px; justify-content: center;">
                    <button class="btn btn-outline" onclick="cancelConfirm()">å–æ¶ˆ</button>
                    <button class="btn-gacha" onclick="confirmDraw()">ç¢ºèªæ‰£æ¬¾</button>
                </div>
            </div>
        </div>

        <script>
            let selectedTheme = null;

            function selectTheme(card) {
                const currentUser = [[${ currentUser != null}]];
            if (!currentUser) {
                window.location.href = '/login';
                return;
            }

            selectedTheme = {
                id: card.dataset.id,
                price: card.dataset.price,
                name: card.dataset.name
            };

            document.getElementById('selectedThemeName').textContent = selectedTheme.name;
            document.getElementById('drawPrice').querySelector('span').textContent = selectedTheme.price;
            document.querySelector('.container.section').style.display = 'none';
            document.getElementById('gachaSection').style.display = 'block';
            }

            function closeGacha() {
                document.querySelector('.container.section').style.display = 'block';
                document.getElementById('gachaSection').style.display = 'none';
                selectedTheme = null;
            }

            function startDraw() {
                if (!selectedTheme) return;
                // é¡¯ç¤ºç¢ºèªæ¨¡æ…‹æ¡†
                document.getElementById('confirmPrice').textContent = selectedTheme.price;
                document.getElementById('confirmModal').style.display = 'flex';
            }

            function cancelConfirm() {
                document.getElementById('confirmModal').style.display = 'none';
            }

            function confirmDraw() {
                document.getElementById('confirmModal').style.display = 'none';

                const btn = document.getElementById('drawBtn');
                btn.disabled = true;
                btn.textContent = 'è½‰å‹•ä¸­...';

                const capsule = document.getElementById('capsule');
                const idleMachine = document.getElementById('idleMachine');

                idleMachine.style.display = 'none';
                capsule.style.display = 'block';
                capsule.style.animation = 'capsule-shake 0.3s ease-in-out infinite';

                setTimeout(() => {
                    capsule.style.animation = 'capsule-open 0.5s ease forwards';

                    const form = document.createElement('form');
                    form.method = 'POST';
                    form.action = '/mystery-box/draw';
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = 'themeId';
                    input.value = selectedTheme.id;
                    form.appendChild(input);
                    document.body.appendChild(form);
                    form.submit();
                }, 1500);
            }

            function closeResult() {
                document.getElementById('resultModal').style.display = 'none';
            }

            // æª¢æŸ¥æ˜¯å¦æœ‰ä¸­ççµæœ
            document.addEventListener('DOMContentLoaded', function () {
                const wonItem = [[${ wonItem != null}]];
            if (wonItem) {
                const name = '[[${wonItem?.name}]]';
                const weight = '[[${wonItem?.weight}]]';
                const value = '[[${wonItem?.estimatedValue}]]';

                document.getElementById('prizeNameResult').textContent = name;
                document.getElementById('prizeWeightResult').querySelector('span').textContent = weight;
                document.getElementById('prizeValueResult').querySelector('span').textContent = '$' + value;
                document.getElementById('resultModal').style.display = 'flex';
            }
            });
        </script>
    </div>
</body>

</html>